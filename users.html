<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management</title>
    
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="./manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-title" content="JoshBurt.com.au">
    <link rel="apple-touch-icon" href="./assets/images/logo-placeholder.svg">
    
    <link rel="stylesheet" href="./assets/css/styles.css">

        <!-- Load shared config and theme system -->
        <script>
            fetch('shared-config.html').then(r => r.text()).then(html => {
                const temp = document.createElement('div');
                temp.innerHTML = html;
                Array.from(temp.children).forEach(child => {
                    if (child.tagName === 'LINK' || child.tagName === 'STYLE' || child.tagName === 'SCRIPT') {
                        document.head.appendChild(child.cloneNode(true));
                    }
                });
            });
            fetch('shared-theme.html').then(r => r.text()).then(html => {
                const temp = document.createElement('div');
                temp.innerHTML = html;
                Array.from(temp.children).forEach(child => {
                    if (child.tagName === 'SCRIPT') {
                        document.head.appendChild(child.cloneNode(true));
                    }
                });
            });
        </script>
    <script>
        // Configuration for dynamic color updates from settings
        function applyDynamicColors() {
            const settingsHead = JSON.parse(localStorage.getItem('siteSettings')) || {};
            // Apply CSS variables for instant color update
            document.documentElement.style.setProperty('--tw-color-primary', settingsHead.primaryColor || '#3b82f6');
            document.documentElement.style.setProperty('--tw-color-secondary', settingsHead.secondaryColor || '#10b981');
            document.documentElement.style.setProperty('--tw-color-accent', settingsHead.accentColor || '#8b5cf6');
        }
        applyDynamicColors();
        // Service Worker Registration for PWA
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("./sw.js")
                    .then(registration => {
                        console.log("SW registered: ", registration);
                    })
                    .catch(registrationError => {
                        console.log("SW registration failed: ", registrationError);
                    });
            });
        }
    </script>
    <style>
        body {
            transition: background-color 0.3s, color 0.3s;
            font-family: 'Inter', 'system-ui', '-apple-system', sans-serif;
            background-color: #0a0a0a;
            color: #ffffff;
        }
        .dark {
            background-color: #0a0a0a;
            color: #ffffff;
        }
        .light {
            background-color: #f9fafb;
            color: #1f2937;
        }
        .sidebar {
            width: 16rem;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            overflow-y: auto;
            transition: background-color 0.3s;
            z-index: 100;
            background-color: #111111;
            border-right: 1px solid #00d4ff20;
        }
        main {
            margin-left: 16rem;
            min-height: 100vh;
            background-color: #0a0a0a;
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
            }
            .sidebar.open {
                transform: translateX(0);
            }
            main {
                margin-left: 0;
            }
        }
        .user-item {
            transition: all 0.2s ease;
            background-color: #111111;
            border: 1px solid #333333;
        }
        .user-item:hover {
            background-color: #181818;
            border-color: #00d4ff;
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.2);
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        .focus\:not-sr-only:focus {
            position: static;
            width: auto;
            height: auto;
            padding: 0.5rem;
            margin: 0;
            overflow: visible;
            clip: auto;
            white-space: normal;
        }
        @media print {
            .sidebar, .no-print { display: none !important; }
            main { margin-left: 0 !important; }
            body { background: white !important; color: black !important; }
        }

        /* Neon button styles */
        .btn-neon-blue {
            background: linear-gradient(45deg, #00d4ff, #0099cc);
            border: 1px solid #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
            color: #000000;
            font-weight: 600;
        }
        .btn-neon-blue:hover {
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.6);
            background: linear-gradient(45deg, #00eeff, #00b8e6);
        }
        .btn-neon-green {
            background: linear-gradient(45deg, #00ff88, #00cc66);
            border: 1px solid #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
            color: #000000;
            font-weight: 600;
        }
        .btn-neon-green:hover {
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.6);
            background: linear-gradient(45deg, #00ff99, #00dd77);
        }

        /* Navigation link styling */
        .nav-link {
            color: #cccccc;
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            color: #00d4ff;
            text-shadow: 0 0 8px rgba(0, 212, 255, 0.6);
        }
        .nav-link.active {
            color: #00d4ff;
            background-color: #00d4ff20;
            border-left: 3px solid #00d4ff;
        }
    </style>

    </head>
    <body class="dark">
    <main>
        <section>
            <p class="text-gray-600 dark:text-gray-300 leading-relaxed">Manage user accounts and permissions. Add, edit, or remove users from the system.</p>
            <!-- User Table Card -->
            <div class="widget-primary rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
                <div class="overflow-x-auto">
                    <table class="w-full text-left mb-6" role="table" aria-label="User accounts table">
                        <thead>
                            <tr class="border-b-2 border-gray-300 dark:border-gray-600">
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Name</th>
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Email</th>
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Role</th>
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- User rows will be dynamically generated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <!-- Add User Form -->
                <form class="mt-6 pt-6 border-t border-gray-300 dark:border-gray-600" id="user-form" role="form" aria-label="Add new user form">
                    <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100">Add New User</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <input type="text" placeholder="Name" required class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" aria-label="User name">
                        <input type="email" placeholder="Email" required class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" aria-label="User email">
                        <select required class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" aria-label="User role">
                            <option value="">Select Role</option>
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 p-3 bg-primary text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 font-semibold transition-colors duration-200">Add User</button>
                        <button type="button" id="cancel-edit" class="px-6 p-3 bg-gray-600 text-white rounded-lg hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 font-semibold hidden transition-colors duration-200">Cancel</button>
                    </div>
                </form>
            </div>
        </section>
        <!-- Bulk Operations -->
        <section class="mt-6" aria-label="Bulk operations">
            <div class="widget-secondary rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100">Bulk Operations</h3>
                <div class="flex flex-wrap gap-4">
                    <button id="export-users-csv" class="px-4 py-2 bg-secondary text-white rounded hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400">Export Users (CSV)</button>
                    <button id="export-users-excel" class="px-4 py-2 bg-accent text-white rounded hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-400">Export Users (Excel)</button>
                    <label for="import-users-csv" class="px-4 py-2 bg-primary text-white rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 cursor-pointer">
                        Import Users (CSV)
                        <input type="file" id="import-users-csv" accept=".csv" class="hidden">
                    </label>
                </div>
                <div class="mt-4 text-sm text-gray-400">
                    <p><strong>CSV Format:</strong> Name,Email,Role</p>
                    <p><strong>Example:</strong> John Doe,john@example.com,user</p>
                </div>
            </div>
        </section>
    </main>

    <script>

        // Show toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Load and apply site settings
        function loadAndApplySettings() {
            const settings = JSON.parse(localStorage.getItem('siteSettings')) || {};
            
            // Apply site title if set
            if (settings['site-title']) {
                const brandingElements = document.querySelectorAll('h1');
                brandingElements.forEach(el => {
                    if (el.textContent.includes('Josh\'s App')) {
                        el.textContent = settings['site-title'];
                    }
                });
            }
        }

        // User management functionality with audit logging
        let users = [];
        let editingUserId = null;

        // Audit Logger for users page
        class AuditLogger {
            static log(action, details, userId = 'admin') {
                const auditLogs = JSON.parse(localStorage.getItem('auditLogs') || '[]');
                const logEntry = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    userId: userId,
                    action: action,
                    details: details,
                    ip: 'localhost'
                };
                
                auditLogs.unshift(logEntry);
                
                if (auditLogs.length > 1000) {
                    auditLogs.splice(1000);
                }
                
                localStorage.setItem('auditLogs', JSON.stringify(auditLogs));
                window.dispatchEvent(new CustomEvent('auditLogUpdated', { detail: logEntry }));
            }
        }

        // Load users from localStorage
        function loadUsers() {
            const savedUsers = localStorage.getItem('siteUsers');
            users = savedUsers ? JSON.parse(savedUsers) : [
                { id: 1, name: 'Josh Burt', email: 'josh@example.com', role: 'admin' },
                { id: 2, name: 'Jane Doe', email: 'jane@example.com', role: 'user' }
            ];
            renderUsers();
        }

        // Save users to localStorage
        function saveUsers() {
            localStorage.setItem('siteUsers', JSON.stringify(users));
        }

        // Render users table
        function renderUsers() {
            const tbody = document.querySelector('tbody');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700';
                row.innerHTML = `
                    <td class="py-2 px-3">${user.name}</td>
                    <td class="py-2 px-3">${user.email}</td>
                    <td class="py-2 px-3">${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</td>
                    <td class="py-2 px-3">
                        <button class="px-2 py-1 bg-secondary text-white rounded mr-2 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 edit-user" data-id="${user.id}">Edit</button>
                        <button class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 delete-user" data-id="${user.id}">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Add or update user with audit logging
        function addOrUpdateUser(event) {
            event.preventDefault();
            
            const form = event.target;
            const name = form.querySelector('input[type="text"]').value.trim();
            const email = form.querySelector('input[type="email"]').value.trim();
            const role = form.querySelector('select').value;
            
            if (!name || !email || !role) {
                showToast('Please fill in all fields');
                return;
            }

            if (editingUserId) {
                // Update existing user
                const userIndex = users.findIndex(u => u.id === editingUserId);
                if (userIndex !== -1) {
                    const oldUser = users[userIndex];
                    users[userIndex] = { id: editingUserId, name, email, role };
                    
                    // Log user update
                    AuditLogger.log('user_update', `Updated user: ${oldUser.name} (${oldUser.email}) → ${name} (${email}), Role: ${oldUser.role} → ${role}`);
                    
                    showToast('User updated successfully!');
                    editingUserId = null;
                    form.querySelector('button[type="submit"]').textContent = 'Add User';
                    form.querySelector('h3').textContent = 'Add New User';
                    document.getElementById('cancel-edit').classList.add('hidden');
                }
            } else {
                // Add new user
                const newUser = {
                    id: Date.now(),
                    name,
                    email,
                    role
                };
                users.push(newUser);
                
                // Log user creation
                AuditLogger.log('user_create', `Created new user: ${name} (${email}) with role: ${role}`);
                
                showToast('User added successfully!');
            }
            
            form.reset();
            saveUsers();
            renderUsers();
        }

        // Edit user
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            const form = document.querySelector('form');
            form.querySelector('input[type="text"]').value = user.name;
            form.querySelector('input[type="email"]').value = user.email;
            form.querySelector('select').value = user.role;
            
            editingUserId = userId;
            form.querySelector('button[type="submit"]').textContent = 'Update User';
            form.querySelector('h3').textContent = 'Edit User';
            document.getElementById('cancel-edit').classList.remove('hidden');
            
            // Scroll to form
            form.scrollIntoView({ behavior: 'smooth' });
        }

        // Delete user with audit logging
        function deleteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user && confirm('Are you sure you want to delete this user?')) {
                users = users.filter(u => u.id !== userId);
                
                // Log user deletion
                AuditLogger.log('user_delete', `Deleted user: ${user.name} (${user.email}) with role: ${user.role}`);
                
                saveUsers();
                renderUsers();
                showToast('User deleted successfully!');
            }
        }

        // Cancel edit
        function cancelEdit() {
            editingUserId = null;
            const form = document.querySelector('form');
            form.reset();
            form.querySelector('button[type="submit"]').textContent = 'Add User';
            form.querySelector('h3').textContent = 'Add New User';
            document.getElementById('cancel-edit').classList.add('hidden');
        }

        // Export users to CSV
        function exportUsersCSV() {
            const headers = ['Name', 'Email', 'Role'];
            const csvContent = [
                headers.join(','),
                ...users.map(user => [
                    `"${user.name}"`,
                    `"${user.email}"`,
                    `"${user.role}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'users.csv';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Users exported to CSV successfully!');
        }

        // Export users to Excel format (actually CSV with different extension)
        function exportUsersExcel() {
            const headers = ['Name', 'Email', 'Role'];
            const csvContent = [
                headers.join('\t'), // Use tabs for better Excel compatibility
                ...users.map(user => [
                    user.name,
                    user.email,
                    user.role
                ].join('\t'))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'application/vnd.ms-excel' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'users.xls';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Users exported to Excel successfully!');
        }

        // Import users from CSV
        function importUsersCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const importedUsers = [];

                    // Skip header row if it exists
                    const startIndex = lines[0].toLowerCase().includes('name') ? 1 : 0;
                    
                    for (let i = startIndex; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        const fields = line.split(',').map(field => field.replace(/^"|"$/g, '').trim());
                        if (fields.length >= 3) {
                            const name = fields[0];
                            const email = fields[1];
                            const role = fields[2].toLowerCase();

                            // Validate email format
                            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                            if (!emailRegex.test(email)) {
                                continue; // Skip invalid emails
                            }

                            // Validate role
                            if (!['user', 'admin'].includes(role)) {
                                continue; // Skip invalid roles
                            }

                            // Check if user already exists
                            const existingUser = users.find(u => u.email === email);
                            if (!existingUser) {
                                importedUsers.push({
                                    id: Date.now() + i,
                                    name,
                                    email,
                                    role
                                });
                            }
                        }
                    }

                    if (importedUsers.length > 0) {
                        users.push(...importedUsers);
                        saveUsers();
                        renderUsers();
                        showToast(`${importedUsers.length} users imported successfully!`);
                    } else {
                        showToast('No valid new users found in CSV file');
                    }
                } catch (error) {
                    showToast('Error importing CSV file: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Reset input
            event.target.value = '';
        }

        // Theme Toggle
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;
        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark');
            body.classList.toggle('light');
            localStorage.setItem('theme', body.classList.contains('dark') ? 'dark' : 'light');
            themeToggle.textContent = body.classList.contains('dark') ? 'Toggle Light Mode' : 'Toggle Dark Mode';
            themeToggle.setAttribute('aria-label', body.classList.contains('dark') ? 'Toggle light mode' : 'Toggle dark mode');
        });

        // Load saved theme from settings or localStorage
        const settings = JSON.parse(localStorage.getItem('siteSettings')) || {};
        const savedTheme = settings['theme'] || localStorage.getItem('theme') || 'dark';
        body.classList.add(savedTheme);
        themeToggle.textContent = savedTheme === 'dark' ? 'Toggle Light Mode' : 'Toggle Dark Mode';
        themeToggle.setAttribute('aria-label', savedTheme === 'dark' ? 'Toggle light mode' : 'Toggle dark mode');

        // Mobile Menu Toggle
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            const isOpen = sidebar.classList.contains('open');
            menuToggle.setAttribute('aria-expanded', isOpen);
        });

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Log page access
            if (typeof AuditLogger !== 'undefined') {
                AuditLogger.log('page_access', 'Accessed User Management page');
            }
            
            loadUsers();
            loadAndApplySettings();
            
            // Form submission
            document.querySelector('form').addEventListener('submit', addOrUpdateUser);
            
            // Cancel edit button
            document.getElementById('cancel-edit').addEventListener('click', cancelEdit);
            
            // Edit and delete buttons
            document.querySelector('tbody').addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-user')) {
                    editUser(parseInt(e.target.dataset.id));
                } else if (e.target.classList.contains('delete-user')) {
                    deleteUser(parseInt(e.target.dataset.id));
                }
            });

            // Bulk operations
            document.getElementById('export-users-csv').addEventListener('click', exportUsersCSV);
            document.getElementById('export-users-excel').addEventListener('click', exportUsersExcel);
            document.getElementById('import-users-csv').addEventListener('change', importUsersCSV);
        });
 
        // Service Worker Registration for PWA
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("./sw.js")
                    .then(registration => {
                        console.log("SW registered: ", registration);
                    })
                    .catch(registrationError => {
                        console.log("SW registration failed: ", registrationError);
                    });
            });
        }
    </script>
</body>
</html>
