<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>User Management</title>
  <link rel="manifest" href="./manifest.json" />
  <link rel="apple-touch-icon" href="./assets/images/logo-placeholder.svg" />
  <link rel="stylesheet" href="./assets/css/styles.css" />
    <script src="./assets/js/init-shared.js" defer></script>
    <script src="./assets/js/audit.js" defer></script>
  <style>
    .user-item{transition:all .2s ease;background:#111;border:1px solid #333}
    .user-item:hover{background:#181818;border-color:#00d4ff;box-shadow:0 4px 20px rgba(0,212,255,.2)}
  </style>
</head>
    <body class="dark">
    <!-- MOBILE MENU TOGGLE (copied from template.html) -->
    <button id="menu-toggle" class="md:hidden fixed top-4 left-4 z-50 p-2 bg-primary text-white rounded-md focus:outline-none focus:ring-2 focus:ring-secondary" aria-label="Toggle sidebar" aria-expanded="false">â˜°</button>
    <div id="sidebar-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-4 right-4 p-4 rounded shadow-lg transition-opacity duration-300 btn-neon-blue text-black" role="alert" aria-live="polite"></div>
    <div class="flex min-h-screen">
        <!-- Shared Navigation Loader -->
        <div id="main-nav"></div>
        <script>
          // Dynamically load shared navigation
          fetch('shared-nav.html')
            .then(response => response.text())
            .then(html => {
              document.getElementById('main-nav').innerHTML = html;
            });
        </script>
                <!-- Main Content -->
                <main class="flex-1 p-4 md:p-6 ml-64 md:ml-0">
                <!-- Header Card -->
                <header class="sticky top-0 p-6 rounded-lg shadow-md mb-6 z-40 border card" role="banner">
                    <div class="flex items-center justify-between gap-4">
                        <div>
                            <h1 class="text-3xl font-bold text-white">User Management</h1>
                            <p class="text-lg mt-2 nav-link-muted">Manage accounts, roles and access</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button id="open-add-user" class="btn-neon-green px-4 py-2 rounded">Add User</button>
                            <button id="refresh-users" class="btn-neon-blue px-4 py-2 rounded">Refresh</button>
                        </div>
                    </div>
                </header>
        <section>
            <p class="text-gray-600 dark:text-gray-300 leading-relaxed">Manage user accounts and permissions. Add, edit, or remove users from the system.</p>
            <!-- User Filters/Search/Sort -->
            <div class="flex flex-wrap gap-4 items-center mb-4">
                <input id="user-search" type="text" placeholder="Search name or email..." class="p-2 rounded border border-gray-400 dark:border-gray-600 bg-gray-900 text-white text-sm min-w-[180px]" />
                <select id="user-role-filter" class="p-2 rounded border border-gray-400 dark:border-gray-600 bg-gray-900 text-white text-sm">
                    <option value="">All Roles</option>
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                    <option value="manager">Manager</option>
                </select>
                <select id="user-status-filter" class="p-2 rounded border border-gray-400 dark:border-gray-600 bg-gray-900 text-white text-sm">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
                <select id="user-sort" class="p-2 rounded border border-gray-400 dark:border-gray-600 bg-gray-900 text-white text-sm">
                    <option value="created_at_desc">Newest</option>
                    <option value="created_at_asc">Oldest</option>
                    <option value="name_asc">Name A-Z</option>
                    <option value="name_desc">Name Z-A</option>
                </select>
            </div>
            <!-- User Table Card (neon theme, .card + .widget-primary) -->
            <div class="card widget-primary rounded-lg shadow-md p-6">
                <div class="overflow-x-auto">
                    <table class="w-full text-left mb-6" role="table" aria-label="User accounts table">
                        <thead>
                            <tr class="border-b-2 border-gray-300 dark:border-gray-600">
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Name</th>
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Email</th>
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Role</th>
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Status</th>
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Last Login</th>
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- User rows will be dynamically generated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <!-- Pagination Controls -->
                <div class="flex gap-2 items-center justify-end mt-2" id="user-pagination"></div>
                <!-- Add User Form (neon theme, .card + .widget-secondary) -->
                <form class="mt-6 pt-6 border-t border-gray-300 dark:border-gray-600" id="user-form" role="form" aria-label="Add new user form">
                    <h3 class="text-xl font-semibold mb-4 text-gray-100">Add New User</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <input type="text" placeholder="Name" required class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" aria-label="User name">
                        <input type="email" placeholder="Email" required class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" aria-label="User email">
                        <select required class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" aria-label="User role">
                            <option value="">Select Role</option>
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="btn-neon-blue flex-1 p-3 rounded-lg">Add User</button>
                        <button type="button" id="cancel-edit" class="btn-neon-green px-6 p-3 rounded-lg hidden">Cancel</button>
                    </div>
                </form>
            </div>
        </section>
        <!-- Bulk Operations -->
        <!-- Bulk Operations (neon theme, .card + .widget-secondary) -->
        <section class="mt-6" aria-label="Bulk operations">
            <div class="card widget-secondary rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-100">Bulk Operations</h3>
                <div class="flex flex-wrap gap-4">
                    <button id="export-users-csv" class="btn-neon-green px-4 py-2 rounded">Export Users (CSV)</button>
                    <button id="export-users-excel" class="btn-neon-blue px-4 py-2 rounded">Export Users (Excel)</button>
                    <label for="import-users-csv" class="btn-neon-blue px-4 py-2 rounded cursor-pointer">
                        Import Users (CSV)
                        <input type="file" id="import-users-csv" accept=".csv" class="hidden">
                    </label>
                </div>
                <div class="mt-4 text-sm text-gray-400">
                    <p><strong>CSV Format:</strong> Name,Email,Role</p>
                    <p><strong>Example:</strong> John Doe,john@example.com,user</p>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Serverless base path and auth token helper
        const FN_BASE = '/.netlify/functions';
        const usersState = { list: [], pagination: { page:1, limit:10, total:0, pages:1 }, filters: { search:'', role:'', status:'', sort:'created_at_desc' }, editingId: null };

        function loadAndApplySettings() {
            const settings = JSON.parse(localStorage.getItem('siteSettings')) || {};
            if (settings['site-title']) {
                document.querySelectorAll('h1').forEach(el => {
                    if (el.textContent.includes("Josh's App")) el.textContent = settings['site-title'];
                });
            }
        }

        class AuditLogger { static log(action, details, userId='admin') { const logs = JSON.parse(localStorage.getItem('auditLogs')||'[]'); const entry={ id:Date.now(), timestamp:new Date().toISOString(), userId, action, details, ip:'localhost' }; logs.unshift(entry); if (logs.length>1000) logs.splice(1000); localStorage.setItem('auditLogs', JSON.stringify(logs)); window.dispatchEvent(new CustomEvent('auditLogUpdated',{ detail:entry })); } }

    async function loadUsers(page=1){
            try {
        const token = localStorage.getItem('accessToken') || localStorage.getItem('authToken');
                const { limit, filters } = { limit: usersState.pagination.limit, filters: usersState.filters };
                const params = new URLSearchParams({ page, limit, search:filters.search, role:filters.role, status:filters.status, sort:filters.sort });
                const res = await fetch(`${FN_BASE}/users?${params.toString()}`, { headers: token ? { 'Authorization': `Bearer ${token}` } : {} });
                if (res.status === 401 || res.status === 403) { 
                    const returnUrl = encodeURIComponent(window.location.pathname + window.location.search);
                    window.location.href = `login.html?message=login-required&returnUrl=${returnUrl}`; 
                    return; 
                }
                if (!res.ok) throw new Error('Failed (status '+res.status+')');
                const data = await res.json();
                usersState.list = data.users || [];
                usersState.pagination = data.pagination || { page:1, limit:limit, total:usersState.list.length, pages:1 };
                renderUsers();
            } catch(err){ console.error('loadUsers', err); showToast('Error loading users: '+err.message,'error'); usersState.list=[]; renderUsers(); }
        }

        function renderUsers(){
            const tbody = document.querySelector('tbody');
            tbody.innerHTML='';
            usersState.list.forEach(u => {
                const tr = document.createElement('tr');
                tr.className='border-b border-gray-700';
                const avatar = u.avatar_url ? `<img src="${u.avatar_url}" class="inline w-8 h-8 rounded-full mr-2"/>` : `<span class="inline-block w-8 h-8 rounded-full bg-gray-600 mr-2"></span>`;
                const status = u.is_active ? '<span class="text-green-400">Active</span>' : '<span class="text-red-400">Inactive</span>';
                const lastLogin = u.last_login ? new Date(u.last_login).toLocaleString() : '--';
                tr.innerHTML = `
                    <td class="py-2 px-3 flex items-center">${avatar}<a href="profile.html?user_id=${u.id}" class="text-blue-400 hover:underline">${u.name}</a></td>
                    <td class="py-2 px-3">${u.email}</td>
                    <td class="py-2 px-3">${u.role.charAt(0).toUpperCase()+u.role.slice(1)}</td>
                    <td class="py-2 px-3">${status}</td>
                    <td class="py-2 px-3">${lastLogin}</td>
                    <td class="py-2 px-3">
                        <button class="px-2 py-1 bg-secondary text-white rounded mr-2 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 edit-user" data-id="${u.id}">Edit</button>
                        <button class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 delete-user" data-id="${u.id}">Delete</button>
                        <button class="px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 lock-user" data-id="${u.id}">${u.is_active ? 'Lock':'Unlock'}</button>
                        <button class="px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 reset-password-user" data-id="${u.id}">Reset PW</button>
                        <button class="px-2 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 impersonate-user" data-id="${u.id}">Impersonate</button>
                    </td>`;
                tbody.appendChild(tr);
            });
            const pagDiv = document.getElementById('user-pagination');
            const { page, pages } = usersState.pagination; pagDiv.innerHTML='';
            if (pages>1){ for(let i=1;i<=pages;i++){ const b=document.createElement('button'); b.textContent=i; b.className='px-2 py-1 rounded '+(i===page?'bg-primary text-white':'bg-gray-700 text-gray-300 hover:bg-gray-600'); b.onclick=()=>loadUsers(i); pagDiv.appendChild(b);} }
        }
        // Show toast notification
        function showToast(message, type = 'success') {
            let toast = document.getElementById('toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast';
                toast.setAttribute('role','alert');
                toast.setAttribute('aria-live','polite');
                toast.className = 'hidden fixed bottom-4 right-4 p-4 rounded shadow-lg transition-opacity duration-300';
                document.body.appendChild(toast);
            }
            toast.textContent = message;
            toast.className = `fixed bottom-4 right-4 p-4 rounded shadow-lg transition-opacity duration-300 ${type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`;
            toast.classList.remove('hidden');
            setTimeout(() => { toast.classList.add('hidden'); }, 3000);
        }

        // Add or update user via backend API
        async function addOrUpdateUser(e){
            e.preventDefault();
            const form = e.target;
            const name = form.querySelector('input[type="text"]').value.trim();
            const email = form.querySelector('input[type="email"]').value.trim();
            const role = form.querySelector('select').value;
            const token = localStorage.getItem('accessToken') || localStorage.getItem('authToken');
            if(!name||!email||!role){ showToast('Please fill in all fields'); return; }
            try {
                if (usersState.editingId){
                    const res = await fetch(`${FN_BASE}/users/${usersState.editingId}`, { method:'PUT', headers:{ 'Content-Type':'application/json', ...(token?{ 'Authorization':`Bearer ${token}` }:{}) }, body:JSON.stringify({ name, role }) });
                    if(!res.ok) throw new Error('Failed to update user');
                    showToast('User updated','success');
                    usersState.editingId=null; form.querySelector('button[type="submit"]').textContent='Add User'; form.querySelector('h3').textContent='Add New User'; document.getElementById('cancel-edit').classList.add('hidden');
                } else {
                    const password = Math.random().toString(36).slice(-10)+'A1!';
                    const res = await fetch(`${FN_BASE}/users`, { method:'POST', headers:{ 'Content-Type':'application/json', ...(token?{ 'Authorization':`Bearer ${token}` }:{}) }, body:JSON.stringify({ name,email,role,password }) });
                    if(!res.ok){ const err=await res.json().catch(()=>({})); throw new Error(err.error||'Failed to add user'); }
                    showToast('User added','success');
                }
                form.reset();
                await loadUsers();
            } catch(err){ showToast('Error: '+err.message,'error'); }
        }

        // Edit user
        function editUser(id){ const u=usersState.list.find(x=>x.id===id); if(!u) return; const form=document.getElementById('user-form'); form.querySelector('input[type="text"]').value=u.name; form.querySelector('input[type="email"]').value=u.email; form.querySelector('select').value=u.role; usersState.editingId=id; form.querySelector('button[type="submit"]').textContent='Update User'; form.querySelector('h3').textContent='Edit User'; document.getElementById('cancel-edit').classList.remove('hidden'); form.scrollIntoView({ behavior:'smooth' }); }

        // Delete user via backend API
    async function deleteUser(id){ if(!confirm('Delete this user?')) return; const token=localStorage.getItem('accessToken') || localStorage.getItem('authToken'); try { const res=await fetch(`${FN_BASE}/users/${id}`, { method:'DELETE', headers: token?{ 'Authorization':`Bearer ${token}` }:{} }); if(!res.ok) throw new Error('Failed to delete user'); showToast('User deleted','success'); await loadUsers(); } catch(err){ showToast('Error: '+err.message,'error'); } }

        // Cancel edit
        function cancelEdit(){ usersState.editingId=null; const form=document.getElementById('user-form'); form.reset(); form.querySelector('button[type="submit"]').textContent='Add User'; form.querySelector('h3').textContent='Add New User'; document.getElementById('cancel-edit').classList.add('hidden'); }

        // Export users to CSV via backend API
    async function exportUsersCSV(){ const token=localStorage.getItem('accessToken') || localStorage.getItem('authToken'); try { const res=await fetch(`${FN_BASE}/users?limit=1000`, { headers: token?{ 'Authorization':`Bearer ${token}` }:{} }); if(!res.ok) throw new Error('Failed to fetch users'); const data=await res.json(); const headers=['Name','Email','Role']; const csv=[ headers.join(','), ...(data.users||[]).map(u=>`"${u.name}","${u.email}","${u.role}"`) ].join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='users.csv'; a.click(); URL.revokeObjectURL(url); showToast('Exported CSV','success'); } catch(err){ showToast('Error: '+err.message,'error'); } }

        // Export users to Excel (tab-separated) via backend API
    async function exportUsersExcel(){ const token=localStorage.getItem('accessToken') || localStorage.getItem('authToken'); try { const res=await fetch(`${FN_BASE}/users?limit=1000`, { headers: token?{ 'Authorization':`Bearer ${token}` }:{} }); if(!res.ok) throw new Error('Failed to fetch users'); const data=await res.json(); const headers=['Name','Email','Role']; const tsv=[ headers.join('\t'), ...(data.users||[]).map(u=>[u.name,u.email,u.role].join('\t')) ].join('\n'); const blob=new Blob([tsv],{type:'application/vnd.ms-excel'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='users.xls'; a.click(); URL.revokeObjectURL(url); showToast('Exported Excel','success'); } catch(err){ showToast('Error: '+err.message,'error'); } }

        // Import users from CSV via backend API
    async function importUsersCSV(evt){ const file=evt.target.files[0]; if(!file) return; const token=localStorage.getItem('accessToken') || localStorage.getItem('authToken'); const reader=new FileReader(); reader.onload=async e=>{ try { const lines=e.target.result.split('\n'); const start = lines[0].toLowerCase().includes('name')?1:0; let imported=0; for(let i=start;i<lines.length;i++){ const line=lines[i].trim(); if(!line) continue; const parts=line.split(',').map(f=>f.replace(/^"|"$/g,'').trim()); if(parts.length<3) continue; const [name,email,roleRaw]=parts; const role=roleRaw.toLowerCase(); const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/; if(!emailRegex.test(email)) continue; if(!['user','admin','manager'].includes(role)) continue; const password=Math.random().toString(36).slice(-10)+'A1!'; const res=await fetch(`${FN_BASE}/users`, { method:'POST', headers:{ 'Content-Type':'application/json', ...(token?{ 'Authorization':`Bearer ${token}` }:{}) }, body:JSON.stringify({ name,email,role,password }) }); if(res.ok) imported++; }
            await loadUsers(); showToast(imported+' users imported','success'); } catch(err){ showToast('Import error: '+err.message,'error'); } }; reader.readAsText(file); evt.target.value=''; }

        // Event wiring
        document.addEventListener('DOMContentLoaded', () => {
            // Require authentication for this page
            const initialToken = localStorage.getItem('accessToken') || localStorage.getItem('authToken');
            if (!initialToken) { 
                const returnUrl = encodeURIComponent(window.location.pathname + window.location.search);
                window.location.href = `login.html?message=login-required&returnUrl=${returnUrl}`; 
                return; 
            }
            if (typeof AuditLogger !== 'undefined') { AuditLogger.log('page_access','Accessed User Management page'); }
            loadUsers();
            loadAndApplySettings();
            document.getElementById('user-form').addEventListener('submit', addOrUpdateUser);
            document.getElementById('cancel-edit').addEventListener('click', cancelEdit);
            // Header actions
            const refreshBtn = document.getElementById('refresh-users');
            if (refreshBtn) refreshBtn.addEventListener('click', ()=> loadUsers(usersState.pagination.page || 1));
            const openAddBtn = document.getElementById('open-add-user');
            if (openAddBtn) openAddBtn.addEventListener('click', ()=> { try { cancelEdit(); } catch(_){} document.getElementById('user-form')?.scrollIntoView({ behavior:'smooth', block:'start' }); });
            document.getElementById('export-users-csv').addEventListener('click', exportUsersCSV);
            document.getElementById('export-users-excel').addEventListener('click', exportUsersExcel);
            document.getElementById('import-users-csv').addEventListener('change', importUsersCSV);
            document.getElementById('user-search').addEventListener('input', e => { usersState.filters.search=e.target.value; loadUsers(1); });
            document.getElementById('user-role-filter').addEventListener('change', e => { usersState.filters.role=e.target.value; loadUsers(1); });
            document.getElementById('user-status-filter').addEventListener('change', e => { usersState.filters.status=e.target.value; loadUsers(1); });
            document.getElementById('user-sort').addEventListener('change', e => { usersState.filters.sort=e.target.value; loadUsers(1); });
            const tbody=document.querySelector('tbody');
            tbody.addEventListener('click', async e => {
                const id=e.target.dataset.id; if(!id) return;
                if(e.target.classList.contains('edit-user')) { editUser(parseInt(id)); return; }
                if(e.target.classList.contains('delete-user')) { deleteUser(parseInt(id)); return; }
                const token=localStorage.getItem('accessToken') || localStorage.getItem('authToken');
                if(e.target.classList.contains('lock-user')){ const u=usersState.list.find(x=>x.id==id); if(!u) return; try { const res=await fetch(`${FN_BASE}/users/${id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', ...(token?{ 'Authorization':`Bearer ${token}` }:{}) }, body:JSON.stringify({ is_active: !u.is_active }) }); if(!res.ok) throw new Error('Failed to update'); showToast(u.is_active?'User locked':'User unlocked','success'); await loadUsers(usersState.pagination.page); } catch(err){ showToast('Error: '+err.message,'error'); } return; }
                if(e.target.classList.contains('reset-password-user')){ if(!confirm('Reset password for this user?')) return; try { const newPassword=Math.random().toString(36).slice(-10)+'A1!'; const res=await fetch(`${FN_BASE}/users/${id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', ...(token?{ 'Authorization':`Bearer ${token}` }:{}) }, body:JSON.stringify({ newPassword }) }); if(!res.ok) throw new Error('Failed to reset'); showToast('Temp password: '+newPassword,'success'); } catch(err){ showToast('Error: '+err.message,'error'); } return; }
                if(e.target.classList.contains('impersonate-user')){ showToast('Impersonation not implemented'); }
            });
        });

        // Mobile menu toggle
        const menuToggle=document.getElementById('menu-toggle');
        const sidebar=document.getElementById('sidebar');
        if(menuToggle && sidebar){ menuToggle.addEventListener('click', ()=>{ sidebar.classList.toggle('open'); menuToggle.setAttribute('aria-expanded', sidebar.classList.contains('open')); }); }

        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("./sw.js")
                    .then(registration => { console.log("SW registered: ", registration); })
                    .catch(registrationError => { console.log("SW registration failed: ", registrationError); });
            });
        }
    </script>
</body>
</html>
