<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>User Management</title>
    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon" href="/assets/images/logo-placeholder.svg" />
    <link rel="stylesheet" href="/assets/css/styles.css" />
    <script src="/assets/js/init-shared.js" defer></script>
    <script src="/assets/js/audit.js" defer></script>
    <script>
        // Load shared modal utilities
        fetch('shared-modals.html').then(r=>r.text()).then(html=>{const t=document.createElement('div');t.innerHTML=html;Array.from(t.children).forEach(c=>document.head.appendChild(c.cloneNode(true)));});
    </script>
    <script>
        // Purge legacy role demo key to avoid stale UI state
        try { localStorage.removeItem('currentUser'); } catch (_) {}
    </script>
  <style>
    .user-item{transition:all .2s ease;background:#111;border:1px solid #333}
    .user-item:hover{background:#181818;border-color:#00d4ff;box-shadow:0 4px 20px rgba(0,212,255,.2)}
    
    /* Stats cards */
    .stat-card {
      background: linear-gradient(135deg, #1a1a1a 0%, #111 100%);
      border: 1px solid #333;
      transition: all 0.3s ease;
    }
    .stat-card:hover {
      border-color: #00d4ff;
      box-shadow: 0 4px 20px rgba(0, 212, 255, 0.2);
      transform: translateY(-2px);
    }
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      background: linear-gradient(135deg, #00d4ff, #0080ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    /* Advanced search */
    .search-container {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 0.5rem;
      padding: 1rem;
    }
    
    /* Table enhancements */
    tbody tr {
      transition: all 0.2s ease;
    }
    tbody tr:hover {
      background: #1a1a1a;
      box-shadow: 0 2px 8px rgba(0, 212, 255, 0.1);
    }
    tbody tr.selected {
      background: rgba(0, 212, 255, 0.1);
      border-left: 3px solid #00d4ff;
    }
    
    /* Modal styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      z-index: 9998;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .modal-overlay.hidden {
      display: none;
    }
    .modal-content {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 0.5rem;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 212, 255, 0.3);
      z-index: 9999;
    }
    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-body {
      padding: 1.5rem;
    }
    .modal-close {
      background: transparent;
      border: none;
      color: #999;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.25rem;
      transition: all 0.2s;
    }
    .modal-close:hover {
      background: #333;
      color: #fff;
    }
  </style>
    <link rel="stylesheet" href="/assets/css/accessibility.css" />
    <script src="/assets/js/accessibility.js" defer></script>
</head>
    <body class="dark">
  

    <!-- MOBILE MENU TOGGLE (copied from template.html) -->
    <button id="menu-toggle" class="md:hidden fixed top-4 left-4 z-50 p-2 bg-blue-600 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400" aria-label="Toggle sidebar" aria-expanded="false">☰</button>
    <div id="sidebar-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
    <!-- Toast Notification (legacy element kept for fallback adapter; no mock toasts) -->
    <div class="flex min-h-screen">
        <!-- Shared Navigation Loader -->
        <div id="main-nav"></div>
                <!-- Main Content -->
                <main id="main-content" class="flex-1 p-4 md:p-6" role="main">
                <!-- Header Card -->
                <header class="page-header ui-card border" role="banner">
                    <div class="flex items-center justify-between gap-4">
                        <div>
                            <h1 class="text-3xl font-bold text-white">User Management</h1>
                            <p class="text-lg mt-2 text-gray-400">Manage accounts, roles and access</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button id="open-add-user" class="ui-btn ui-btn-secondary px-4 py-2 rounded">Add User</button>
                            <button id="refresh-users" class="ui-btn ui-btn-primary px-4 py-2 rounded">Refresh</button>
                        </div>
                    </div>
                </header>

        <!-- Stats Dashboard -->
        <section class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="stat-ui-card rounded-lg p-6">
                <div class="text-gray-400 text-sm mb-2">Total Users</div>
                <div class="stat-value" id="stat-total">0</div>
                <div class="text-xs text-gray-500 mt-2">All registered users</div>
            </div>
            <div class="stat-ui-card rounded-lg p-6">
                <div class="text-gray-400 text-sm mb-2">Active Users</div>
                <div class="stat-value" id="stat-active">0</div>
                <div class="text-xs text-gray-500 mt-2">Currently enabled</div>
            </div>
            <div class="stat-ui-card rounded-lg p-6">
                <div class="text-gray-400 text-sm mb-2">Admins</div>
                <div class="stat-value" id="stat-admins">0</div>
                <div class="text-xs text-gray-500 mt-2">Admin & Manager roles</div>
            </div>
            <div class="stat-ui-card rounded-lg p-6">
                <div class="text-gray-400 text-sm mb-2">Verified Emails</div>
                <div class="stat-value" id="stat-verified">0</div>
                <div class="text-xs text-gray-500 mt-2">Email confirmed</div>
            </div>
        </section>

        <section>
            <p class="text-gray-600 dark:text-gray-300 leading-relaxed mb-4">Manage user accounts and permissions. Add, edit, or remove users from the system.</p>
            
            <!-- Advanced Search & Filters -->
            <div class="search-container mb-4">
                <div class="flex items-center gap-2 mb-3">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <input id="user-search" type="text" placeholder="Search by name, email, or ID..." class="flex-1 p-2 rounded border border-gray-600 bg-gray-800 text-white text-sm focus:outline-none focus:ring-2 focus:ring-cyan-400" />
                    <button id="clear-search" class="px-3 py-2 text-sm text-gray-400 hover:text-white transition-colors">Clear</button>
                </div>
                <div class="flex flex-wrap gap-3 items-center">
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-400">Role:</label>
                        <select id="user-role-filter" class="p-2 rounded border border-gray-600 bg-gray-800 text-white text-sm focus:outline-none focus:ring-2 focus:ring-cyan-400">
                            <option value="">All Roles</option>
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                            <option value="manager">Manager</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-400">Status:</label>
                        <select id="user-status-filter" class="p-2 rounded border border-gray-600 bg-gray-800 text-white text-sm focus:outline-none focus:ring-2 focus:ring-cyan-400">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-400">Verification:</label>
                        <select id="user-verification-filter" class="p-2 rounded border border-gray-600 bg-gray-800 text-white text-sm focus:outline-none focus:ring-2 focus:ring-cyan-400">
                            <option value="">All</option>
                            <option value="verified">Verified</option>
                            <option value="unverified">Unverified</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-400">Sort:</label>
                        <select id="user-sort" class="p-2 rounded border border-gray-600 bg-gray-800 text-white text-sm focus:outline-none focus:ring-2 focus:ring-cyan-400">
                            <option value="created_at_desc">Newest First</option>
                            <option value="created_at_asc">Oldest First</option>
                            <option value="name_asc">Name A-Z</option>
                            <option value="name_desc">Name Z-A</option>
                            <option value="last_login_desc">Recent Login</option>
                        </select>
                    </div>
                    <div class="flex-1"></div>
                    <div class="text-sm text-gray-400">
                        <span id="results-count">0</span> results
                    </div>
                </div>
            </div>
            <!-- Deep-link banner (shown when focusing a specific userId) -->
            <div id="user-deeplink-banner" class="hidden mb-4 p-3 rounded border border-gray-700 bg-gray-900 text-gray-200 flex items-center justify-between">
                <div><span id="deeplink-text"></span></div>
                <button id="deeplink-clear" class="ui-btn ui-btn-primary px-3 py-1 rounded">Clear</button>
            </div>
            <!-- User Table Card (neon theme, .card + .widget-primary) -->
            <div class="ui-card ui-card-primary rounded-lg shadow-md p-6">
                <div class="overflow-x-auto">
                    <table class="w-full text-left mb-6" role="table" aria-label="User accounts table">
                        <thead>
                            <tr class="border-b-2 border-gray-300 dark:border-gray-600">
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Name</th>
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Email</th>
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Role</th>
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Status</th>
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Last Login</th>
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- User rows will be dynamically generated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <!-- Pagination Controls -->
                <div class="flex gap-2 items-center justify-end mt-2" id="user-pagination"></div>
                <!-- Add User Form (neon theme, .card + .widget-secondary) -->
                <form class="mt-6 pt-6 border-t border-gray-300 dark:border-gray-600" id="user-form" role="form" aria-label="Add new user form">
                    <h3 class="text-xl font-semibold mb-4 text-gray-100">Add New User</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <input type="text" placeholder="Name" required class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" aria-label="User name">
                        <input type="email" placeholder="Email" required class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" aria-label="User email">
                        <select required class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" aria-label="User role">
                            <option value="">Select Role</option>
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="ui-btn ui-btn-primary flex-1 p-3 rounded-lg">Add User</button>
                        <button type="button" id="cancel-edit" class="ui-btn ui-btn-secondary px-6 p-3 rounded-lg hidden">Cancel</button>
                    </div>
                </form>
            </div>
        </section>
        <!-- Bulk Operations -->
        <!-- Bulk Operations (neon theme, .card + .widget-secondary) -->
        <section class="mt-6" aria-label="Bulk operations">
            <div class="ui-card ui-card-secondary rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-100">Bulk Operations</h3>
                <div class="flex flex-wrap gap-4">
                    <button id="export-users-csv" class="ui-btn ui-btn-secondary px-4 py-2 rounded">Export Users (CSV)</button>
                    <button id="export-users-excel" class="ui-btn ui-btn-primary px-4 py-2 rounded">Export Users (Excel)</button>
                    <label for="import-users-csv" class="ui-btn ui-btn-primary px-4 py-2 rounded cursor-pointer">
                        Import Users (CSV)
                        <input type="file" id="import-users-csv" accept=".csv" class="hidden">
                    </label>
                </div>
                <div class="mt-4 text-sm text-gray-400">
                    <p><strong>CSV Format:</strong> Name,Email,Role</p>
                    <p><strong>Example:</strong> John Doe,john@example.com,user</p>
                </div>
            </div>
        </section>
    </main>
    </div>

    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="ui-modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="edit-user-title">
      <div class="modal-content">
          <div class="ui-modal-header">
          <h3 id="edit-user-title" class="text-xl font-semibold text-gray-100">Edit User</h3>
          <button class="modal-close" id="close-modal" aria-label="Close modal">&times;</button>
        </div>
        <div class="ui-modal-body">
                    <form id="edit-user-form">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Name</label>
                                <input type="text" id="edit-name" required class="w-full p-3 rounded-lg border border-gray-600 bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                                <input type="email" id="edit-email" disabled class="w-full p-3 rounded-lg border border-gray-600 bg-gray-700 text-gray-400 cursor-not-allowed" />
                            </div>
                            <div class="md:flex md:gap-4">
                                <div class="md:flex-1">
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Role</label>
                                    <select id="edit-role" required class="w-full p-3 rounded-lg border border-gray-600 bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                        <option value="">Select Role</option>
                                        <option value="user">User</option>
                                        <option value="admin">Admin</option>
                                        <option value="manager">Manager</option>
                                    </select>
                                </div>
                                <div class="md:w-40 mt-3 md:mt-0">
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="edit-active" class="mr-2" />
                                        <span class="text-sm text-gray-300">Active</span>
                                    </label>
                                    <div class="text-xs text-gray-400 mt-2" id="edit-last-login">Last login: --</div>
                                </div>
                            </div>

                            <div>
                                <button type="button" id="toggle-change-password" class="text-sm text-cyan-400 hover:underline">Change password</button>
                                <div id="change-password-section" class="mt-3 hidden">
                                    <label class="block text-sm font-medium text-gray-300 mb-2">New Password (optional)</label>
                                    <input type="password" id="edit-new-password" placeholder="Enter new password" class="w-full p-3 rounded-lg border border-gray-600 bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                                    <div class="flex items-center gap-2 mt-2">
                                        <input type="checkbox" id="edit-send-reset-email" />
                                        <label for="edit-send-reset-email" class="text-sm text-gray-400">Send password reset email</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Verification Attempts Section -->
                            <div class="border-t border-gray-700 pt-4 mt-4">
                                <button type="button" id="view-verification-attempts-btn" class="text-sm text-indigo-400 hover:underline">View verification attempts</button>
                                <div id="verification-attempts-section" class="mt-3 hidden">
                                    <div id="verification-attempts-list" class="text-sm text-gray-400">Loading...</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button type="submit" id="edit-submit" class="ui-btn ui-btn-primary flex-1 p-3 rounded-lg">Update User</button>
                            <button type="button" id="cancel-modal" class="ui-btn ui-btn-secondary px-6 p-3 rounded-lg">Cancel</button>
                        </div>
                    </form>
                </div>
      </div>
    </div>

    <script>
    // Serverless base path and auth token helper (computed in init-shared.js)
    const FN_BASE = window.FN_BASE || '/.netlify/functions';
    const AUTH_DISABLED = window.AUTH_DISABLED === true;
    const usersState = { list: [], pagination: { page:1, limit:10, total:0, pages:1 }, filters: { search:'', role:'', status:'', sort:'created_at_desc' }, editingId: null, loading: false };

        function loadAndApplySettings() {
            const settings = JSON.parse(localStorage.getItem('siteSettings')) || {};
            if (settings['site-title']) {
                document.querySelectorAll('h1').forEach(el => {
                    if (el.textContent.includes("Josh's App")) el.textContent = settings['site-title'];
                });
            }
        }

        class AuditLogger { static log(action, details, userId='admin') { const logs = JSON.parse(localStorage.getItem('auditLogs')||'[]'); const entry={ id:Date.now(), timestamp:new Date().toISOString(), userId, action, details, ip:'localhost' }; logs.unshift(entry); if (logs.length>1000) logs.splice(1000); localStorage.setItem('auditLogs', JSON.stringify(logs)); window.dispatchEvent(new CustomEvent('auditLogUpdated',{ detail:entry })); } }

async function loadUsers(page = 1) {
            try {
        if (usersState.loading) return; usersState.loading = true;
                const { limit, filters } = { limit: usersState.pagination.limit, filters: usersState.filters };
                const params = new URLSearchParams({ page, limit, search:filters.search, role:filters.role, status:filters.status, sort:filters.sort });

                // Use authFetch which handles token refresh automatically
                const res = window.authFetch 
                    ? await window.authFetch(`${FN_BASE}/users?${params.toString()}`)
                    : await fetch(`${FN_BASE}/users?${params.toString()}`, { 
                        headers: { 'Authorization': `Bearer ${(window.getToken && window.getToken()) || ''}` }
                      });

                // If forbidden, do not redirect to login; show message and stop
                if (res.status === 403 && !AUTH_DISABLED) {
                    showToast('Access denied: you do not have permission to view users.', 'error');
                    usersState.list = [];
                    renderUsers();
                    return;
                }

                // Any other error is now handled by ensureSessionAndRole or is a server error.
                if (!res.ok) throw new Error('Failed to load users (status '+res.status+')');
                const data = await res.json();
                usersState.list = data.users || [];
                usersState.pagination = data.pagination || { page:1, limit:limit, total:usersState.list.length, pages:1 };
                renderUsers();
                updateStats();
            } catch(err){
                console.error('loadUsers', err);
                showToast('Error loading users: '+(err.message||'Network error'),'error');
                usersState.list=[]; renderUsers();
            } finally { usersState.loading = false; }
        }

        // Update statistics dashboard
        function updateStats() {
            try {
                const total = usersState.pagination.total || usersState.list.length;
                const active = usersState.list.filter(u => u.is_active).length;
                const admins = usersState.list.filter(u => ['admin', 'manager'].includes(u.role)).length;
                const verified = usersState.list.filter(u => u.email_verified).length;
                
                document.getElementById('stat-total').textContent = total;
                document.getElementById('stat-active').textContent = active;
                document.getElementById('stat-admins').textContent = admins;
                document.getElementById('stat-verified').textContent = verified;
            } catch(e) {
                console.error('Error updating stats:', e);
            }
        }

        function renderUsers(){
            const tbody = document.querySelector('tbody');
            tbody.innerHTML='';
            
            // Update results count
            const resultsCount = document.getElementById('results-count');
            if (resultsCount) resultsCount.textContent = usersState.pagination.total || usersState.list.length;
            
            usersState.list.forEach(u => {
                const tr = document.createElement('tr');
                tr.className='border-b border-gray-700';
                tr.dataset.userId = String(u.id);
                tr.id = `user-row-${u.id}`;
                const avatar = u.avatar_url ? `<img src="${u.avatar_url}" class="inline w-8 h-8 rounded-full mr-2"/>` : `<span class="inline-block w-8 h-8 rounded-full bg-gray-600 mr-2"></span>`;
                const status = u.is_active ? '<span class="text-green-400">Active</span>' : '<span class="text-red-400">Inactive</span>';
                const emailVerified = u.email_verified ? '<span class="text-green-400 text-xs">✓ Verified</span>' : '<span class="text-yellow-400 text-xs">⚠ Unverified</span>';
                const lastLogin = u.last_login ? new Date(u.last_login).toLocaleString() : '--';
                tr.innerHTML = `
                    <td class="py-2 px-3 flex items-center">${avatar}<a href="profile.html?user_id=${u.id}" class="text-blue-400 hover:underline">${u.name}</a></td>
                    <td class="py-2 px-3">${u.email}<br/>${emailVerified}</td>
                    <td class="py-2 px-3">${u.role.charAt(0).toUpperCase()+u.role.slice(1)}</td>
                    <td class="py-2 px-3">${status}</td>
                    <td class="py-2 px-3">${lastLogin}</td>
                    <td class="py-2 px-3">
                        <button class="px-2 py-1 bg-cyan-500 text-white rounded mr-2 hover:bg-cyan-600 focus:outline-none focus:ring-2 focus:ring-cyan-400 edit-user" data-id="${u.id}">Edit</button>
                        ${!u.email_verified ? `<button class="px-2 py-1 bg-purple-500 text-white rounded mr-2 hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-400 verify-email-user" data-id="${u.id}" data-email="${u.email}">Verify Email</button>` : ''}
                        <button class="px-2 py-1 bg-red-500 text-white rounded mr-2 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 delete-user" data-id="${u.id}">Delete</button>
                        <button class="px-2 py-1 bg-yellow-500 text-white rounded mr-2 hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 lock-user" data-id="${u.id}">${u.is_active ? 'Lock':'Unlock'}</button>
                        <button class="px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 reset-password-user" data-id="${u.id}">Reset PW</button>
                    </td>`;
                tbody.appendChild(tr);
            });
            const pagDiv = document.getElementById('user-pagination');
            const { page, pages } = usersState.pagination; pagDiv.innerHTML='';
            if (pages>1){ for(let i=1;i<=pages;i++){ const b=document.createElement('button'); b.textContent=i; b.className='px-2 py-1 rounded '+(i===page?'bg-primary text-white':'bg-gray-700 text-gray-300 hover:bg-gray-600'); b.onclick=()=>loadUsers(i); pagDiv.appendChild(b);} }
        }
        // Highlight a specific row (used for deep-links)
        function highlightUserRow(userId){
            try {
                const row = document.getElementById(`user-row-${userId}`);
                if (!row) return false;
                row.classList.add('ring-2','ring-cyan-400','ring-offset-2','ring-offset-gray-900');
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => { row.classList.remove('ring-2','ring-cyan-400','ring-offset-2','ring-offset-gray-900'); }, 5000);
                return true;
            } catch (_) { return false; }
        }

        // Show a banner indicating deep-linked user view with a clear option
        function showDeeplinkBanner(user){
            const banner = document.getElementById('user-deeplink-banner');
            const text = document.getElementById('deeplink-text');
            const clearBtn = document.getElementById('deeplink-clear');
            if (!banner || !text || !clearBtn) return;
            text.textContent = `Focusing on user #${user.id} (${user.name || user.email || 'unknown'})`;
            banner.classList.remove('hidden');
            clearBtn.onclick = () => {
                banner.classList.add('hidden');
                // Reset filters and reload full list
                usersState.filters.search = '';
                document.getElementById('user-search').value = '';
                loadUsers(1);
                // Also remove the query param from URL without reloading
                try {
                    const url = new URL(window.location.href);
                    url.searchParams.delete('userId');
                    url.searchParams.delete('user_id');
                    window.history.replaceState({}, '', url.toString());
                } catch(_){ /* noop */ }
            };
        }
    // Toast adapter now handled globally via window.showToast -> window.showNotification

        // Show sign-in CTA instead of auto-redirecting
        function showSignInCTA(message) {
            try {
                const main = document.querySelector('main');
                if (!main) return;
                // Hide interactive sections while unauthenticated
                const sections = main.querySelectorAll('section');
                sections.forEach(s => s.classList.add('hidden'));
                // Create CTA once
                let cta = document.getElementById('signin-cta');
                if (!cta) {
                    cta = document.createElement('div');
                    cta.id = 'signin-cta';
                    cta.className = 'mt-6 p-6 border border-gray-700 rounded-lg text-center';
                    const msg = document.createElement('p');
                    msg.className = 'mb-4 text-gray-300';
                    msg.textContent = message || 'Please sign in to view and manage users.';
                    const btn = document.createElement('button');
                    btn.id = 'go-to-login';
                    btn.className = 'ui-btn ui-btn-primary px-4 py-2 rounded';
                    btn.textContent = 'Sign in';
                    btn.addEventListener('click', () => {
                        const returnUrl = encodeURIComponent(window.location.pathname + window.location.search);
                        window.location.href = `login.html?message=login-required&returnUrl=${returnUrl}`;
                    });
                    cta.appendChild(msg);
                    cta.appendChild(btn);
                    main.appendChild(cta);
                } else {
                    const p = cta.querySelector('p');
                    if (p) p.textContent = message || 'Please sign in to view and manage users.';
                }
                // Ensure visible
                cta.classList.remove('hidden');
            } catch (_) { /* noop */ }
        }

        // Verify session and role before loading users to avoid 401 loops
        async function ensureSessionAndRole(){
            if (AUTH_DISABLED) return true;
            
            // First check if we have any tokens at all
            const token = (window.getToken && window.getToken()) || null;
            const refreshToken = (window.getRefreshToken && window.getRefreshToken()) || null;
            
            if (!token && !refreshToken) { 
                showSignInCTA('Please sign in to view and manage users.'); 
                return false; 
            }
            
            if (!token) {
                showSignInCTA('Session expired. Please sign in again.');
                return false;
            }
            
            try {
                const res = await fetch(`${FN_BASE}/auth?action=me`, { headers: { 'Authorization': `Bearer ${token}` }});
                if (!res.ok) {
                    // Token is invalid - clear session and show sign-in CTA
                    try{localStorage.removeItem('accessToken');localStorage.removeItem('refreshToken');localStorage.removeItem('user');localStorage.removeItem('currentUser');}catch(_){}
                    let msg = 'Session expired. Please sign in again.';
                    try { const body = await res.json(); if (body && body.error) { msg = body.error + '. Please sign in again.'; } } catch(_){}
                    showSignInCTA(msg);
                    return false;
                }
                const me = await res.json();
                if (me && me.user) {
                    try { localStorage.setItem('user', JSON.stringify(me.user)); localStorage.setItem('currentUser', JSON.stringify({ name: me.user.name || me.user.email || 'User', role: me.user.role || 'user', email: me.user.email })); } catch(_) {}
                    if (['admin','manager'].includes(me.user.role)) return true;
                    showToast('Access denied: you do not have permission to view users.','error');
                    return false;
                }
                // me was OK but no user field -> treat as invalid session
                try{localStorage.removeItem('accessToken');localStorage.removeItem('refreshToken');localStorage.removeItem('user');localStorage.removeItem('currentUser');}catch(_){}
                showSignInCTA('Account not found. Please sign in again.');
                return false;
            } catch(_) { 
                showSignInCTA('Unable to verify session. Please sign in.');
                return false; 
            }
        }

        // Add or update user via backend API
        async function addOrUpdateUser(e){
            e.preventDefault();
            const form = e.target;
            const name = form.querySelector('input[type="text"]').value.trim();
            const email = form.querySelector('input[type="email"]').value.trim();
            const role = form.querySelector('select').value;
            const token = (window.getToken && window.getToken()) || null;
            if(!name||!email||!role){ showToast('Please fill in all fields'); return; }
            try {
                const password = Math.random().toString(36).slice(-10)+'A1!';
                const res = await fetch(`${FN_BASE}/users`, { method:'POST', headers:{ 'Content-Type':'application/json', ...(token?{ 'Authorization':`Bearer ${token}` }:{}) }, body:JSON.stringify({ name,email,role,password }) });
                if(!res.ok){ const err=await res.json().catch(()=>({})); throw new Error(err.error||'Failed to add user'); }
                showToast('User added','success');
                form.reset();
                await loadUsers(1);
            } catch(err){ showToast('Error: '+err.message,'error'); }
        }

        // Update user from modal
        async function updateUserFromModal(e){
            e.preventDefault();
            const submitBtn = document.getElementById('edit-submit');
            const cancelBtn = document.getElementById('cancel-modal');
            const name = document.getElementById('edit-name').value.trim();
            const role = document.getElementById('edit-role').value;
            const isActive = !!document.getElementById('edit-active').checked;
            const newPassword = document.getElementById('edit-new-password').value.trim();
            const sendResetEmail = !!document.getElementById('edit-send-reset-email').checked;
            const token = (window.getToken && window.getToken()) || null;
            if(!name||!role){ showToast('Please fill in all fields'); return; }
            if(!usersState.editingId){ showToast('No user selected for editing','error'); return; }
            try {
                // Disable buttons to prevent double submit
                if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Saving...'; }
                if (cancelBtn) cancelBtn.disabled = true;

                const body = { name, role, is_active: isActive };
                if (newPassword) {
                    // include newPassword if provided
                    body.newPassword = newPassword;
                    // optionally include flag to send reset email
                    if (sendResetEmail) body.sendResetEmail = true;
                }

                const res = await fetch(`${FN_BASE}/users/${usersState.editingId}`, { method:'PUT', headers:{ 'Content-Type':'application/json', ...(token?{ 'Authorization':`Bearer ${token}` }:{}) }, body:JSON.stringify(body) });
                if(!res.ok){
                    const err = await res.json().catch(()=>({}));
                    throw new Error(err.error || 'Failed to update user');
                }
                showToast('User updated','success');
                closeEditModal();
                await loadUsers(usersState.pagination.page || 1);
            } catch(err){ showToast('Error: '+err.message,'error'); }
            finally {
                if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Update User'; }
                if (cancelBtn) cancelBtn.disabled = false;
            }
        }

        // Open edit modal
        function openEditModal(id){ 
            const u=usersState.list.find(x=>x.id===id); 
            if(!u) return; 
            document.getElementById('edit-name').value = u.name || '';
            document.getElementById('edit-email').value = u.email || '';
            document.getElementById('edit-role').value = u.role || '';
            document.getElementById('edit-active').checked = !!u.is_active;
            // show last login if available
            const lastLoginElem = document.getElementById('edit-last-login');
            if (lastLoginElem) lastLoginElem.textContent = 'Last login: ' + (u.last_login ? new Date(u.last_login).toLocaleString() : '--');
            // reset change-password section
            document.getElementById('change-password-section').classList.add('hidden');
            document.getElementById('edit-new-password').value = '';
            document.getElementById('edit-send-reset-email').checked = false;
            // reset verification attempts section
            const verifySec = document.getElementById('verification-attempts-section');
            if (verifySec) verifySec.classList.add('hidden');
            const verifyList = document.getElementById('verification-attempts-list');
            if (verifyList) verifyList.innerHTML = '';

            usersState.editingId=id; 
            document.getElementById('edit-user-modal').classList.remove('hidden');
            // Focus the name field
            setTimeout(() => document.getElementById('edit-name').focus(), 100);
        }

        // Close edit modal
        function closeEditModal(){ 
            usersState.editingId=null; 
            const modal = document.getElementById('edit-user-modal');
            if (modal) modal.classList.add('hidden');
            // Clear and reset fields
            const form = document.getElementById('edit-user-form');
            if (form) {
                try { form.reset(); } catch(_){}
            }
            const changeSection = document.getElementById('change-password-section');
            if (changeSection) changeSection.classList.add('hidden');
            const lastLoginElem = document.getElementById('edit-last-login');
            if (lastLoginElem) lastLoginElem.textContent = 'Last login: --';
        }

        // Edit user (deprecated - now opens modal)
        function editUser(id){ openEditModal(id); }

        // Delete user via backend API
    async function deleteUser(id){ 
        const user = usersState.list.find(u => u.id == id);
        const userName = user ? (user.name || user.email) : 'this user';
        let confirmed = false;
        if (window.ModalUtils && window.ModalUtils.confirm) {
            confirmed = await window.ModalUtils.confirm({
                title: 'Delete User',
                message: `Are you sure you want to delete ${userName}? This action cannot be undone.`,
                confirmText: 'Delete',
                cancelText: 'Cancel',
                type: 'danger'
            });
        } else {
            confirmed = confirm(`Are you sure you want to delete ${userName}? This action cannot be undone.`);
        }
        if(!confirmed) return; 
        const token=(window.getToken && window.getToken()) || null; 
        try { 
            const res=await fetch(`${FN_BASE}/users/${id}`, { method:'DELETE', headers: token?{ 'Authorization':`Bearer ${token}` }:{} }); 
            if(!res.ok) throw new Error('Failed to delete user'); 
            showToast('User deleted','success'); 
            await loadUsers(1); 
        } catch(err){ 
            showToast('Error: '+err.message,'error'); 
        } 
    }

        // Cancel edit
        function cancelEdit(){ usersState.editingId=null; const form=document.getElementById('user-form'); form.reset(); form.querySelector('button[type="submit"]').textContent='Add User'; form.querySelector('h3').textContent='Add New User'; document.getElementById('cancel-edit').classList.add('hidden'); }

        // Export users to CSV via backend API
    async function exportUsersCSV(){ const token=(window.getToken && window.getToken()) || null; try { const res=await fetch(`${FN_BASE}/users?limit=1000`, { headers: token?{ 'Authorization':`Bearer ${token}` }:{} }); if(!res.ok) throw new Error('Failed to fetch users'); const data=await res.json(); const headers=['Name','Email','Role']; const csv=[ headers.join(','), ...(data.users||[]).map(u=>`"${u.name}","${u.email}","${u.role}"`) ].join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='users.csv'; a.click(); URL.revokeObjectURL(url); showToast('Exported CSV','success'); } catch(err){ showToast('Error: '+err.message,'error'); } }

        // Export users to Excel (tab-separated) via backend API
    async function exportUsersExcel(){ const token=(window.getToken && window.getToken()) || null; try { const res=await fetch(`${FN_BASE}/users?limit=1000`, { headers: token?{ 'Authorization':`Bearer ${token}` }:{} }); if(!res.ok) throw new Error('Failed to fetch users'); const data=await res.json(); const headers=['Name','Email','Role']; const tsv=[ headers.join('\t'), ...(data.users||[]).map(u=>[u.name,u.email,u.role].join('\t')) ].join('\n'); const blob=new Blob([tsv],{type:'application/vnd.ms-excel'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='users.xls'; a.click(); URL.revokeObjectURL(url); showToast('Exported Excel','success'); } catch(err){ showToast('Error: '+err.message,'error'); } }

        // Import users from CSV via backend API
    async function importUsersCSV(evt){ const file=evt.target.files[0]; if(!file) return; const token=(window.getToken && window.getToken()) || null; const reader=new FileReader(); reader.onload=async e=>{ try { const lines=e.target.result.split('\n'); const start = lines[0].toLowerCase().includes('name')?1:0; let imported=0; for(let i=start;i<lines.length;i++){ const line=lines[i].trim(); if(!line) continue; const parts=line.split(',').map(f=>f.replace(/^\"|\"$/g,'').trim()); if(parts.length<3) continue; const [name,email,roleRaw]=parts; const role=roleRaw.toLowerCase(); const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/; if(!emailRegex.test(email)) continue; if(!['user','admin','manager'].includes(role)) continue; const password=Math.random().toString(36).slice(-10)+'A1!'; const res=await fetch(`${FN_BASE}/users`, { method:'POST', headers:{ 'Content-Type':'application/json', ...(token?{ 'Authorization':`Bearer ${token}` }:{}) }, body:JSON.stringify({ name,email,role,password }) }); if(res.ok) imported++; }
            await loadUsers(1); showToast(imported+' users imported','success'); } catch(err){ showToast('Import error: '+err.message,'error'); } }; reader.readAsText(file); evt.target.value=''; }

        // Event wiring
    document.addEventListener('DOMContentLoaded', async () => {
            // Parse deep-link id (?userId= or ?user_id=)
            let deepLinkId = null;
            try {
                const url = new URL(window.location.href);
                const idParam = url.searchParams.get('userId') || url.searchParams.get('user_id');
                if (idParam && /^[0-9]+$/.test(idParam)) deepLinkId = parseInt(idParam, 10);
            } catch(_) { /* noop */ }
            
            // Wait a moment for init-shared.js session bootstrap to complete any token refresh
            await new Promise(resolve => setTimeout(resolve, 200));
            
            // Require authentication and proper role before loading content
            const allowed = await ensureSessionAndRole();
            if (!allowed) return;

                        // Listen for global auth required events and show CTA instead of redirect
                        try {
                            window.addEventListener('auth:required', (ev) => {
                                try { showSignInCTA(); } catch(_){}
                                // Return false to signal that the event was not handled if we want fallback redirect
                                return true;
                            });
                        } catch(e) { /* noop */ }
            if (typeof AuditLogger !== 'undefined') { AuditLogger.log('page_access','Accessed User Management page'); }
            // Load users and handle deep-link focus
            (async () => {
                // Pass the token from ensureSessionAndRole directly to the first load
                await loadUsers(1);
                if (deepLinkId) {
                    // If the user is already in the rendered list, highlight and banner
                    if (highlightUserRow(deepLinkId)) {
                        const found = usersState.list.find(u => u.id === deepLinkId);
                        if (found) showDeeplinkBanner(found);
                    } else {
                        // Fetch the specific user and render a focused view
                        try {
                            const token = (window.getToken && window.getToken()) || null;
                            const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                            const res = await fetch(`${FN_BASE}/users/${deepLinkId}`, { headers });
                            if (res.ok) {
                                const data = await res.json();
                                if (data && data.user) {
                                    usersState.list = [data.user];
                                    usersState.pagination = { page:1, limit:1, total:1, pages:1 };
                                    renderUsers();
                                    highlightUserRow(deepLinkId);
                                    showDeeplinkBanner(data.user);
                                }
                            }
                        } catch(_) { /* ignore */ }
                    }
                }
            })();
            loadAndApplySettings();
            document.getElementById('user-form').addEventListener('submit', addOrUpdateUser);
            document.getElementById('cancel-edit').addEventListener('click', cancelEdit);
            
            // Modal event listeners
            document.getElementById('edit-user-form').addEventListener('submit', updateUserFromModal);
            document.getElementById('close-modal').addEventListener('click', closeEditModal);
            document.getElementById('cancel-modal').addEventListener('click', closeEditModal);
            // Toggle change-password section inside modal
            const togglePwd = document.getElementById('toggle-change-password');
            if (togglePwd) togglePwd.addEventListener('click', () => {
                const sec = document.getElementById('change-password-section');
                if (!sec) return;
                const visible = !sec.classList.contains('hidden');
                if (visible) {
                    sec.classList.add('hidden');
                } else {
                    sec.classList.remove('hidden');
                    // focus new password input
                    setTimeout(() => { const np = document.getElementById('edit-new-password'); if (np) np.focus(); }, 50);
                }
            });
            
            // Toggle verification attempts section inside modal
            const toggleVerifyAttempts = document.getElementById('view-verification-attempts-btn');
            if (toggleVerifyAttempts) toggleVerifyAttempts.addEventListener('click', async () => {
                const sec = document.getElementById('verification-attempts-section');
                const list = document.getElementById('verification-attempts-list');
                if (!sec || !list) return;
                const visible = !sec.classList.contains('hidden');
                if (visible) {
                    sec.classList.add('hidden');
                } else {
                    sec.classList.remove('hidden');
                    list.innerHTML = '<p class="text-gray-400">Loading...</p>';
                    
                    // Fetch verification attempts for the editing user
                    if (!usersState.editingId) {
                        list.innerHTML = '<p class="text-red-400">No user selected</p>';
                        return;
                    }
                    
                    try {
                        const token = (window.getToken && window.getToken()) || null;
                        const res = await fetch(`${FN_BASE}/users/${usersState.editingId}/verification-attempts`, {
                            headers: { ...(token ? { 'Authorization': `Bearer ${token}` } : {}) }
                        });
                        if (!res.ok) {
                            const err = await res.json().catch(() => ({}));
                            throw new Error(err.error || 'Failed to fetch attempts');
                        }
                        const data = await res.json();
                        const attempts = data.attempts || [];
                        
                        if (attempts.length === 0) {
                            list.innerHTML = '<p class="text-gray-400">No verification attempts found</p>';
                        } else {
                            list.innerHTML = `
                                <div class="space-y-3 max-h-48 overflow-y-auto">
                                    ${attempts.map(a => `
                                        <div class="p-3 rounded border ${a.success ? 'border-green-700 bg-green-900/20' : 'border-red-700 bg-red-900/20'}">
                                            <div class="flex items-center justify-between mb-2">
                                                <span class="font-semibold text-xs">${a.attempt_type.replace(/_/g, ' ').toUpperCase()}</span>
                                                <span class="text-xs ${a.success ? 'text-green-400' : 'text-red-400'}">${a.success ? '✓ Success' : '✗ Failed'}</span>
                                            </div>
                                            <div class="text-xs text-gray-400 space-y-1">
                                                <div>IP: ${a.ip_address || 'N/A'}</div>
                                                <div>Time: ${new Date(a.created_at).toLocaleString()}</div>
                                                ${a.error_message ? `<div class="text-red-400">Error: ${a.error_message}</div>` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }
                    } catch (err) {
                        list.innerHTML = `<p class="text-red-400">Error: ${err.message}</p>`;
                    }
                }
            });
            
            // Close modal when clicking outside
            document.getElementById('edit-user-modal').addEventListener('click', (e) => {
                if (e.target.id === 'edit-user-modal') closeEditModal();
            });
            // Close modal with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !document.getElementById('edit-user-modal').classList.contains('hidden')) {
                    closeEditModal();
                }
            });
            
            // Header actions
            const refreshBtn = document.getElementById('refresh-users');
            if (refreshBtn) refreshBtn.addEventListener('click', ()=> loadUsers(usersState.pagination.page || 1));
            const openAddBtn = document.getElementById('open-add-user');
            if (openAddBtn) openAddBtn.addEventListener('click', ()=> { try { cancelEdit(); } catch(_){} document.getElementById('user-form')?.scrollIntoView({ behavior:'smooth', block:'start' }); });
            document.getElementById('export-users-csv').addEventListener('click', exportUsersCSV);
            document.getElementById('export-users-excel').addEventListener('click', exportUsersExcel);
            document.getElementById('import-users-csv').addEventListener('change', importUsersCSV);
            let filterDebounce = null;
            document.getElementById('user-search').addEventListener('input', e => {
                usersState.filters.search=e.target.value;
                if (filterDebounce) clearTimeout(filterDebounce);
                filterDebounce = setTimeout(()=> loadUsers(1), 250);
            });
            document.getElementById('clear-search').addEventListener('click', () => {
                document.getElementById('user-search').value = '';
                usersState.filters.search = '';
                loadUsers(1);
            });
            document.getElementById('user-role-filter').addEventListener('change', e => { usersState.filters.role=e.target.value; loadUsers(1); });
            document.getElementById('user-status-filter').addEventListener('change', e => { usersState.filters.status=e.target.value; loadUsers(1); });
            document.getElementById('user-verification-filter').addEventListener('change', e => { usersState.filters.verification=e.target.value; loadUsers(1); });
            document.getElementById('user-sort').addEventListener('change', e => { usersState.filters.sort=e.target.value; loadUsers(1); });
            const tbody=document.querySelector('tbody');
            tbody.addEventListener('click', async e => {
                const id=e.target.dataset.id; if(!id) return;
                if(e.target.classList.contains('edit-user')) { editUser(parseInt(id)); return; }
                if(e.target.classList.contains('delete-user')) { deleteUser(parseInt(id)); return; }
                const token=(window.getToken && window.getToken()) || null;
                if(e.target.classList.contains('lock-user')){ const u=usersState.list.find(x=>x.id==id); if(!u) return; try { const res=await fetch(`${FN_BASE}/users/${id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', ...(token?{ 'Authorization':`Bearer ${token}` }:{}) }, body:JSON.stringify({ is_active: !u.is_active }) }); if(!res.ok) throw new Error('Failed to update'); showToast(u.is_active?'User locked':'User unlocked','success'); await loadUsers(usersState.pagination.page); } catch(err){ showToast('Error: '+err.message,'error'); } return; }
                if(e.target.classList.contains('reset-password-user')){ 
                    const user = usersState.list.find(u => u.id == id);
                    const userName = user ? (user.name || user.email) : 'this user';
                    let confirmed = false;
                    if (window.ModalUtils && window.ModalUtils.confirm) {
                        confirmed = await window.ModalUtils.confirm({
                            title: 'Reset Password',
                            message: `Reset password for ${userName}? A temporary password will be generated.`,
                            confirmText: 'Reset',
                            cancelText: 'Cancel',
                            type: 'warning'
                        });
                    } else {
                        confirmed = confirm(`Reset password for ${userName}? A temporary password will be generated.`);
                    }
                    if(!confirmed) return;
                    try { 
                        const newPassword=Math.random().toString(36).slice(-10)+'A1!'; 
                        const res=await fetch(`${FN_BASE}/users/${id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', ...(token?{ 'Authorization':`Bearer ${token}` }:{}) }, body:JSON.stringify({ newPassword }) }); 
                        if(!res.ok) throw new Error('Failed to reset'); 
                        if (window.ModalUtils && window.ModalUtils.alert) {
                            await window.ModalUtils.alert({
                                title: 'Password Reset',
                                message: `Temporary password for ${userName}:\n\n${newPassword}\n\nPlease save this password and share it securely with the user.`,
                                type: 'success'
                            });
                        } else {
                            alert(`Temporary password for ${userName}:\n\n${newPassword}\n\nPlease save this password and share it securely with the user.`);
                        }
                    } catch(err){ 
                        showToast('Error: '+err.message,'error'); 
                    } 
                    return; 
                }
                if(e.target.classList.contains('verify-email-user')){
                    const user = usersState.list.find(u => u.id == id);
                    const userEmail = user ? user.email : e.target.dataset.email;
                    const userName = user ? (user.name || user.email) : 'this user';
                    let confirmed = false;
                    if (window.ModalUtils && window.ModalUtils.confirm) {
                        confirmed = await window.ModalUtils.confirm({
                            title: 'Manually Verify Email',
                            message: `Manually verify email for ${userName} (${userEmail})? This will mark their email as verified without requiring them to click a link.`,
                            confirmText: 'Verify Email',
                            cancelText: 'Cancel',
                            type: 'info'
                        });
                    } else {
                        confirmed = confirm(`Manually verify email for ${userName} (${userEmail})?`);
                    }
                    if(!confirmed) return;
                    try {
                        const res = await fetch(`${FN_BASE}/users/${id}/verify-email`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                            }
                        });
                        if(!res.ok) {
                            const err = await res.json().catch(() => ({}));
                            throw new Error(err.error || 'Failed to verify email');
                        }
                        showToast(`Email verified for ${userName}`, 'success');
                        await loadUsers(usersState.pagination.page);
                    } catch(err) {
                        showToast('Error: ' + err.message, 'error');
                    }
                    return;
                }
            });
        });

        // Mobile menu toggle
        const menuToggle=document.getElementById('menu-toggle');
        const sidebar=document.getElementById('sidebar');
        if(menuToggle && sidebar){ menuToggle.addEventListener('click', ()=>{ sidebar.classList.toggle('open'); menuToggle.setAttribute('aria-expanded', sidebar.classList.contains('open')); }); }

        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("./sw.js")
                    .then(registration => { console.log("SW registered: ", registration); })
                    .catch(registrationError => { console.log("SW registration failed: ", registrationError); });
            });
        }
    </script>
</body>
</html>
