<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management</title>
    
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="./manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-title" content="JoshBurt.com.au">
    <link rel="apple-touch-icon" href="./assets/images/logo-placeholder.svg">
    
    <link rel="stylesheet" href="./assets/css/styles.css">

        <!-- Load shared config and theme system -->
        <script>
            fetch('shared-config.html').then(r => r.text()).then(html => {
                const temp = document.createElement('div');
                temp.innerHTML = html;
                Array.from(temp.children).forEach(child => {
                    if (child.tagName === 'LINK' || child.tagName === 'STYLE' || child.tagName === 'SCRIPT') {
                        document.head.appendChild(child.cloneNode(true));
                    }
                });
            });
            fetch('shared-theme.html').then(r => r.text()).then(html => {
                const temp = document.createElement('div');
                temp.innerHTML = html;
                Array.from(temp.children).forEach(child => {
                    if (child.tagName === 'SCRIPT') {
                        document.head.appendChild(child.cloneNode(true));
                    }
                });
            });
        </script>
    <script>
        // Configuration for dynamic color updates from settings
        function applyDynamicColors() {
            const settingsHead = JSON.parse(localStorage.getItem('siteSettings')) || {};
            // Apply CSS variables for instant color update
            document.documentElement.style.setProperty('--tw-color-primary', settingsHead.primaryColor || '#3b82f6');
            document.documentElement.style.setProperty('--tw-color-secondary', settingsHead.secondaryColor || '#10b981');
            document.documentElement.style.setProperty('--tw-color-accent', settingsHead.accentColor || '#8b5cf6');
        }
        applyDynamicColors();
        // Service Worker Registration for PWA
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("./sw.js")
                    .then(registration => {
                        console.log("SW registered: ", registration);
                    })
                    .catch(registrationError => {
                        console.log("SW registration failed: ", registrationError);
                    });
            });
        }
    </script>
    <style>
        body {
            transition: background-color 0.3s, color 0.3s;
            font-family: 'Inter', 'system-ui', '-apple-system', sans-serif;
            background-color: #0a0a0a;
            color: #ffffff;
        }
        .dark {
            background-color: #0a0a0a;
            color: #ffffff;
        }
        .light {
            background-color: #f9fafb;
            color: #1f2937;
        }
        .sidebar {
            width: 16rem;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            overflow-y: auto;
            transition: background-color 0.3s;
            z-index: 100;
            background-color: #111111;
            border-right: 1px solid #00d4ff20;
        }
        main {
            margin-left: 16rem;
            min-height: 100vh;
            background-color: #0a0a0a;
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
            }
            .sidebar.open {
                transform: translateX(0);
            }
            main {
                margin-left: 0;
            }
        }
        .user-item {
            transition: all 0.2s ease;
            background-color: #111111;
            border: 1px solid #333333;
        }
        .user-item:hover {
            background-color: #181818;
            border-color: #00d4ff;
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.2);
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        .focus\:not-sr-only:focus {
            position: static;
            width: auto;
            height: auto;
            padding: 0.5rem;
            margin: 0;
            overflow: visible;
            clip: auto;
            white-space: normal;
        }
        @media print {
            .sidebar, .no-print { display: none !important; }
            main { margin-left: 0 !important; }
            body { background: white !important; color: black !important; }
        }

        /* Neon button styles */
        .btn-neon-blue {
            background: linear-gradient(45deg, #00d4ff, #0099cc);
            border: 1px solid #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
            color: #000000;
            font-weight: 600;
        }
        .btn-neon-blue:hover {
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.6);
            background: linear-gradient(45deg, #00eeff, #00b8e6);
        }
        .btn-neon-green {
            background: linear-gradient(45deg, #00ff88, #00cc66);
            border: 1px solid #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
            color: #000000;
            font-weight: 600;
        }
        .btn-neon-green:hover {
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.6);
            background: linear-gradient(45deg, #00ff99, #00dd77);
        }

        /* Navigation link styling */
        .nav-link {
            color: #cccccc;
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            color: #00d4ff;
            text-shadow: 0 0 8px rgba(0, 212, 255, 0.6);
        }
        .nav-link.active {
            color: #00d4ff;
            background-color: #00d4ff20;
            border-left: 3px solid #00d4ff;
        }
    </style>

    </head>
    <body class="dark">
    <!-- MOBILE MENU TOGGLE (copied from template.html) -->
    <button id="menu-toggle" class="md:hidden fixed top-4 left-4 z-50 p-2 bg-primary text-white rounded-md focus:outline-none focus:ring-2 focus:ring-secondary" aria-label="Toggle sidebar" aria-expanded="false">â˜°</button>
    <div id="sidebar-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
    <div class="flex min-h-screen">
        <!-- Shared Navigation Loader -->
        <div id="main-nav"></div>
        <script>
          // Dynamically load shared navigation
          fetch('shared-nav.html')
            .then(response => response.text())
            .then(html => {
              document.getElementById('main-nav').innerHTML = html;
            });
        </script>
        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-6 ml-64 md:ml-0">
        <section>
            <p class="text-gray-600 dark:text-gray-300 leading-relaxed">Manage user accounts and permissions. Add, edit, or remove users from the system.</p>
            <!-- User Filters/Search/Sort -->
            <div class="flex flex-wrap gap-4 items-center mb-4">
                <input id="user-search" type="text" placeholder="Search name or email..." class="p-2 rounded border border-gray-400 dark:border-gray-600 bg-gray-900 text-white text-sm" style="min-width:180px;" />
                <select id="user-role-filter" class="p-2 rounded border border-gray-400 dark:border-gray-600 bg-gray-900 text-white text-sm">
                    <option value="">All Roles</option>
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                    <option value="manager">Manager</option>
                </select>
                <select id="user-status-filter" class="p-2 rounded border border-gray-400 dark:border-gray-600 bg-gray-900 text-white text-sm">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
                <select id="user-sort" class="p-2 rounded border border-gray-400 dark:border-gray-600 bg-gray-900 text-white text-sm">
                    <option value="created_at_desc">Newest</option>
                    <option value="created_at_asc">Oldest</option>
                    <option value="name_asc">Name A-Z</option>
                    <option value="name_desc">Name Z-A</option>
                </select>
            </div>
            <!-- User Table Card (neon theme, .card + .widget-primary) -->
            <div class="card widget-primary rounded-lg shadow-md p-6">
                <div class="overflow-x-auto">
                    <table class="w-full text-left mb-6" role="table" aria-label="User accounts table">
                        <thead>
                            <tr class="border-b-2 border-gray-300 dark:border-gray-600">
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Name</th>
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Email</th>
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Role</th>
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Status</th>
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Last Login</th>
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- User rows will be dynamically generated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <!-- Pagination Controls -->
                <div class="flex gap-2 items-center justify-end mt-2" id="user-pagination"></div>
                <!-- Add User Form (neon theme, .card + .widget-secondary) -->
                <form class="mt-6 pt-6 border-t border-gray-300 dark:border-gray-600" id="user-form" role="form" aria-label="Add new user form">
                    <h3 class="text-xl font-semibold mb-4 text-gray-100">Add New User</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <input type="text" placeholder="Name" required class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" aria-label="User name">
                        <input type="email" placeholder="Email" required class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" aria-label="User email">
                        <select required class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" aria-label="User role">
                            <option value="">Select Role</option>
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="btn-neon-blue flex-1 p-3 rounded-lg">Add User</button>
                        <button type="button" id="cancel-edit" class="btn-neon-green px-6 p-3 rounded-lg hidden">Cancel</button>
                    </div>
                </form>
            </div>
        </section>
        <!-- Bulk Operations -->
        <!-- Bulk Operations (neon theme, .card + .widget-secondary) -->
        <section class="mt-6" aria-label="Bulk operations">
            <div class="card widget-secondary rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-100">Bulk Operations</h3>
                <div class="flex flex-wrap gap-4">
                    <button id="export-users-csv" class="btn-neon-green px-4 py-2 rounded">Export Users (CSV)</button>
                    <button id="export-users-excel" class="btn-neon-blue px-4 py-2 rounded">Export Users (Excel)</button>
                    <label for="import-users-csv" class="btn-neon-blue px-4 py-2 rounded cursor-pointer">
                        Import Users (CSV)
                        <input type="file" id="import-users-csv" accept=".csv" class="hidden">
                    </label>
                </div>
                <div class="mt-4 text-sm text-gray-400">
                    <p><strong>CSV Format:</strong> Name,Email,Role</p>
                    <p><strong>Example:</strong> John Doe,john@example.com,user</p>
                </div>
            </div>
        </section>
    </main>

    <script>

        // Show toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Load and apply site settings
        function loadAndApplySettings() {
            const settings = JSON.parse(localStorage.getItem('siteSettings')) || {};
            
            // Apply site title if set
            if (settings['site-title']) {
                const brandingElements = document.querySelectorAll('h1');
                brandingElements.forEach(el => {
                    if (el.textContent.includes('Josh\'s App')) {
                        el.textContent = settings['site-title'];
                    }
                });
            }
        }

        // User management functionality with audit logging
        let users = [];
        let editingUserId = null;

        // Audit Logger for users page
        class AuditLogger {
            static log(action, details, userId = 'admin') {
                const auditLogs = JSON.parse(localStorage.getItem('auditLogs') || '[]');
                const logEntry = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    userId: userId,
                    action: action,
                    details: details,
                    ip: 'localhost'
                };
                
                auditLogs.unshift(logEntry);
                
                if (auditLogs.length > 1000) {
                    auditLogs.splice(1000);
                }
                
                localStorage.setItem('auditLogs', JSON.stringify(auditLogs));
                window.dispatchEvent(new CustomEvent('auditLogUpdated', { detail: logEntry }));
            }
        }


        // Load users from backend API with filters, sorting, and pagination
        let userPagination = { page: 1, limit: 10, total: 0, pages: 1 };
        let userFilters = { search: '', role: '', status: '', sort: 'created_at_desc' };
        async function loadUsers(page = 1) {
            try {
                const token = localStorage.getItem('authToken');
                const params = new URLSearchParams({
                    page,
                    limit: userPagination.limit,
                    search: userFilters.search,
                    role: userFilters.role,
                    status: userFilters.status,
                    sort: userFilters.sort
                });
                const res = await fetch(`/api/users?${params.toString()}`, {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });
                if (!res.ok) throw new Error('Failed to load users');
                const data = await res.json();
                users = data.users || [];
                userPagination = data.pagination || { page: 1, limit: 10, total: users.length, pages: 1 };
                renderUsers();
            } catch (e) {
                showToast('Error loading users: ' + e.message);
                users = [];
                renderUsers();
            }
        }


        // Render users table with avatars, status, last login, and pagination
        function renderUsers() {
            const tbody = document.querySelector('tbody');
            tbody.innerHTML = '';
            users.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700';
                const avatar = user.avatar_url ? `<img src="${user.avatar_url}" class="inline w-8 h-8 rounded-full mr-2"/>` : `<span class="inline-block w-8 h-8 rounded-full bg-gray-600 mr-2"></span>`;
                const status = user.is_active ? '<span class="text-green-400">Active</span>' : '<span class="text-red-400">Inactive</span>';
                const lastLogin = user.last_login ? new Date(user.last_login).toLocaleString() : '--';
                row.innerHTML = `
                    <td class="py-2 px-3 flex items-center">${avatar}<a href="profile.html?user_id=${user.id}" class="text-blue-400 hover:underline">${user.name}</a></td>
                    <td class="py-2 px-3">${user.email}</td>
                    <td class="py-2 px-3">${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</td>
                    <td class="py-2 px-3">${status}</td>
                    <td class="py-2 px-3">${lastLogin}</td>
                    <td class="py-2 px-3">
                        <button class="px-2 py-1 bg-secondary text-white rounded mr-2 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 edit-user" data-id="${user.id}">Edit</button>
                        <button class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 delete-user" data-id="${user.id}">Delete</button>
                        <button class="px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 lock-user" data-id="${user.id}">${user.is_active ? 'Lock' : 'Unlock'}</button>
                        <button class="px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 reset-password-user" data-id="${user.id}">Reset PW</button>
                        <button class="px-2 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 impersonate-user" data-id="${user.id}">Impersonate</button>
                    </td>
                `;
        // Admin action handlers: lock/unlock, reset password, impersonate
        document.addEventListener('DOMContentLoaded', () => {
            const tbody = document.querySelector('tbody');
            tbody.addEventListener('click', async (e) => {
                const id = e.target.dataset.id;
                if (e.target.classList.contains('lock-user')) {
                    // Lock/unlock user
                    const user = users.find(u => u.id == id);
                    if (!user) return;
                    const token = localStorage.getItem('authToken');
                    try {
                        const headers = { 'Content-Type': 'application/json' };
                        if (token) headers['Authorization'] = `Bearer ${token}`;
                        const res = await fetch(`/api/users/${id}`, {
                            method: 'PUT',
                            headers,
                            body: JSON.stringify({ is_active: !user.is_active })
                        });
                        if (!res.ok) throw new Error('Failed to update user status');
                        showToast(user.is_active ? 'User locked.' : 'User unlocked.');
                        await loadUsers(userPagination.page);
                    } catch (err) { showToast('Error: ' + err.message); }
                } else if (e.target.classList.contains('reset-password-user')) {
                    // Reset password
                    if (!confirm('Reset password for this user?')) return;
                    const token = localStorage.getItem('authToken');
                    try {
                        const headers = { 'Content-Type': 'application/json' };
                        if (token) headers['Authorization'] = `Bearer ${token}`;
                        const newPassword = Math.random().toString(36).slice(-10) + 'A1!';
                        const res = await fetch(`/api/users/${id}/password`, {
                            method: 'PUT',
                            headers,
                            body: JSON.stringify({ newPassword })
                        });
                        if (!res.ok) throw new Error('Failed to reset password');
                        showToast('Password reset. New temp password: ' + newPassword);
                    } catch (err) { showToast('Error: ' + err.message); }
                } else if (e.target.classList.contains('impersonate-user')) {
                    // Impersonate user (set authToken to user's token if API supports, else show message)
                    showToast('Impersonation feature not implemented. (Requires backend support)');
                }
            });
        });
                tbody.appendChild(row);
            });
            // Pagination controls
            const pagDiv = document.getElementById('user-pagination');
            pagDiv.innerHTML = '';
            if (userPagination.pages > 1) {
                for (let i = 1; i <= userPagination.pages; i++) {
                    const btn = document.createElement('button');
                    btn.textContent = i;
                    btn.className = 'px-2 py-1 rounded ' + (i === userPagination.page ? 'bg-primary text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600');
                    btn.onclick = () => { loadUsers(i); };
                    pagDiv.appendChild(btn);
                }
            }
        }
        // Filter, sort, and search event listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('user-search').addEventListener('input', e => {
                userFilters.search = e.target.value;
                loadUsers(1);
            });
            document.getElementById('user-role-filter').addEventListener('change', e => {
                userFilters.role = e.target.value;
                loadUsers(1);
            });
            document.getElementById('user-status-filter').addEventListener('change', e => {
                userFilters.status = e.target.value;
                loadUsers(1);
            });
            document.getElementById('user-sort').addEventListener('change', e => {
                userFilters.sort = e.target.value;
                loadUsers(1);
            });
        });


        // Add or update user via backend API
        async function addOrUpdateUser(event) {
            event.preventDefault();
            const form = event.target;
            const name = form.querySelector('input[type="text"]').value.trim();
            const email = form.querySelector('input[type="email"]').value.trim();
            const role = form.querySelector('select').value;
            const token = localStorage.getItem('authToken');
            if (!name || !email || !role) {
                showToast('Please fill in all fields');
                return;
            }
            try {
                if (editingUserId) {
                    // Update existing user (PUT)
                    const res = await fetch(`/api/users/${editingUserId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                        },
                        body: JSON.stringify({ name, role })
                    });
                    if (!res.ok) throw new Error('Failed to update user');
                    showToast('User updated successfully!');
                    editingUserId = null;
                    form.querySelector('button[type="submit"]').textContent = 'Add User';
                    form.querySelector('h3').textContent = 'Add New User';
                    document.getElementById('cancel-edit').classList.add('hidden');
                } else {
                    // Add new user (POST)
                    const password = Math.random().toString(36).slice(-10) + 'A1!'; // temp password
                    const res = await fetch('/api/users', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                        },
                        body: JSON.stringify({ name, email, role, password })
                    });
                    if (!res.ok) {
                        const err = await res.json();
                        throw new Error(err.error || 'Failed to add user');
                    }
                    showToast('User added successfully!');
                }
                form.reset();
                await loadUsers();
            } catch (e) {
                showToast('Error: ' + e.message);
            }
        }

        // Edit user
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            const form = document.querySelector('form');
            form.querySelector('input[type="text"]').value = user.name;
            form.querySelector('input[type="email"]').value = user.email;
            form.querySelector('select').value = user.role;
            
            editingUserId = userId;
            form.querySelector('button[type="submit"]').textContent = 'Update User';
            form.querySelector('h3').textContent = 'Edit User';
            document.getElementById('cancel-edit').classList.remove('hidden');
            
            // Scroll to form
            form.scrollIntoView({ behavior: 'smooth' });
        }


        // Delete user via backend API
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            const token = localStorage.getItem('authToken');
            try {
                const res = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });
                if (!res.ok) throw new Error('Failed to delete user');
                showToast('User deleted successfully!');
                await loadUsers();
            } catch (e) {
                showToast('Error: ' + e.message);
            }
        }

        // Cancel edit
        function cancelEdit() {
            editingUserId = null;
            const form = document.querySelector('form');
            form.reset();
            form.querySelector('button[type="submit"]').textContent = 'Add User';
            form.querySelector('h3').textContent = 'Add New User';
            document.getElementById('cancel-edit').classList.add('hidden');
        }


        // Export users to CSV via backend API
        async function exportUsersCSV() {
            const token = localStorage.getItem('authToken');
            try {
                const res = await fetch('/api/users?limit=1000', {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });
                if (!res.ok) throw new Error('Failed to fetch users');
                const data = await res.json();
                const headers = ['Name', 'Email', 'Role'];
                const csvContent = [
                    headers.join(','),
                    ...data.users.map(user => [
                        `"${user.name}"`,
                        `"${user.email}"`,
                        `"${user.role}"`
                    ].join(','))
                ].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'users.csv';
                a.click();
                URL.revokeObjectURL(url);
                showToast('Users exported to CSV successfully!');
            } catch (e) {
                showToast('Error: ' + e.message);
            }
        }

        // Export users to Excel (tab-separated) via backend API
        async function exportUsersExcel() {
            const token = localStorage.getItem('authToken');
            try {
                const res = await fetch('/api/users?limit=1000', {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });
                if (!res.ok) throw new Error('Failed to fetch users');
                const data = await res.json();
                const headers = ['Name', 'Email', 'Role'];
                const csvContent = [
                    headers.join('\t'),
                    ...data.users.map(user => [
                        user.name,
                        user.email,
                        user.role
                    ].join('\t'))
                ].join('\n');
                const blob = new Blob([csvContent], { type: 'application/vnd.ms-excel' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'users.xls';
                a.click();
                URL.revokeObjectURL(url);
                showToast('Users exported to Excel successfully!');
            } catch (e) {
                showToast('Error: ' + e.message);
            }
        }


        // Import users from CSV via backend API
        async function importUsersCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            const token = localStorage.getItem('authToken');
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const startIndex = lines[0].toLowerCase().includes('name') ? 1 : 0;
                    let imported = 0;
                    for (let i = startIndex; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        const fields = line.split(',').map(field => field.replace(/^"|"$/g, '').trim());
                        if (fields.length >= 3) {
                            const name = fields[0];
                            const email = fields[1];
                            const role = fields[2].toLowerCase();
                            // Validate email format
                            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                            if (!emailRegex.test(email)) continue;
                            if (!['user', 'admin', 'manager'].includes(role)) continue;
                            // POST to API (random password)
                            const password = Math.random().toString(36).slice(-10) + 'A1!';
                            const res = await fetch('/api/users', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                                },
                                body: JSON.stringify({ name, email, role, password })
                            });
                            if (res.ok) imported++;
                        }
                    }
                    await loadUsers();
                    showToast(`${imported} users imported successfully!`);
                } catch (error) {
                    showToast('Error importing CSV file: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }



        // Mobile Menu Toggle
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            const isOpen = sidebar.classList.contains('open');
            menuToggle.setAttribute('aria-expanded', isOpen);
        });

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Log page access
            if (typeof AuditLogger !== 'undefined') {
                AuditLogger.log('page_access', 'Accessed User Management page');
            }
            
            loadUsers();
            loadAndApplySettings();
            
            // Form submission
            document.querySelector('form').addEventListener('submit', addOrUpdateUser);
            
            // Cancel edit button
            document.getElementById('cancel-edit').addEventListener('click', cancelEdit);
            
            // Edit and delete buttons
            document.querySelector('tbody').addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-user')) {
                    editUser(parseInt(e.target.dataset.id));
                } else if (e.target.classList.contains('delete-user')) {
                    deleteUser(parseInt(e.target.dataset.id));
                }
            });

            // Bulk operations
            document.getElementById('export-users-csv').addEventListener('click', exportUsersCSV);
            document.getElementById('export-users-excel').addEventListener('click', exportUsersExcel);
            document.getElementById('import-users-csv').addEventListener('change', importUsersCSV);
        });
 
        // Service Worker Registration for PWA
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("./sw.js")
                    .then(registration => {
                        console.log("SW registered: ", registration);
                    })
                    .catch(registrationError => {
                        console.log("SW registration failed: ", registrationError);
                    });
            });
        }
    </script>
</body>
</html>
