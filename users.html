<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>User Management</title>
  <link rel="manifest" href="./manifest.json" />
  <link rel="apple-touch-icon" href="./assets/images/logo-placeholder.svg" />
  <link rel="stylesheet" href="./assets/css/styles.css" />
    <script src="./assets/js/init-shared.js" defer></script>
    <script src="./assets/js/audit.js" defer></script>
    <script>
        // Load shared modal utilities
        fetch('shared-modals.html').then(r=>r.text()).then(html=>{const t=document.createElement('div');t.innerHTML=html;Array.from(t.children).forEach(c=>document.head.appendChild(c.cloneNode(true)));});
    </script>
    <script>
        // Purge legacy role demo key to avoid stale UI state
        try { localStorage.removeItem('currentUser'); } catch (_) {}
    </script>
  <style>
    .user-item{transition:all .2s ease;background:#111;border:1px solid #333}
    .user-item:hover{background:#181818;border-color:#00d4ff;box-shadow:0 4px 20px rgba(0,212,255,.2)}
    
    /* Modal styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      z-index: 9998;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .modal-overlay.hidden {
      display: none;
    }
    .modal-content {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 0.5rem;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 212, 255, 0.3);
      z-index: 9999;
    }
    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-body {
      padding: 1.5rem;
    }
    .modal-close {
      background: transparent;
      border: none;
      color: #999;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.25rem;
      transition: all 0.2s;
    }
    .modal-close:hover {
      background: #333;
      color: #fff;
    }
  </style>
  <link rel="stylesheet" href="./assets/css/accessibility.css" />
  <script src="./assets/js/accessibility.js" defer></script>
</head>
    <body class="dark">
  <!-- Skip to main content link for accessibility -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- MOBILE MENU TOGGLE (copied from template.html) -->
    <button id="menu-toggle" class="md:hidden fixed top-4 left-4 z-50 p-2 bg-blue-600 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400" aria-label="Toggle sidebar" aria-expanded="false">â˜°</button>
    <div id="sidebar-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
    <!-- Toast Notification (legacy element kept for fallback adapter; no mock toasts) -->
    <div class="flex min-h-screen">
        <!-- Shared Navigation Loader -->
        <div id="main-nav"></div>
        <script>
          // Dynamically load shared navigation
          fetch('shared-nav.html')
            .then(response => response.text())
            .then(html => {
              document.getElementById('main-nav').innerHTML = html;
              // Call the function to highlight the active nav link after insertion
              if (window.setActiveNavLink) window.setActiveNavLink();
            });
        </script>
                <!-- Main Content -->
                <main id="main-content" class="flex-1 p-4 md:p-6 ml-64 md:ml-0" role="main">
                <!-- Header Card -->
                <header class="page-header card border" role="banner">
                    <div class="flex items-center justify-between gap-4">
                        <div>
                            <h1 class="text-3xl font-bold text-white">User Management</h1>
                            <p class="text-lg mt-2 nav-link-muted">Manage accounts, roles and access</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button id="open-add-user" class="btn-neon-green px-4 py-2 rounded">Add User</button>
                            <button id="refresh-users" class="btn-neon-blue px-4 py-2 rounded">Refresh</button>
                        </div>
                    </div>
                </header>
        <section>
            <p class="text-gray-600 dark:text-gray-300 leading-relaxed">Manage user accounts and permissions. Add, edit, or remove users from the system.</p>
            <!-- User Filters/Search/Sort -->
            <div class="flex flex-wrap gap-4 items-center mb-4">
                <input id="user-search" type="text" placeholder="Search name or email..." class="p-2 rounded border border-gray-400 dark:border-gray-600 bg-gray-900 text-white text-sm min-w-[180px]" />
                <select id="user-role-filter" class="p-2 rounded border border-gray-400 dark:border-gray-600 bg-gray-900 text-white text-sm">
                    <option value="">All Roles</option>
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                    <option value="manager">Manager</option>
                </select>
                <select id="user-status-filter" class="p-2 rounded border border-gray-400 dark:border-gray-600 bg-gray-900 text-white text-sm">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
                <select id="user-sort" class="p-2 rounded border border-gray-400 dark:border-gray-600 bg-gray-900 text-white text-sm">
                    <option value="created_at_desc">Newest</option>
                    <option value="created_at_asc">Oldest</option>
                    <option value="name_asc">Name A-Z</option>
                    <option value="name_desc">Name Z-A</option>
                </select>
            </div>
            <!-- Deep-link banner (shown when focusing a specific userId) -->
            <div id="user-deeplink-banner" class="hidden mb-4 p-3 rounded border border-gray-700 bg-gray-900 text-gray-200 flex items-center justify-between">
                <div><span id="deeplink-text"></span></div>
                <button id="deeplink-clear" class="btn-neon-blue px-3 py-1 rounded">Clear</button>
            </div>
            <!-- User Table Card (neon theme, .card + .widget-primary) -->
            <div class="card widget-primary rounded-lg shadow-md p-6">
                <div class="overflow-x-auto">
                    <table class="w-full text-left mb-6" role="table" aria-label="User accounts table">
                        <thead>
                            <tr class="border-b-2 border-gray-300 dark:border-gray-600">
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Name</th>
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Email</th>
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Role</th>
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Status</th>
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Last Login</th>
                                <th class="py-3 px-4 text-gray-900 dark:text-gray-100 font-semibold">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- User rows will be dynamically generated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <!-- Pagination Controls -->
                <div class="flex gap-2 items-center justify-end mt-2" id="user-pagination"></div>
                <!-- Add User Form (neon theme, .card + .widget-secondary) -->
                <form class="mt-6 pt-6 border-t border-gray-300 dark:border-gray-600" id="user-form" role="form" aria-label="Add new user form">
                    <h3 class="text-xl font-semibold mb-4 text-gray-100">Add New User</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <input type="text" placeholder="Name" required class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" aria-label="User name">
                        <input type="email" placeholder="Email" required class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" aria-label="User email">
                        <select required class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" aria-label="User role">
                            <option value="">Select Role</option>
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="btn-neon-blue flex-1 p-3 rounded-lg">Add User</button>
                        <button type="button" id="cancel-edit" class="btn-neon-green px-6 p-3 rounded-lg hidden">Cancel</button>
                    </div>
                </form>
            </div>
        </section>
        <!-- Bulk Operations -->
        <!-- Bulk Operations (neon theme, .card + .widget-secondary) -->
        <section class="mt-6" aria-label="Bulk operations">
            <div class="card widget-secondary rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-100">Bulk Operations</h3>
                <div class="flex flex-wrap gap-4">
                    <button id="export-users-csv" class="btn-neon-green px-4 py-2 rounded">Export Users (CSV)</button>
                    <button id="export-users-excel" class="btn-neon-blue px-4 py-2 rounded">Export Users (Excel)</button>
                    <label for="import-users-csv" class="btn-neon-blue px-4 py-2 rounded cursor-pointer">
                        Import Users (CSV)
                        <input type="file" id="import-users-csv" accept=".csv" class="hidden">
                    </label>
                </div>
                <div class="mt-4 text-sm text-gray-400">
                    <p><strong>CSV Format:</strong> Name,Email,Role</p>
                    <p><strong>Example:</strong> John Doe,john@example.com,user</p>
                </div>
            </div>
        </section>
    </main>
    </div>

    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="text-xl font-semibold text-gray-100">Edit User</h3>
          <button class="modal-close" id="close-modal" aria-label="Close modal">&times;</button>
        </div>
        <div class="modal-body">
          <form id="edit-user-form">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Name</label>
                <input type="text" id="edit-name" required class="w-full p-3 rounded-lg border border-gray-600 bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-primary" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                <input type="email" id="edit-email" disabled class="w-full p-3 rounded-lg border border-gray-600 bg-gray-700 text-gray-400 cursor-not-allowed" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Role</label>
                <select id="edit-role" required class="w-full p-3 rounded-lg border border-gray-600 bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-primary">
                  <option value="">Select Role</option>
                  <option value="user">User</option>
                  <option value="admin">Admin</option>
                  <option value="manager">Manager</option>
                </select>
              </div>
            </div>
            <div class="flex gap-3 mt-6">
              <button type="submit" class="btn-neon-blue flex-1 p-3 rounded-lg">Update User</button>
              <button type="button" id="cancel-modal" class="btn-neon-green px-6 p-3 rounded-lg">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
    // Serverless base path and auth token helper (computed in init-shared.js)
    const FN_BASE = window.FN_BASE || '/.netlify/functions';
    const AUTH_DISABLED = window.AUTH_DISABLED === true;
    const usersState = { list: [], pagination: { page:1, limit:10, total:0, pages:1 }, filters: { search:'', role:'', status:'', sort:'created_at_desc' }, editingId: null, loading: false };

        function loadAndApplySettings() {
            const settings = JSON.parse(localStorage.getItem('siteSettings')) || {};
            if (settings['site-title']) {
                document.querySelectorAll('h1').forEach(el => {
                    if (el.textContent.includes("Josh's App")) el.textContent = settings['site-title'];
                });
            }
        }

        class AuditLogger { static log(action, details, userId='admin') { const logs = JSON.parse(localStorage.getItem('auditLogs')||'[]'); const entry={ id:Date.now(), timestamp:new Date().toISOString(), userId, action, details, ip:'localhost' }; logs.unshift(entry); if (logs.length>1000) logs.splice(1000); localStorage.setItem('auditLogs', JSON.stringify(logs)); window.dispatchEvent(new CustomEvent('auditLogUpdated',{ detail:entry })); } }

async function loadUsers(page = 1) {
            try {
        if (usersState.loading) return; usersState.loading = true;
                const { limit, filters } = { limit: usersState.pagination.limit, filters: usersState.filters };
                const params = new URLSearchParams({ page, limit, search:filters.search, role:filters.role, status:filters.status, sort:filters.sort });

                // Use authFetch which handles token refresh automatically
                const res = window.authFetch 
                    ? await window.authFetch(`${FN_BASE}/users?${params.toString()}`)
                    : await fetch(`${FN_BASE}/users?${params.toString()}`, { 
                        headers: { 'Authorization': `Bearer ${(window.getToken && window.getToken()) || ''}` }
                      });

                // If forbidden, do not redirect to login; show message and stop
                if (res.status === 403 && !AUTH_DISABLED) {
                    showToast('Access denied: you do not have permission to view users.', 'error');
                    usersState.list = [];
                    renderUsers();
                    return;
                }

                // Any other error is now handled by ensureSessionAndRole or is a server error.
                if (!res.ok) throw new Error('Failed to load users (status '+res.status+')');
                const data = await res.json();
                usersState.list = data.users || [];
                usersState.pagination = data.pagination || { page:1, limit:limit, total:usersState.list.length, pages:1 };
                renderUsers();
            } catch(err){
                console.error('loadUsers', err);
                showToast('Error loading users: '+(err.message||'Network error'),'error');
                usersState.list=[]; renderUsers();
            } finally { usersState.loading = false; }
        }

        function renderUsers(){
            const tbody = document.querySelector('tbody');
            tbody.innerHTML='';
            usersState.list.forEach(u => {
                const tr = document.createElement('tr');
                tr.className='border-b border-gray-700';
                tr.dataset.userId = String(u.id);
                tr.id = `user-row-${u.id}`;
                const avatar = u.avatar_url ? `<img src="${u.avatar_url}" class="inline w-8 h-8 rounded-full mr-2"/>` : `<span class="inline-block w-8 h-8 rounded-full bg-gray-600 mr-2"></span>`;
                const status = u.is_active ? '<span class="text-green-400">Active</span>' : '<span class="text-red-400">Inactive</span>';
                const lastLogin = u.last_login ? new Date(u.last_login).toLocaleString() : '--';
                tr.innerHTML = `
                    <td class="py-2 px-3 flex items-center">${avatar}<a href="profile.html?user_id=${u.id}" class="text-blue-400 hover:underline">${u.name}</a></td>
                    <td class="py-2 px-3">${u.email}</td>
                    <td class="py-2 px-3">${u.role.charAt(0).toUpperCase()+u.role.slice(1)}</td>
                    <td class="py-2 px-3">${status}</td>
                    <td class="py-2 px-3">${lastLogin}</td>
                    <td class="py-2 px-3">
                        <button class="px-2 py-1 bg-secondary text-white rounded mr-2 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 edit-user" data-id="${u.id}">Edit</button>
                        <button class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 delete-user" data-id="${u.id}">Delete</button>
                        <button class="px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 lock-user" data-id="${u.id}">${u.is_active ? 'Lock':'Unlock'}</button>
                        <button class="px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 reset-password-user" data-id="${u.id}">Reset PW</button>
                        <button class="px-2 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 impersonate-user" data-id="${u.id}">Impersonate</button>
                    </td>`;
                tbody.appendChild(tr);
            });
            const pagDiv = document.getElementById('user-pagination');
            const { page, pages } = usersState.pagination; pagDiv.innerHTML='';
            if (pages>1){ for(let i=1;i<=pages;i++){ const b=document.createElement('button'); b.textContent=i; b.className='px-2 py-1 rounded '+(i===page?'bg-primary text-white':'bg-gray-700 text-gray-300 hover:bg-gray-600'); b.onclick=()=>loadUsers(i); pagDiv.appendChild(b);} }
        }
        // Highlight a specific row (used for deep-links)
        function highlightUserRow(userId){
            try {
                const row = document.getElementById(`user-row-${userId}`);
                if (!row) return false;
                row.classList.add('ring-2','ring-cyan-400','ring-offset-2','ring-offset-gray-900');
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => { row.classList.remove('ring-2','ring-cyan-400','ring-offset-2','ring-offset-gray-900'); }, 5000);
                return true;
            } catch (_) { return false; }
        }

        // Show a banner indicating deep-linked user view with a clear option
        function showDeeplinkBanner(user){
            const banner = document.getElementById('user-deeplink-banner');
            const text = document.getElementById('deeplink-text');
            const clearBtn = document.getElementById('deeplink-clear');
            if (!banner || !text || !clearBtn) return;
            text.textContent = `Focusing on user #${user.id} (${user.name || user.email || 'unknown'})`;
            banner.classList.remove('hidden');
            clearBtn.onclick = () => {
                banner.classList.add('hidden');
                // Reset filters and reload full list
                usersState.filters.search = '';
                document.getElementById('user-search').value = '';
                loadUsers(1);
                // Also remove the query param from URL without reloading
                try {
                    const url = new URL(window.location.href);
                    url.searchParams.delete('userId');
                    url.searchParams.delete('user_id');
                    window.history.replaceState({}, '', url.toString());
                } catch(_){ /* noop */ }
            };
        }
    // Toast adapter now handled globally via window.showToast -> window.showNotification

        // Show sign-in CTA instead of auto-redirecting
        function showSignInCTA(message) {
            try {
                const main = document.querySelector('main');
                if (!main) return;
                // Hide interactive sections while unauthenticated
                const sections = main.querySelectorAll('section');
                sections.forEach(s => s.classList.add('hidden'));
                // Create CTA once
                let cta = document.getElementById('signin-cta');
                if (!cta) {
                    cta = document.createElement('div');
                    cta.id = 'signin-cta';
                    cta.className = 'mt-6 p-6 border border-gray-700 rounded-lg text-center';
                    const msg = document.createElement('p');
                    msg.className = 'mb-4 text-gray-300';
                    msg.textContent = message || 'Please sign in to view and manage users.';
                    const btn = document.createElement('button');
                    btn.id = 'go-to-login';
                    btn.className = 'btn-neon-blue px-4 py-2 rounded';
                    btn.textContent = 'Sign in';
                    btn.addEventListener('click', () => {
                        const returnUrl = encodeURIComponent(window.location.pathname + window.location.search);
                        window.location.href = `login.html?message=login-required&returnUrl=${returnUrl}`;
                    });
                    cta.appendChild(msg);
                    cta.appendChild(btn);
                    main.appendChild(cta);
                } else {
                    const p = cta.querySelector('p');
                    if (p) p.textContent = message || 'Please sign in to view and manage users.';
                }
                // Ensure visible
                cta.classList.remove('hidden');
            } catch (_) { /* noop */ }
        }

        // Verify session and role before loading users to avoid 401 loops
        async function ensureSessionAndRole(){
            if (AUTH_DISABLED) return true;
            
            // First check if we have any tokens at all
            const token = (window.getToken && window.getToken()) || null;
            const refreshToken = (window.getRefreshToken && window.getRefreshToken()) || null;
            
            if (!token && !refreshToken) { 
                showSignInCTA('Please sign in to view and manage users.'); 
                return false; 
            }
            
            if (!token) {
                showSignInCTA('Session expired. Please sign in again.');
                return false;
            }
            
            try {
                const res = await fetch(`${FN_BASE}/auth?action=me`, { headers: { 'Authorization': `Bearer ${token}` }});
                if (!res.ok) {
                    // Token is invalid - clear session and show sign-in CTA
                    try{localStorage.removeItem('accessToken');localStorage.removeItem('refreshToken');localStorage.removeItem('user');localStorage.removeItem('currentUser');}catch(_){}
                    let msg = 'Session expired. Please sign in again.';
                    try { const body = await res.json(); if (body && body.error) { msg = body.error + '. Please sign in again.'; } } catch(_){}
                    showSignInCTA(msg);
                    return false;
                }
                const me = await res.json();
                if (me && me.user) {
                    try { localStorage.setItem('user', JSON.stringify(me.user)); localStorage.setItem('currentUser', JSON.stringify({ name: me.user.name || me.user.email || 'User', role: me.user.role || 'user', email: me.user.email })); } catch(_) {}
                    if (['admin','manager'].includes(me.user.role)) return true;
                    showToast('Access denied: you do not have permission to view users.','error');
                    return false;
                }
                // me was OK but no user field -> treat as invalid session
                try{localStorage.removeItem('accessToken');localStorage.removeItem('refreshToken');localStorage.removeItem('user');localStorage.removeItem('currentUser');}catch(_){}
                showSignInCTA('Account not found. Please sign in again.');
                return false;
            } catch(_) { 
                showSignInCTA('Unable to verify session. Please sign in.');
                return false; 
            }
        }

        // Add or update user via backend API
        async function addOrUpdateUser(e){
            e.preventDefault();
            const form = e.target;
            const name = form.querySelector('input[type="text"]').value.trim();
            const email = form.querySelector('input[type="email"]').value.trim();
            const role = form.querySelector('select').value;
            const token = (window.getToken && window.getToken()) || null;
            if(!name||!email||!role){ showToast('Please fill in all fields'); return; }
            try {
                const password = Math.random().toString(36).slice(-10)+'A1!';
                const res = await fetch(`${FN_BASE}/users`, { method:'POST', headers:{ 'Content-Type':'application/json', ...(token?{ 'Authorization':`Bearer ${token}` }:{}) }, body:JSON.stringify({ name,email,role,password }) });
                if(!res.ok){ const err=await res.json().catch(()=>({})); throw new Error(err.error||'Failed to add user'); }
                showToast('User added','success');
                form.reset();
                await loadUsers(1);
            } catch(err){ showToast('Error: '+err.message,'error'); }
        }

        // Update user from modal
        async function updateUserFromModal(e){
            e.preventDefault();
            const name = document.getElementById('edit-name').value.trim();
            const role = document.getElementById('edit-role').value;
            const token = (window.getToken && window.getToken()) || null;
            if(!name||!role){ showToast('Please fill in all fields'); return; }
            if(!usersState.editingId){ showToast('No user selected for editing','error'); return; }
            try {
                const res = await fetch(`${FN_BASE}/users/${usersState.editingId}`, { method:'PUT', headers:{ 'Content-Type':'application/json', ...(token?{ 'Authorization':`Bearer ${token}` }:{}) }, body:JSON.stringify({ name, role }) });
                if(!res.ok) throw new Error('Failed to update user');
                showToast('User updated','success');
                closeEditModal();
                await loadUsers(usersState.pagination.page || 1);
            } catch(err){ showToast('Error: '+err.message,'error'); }
        }

        // Open edit modal
        function openEditModal(id){ 
            const u=usersState.list.find(x=>x.id===id); 
            if(!u) return; 
            document.getElementById('edit-name').value=u.name; 
            document.getElementById('edit-email').value=u.email; 
            document.getElementById('edit-role').value=u.role; 
            usersState.editingId=id; 
            document.getElementById('edit-user-modal').classList.remove('hidden');
            // Focus the name field
            setTimeout(() => document.getElementById('edit-name').focus(), 100);
        }

        // Close edit modal
        function closeEditModal(){ 
            usersState.editingId=null; 
            document.getElementById('edit-user-modal').classList.add('hidden');
            document.getElementById('edit-user-form').reset();
        }

        // Edit user (deprecated - now opens modal)
        function editUser(id){ openEditModal(id); }

        // Delete user via backend API
    async function deleteUser(id){ 
        const user = usersState.list.find(u => u.id == id);
        const userName = user ? (user.name || user.email) : 'this user';
        const confirmed = await window.ModalUtils.confirm({
            title: 'Delete User',
            message: `Are you sure you want to delete ${userName}? This action cannot be undone.`,
            confirmText: 'Delete',
            cancelText: 'Cancel',
            type: 'danger'
        });
        if(!confirmed) return; 
        const token=(window.getToken && window.getToken()) || null; 
        try { 
            const res=await fetch(`${FN_BASE}/users/${id}`, { method:'DELETE', headers: token?{ 'Authorization':`Bearer ${token}` }:{} }); 
            if(!res.ok) throw new Error('Failed to delete user'); 
            showToast('User deleted','success'); 
            await loadUsers(1); 
        } catch(err){ 
            showToast('Error: '+err.message,'error'); 
        } 
    }

        // Cancel edit
        function cancelEdit(){ usersState.editingId=null; const form=document.getElementById('user-form'); form.reset(); form.querySelector('button[type="submit"]').textContent='Add User'; form.querySelector('h3').textContent='Add New User'; document.getElementById('cancel-edit').classList.add('hidden'); }

        // Export users to CSV via backend API
    async function exportUsersCSV(){ const token=(window.getToken && window.getToken()) || null; try { const res=await fetch(`${FN_BASE}/users?limit=1000`, { headers: token?{ 'Authorization':`Bearer ${token}` }:{} }); if(!res.ok) throw new Error('Failed to fetch users'); const data=await res.json(); const headers=['Name','Email','Role']; const csv=[ headers.join(','), ...(data.users||[]).map(u=>`"${u.name}","${u.email}","${u.role}"`) ].join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='users.csv'; a.click(); URL.revokeObjectURL(url); showToast('Exported CSV','success'); } catch(err){ showToast('Error: '+err.message,'error'); } }

        // Export users to Excel (tab-separated) via backend API
    async function exportUsersExcel(){ const token=(window.getToken && window.getToken()) || null; try { const res=await fetch(`${FN_BASE}/users?limit=1000`, { headers: token?{ 'Authorization':`Bearer ${token}` }:{} }); if(!res.ok) throw new Error('Failed to fetch users'); const data=await res.json(); const headers=['Name','Email','Role']; const tsv=[ headers.join('\t'), ...(data.users||[]).map(u=>[u.name,u.email,u.role].join('\t')) ].join('\n'); const blob=new Blob([tsv],{type:'application/vnd.ms-excel'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='users.xls'; a.click(); URL.revokeObjectURL(url); showToast('Exported Excel','success'); } catch(err){ showToast('Error: '+err.message,'error'); } }

        // Import users from CSV via backend API
    async function importUsersCSV(evt){ const file=evt.target.files[0]; if(!file) return; const token=(window.getToken && window.getToken()) || null; const reader=new FileReader(); reader.onload=async e=>{ try { const lines=e.target.result.split('\n'); const start = lines[0].toLowerCase().includes('name')?1:0; let imported=0; for(let i=start;i<lines.length;i++){ const line=lines[i].trim(); if(!line) continue; const parts=line.split(',').map(f=>f.replace(/^\"|\"$/g,'').trim()); if(parts.length<3) continue; const [name,email,roleRaw]=parts; const role=roleRaw.toLowerCase(); const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/; if(!emailRegex.test(email)) continue; if(!['user','admin','manager'].includes(role)) continue; const password=Math.random().toString(36).slice(-10)+'A1!'; const res=await fetch(`${FN_BASE}/users`, { method:'POST', headers:{ 'Content-Type':'application/json', ...(token?{ 'Authorization':`Bearer ${token}` }:{}) }, body:JSON.stringify({ name,email,role,password }) }); if(res.ok) imported++; }
            await loadUsers(1); showToast(imported+' users imported','success'); } catch(err){ showToast('Import error: '+err.message,'error'); } }; reader.readAsText(file); evt.target.value=''; }

        // Event wiring
    document.addEventListener('DOMContentLoaded', async () => {
            // Parse deep-link id (?userId= or ?user_id=)
            let deepLinkId = null;
            try {
                const url = new URL(window.location.href);
                const idParam = url.searchParams.get('userId') || url.searchParams.get('user_id');
                if (idParam && /^[0-9]+$/.test(idParam)) deepLinkId = parseInt(idParam, 10);
            } catch(_) { /* noop */ }
            
            // Wait a moment for init-shared.js session bootstrap to complete any token refresh
            await new Promise(resolve => setTimeout(resolve, 200));
            
            // Require authentication and proper role before loading content
            const allowed = await ensureSessionAndRole();
            if (!allowed) return;

                        // Listen for global auth required events and show CTA instead of redirect
                        try {
                            window.addEventListener('auth:required', (ev) => {
                                try { showSignInCTA(); } catch(_){}
                                // Return false to signal that the event was not handled if we want fallback redirect
                                return true;
                            });
                        } catch(e) { /* noop */ }
            if (typeof AuditLogger !== 'undefined') { AuditLogger.log('page_access','Accessed User Management page'); }
            // Load users and handle deep-link focus
            (async () => {
                // Pass the token from ensureSessionAndRole directly to the first load
                await loadUsers(1);
                if (deepLinkId) {
                    // If the user is already in the rendered list, highlight and banner
                    if (highlightUserRow(deepLinkId)) {
                        const found = usersState.list.find(u => u.id === deepLinkId);
                        if (found) showDeeplinkBanner(found);
                    } else {
                        // Fetch the specific user and render a focused view
                        try {
                            const token = (window.getToken && window.getToken()) || null;
                            const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                            const res = await fetch(`${FN_BASE}/users/${deepLinkId}`, { headers });
                            if (res.ok) {
                                const data = await res.json();
                                if (data && data.user) {
                                    usersState.list = [data.user];
                                    usersState.pagination = { page:1, limit:1, total:1, pages:1 };
                                    renderUsers();
                                    highlightUserRow(deepLinkId);
                                    showDeeplinkBanner(data.user);
                                }
                            }
                        } catch(_) { /* ignore */ }
                    }
                }
            })();
            loadAndApplySettings();
            document.getElementById('user-form').addEventListener('submit', addOrUpdateUser);
            document.getElementById('cancel-edit').addEventListener('click', cancelEdit);
            
            // Modal event listeners
            document.getElementById('edit-user-form').addEventListener('submit', updateUserFromModal);
            document.getElementById('close-modal').addEventListener('click', closeEditModal);
            document.getElementById('cancel-modal').addEventListener('click', closeEditModal);
            // Close modal when clicking outside
            document.getElementById('edit-user-modal').addEventListener('click', (e) => {
                if (e.target.id === 'edit-user-modal') closeEditModal();
            });
            // Close modal with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !document.getElementById('edit-user-modal').classList.contains('hidden')) {
                    closeEditModal();
                }
            });
            
            // Header actions
            const refreshBtn = document.getElementById('refresh-users');
            if (refreshBtn) refreshBtn.addEventListener('click', ()=> loadUsers(usersState.pagination.page || 1));
            const openAddBtn = document.getElementById('open-add-user');
            if (openAddBtn) openAddBtn.addEventListener('click', ()=> { try { cancelEdit(); } catch(_){} document.getElementById('user-form')?.scrollIntoView({ behavior:'smooth', block:'start' }); });
            document.getElementById('export-users-csv').addEventListener('click', exportUsersCSV);
            document.getElementById('export-users-excel').addEventListener('click', exportUsersExcel);
            document.getElementById('import-users-csv').addEventListener('change', importUsersCSV);
            let filterDebounce = null;
            document.getElementById('user-search').addEventListener('input', e => {
                usersState.filters.search=e.target.value;
                if (filterDebounce) clearTimeout(filterDebounce);
                filterDebounce = setTimeout(()=> loadUsers(1), 250);
            });
            document.getElementById('user-role-filter').addEventListener('change', e => { usersState.filters.role=e.target.value; loadUsers(1); });
            document.getElementById('user-status-filter').addEventListener('change', e => { usersState.filters.status=e.target.value; loadUsers(1); });
            document.getElementById('user-sort').addEventListener('change', e => { usersState.filters.sort=e.target.value; loadUsers(1); });
            const tbody=document.querySelector('tbody');
            tbody.addEventListener('click', async e => {
                const id=e.target.dataset.id; if(!id) return;
                if(e.target.classList.contains('edit-user')) { editUser(parseInt(id)); return; }
                if(e.target.classList.contains('delete-user')) { deleteUser(parseInt(id)); return; }
                const token=(window.getToken && window.getToken()) || null;
                if(e.target.classList.contains('lock-user')){ const u=usersState.list.find(x=>x.id==id); if(!u) return; try { const res=await fetch(`${FN_BASE}/users/${id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', ...(token?{ 'Authorization':`Bearer ${token}` }:{}) }, body:JSON.stringify({ is_active: !u.is_active }) }); if(!res.ok) throw new Error('Failed to update'); showToast(u.is_active?'User locked':'User unlocked','success'); await loadUsers(usersState.pagination.page); } catch(err){ showToast('Error: '+err.message,'error'); } return; }
                if(e.target.classList.contains('reset-password-user')){ 
                    const user = usersState.list.find(u => u.id == id);
                    const userName = user ? (user.name || user.email) : 'this user';
                    const confirmed = await window.ModalUtils.confirm({
                        title: 'Reset Password',
                        message: `Reset password for ${userName}? A temporary password will be generated.`,
                        confirmText: 'Reset',
                        cancelText: 'Cancel',
                        type: 'warning'
                    });
                    if(!confirmed) return;
                    try { 
                        const newPassword=Math.random().toString(36).slice(-10)+'A1!'; 
                        const res=await fetch(`${FN_BASE}/users/${id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', ...(token?{ 'Authorization':`Bearer ${token}` }:{}) }, body:JSON.stringify({ newPassword }) }); 
                        if(!res.ok) throw new Error('Failed to reset'); 
                        await window.ModalUtils.alert({
                            title: 'Password Reset',
                            message: `Temporary password for ${userName}:\n\n${newPassword}\n\nPlease save this password and share it securely with the user.`,
                            type: 'success'
                        });
                    } catch(err){ 
                        showToast('Error: '+err.message,'error'); 
                    } 
                    return; 
                }
                if(e.target.classList.contains('impersonate-user')){ showToast('Impersonation not implemented'); }
            });
        });

        // Mobile menu toggle
        const menuToggle=document.getElementById('menu-toggle');
        const sidebar=document.getElementById('sidebar');
        if(menuToggle && sidebar){ menuToggle.addEventListener('click', ()=>{ sidebar.classList.toggle('open'); menuToggle.setAttribute('aria-expanded', sidebar.classList.contains('open')); }); }

        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("./sw.js")
                    .then(registration => { console.log("SW registered: ", registration); })
                    .catch(registrationError => { console.log("SW registration failed: ", registrationError); });
            });
        }
    </script>
</body>
</html>
