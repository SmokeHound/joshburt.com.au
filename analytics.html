<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for analytics charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Analytics Data Manager -->
    <script src="analytics-manager.js"></script>
    <script>
        // Configuration for dynamic color updates from settings
        function applyDynamicColors() {
            const settingsHead = JSON.parse(localStorage.getItem('siteSettings')) || {};
            // Apply CSS variables for instant color update
            document.documentElement.style.setProperty('--tw-color-primary', settingsHead.primaryColor || '#3b82f6');
            document.documentElement.style.setProperty('--tw-color-secondary', settingsHead.secondaryColor || '#10b981');
            document.documentElement.style.setProperty('--tw-color-accent', settingsHead.accentColor || '#8b5cf6');
        }
        applyDynamicColors();
        // Service Worker Registration for PWA
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("./sw.js")
                    .then(registration => {
                        console.log("SW registered: ", registration);
                    })
                    .catch(registrationError => {
                        console.log("SW registration failed: ", registrationError);
                    });
            });
        }
    </script>
    <style>
        body {
            transition: background-color 0.3s, color 0.3s;
        }
        .dark {
            background-color: #1f2937;
            color: #f9fafb;
        }
        .light {
            background-color: #f9fafb;
            color: #1f2937;
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
        }
        .card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="dark min-h-screen flex flex-col md:flex-row font-sans">
    <!-- Mobile Menu Toggle -->
    <button id="menu-toggle" class="md:hidden fixed top-4 left-4 z-50 p-2 bg-primary text-white rounded-md focus:outline-none focus:ring-2 focus:ring-secondary" aria-label="Toggle sidebar" aria-expanded="false">
        â˜°
    </button>


    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-4 right-4 p-4 bg-accent text-white rounded shadow-lg transition-opacity duration-300" role="alert" aria-live="polite"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar w-64 fixed top-0 left-0 h-full p-4 flex flex-col shadow-lg md:static md:translate-x-0" aria-label="Main navigation">
        <!-- App Branding -->
        <h1 class="text-2xl font-bold mb-6 text-white">Josh's App</h1>

        <!-- Navigation -->
        <nav>
            <ul class="space-y-2">
                <li><a href="index.html" class="block p-2 hover:bg-primary hover:text-white rounded focus:outline-none focus:ring-2 focus:ring-secondary">Home</a></li>
                <li><a href="admin.html" class="block p-2 hover:bg-primary hover:text-white rounded focus:outline-none focus:ring-2 focus:ring-secondary">Admin</a></li>
                <li><a href="users.html" class="block p-2 hover:bg-primary hover:text-white rounded focus:outline-none focus:ring-2 focus:ring-secondary">User Management</a></li>
                <li><a href="analytics.html" class="block p-2 bg-primary text-white rounded focus:outline-none focus:ring-2 focus:ring-secondary" aria-current="page">Analytics</a></li>
                <li><a href="settings.html" class="block p-2 hover:bg-primary hover:text-white rounded focus:outline-none focus:ring-2 focus:ring-secondary">Settings</a></li>
                <li><a href="oil.html" class="block p-2 hover:bg-primary hover:text-white rounded focus:outline-none focus:ring-2 focus:ring-secondary">Oil Orders</a></li>
                <li><a href="login.html" class="block p-2 hover:bg-red-500 hover:text-white rounded focus:outline-none focus:ring-2 focus:ring-red-400">Logout</a></li>

            </ul>
        </nav>

        <!-- Theme Toggle -->
        <div class="mt-auto">
            <button id="theme-toggle" class="w-full p-2 bg-primary text-white rounded hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-secondary" aria-label="Toggle light mode">
                Toggle Light Mode
            </button>

        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-4">
        <!-- Sticky Header -->
        <header class="sticky top-0 bg-gray-700 dark:bg-gray-700 p-4 rounded shadow mb-6 z-10">
            <h2 class="text-3xl font-semibold" id="welcome-message">Analytics Dashboard</h2>
        </header>

        <!-- Filters and Export Controls -->
        <section class="mb-6">
            <div class="bg-gray-700 dark:bg-gray-700 p-4 rounded shadow">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Filters & Export</h3>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-400">Last Updated:</span>
                        <span id="last-updated" class="text-sm text-green-400">Loading...</span>
                        <button id="refresh-data" class="px-2 py-1 bg-primary text-white rounded text-sm hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-primary">
                            ðŸ”„ Refresh
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <!-- Date Range Filter -->
                    <div>
                        <label class="block text-sm font-medium mb-2">Date Range</label>
                        <select id="date-range" class="w-full p-2 bg-gray-600 text-white rounded border border-gray-500 focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="365">Last year</option>
                        </select>
                    </div>
                    
                    <!-- User Type Filter -->
                    <div>
                        <label class="block text-sm font-medium mb-2">User Type</label>
                        <select id="user-type" class="w-full p-2 bg-gray-600 text-white rounded border border-gray-500 focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="all" selected>All Users</option>
                            <option value="admin">Admin Users</option>
                            <option value="user">Regular Users</option>
                        </select>
                    </div>
                    
                    <!-- Export Options -->
                    <div class="flex flex-col gap-2">
                        <label class="block text-sm font-medium">Export Options</label>
                        <div class="flex gap-2">
                            <button id="export-csv" class="px-3 py-2 bg-secondary text-white rounded hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-secondary">
                                Export CSV
                            </button>
                            <button id="export-pdf" class="px-3 py-2 bg-accent text-white rounded hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-accent">
                                Export PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Real-time Statistics -->
        <section class="mb-6">
            <div class="bg-gray-700 dark:bg-gray-700 p-4 rounded shadow">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <span class="w-3 h-3 bg-green-400 rounded-full animate-pulse mr-2"></span>
                    Real-time Statistics
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-400" id="active-users">-</div>
                        <div class="text-sm text-gray-400">Active Users</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-400" id="current-page-views">-</div>
                        <div class="text-sm text-gray-400">Page Views (Hour)</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-yellow-400" id="server-status">-</div>
                        <div class="text-sm text-gray-400">Server Status</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-400" id="total-users">-</div>
                        <div class="text-sm text-gray-400">Total Users</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Charts Section -->
        <section class="mb-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Visitor Trends Chart -->
                <div class="p-4 bg-gray-700 dark:bg-gray-700 rounded shadow card">
                    <h3 class="font-semibold mb-4">Visitor Trends</h3>
                    <canvas id="visitor-chart" width="400" height="200"></canvas>
                </div>
                
                <!-- User Engagement Chart -->
                <div class="p-4 bg-gray-700 dark:bg-gray-700 rounded shadow card">
                    <h3 class="font-semibold mb-4">User Engagement</h3>
                    <canvas id="engagement-chart" width="400" height="200"></canvas>
                </div>
            </div>
        </section>

        <!-- Product Sales Chart -->
        <section class="mb-6">
            <div class="p-4 bg-gray-700 dark:bg-gray-700 rounded shadow card">
                <h3 class="font-semibold mb-4">Product Sales Analytics</h3>
                <canvas id="sales-chart" width="800" height="300"></canvas>
            </div>
        </section>

        <!-- Statistics Cards -->
        <section>
            <p class="mb-4">Real-time statistics and key metrics from your analytics data.</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="p-4 bg-gray-700 dark:bg-gray-700 rounded shadow card">
                    <h3 class="font-semibold mb-2">Visitor Statistics</h3>
                    <ul id="visitor-stats" class="list-disc pl-5 text-gray-300 space-y-1">
                        <li>Loading...</li>
                    </ul>
                </div>
                <div class="p-4 bg-gray-700 dark:bg-gray-700 rounded shadow card">
                    <h3 class="font-semibold mb-2">User Engagement</h3>
                    <ul id="engagement-stats" class="list-disc pl-5 text-gray-300 space-y-1">
                        <li>Loading...</li>
                    </ul>
                </div>
                <div class="p-4 bg-gray-700 dark:bg-gray-700 rounded shadow card">
                    <h3 class="font-semibold mb-2">Top Pages</h3>
                    <ol id="top-pages" class="list-decimal pl-5 text-gray-300 space-y-1">
                        <li>Loading...</li>
                    </ol>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Global variables for charts
        let visitorChart, engagementChart, salesChart;
        let currentFilters = {
            dateRange: 30,
            userType: 'all'
        };

        // Show toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Load and apply site settings
        function loadAndApplySettings() {
            const settings = JSON.parse(localStorage.getItem('siteSettings')) || {};
            
            // Apply site title if set
            if (settings['site-title']) {
                const brandingElements = document.querySelectorAll('h1');
                brandingElements.forEach(el => {
                    if (el.textContent.includes('Josh\'s App')) {
                        el.textContent = settings['site-title'];
                    }
                });
            }
        }

        // Generate mock analytics data based on filters
        function generateAnalyticsData(filters) {
            // Use the new analytics manager
            if (window.analyticsManager) {
                const analyticsData = window.analyticsManager.getData(filters);
                if (analyticsData) {
                    return processAnalyticsData(analyticsData.data, filters);
                }
            }
            
            // Fallback to original mock data generation
            const days = filters.dateRange;
            const userType = filters.userType;
            const users = JSON.parse(localStorage.getItem('siteUsers') || '[]');
            
            // Filter users by type
            let filteredUsers = users;
            if (userType === 'admin') {
                filteredUsers = users.filter(u => u.role === 'admin');
            } else if (userType === 'user') {
                filteredUsers = users.filter(u => u.role === 'user');
            }
            
            // Generate visitor trend data
            const visitorData = [];
            const labels = [];
            const baseVisitors = Math.max(filteredUsers.length * 10, 50);
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString());
                
                // Simulate visitor patterns (weekends lower, recent days higher)
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const trendMultiplier = 1 + (days - i) / days * 0.3; // Recent growth
                const weekendMultiplier = isWeekend ? 0.7 : 1;
                const randomVariation = 0.8 + Math.random() * 0.4;
                
                const visitors = Math.floor(baseVisitors * trendMultiplier * weekendMultiplier * randomVariation);
                visitorData.push(visitors);
            }
            
            // Generate engagement data
            const engagementData = {
                bounceRate: 30 + Math.random() * 40, // 30-70%
                avgSessionDuration: 180 + Math.random() * 300, // 3-8 minutes
                pagesPerSession: 2 + Math.random() * 3, // 2-5 pages
                returnVisitorRate: 20 + Math.random() * 30 // 20-50%
            };
            
            // Generate product sales data (from oil orders)
            const salesData = {
                labels: ['Castrol GTX', 'Castrol Magnatec', 'Castrol EDGE', 'Castrol GTX Diesel', 'Castrol Actevo'],
                data: [
                    Math.floor(Math.random() * 50 + 10),
                    Math.floor(Math.random() * 40 + 15),
                    Math.floor(Math.random() * 60 + 20),
                    Math.floor(Math.random() * 30 + 5),
                    Math.floor(Math.random() * 25 + 8)
                ]
            };
            
            return {
                visitors: { labels, data: visitorData },
                engagement: engagementData,
                sales: salesData,
                summary: {
                    totalUsers: filteredUsers.length,
                    activeSession: JSON.parse(localStorage.getItem('user') || 'null') ? 1 : 0,
                    adminUsers: users.filter(u => u.role === 'admin').length,
                    regularUsers: users.filter(u => u.role === 'user').length,
                    totalVisitors: visitorData.reduce((a, b) => a + b, 0),
                    avgDailyVisitors: Math.floor(visitorData.reduce((a, b) => a + b, 0) / visitorData.length)
                }
            };
        }

        // Process analytics data from the manager
        function processAnalyticsData(data, filters) {
            const visitorData = data.visitors || [];
            const labels = visitorData.map(v => new Date(v.date).toLocaleDateString());
            const visitors = visitorData.map(v => v.totalVisitors);
            
            // Calculate engagement metrics from session data
            const sessions = data.userSessions || [];
            const avgBounceRate = sessions.reduce((sum, s) => sum + s.bounceRate, 0) / sessions.length || 0;
            const avgSessionDuration = sessions.reduce((sum, s) => sum + s.avgSessionDuration, 0) / sessions.length || 0;
            const avgPagesPerSession = sessions.reduce((sum, s) => sum + s.pagesPerSession, 0) / sessions.length || 0;
            
            // Calculate return visitor rate
            const totalVisitors = visitorData.reduce((sum, v) => sum + v.totalVisitors, 0);
            const totalReturning = visitorData.reduce((sum, v) => sum + v.returningVisitors, 0);
            const returnVisitorRate = totalVisitors > 0 ? (totalReturning / totalVisitors) * 100 : 0;
            
            // Process oil orders data
            const orderData = data.oilOrders || [];
            const productSales = {};
            const productNames = ['Castrol GTX', 'Castrol Magnatec', 'Castrol EDGE', 'Castrol GTX Diesel', 'Castrol Actevo'];
            
            productNames.forEach(product => {
                productSales[product] = orderData.reduce((sum, day) => {
                    return sum + (day.products[product]?.orders || 0);
                }, 0);
            });
            
            return {
                visitors: { labels, data: visitors },
                engagement: {
                    bounceRate: avgBounceRate * 100,
                    avgSessionDuration: avgSessionDuration,
                    pagesPerSession: avgPagesPerSession,
                    returnVisitorRate: returnVisitorRate
                },
                sales: {
                    labels: productNames,
                    data: productNames.map(name => productSales[name])
                },
                summary: {
                    totalUsers: JSON.parse(localStorage.getItem('siteUsers') || '[]').length,
                    activeSession: JSON.parse(localStorage.getItem('user') || 'null') ? 1 : 0,
                    adminUsers: JSON.parse(localStorage.getItem('siteUsers') || '[]').filter(u => u.role === 'admin').length,
                    regularUsers: JSON.parse(localStorage.getItem('siteUsers') || '[]').filter(u => u.role === 'user').length,
                    totalVisitors: totalVisitors,
                    avgDailyVisitors: Math.floor(totalVisitors / visitorData.length)
                }
            };
        }

        // Initialize charts
        function initializeCharts() {
            const data = generateAnalyticsData(currentFilters);
            
            // Check if Chart.js is available
            if (!window.Chart) {
                // Fallback: Replace canvas elements with text summaries
                const visitorCanvas = document.getElementById('visitor-chart');
                const engagementCanvas = document.getElementById('engagement-chart');
                const salesCanvas = document.getElementById('sales-chart');
                
                if (visitorCanvas) {
                    visitorCanvas.parentElement.innerHTML = `
                        <h3 class="font-semibold mb-4">Visitor Trends</h3>
                        <div class="text-gray-300 space-y-2">
                            <p><strong>Chart unavailable (CDN blocked)</strong></p>
                            <p>Total Visitors: ${data.summary.totalVisitors}</p>
                            <p>Average Daily: ${data.summary.avgDailyVisitors}</p>
                            <p>Peak Day: ${Math.max(...data.visitors.data)} visitors</p>
                        </div>
                    `;
                }
                
                if (engagementCanvas) {
                    engagementCanvas.parentElement.innerHTML = `
                        <h3 class="font-semibold mb-4">User Engagement</h3>
                        <div class="text-gray-300 space-y-2">
                            <p><strong>Chart unavailable (CDN blocked)</strong></p>
                            <p>Bounce Rate: ${data.engagement.bounceRate.toFixed(1)}%</p>
                            <p>Return Rate: ${data.engagement.returnVisitorRate.toFixed(1)}%</p>
                            <p>Avg Session: ${Math.floor(data.engagement.avgSessionDuration / 60)}m</p>
                        </div>
                    `;
                }
                
                if (salesCanvas) {
                    salesCanvas.parentElement.innerHTML = `
                        <h3 class="font-semibold mb-4">Product Sales Analytics</h3>
                        <div class="text-gray-300 space-y-2">
                            <p><strong>Chart unavailable (CDN blocked)</strong></p>
                            ${data.sales.labels.map((product, i) => 
                                `<p>${product}: ${data.sales.data[i]} units</p>`
                            ).join('')}
                        </div>
                    `;
                }
                return;
            }
            
            // Visitor Trends Chart
            const visitorCtx = document.getElementById('visitor-chart').getContext('2d');
            visitorChart = new Chart(visitorCtx, {
                type: 'line',
                data: {
                    labels: data.visitors.labels,
                    datasets: [{
                        label: 'Daily Visitors',
                        data: data.visitors.data,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#f9fafb' }
                        }
                    },
                    scales: {
                        x: { 
                            ticks: { color: '#f9fafb' },
                            grid: { color: 'rgba(249, 250, 251, 0.1)' }
                        },
                        y: { 
                            ticks: { color: '#f9fafb' },
                            grid: { color: 'rgba(249, 250, 251, 0.1)' }
                        }
                    }
                }
            });
            
            // User Engagement Chart (Doughnut)
            const engagementCtx = document.getElementById('engagement-chart').getContext('2d');
            engagementChart = new Chart(engagementCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Return Visitors', 'New Visitors', 'Bounced Sessions', 'Engaged Sessions'],
                    datasets: [{
                        data: [
                            data.engagement.returnVisitorRate,
                            100 - data.engagement.returnVisitorRate,
                            data.engagement.bounceRate,
                            100 - data.engagement.bounceRate
                        ],
                        backgroundColor: [
                            'rgb(16, 185, 129)',
                            'rgb(59, 130, 246)', 
                            'rgb(239, 68, 68)',
                            'rgb(139, 92, 246)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#f9fafb' }
                        }
                    }
                }
            });
            
            // Product Sales Chart (Bar)
            const salesCtx = document.getElementById('sales-chart').getContext('2d');
            salesChart = new Chart(salesCtx, {
                type: 'bar',
                data: {
                    labels: data.sales.labels,
                    datasets: [{
                        label: 'Units Sold',
                        data: data.sales.data,
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderColor: [
                            'rgb(239, 68, 68)',
                            'rgb(16, 185, 129)',
                            'rgb(59, 130, 246)',
                            'rgb(139, 92, 246)',
                            'rgb(245, 158, 11)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#f9fafb' }
                        }
                    },
                    scales: {
                        x: { 
                            ticks: { color: '#f9fafb' },
                            grid: { color: 'rgba(249, 250, 251, 0.1)' }
                        },
                        y: { 
                            ticks: { color: '#f9fafb' },
                            grid: { color: 'rgba(249, 250, 251, 0.1)' }
                        }
                    }
                }
            });
        }

        // Update analytics data and charts
        function updateAnalytics() {
            const data = generateAnalyticsData(currentFilters);
            
            // Update charts
            if (visitorChart) {
                visitorChart.data.labels = data.visitors.labels;
                visitorChart.data.datasets[0].data = data.visitors.data;
                visitorChart.update();
            }
            
            if (engagementChart) {
                engagementChart.data.datasets[0].data = [
                    data.engagement.returnVisitorRate,
                    100 - data.engagement.returnVisitorRate,
                    data.engagement.bounceRate,
                    100 - data.engagement.bounceRate
                ];
                engagementChart.update();
            }
            
            if (salesChart) {
                salesChart.data.datasets[0].data = data.sales.data;
                salesChart.update();
            }
            
            // Update statistics cards
            updateStatCard('visitor-stats', [
                `Total Users: ${data.summary.totalUsers}`,
                `Total Visitors (${currentFilters.dateRange}d): ${data.summary.totalVisitors}`,
                `Avg Daily Visitors: ${data.summary.avgDailyVisitors}`,
                `Active Session: ${data.summary.activeSession > 0 ? 'Yes' : 'No'}`
            ]);
            
            updateStatCard('engagement-stats', [
                `Bounce Rate: ${data.engagement.bounceRate.toFixed(1)}%`,
                `Avg Session: ${Math.floor(data.engagement.avgSessionDuration / 60)}m ${Math.floor(data.engagement.avgSessionDuration % 60)}s`,
                `Pages/Session: ${data.engagement.pagesPerSession.toFixed(1)}`,
                `Return Rate: ${data.engagement.returnVisitorRate.toFixed(1)}%`
            ]);
            
            updateStatCard('top-pages', [
                'Analytics Dashboard',
                'Oil Orders System', 
                'User Management',
                'Settings Page',
                'Admin Dashboard'
            ]);
        }
        
        function updateStatCard(cardType, items) {
            let listElement;
            if (cardType === 'visitor-stats') {
                listElement = document.getElementById('visitor-stats');
            } else if (cardType === 'engagement-stats') {
                listElement = document.getElementById('engagement-stats');
            } else if (cardType === 'top-pages') {
                listElement = document.getElementById('top-pages');
            }
            
            if (listElement) {
                listElement.innerHTML = '';
                items.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    listElement.appendChild(li);
                });
            }
        }

        // CSV Export functionality
        function exportCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Use analytics manager if available
            if (window.analyticsManager) {
                csvContent += window.analyticsManager.exportData('csv', currentFilters.dateRange);
            } else {
                // Fallback to original CSV export
                const data = generateAnalyticsData(currentFilters);
                csvContent += "Date,Visitors\n";
                data.visitors.labels.forEach((label, index) => {
                    csvContent += `${label},${data.visitors.data[index]}\n`;
                });
                
                // Add summary statistics
                csvContent += "\nSummary Statistics\n";
                csvContent += `Total Users,${data.summary.totalUsers}\n`;
                csvContent += `Total Visitors (${currentFilters.dateRange}d),${data.summary.totalVisitors}\n`;
                csvContent += `Average Daily Visitors,${data.summary.avgDailyVisitors}\n`;
                csvContent += `Bounce Rate,${data.engagement.bounceRate.toFixed(1)}%\n`;
                csvContent += `Average Session Duration,${Math.floor(data.engagement.avgSessionDuration / 60)}m ${Math.floor(data.engagement.avgSessionDuration % 60)}s\n`;
                csvContent += `Pages per Session,${data.engagement.pagesPerSession.toFixed(1)}\n`;
            }
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `analytics-report-${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Enhanced CSV report exported successfully!');
        }

        // Update real-time statistics
        function updateRealtimeStats() {
            if (window.analyticsManager) {
                const realtimeStats = window.analyticsManager.getRealtimeStats();
                
                document.getElementById('active-users').textContent = realtimeStats.activeUsers;
                document.getElementById('current-page-views').textContent = realtimeStats.currentPageViews;
                document.getElementById('server-status').textContent = realtimeStats.serverStatus;
                document.getElementById('total-users').textContent = realtimeStats.totalUsers;
                
                // Update last updated timestamp
                const lastUpdatedElement = document.getElementById('last-updated');
                if (lastUpdatedElement) {
                    const date = new Date(realtimeStats.lastUpdate);
                    lastUpdatedElement.textContent = date.toLocaleTimeString();
                }
            }
        }

        // Refresh analytics data
        function refreshAnalyticsData() {
            if (window.analyticsManager) {
                // Force refresh of analytics data
                window.analyticsManager.createInitialData();
                updateAnalytics();
                updateRealtimeStats();
                showToast('Analytics data refreshed successfully!');
            }
        }

        // PDF Export functionality
        function exportPDF() {
            // Check if jsPDF is available
            if (!window.jspdf || !window.jspdf.jsPDF) {
                showToast('PDF export not available - CDN blocked. Using CSV fallback.');
                exportCSV();
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const data = generateAnalyticsData(currentFilters);
            
            // Add title
            doc.setFontSize(20);
            doc.text('Analytics Report', 20, 30);
            
            // Add date range
            doc.setFontSize(12);
            doc.text(`Date Range: Last ${currentFilters.dateRange} days`, 20, 45);
            doc.text(`User Filter: ${currentFilters.userType === 'all' ? 'All Users' : currentFilters.userType + ' Users'}`, 20, 55);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 65);
            
            // Add summary statistics
            doc.setFontSize(14);
            doc.text('Summary Statistics', 20, 85);
            doc.setFontSize(10);
            let yPos = 95;
            
            const summaryStats = [
                `Total Users: ${data.summary.totalUsers}`,
                `Total Visitors (${currentFilters.dateRange}d): ${data.summary.totalVisitors}`,
                `Average Daily Visitors: ${data.summary.avgDailyVisitors}`,
                `Bounce Rate: ${data.engagement.bounceRate.toFixed(1)}%`,
                `Average Session Duration: ${Math.floor(data.engagement.avgSessionDuration / 60)}m ${Math.floor(data.engagement.avgSessionDuration % 60)}s`,
                `Pages per Session: ${data.engagement.pagesPerSession.toFixed(1)}`,
                `Return Visitor Rate: ${data.engagement.returnVisitorRate.toFixed(1)}%`
            ];
            
            summaryStats.forEach(stat => {
                doc.text(stat, 25, yPos);
                yPos += 10;
            });
            
            // Add product sales section
            doc.setFontSize(14);
            doc.text('Product Sales', 20, yPos + 15);
            doc.setFontSize(10);
            yPos += 25;
            
            data.sales.labels.forEach((product, index) => {
                doc.text(`${product}: ${data.sales.data[index]} units`, 25, yPos);
                yPos += 8;
            });
            
            // Add visitor trend data (sample)
            doc.setFontSize(14);
            doc.text('Recent Visitor Trends', 20, yPos + 15);
            doc.setFontSize(10);
            yPos += 25;
            
            const recentDays = data.visitors.labels.slice(-7);
            const recentData = data.visitors.data.slice(-7);
            
            recentDays.forEach((date, index) => {
                if (yPos > 250) { // Start new page if needed
                    doc.addPage();
                    yPos = 30;
                }
                doc.text(`${date}: ${recentData[index]} visitors`, 25, yPos);
                yPos += 8;
            });
            
            doc.save(`analytics-report-${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('PDF report exported successfully!');
        }

        // Filter change handlers
        function setupFilterHandlers() {
            document.getElementById('date-range').addEventListener('change', (e) => {
                currentFilters.dateRange = parseInt(e.target.value);
                updateAnalytics();
                showToast(`Updated data for last ${currentFilters.dateRange} days`);
            });
            
            document.getElementById('user-type').addEventListener('change', (e) => {
                currentFilters.userType = e.target.value;
                updateAnalytics();
                showToast(`Filtered by ${currentFilters.userType === 'all' ? 'all users' : currentFilters.userType + ' users'}`);
            });
            
            document.getElementById('export-csv').addEventListener('click', exportCSV);
            document.getElementById('export-pdf').addEventListener('click', exportPDF);
            
            // Add refresh button handler
            const refreshBtn = document.getElementById('refresh-data');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', refreshAnalyticsData);
            }
        }

        // Theme Toggle
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;
        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark');
            body.classList.toggle('light');
            localStorage.setItem('theme', body.classList.contains('dark') ? 'dark' : 'light');
            themeToggle.textContent = body.classList.contains('dark') ? 'Toggle Light Mode' : 'Toggle Dark Mode';
            themeToggle.setAttribute('aria-label', body.classList.contains('dark') ? 'Toggle light mode' : 'Toggle dark mode');
        });

        // Load saved theme from settings or localStorage
        const settings = JSON.parse(localStorage.getItem('siteSettings')) || {};
        const savedTheme = settings['theme'] || localStorage.getItem('theme') || 'dark';
        body.classList.add(savedTheme);
        themeToggle.textContent = savedTheme === 'dark' ? 'Toggle Light Mode' : 'Toggle Dark Mode';
        themeToggle.setAttribute('aria-label', savedTheme === 'dark' ? 'Toggle light mode' : 'Toggle dark mode');

        // Mobile Menu Toggle
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            const isOpen = sidebar.classList.contains('open');
            menuToggle.setAttribute('aria-expanded', isOpen);
        });
        
        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadAndApplySettings();
            setupFilterHandlers();
            
            // Initialize charts after a short delay to ensure DOM is ready
            setTimeout(() => {
                initializeCharts();
                updateAnalytics();
                updateRealtimeStats();
                
                // Set up real-time updates every 30 seconds
                setInterval(updateRealtimeStats, 30000);
            }, 100);
        });
    </script>
</body>
</html>
