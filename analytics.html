<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Analytics</title>
  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="/assets/images/logo-placeholder.svg" />
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <script src="/assets/js/init-shared.js" defer></script>
  <script src="/assets/js/feature-flags.js" defer></script>
  <script>
    // Purge legacy role demo key to avoid stale UI state
    try { localStorage.removeItem('currentUser'); } catch (_) {}
  </script>
  <script>
    // Defer heavy analytics deps and then load manager
    (async()=>{
      if(!window.Chart){ await import('https://cdn.jsdelivr.net/npm/chart.js'); }
      if(!window.jspdf || !window.jspdf.jsPDF){ await import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'); }
      const s=document.createElement('script'); s.src='/analytics-manager.js'; s.defer=true; document.head.appendChild(s);
    })();
  </script>
  <link rel="stylesheet" href="/assets/css/accessibility.css" />
  <script src="/assets/js/accessibility.js" defer></script>
</head>
<body class="min-h-screen flex flex-col md:flex-row font-sans">
  
  <div id="main-nav"></div>
  <main id="main-content" class="flex-1 p-4 space-y-6" role="main">
  <header class="page-header ui-card border">
      <h1 class="text-2xl font-bold">Analytics Dashboard</h1>
  <p class="text-sm text-[color:var(--token-text-muted)] mt-1">Business metrics, orders, inventory & returns overview</p>
    </header>
    <section class="space-y-4">
      <div class="flex flex-wrap gap-2" id="quick-date-chips"></div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <label class="block text-sm font-semibold mb-2">Date Range</label>
          <select id="date-range" class="w-full p-3 rounded-lg bg-[color:var(--token-bg-elevated)] text-[color:var(--token-text-primary)] border border-[color:var(--token-border-default)] focus:outline-none focus:border-[color:var(--token-color-primary)] focus:shadow-[var(--token-shadow-glow-primary)]">
            <option value="7">Last 7 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
            <option value="365">Last year</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-2">User Type</label>
          <select id="user-type" class="w-full p-3 rounded-lg bg-[color:var(--token-bg-elevated)] text-[color:var(--token-text-primary)] border border-[color:var(--token-border-default)] focus:outline-none focus:border-[color:var(--token-color-primary)] focus:shadow-[var(--token-shadow-glow-primary)]">
            <option value="all" selected>All Users</option>
            <option value="admin">Admin Users</option>
            <option value="user">Regular Users</option>
          </select>
        </div>
        <div class="flex flex-col gap-2">
          <label class="block text-sm font-semibold">Export</label>
          <div class="flex gap-2">
            <button id="export-csv" class="ui-btn ui-btn-secondary flex-1 px-3 py-2 rounded-lg">CSV</button>
            <button id="export-pdf" class="ui-btn ui-btn-primary flex-1 px-3 py-2 rounded-lg">PDF</button>
            <button id="export-png" class="ui-btn ui-btn-primary flex-1 px-3 py-2 rounded-lg">PNG</button>
          </div>
        </div>
      </div>
      <div class="w-full text-center text-xs text-[color:var(--token-text-muted)] flex items-center justify-center gap-2">
        <span id="last-updated">Last updated: --</span>
        <button id="refresh-btn" class="ml-2 ui-btn ui-btn-outline px-2 py-1 rounded text-xs">âŸ³ Refresh</button>
        <span class="text-[color:var(--token-text-muted)] text-xs ml-2" id="auto-refresh-label">(auto every 60s)</span>
      </div>
    </section>
    <section class="mb-2">
      <div class="card ui-card ui-card-secondary rounded-lg shadow-md p-6">
        <h2 class="text-lg font-semibold mb-4 flex items-center"><span class="w-3 h-3 bg-[color:var(--token-color-success)] rounded-full animate-pulse mr-3"></span>Business Overview</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="text-center"><div class="text-2xl font-bold text-[color:var(--token-color-success)]" id="total-orders">-</div><div class="text-xs text-[color:var(--token-text-muted)]">Total Orders</div></div>
          <div class="text-center"><div class="text-2xl font-bold text-[color:var(--token-color-primary)]" id="pending-orders">-</div><div class="text-xs text-[color:var(--token-text-muted)]">Pending Orders</div></div>
          <div class="text-center"><div class="text-2xl font-bold text-[color:var(--token-color-warning)]" id="low-stock-items">-</div><div class="text-xs text-[color:var(--token-text-muted)]">Low Stock Items</div></div>
          <div class="text-center"><div class="text-2xl font-bold text-[color:var(--token-color-accent)]" id="pending-returns">-</div><div class="text-xs text-[color:var(--token-text-muted)]">Pending Returns</div></div>
        </div>
      </div>
    </section>
    <section class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="card p-4 ui-card ui-card-primary rounded-lg"><h3 class="text-sm font-semibold mb-1">Order Fulfillment</h3><div id="insight-conversion" class="text-xl font-bold">--%</div></div>
      <div class="card p-4 ui-card ui-card-secondary rounded-lg"><h3 class="text-sm font-semibold mb-1">Avg Order Value</h3><div id="insight-retention" class="text-xl font-bold">$--</div></div>
      <div class="card p-4 ui-card ui-card-accent rounded-lg"><h3 class="text-sm font-semibold mb-1">Top Product</h3><div id="insight-top-product" class="text-xl font-bold">--</div></div>
      <div class="ui-card p-4 widget-yellow rounded-lg"><h3 class="text-sm font-semibold mb-1">Returns Rate</h3><div id="insight-returns-rate" class="text-xl font-bold">--%</div></div>
    </section>
    <div id="status-bar" class="w-full flex flex-wrap items-center justify-center gap-4 py-2 px-4 ui-card text-sm">
      <span id="status-api" class="inline-flex items-center"><span class="w-2 h-2 rounded-full mr-2 bg-[color:var(--token-text-muted)]"></span>API: <span class="ml-1">Checking...</span></span>
      <span id="status-db" class="inline-flex items-center"><span class="w-2 h-2 rounded-full mr-2 bg-[color:var(--token-text-muted)]"></span>Database: <span class="ml-1">Checking...</span></span>
      <span id="status-server" class="inline-flex items-center"><span class="w-2 h-2 rounded-full mr-2 bg-[color:var(--token-text-muted)]"></span>Server: <span class="ml-1">Checking...</span></span>
    </div>
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <div class="card ui-card ui-card-primary p-6 rounded-lg shadow-md"><h3 class="text-base font-semibold mb-4 flex items-center gap-2"><span class="inline-block w-2 h-2 bg-[color:var(--token-color-primary)] rounded-full"></span>Daily Orders</h3><div class="h-72"><canvas id="visitor-chart"></canvas></div></div>
  <div class="card ui-card ui-card-secondary p-6 rounded-lg shadow-md"><h3 class="text-base font-semibold mb-4 flex items-center gap-2"><span class="inline-block w-2 h-2 bg-[color:var(--token-color-success)] rounded-full"></span>Order Status Distribution</h3><div class="h-72"><canvas id="engagement-chart"></canvas></div></div>
  <div class="card ui-card ui-card-accent p-6 rounded-lg shadow-md lg:col-span-2"><h3 class="text-base font-semibold mb-4 flex items-center gap-2"><span class="inline-block w-2 h-2 bg-[color:var(--token-color-accent)] rounded-full"></span>Top Products by Orders</h3><div class="h-80"><canvas id="sales-chart"></canvas></div></div>
    </section>
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="card ui-card ui-card-primary p-6 rounded-lg shadow-md"><h3 class="text-base font-semibold mb-2">Order Statistics</h3><ul id="visitor-stats" class="list-disc pl-5 space-y-1 text-[color:var(--token-text-secondary)]"><li>Loading...</li></ul></div>
      <div class="card ui-card ui-card-secondary p-6 rounded-lg shadow-md"><h3 class="text-base font-semibold mb-2">Inventory Summary</h3><ul id="engagement-stats" class="list-disc pl-5 space-y-1 text-[color:var(--token-text-secondary)]"><li>Loading...</li></ul></div>
      <div class="card ui-card ui-card-accent p-6 rounded-lg shadow-md"><h3 class="text-base font-semibold mb-2">Returns Overview</h3><ul id="returns-stats" class="list-disc pl-5 space-y-1 text-[color:var(--token-text-secondary)]"><li>Loading...</li></ul></div>
    </section>
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="ui-card p-4 rounded-lg"><h3 class="text-sm font-semibold mb-2">User Breakdown</h3><ul id="user-breakdown-list" class="space-y-1 text-sm"></ul></div>
      <div class="ui-card p-4 rounded-lg"><h3 class="text-sm font-semibold mb-2">User Growth (30d)</h3><canvas id="user-growth-sparkline" width="180" height="60"></canvas></div>
      <div class="ui-card p-4 rounded-lg"><h3 class="text-sm font-semibold mb-2">Top Users</h3><ul id="top-users-list" class="flex flex-col gap-1 text-sm"></ul><div class="mt-3 flex gap-2 items-center text-xs"><label for="user-role-filter">Role:</label><select id="user-role-filter" class="rounded px-2 py-1 text-xs bg-[color:var(--token-bg-elevated)] text-[color:var(--token-text-primary)] border border-[color:var(--token-border-default)] focus:outline-none focus:border-[color:var(--token-color-primary)] focus:shadow-[var(--token-shadow-glow-primary)]"><option value="all">All</option><option value="admin">Admin</option><option value="user">User</option><option value="locked">Locked</option></select></div><div class="mt-2 flex gap-2 items-center text-xs"><label for="user-date-filter">Since:</label><input type="date" id="user-date-filter" class="rounded px-2 py-1 text-xs bg-[color:var(--token-bg-elevated)] text-[color:var(--token-text-primary)] border border-[color:var(--token-border-default)] focus:outline-none focus:border-[color:var(--token-color-primary)] focus:shadow-[var(--token-shadow-glow-primary)]" /></div><button id="export-user-analytics" class="mt-3 w-full ui-btn ui-btn-outline ui-btn-sm">Export Users CSV</button></div>
    </section>

    <!-- Advanced Reports Section (Feature Flag Gated) -->
    <section id="advanced-reports-section" class="hidden mt-8">
      <div class="ui-card p-6 rounded-lg border-2 border-[color:var(--token-color-accent)]">
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <h2 class="text-xl font-bold text-[color:var(--token-color-accent)]">ðŸ“Š Advanced Reports</h2>
            <span class="text-xs bg-[color:var(--token-color-accent)] text-[color:var(--token-text-on-accent)] px-2 py-1 rounded">PREMIUM</span>
          </div>
          <button id="generate-advanced-report" class="ui-btn ui-btn-accent">
            Generate Report
          </button>
        </div>

        <!-- Report Configuration -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <div>
            <label class="block text-sm font-semibold mb-2">Report Type</label>
            <select id="report-type" class="w-full p-3 rounded-lg bg-[color:var(--token-bg-elevated)] text-[color:var(--token-text-primary)] border border-[color:var(--token-border-default)] focus:outline-none focus:border-[color:var(--token-color-primary)] focus:shadow-[var(--token-shadow-glow-primary)]">
              <option value="comprehensive">Comprehensive Analysis</option>
              <option value="predictive">Predictive Analytics</option>
              <option value="comparative">Comparative Report</option>
              <option value="behavioral">User Behavior Analysis</option>
              <option value="revenue">Revenue Forecast</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2">Time Period</label>
            <select id="report-period" class="w-full p-3 rounded-lg bg-[color:var(--token-bg-elevated)] text-[color:var(--token-text-primary)] border border-[color:var(--token-border-default)] focus:outline-none focus:border-[color:var(--token-color-primary)] focus:shadow-[var(--token-shadow-glow-primary)]">
              <option value="7">Last 7 days</option>
              <option value="30">Last 30 days</option>
              <option value="90">Last 90 days</option>
              <option value="365">Last year</option>
              <option value="custom">Custom Range</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2">Export Format</label>
            <select id="report-format" class="w-full p-3 rounded-lg bg-[color:var(--token-bg-elevated)] text-[color:var(--token-text-primary)] border border-[color:var(--token-border-default)] focus:outline-none focus:border-[color:var(--token-color-primary)] focus:shadow-[var(--token-shadow-glow-primary)]">
              <option value="pdf">PDF Report</option>
              <option value="excel">Excel Spreadsheet</option>
              <option value="json">JSON Data</option>
              <option value="dashboard">Interactive Dashboard</option>
            </select>
          </div>
        </div>

        <!-- Advanced Metrics Grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-[color:var(--token-bg-elevated)] border border-[color:var(--token-border-default)] p-4 rounded-lg text-center">
            <div class="text-xs text-[color:var(--token-text-muted)] mb-1">Customer Lifetime Value</div>
            <div class="text-2xl font-bold text-[color:var(--token-color-accent)]">$2,456</div>
            <div class="text-xs text-[color:var(--token-color-success)] mt-1">â†— +12.5%</div>
          </div>
          <div class="bg-[color:var(--token-bg-elevated)] border border-[color:var(--token-border-default)] p-4 rounded-lg text-center">
            <div class="text-xs text-[color:var(--token-text-muted)] mb-1">Churn Rate</div>
            <div class="text-2xl font-bold text-[color:var(--token-color-accent)]">8.3%</div>
            <div class="text-xs text-[color:var(--token-color-success)] mt-1">â†˜ -2.1%</div>
          </div>
          <div class="bg-[color:var(--token-bg-elevated)] border border-[color:var(--token-border-default)] p-4 rounded-lg text-center">
            <div class="text-xs text-[color:var(--token-text-muted)] mb-1">Customer Acquisition Cost</div>
            <div class="text-2xl font-bold text-[color:var(--token-color-accent)]">$127</div>
            <div class="text-xs text-[color:var(--token-color-danger)] mt-1">â†— +5.3%</div>
          </div>
          <div class="bg-[color:var(--token-bg-elevated)] border border-[color:var(--token-border-default)] p-4 rounded-lg text-center">
            <div class="text-xs text-[color:var(--token-text-muted)] mb-1">Revenue Per User</div>
            <div class="text-2xl font-bold text-[color:var(--token-color-accent)]">$182</div>
            <div class="text-xs text-[color:var(--token-color-success)] mt-1">â†— +8.7%</div>
          </div>
        </div>

        <!-- Report Preview Area -->
        <div id="report-preview" class="bg-[color:var(--token-bg-elevated)] p-6 rounded-lg border border-[color:var(--token-border-default)]">
          <div class="text-center text-[color:var(--token-text-muted)]">
            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <p class="font-semibold mb-2">Select report type and click "Generate Report"</p>
            <p class="text-sm">Advanced reports include predictive analytics, trend analysis, and actionable insights.</p>
          </div>
        </div>
      </div>
    </section>
  </main>
  <script>
  const FN_BASE=window.FN_BASE||'/.netlify/functions';
    const REFRESH_INTERVAL=60000; let autoTimer=null; const filters={dateRange:30,userType:'all'};
    let visitorChart, engagementChart, salesChart, userGrowthSparkline;

    function getCssVar(name, fallback) {
      try {
        const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        return v || fallback;
      } catch (e) {
        return fallback;
      }
    }

    function colorToRgba(color, alpha) {
      if (!color) return color;
      const c = String(color).trim();
      const clamp = (n, min, max) => Math.min(max, Math.max(min, n));
      const a = clamp(Number(alpha), 0, 1);

      if (c.startsWith('rgba(')) {
        const parts = c
          .slice(5, -1)
          .split(',')
          .map(p => p.trim());
        if (parts.length >= 3) {
          return `rgba(${parts[0]}, ${parts[1]}, ${parts[2]}, ${a})`;
        }
      }

      if (c.startsWith('rgb(')) {
        const parts = c
          .slice(4, -1)
          .split(',')
          .map(p => p.trim());
        if (parts.length >= 3) {
          return `rgba(${parts[0]}, ${parts[1]}, ${parts[2]}, ${a})`;
        }
      }

      if (c.startsWith('#')) {
        const raw = c.slice(1);
        const hex = raw.length === 3 ? raw.split('').map(ch => ch + ch).join('') : raw;
        if (/^[0-9a-fA-F]{6}$/.test(hex)) {
          const r = parseInt(hex.slice(0, 2), 16);
          const g = parseInt(hex.slice(2, 4), 16);
          const b = parseInt(hex.slice(4, 6), 16);
          return `rgba(${r}, ${g}, ${b}, ${a})`;
        }
      }

      return c;
    }

    function getChartTheme() {
      const primary = getCssVar('--token-color-primary', '#3b82f6');
      const secondary = getCssVar('--token-color-secondary', '#10b981');
      const accent = getCssVar('--token-color-accent', '#8b5cf6');
      const warning = getCssVar('--token-color-warning', '#f59e0b');
      const danger = getCssVar('--token-color-danger', '#ef4444');
      const success = getCssVar('--token-color-success', '#10b981');
      const textPrimary = getCssVar('--token-text-primary', '#f9fafb');
      const textMuted = getCssVar('--token-text-muted', '#9ca3af');
      const grid = getCssVar('--token-border-default', 'rgba(255, 255, 255, 0.1)');

      return {
        primary,
        secondary,
        accent,
        warning,
        danger,
        success,
        textPrimary,
        textMuted,
        grid,
        primaryFill: getCssVar('--token-color-primary-alpha-10', colorToRgba(primary, 0.1))
      };
    }

    function applyChartsTheme() {
      if (!window.Chart) return;
      const t = getChartTheme();

      if (visitorChart) {
        try {
          visitorChart.data.datasets[0].borderColor = t.primary;
          visitorChart.data.datasets[0].backgroundColor = t.primaryFill;
          if (visitorChart.options?.plugins?.legend?.labels) {
            visitorChart.options.plugins.legend.labels.color = t.textPrimary;
          }
          if (visitorChart.options?.scales?.x?.ticks) {
            visitorChart.options.scales.x.ticks.color = t.textMuted;
          }
          if (visitorChart.options?.scales?.y?.ticks) {
            visitorChart.options.scales.y.ticks.color = t.textMuted;
          }
          if (visitorChart.options?.scales?.x?.grid) {
            visitorChart.options.scales.x.grid.color = colorToRgba(t.grid, 0.25);
          }
          if (visitorChart.options?.scales?.y?.grid) {
            visitorChart.options.scales.y.grid.color = colorToRgba(t.grid, 0.25);
          }
          visitorChart.update();
        } catch (e) {}
      }

      if (engagementChart) {
        try {
          if (engagementChart.data?.datasets?.[0]) {
            engagementChart.data.datasets[0].backgroundColor = [
              t.warning,
              t.primary,
              t.success,
              t.danger,
              t.accent
            ];
          }
          if (engagementChart.options?.plugins?.legend?.labels) {
            engagementChart.options.plugins.legend.labels.color = t.textPrimary;
          }
          engagementChart.update();
        } catch (e) {}
      }

      if (salesChart) {
        try {
          if (salesChart.data?.datasets?.[0]) {
            salesChart.data.datasets[0].backgroundColor = [
              colorToRgba(t.primary, 0.8),
              colorToRgba(t.success, 0.8),
              colorToRgba(t.warning, 0.8),
              colorToRgba(t.danger, 0.8),
              colorToRgba(t.accent, 0.8)
            ];
          }
          if (salesChart.options?.plugins?.legend?.labels) {
            salesChart.options.plugins.legend.labels.color = t.textPrimary;
          }
          if (salesChart.options?.scales?.x?.ticks) {
            salesChart.options.scales.x.ticks.color = t.textMuted;
          }
          if (salesChart.options?.scales?.y?.ticks) {
            salesChart.options.scales.y.ticks.color = t.textMuted;
          }
          if (salesChart.options?.scales?.x?.grid) {
            salesChart.options.scales.x.grid.color = colorToRgba(t.grid, 0.25);
          }
          if (salesChart.options?.scales?.y?.grid) {
            salesChart.options.scales.y.grid.color = colorToRgba(t.grid, 0.25);
          }
          salesChart.update();
        } catch (e) {}
      }

      if (userGrowthSparkline) {
        try {
          if (userGrowthSparkline.data?.datasets?.[0]) {
            userGrowthSparkline.data.datasets[0].borderColor = t.primary;
            userGrowthSparkline.data.datasets[0].backgroundColor = t.primaryFill;
          }
          userGrowthSparkline.update();
        } catch (e) {}
      }
    }

    window.addEventListener('theme:changed', () => {
      applyChartsTheme();
    });
    function setupQuickChips(){const ranges=[1,7,30,90,365]; const wrap=document.getElementById('quick-date-chips'); ranges.forEach(r=>{ const btn=document.createElement('button'); btn.className='ui-btn ui-btn-outline ui-btn-sm rounded-full'; btn.textContent=r===1?'Today': (r===365?'YTD': r+'d'); btn.dataset.range=r; btn.addEventListener('click',()=>{ filters.dateRange=r; document.getElementById('date-range').value=r; highlight(); updateAll();}); wrap.appendChild(btn);}); function highlight(){wrap.querySelectorAll('button').forEach(b=>{const active=parseInt(b.dataset.range)===filters.dateRange; b.classList.toggle('ui-btn-primary',active); b.classList.toggle('ui-btn-outline',!active);});} highlight(); }
  async function fetchJSON(url){ 
    try{ 
      const r = await (window.authFetch ? window.authFetch(url) : fetch(url)); 
      if(!r.ok) {
        // Don't throw error for 401/403 on optional endpoints like inventory
        if (r.status === 401 || r.status === 403) {
          console.warn(`Access denied for ${url} (${r.status})`);
          return null;
        }
        throw new Error(r.status);
      }
      return await r.json(); 
    }catch(e){ 
      console.warn(`Fetch failed for ${url}:`, e);
      return null; 
    } 
  }
  async function fetchAuditLogs(limit=2000){ const res=await fetchJSON(`${FN_BASE}/audit-logs?limit=${limit}`); if(!res) return []; return Array.isArray(res.data)? res.data : (Array.isArray(res)? res : []); }
  function safeParseDetails(d){ if(!d) return {}; try{ return JSON.parse(d); }catch(_){ return {}; } }
  function isWithinDays(ts, days){ try{ const t=new Date(ts).getTime(); return (Date.now()-t) <= days*24*60*60*1000; }catch(_){ return false; } }
  function isWithinMs(ts, ms){ try{ const t=new Date(ts).getTime(); return (Date.now()-t) <= ms; }catch(_){ return false; } }
  async function generateData(){ 
    const days = filters.dateRange;
    
    // Check user role to avoid unnecessary 401s on inventory
    const currentUser = await (async () => {
      try {
        const res = await (window.authFetch ? window.authFetch(`${FN_BASE}/auth?action=me`) : fetch(`${FN_BASE}/auth?action=me`));
        if (res.ok) {
          const data = await res.json();
          return data.user;
        }
      } catch (e) {
        console.warn('Could not fetch current user');
      }
      return null;
    })();
    
    const canAccessInventory = currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager');
    
    // Fetch all business data (conditionally fetch inventory)
    const promises = [
      fetchJSON(`${FN_BASE}/orders`),
      fetchJSON(`${FN_BASE}/products`),
      fetchJSON(`${FN_BASE}/consumables`),
      fetchJSON(`${FN_BASE}/filters`),
      fetchJSON(`${FN_BASE}/supplier-returns`)
    ];
    
    if (canAccessInventory) {
      promises.push(fetchJSON(`${FN_BASE}/inventory`));
    }
    
    const results = await Promise.all(promises);
    const [ordersRes, productsRes, consumablesRes, filtersRes, returnsRes, inventoryRes] = canAccessInventory
      ? results
      : [...results, null];
    
    const orders = (ordersRes && ordersRes.orders) || [];
    const products = (productsRes && productsRes.products) || [];
    const consumables = (consumablesRes && consumablesRes.consumables) || [];
    const filterItems = (filtersRes && filtersRes.filters) || [];
    const returns = (returnsRes && returnsRes.data) || (Array.isArray(returnsRes) ? returnsRes : []);
    const inventory = canAccessInventory ? ((inventoryRes && inventoryRes.inventory) || []) : [];
    
    // Filter orders by date range
    const ordersInRange = orders.filter(o => isWithinDays(o.created_at || o.createdAt, days));
    const returnsInRange = returns.filter(r => isWithinDays(r.return_date, days));
    
    // Generate daily order counts
    const labels = [];
    const dailyOrderCounts = [];
    const now = new Date();
    for(let i = days - 1; i >= 0; i--) {
      const d = new Date(now);
      d.setDate(now.getDate() - i);
      labels.push(d.toLocaleDateString());
      const ds = d.toISOString().split('T')[0];
      const count = ordersInRange.filter(o => String(o.created_at || o.createdAt || '').startsWith(ds)).length;
      dailyOrderCounts.push(count);
    }
    
    // Order status distribution
    const statusCounts = {
      pending: 0,
      processing: 0,
      completed: 0,
      cancelled: 0,
      other: 0
    };
    ordersInRange.forEach(o => {
      const status = (o.status || 'other').toLowerCase();
      if (statusCounts[status] !== undefined) statusCounts[status]++;
      else statusCounts.other++;
    });
    
    // Product popularity from order_items
    const productCounts = {};
    ordersInRange.forEach(o => {
      if (o.items && Array.isArray(o.items)) {
        o.items.forEach(item => {
          const productName = item.product_name || item.name || 'Unknown';
          productCounts[productName] = (productCounts[productName] || 0) + (item.quantity || 1);
        });
      }
    });
    const topProducts = Object.entries(productCounts).sort((a,b) => b[1] - a[1]).slice(0,10);
    
    // Calculate metrics
    const totalOrders = ordersInRange.length;
    const completedOrders = ordersInRange.filter(o => o.status === 'completed').length;
    const pendingOrders = ordersInRange.filter(o => o.status === 'pending').length;
    const fulfillmentRate = totalOrders > 0 ? (completedOrders / totalOrders) * 100 : 0;
    
    const totalOrderValue = ordersInRange.reduce((sum, o) => sum + (parseFloat(o.total_amount || o.total || 0)), 0);
    const avgOrderValue = totalOrders > 0 ? totalOrderValue / totalOrders : 0;
    
    const lowStockItems = inventory.filter(i => (i.stock_quantity || i.quantity || 0) < 10).length;
    const pendingReturns = returns.filter(r => r.status === 'pending_shipment' || r.status === 'in_transit').length;
    
    const returnsRate = totalOrders > 0 ? (returnsInRange.length / totalOrders) * 100 : 0;
    
    return {
      orders: ordersInRange,
      dailyOrders: { labels, data: dailyOrderCounts },
      statusDistribution: statusCounts,
      topProducts: { labels: topProducts.map(([name]) => name), data: topProducts.map(([, count]) => count) },
      summary: {
        totalOrders,
        pendingOrders,
        lowStockItems,
        pendingReturns,
        fulfillmentRate,
        avgOrderValue,
        returnsRate,
        topProduct: topProducts[0]?.[0] || '--',
        totalProducts: products.length,
        totalConsumables: consumables.length,
        totalFilters: filterItems.length,
        totalReturns: returnsInRange.length
      }
    };
  }
    function ensureCharts(data){
      if(!window.Chart) return;
      const t = getChartTheme();
      if(!visitorChart){
        visitorChart=new Chart(document.getElementById('visitor-chart'), {
          type:'line',
          data:{labels:data.dailyOrders.labels,datasets:[{label:'Daily Orders',data:data.dailyOrders.data,borderColor:t.primary,backgroundColor:t.primaryFill,tension:.4,fill:true}]},
          options:{plugins:{legend:{labels:{color:t.textPrimary}}},scales:{x:{ticks:{color:t.textMuted},grid:{color:colorToRgba(t.grid,0.25)}},y:{ticks:{color:t.textMuted},grid:{color:colorToRgba(t.grid,0.25)}}}}
        });
      } else {
        visitorChart.data.labels=data.dailyOrders.labels;
        visitorChart.data.datasets[0].data=data.dailyOrders.data;
        visitorChart.update();
      }

      const statusVals=[data.statusDistribution.pending||0,data.statusDistribution.processing||0,data.statusDistribution.completed||0,data.statusDistribution.cancelled||0,(data.statusDistribution.other||0)];
      if(!engagementChart){
        engagementChart=new Chart(document.getElementById('engagement-chart'), {
          type:'doughnut',
          data:{ labels:['Pending','Processing','Completed','Cancelled','Other'], datasets:[{ data:statusVals, backgroundColor:[t.warning,t.primary,t.success,t.danger,t.accent] }]},
          options:{plugins:{legend:{labels:{color:t.textPrimary}}}}
        });
      } else {
        engagementChart.data.datasets[0].data=statusVals;
        engagementChart.update();
      }

      if(!salesChart){
        salesChart=new Chart(document.getElementById('sales-chart'), {
          type:'bar',
          data:{ labels:data.topProducts.labels, datasets:[{ label:'Units Ordered', data:data.topProducts.data, backgroundColor:[colorToRgba(t.primary,0.8),colorToRgba(t.success,0.8),colorToRgba(t.warning,0.8),colorToRgba(t.danger,0.8),colorToRgba(t.accent,0.8)]}]},
          options:{plugins:{legend:{labels:{color:t.textPrimary}}},scales:{x:{ticks:{color:t.textMuted},grid:{color:colorToRgba(t.grid,0.25)}},y:{ticks:{color:t.textMuted},grid:{color:colorToRgba(t.grid,0.25)}}}}
        });
      } else {
        salesChart.data.labels=data.topProducts.labels;
        salesChart.data.datasets[0].data=data.topProducts.data;
        salesChart.update();
      }

      applyChartsTheme();
    }
    function updateStatCard(id, items){ const el=document.getElementById(id); if(!el) return; el.innerHTML=''; if(!items.length){ el.innerHTML='<li>No results</li>'; return;} items.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; el.appendChild(li); }); }
    function trendArrow(v){ if(v>50) return 'â†—'; if(v<20) return 'â†˜'; return 'â†’'; }
  async function updateAll(){ const last=document.getElementById('last-updated'); try{ const data=await generateData(); if(last) last.textContent='Last updated: '+ new Date().toLocaleTimeString(); ensureCharts(data); updateStatCard('visitor-stats',[`Total Orders (${filters.dateRange}d): ${data.summary.totalOrders}`,`Completed: ${data.statusDistribution.completed||0}`,`Pending: ${data.summary.pendingOrders}`,`Avg Value: $${data.summary.avgOrderValue.toFixed(2)}`]); updateStatCard('engagement-stats',[`Total Products: ${data.summary.totalProducts}`,`Consumables: ${data.summary.totalConsumables}`,`Filters: ${data.summary.totalFilters}`,`Low Stock: ${data.summary.lowStockItems}`]); updateStatCard('returns-stats',[`Total Returns (${filters.dateRange}d): ${data.summary.totalReturns}`,`Pending: ${data.summary.pendingReturns}`,`Returns Rate: ${data.summary.returnsRate.toFixed(1)}%`]); const fulfillment=data.summary.fulfillmentRate||0; document.getElementById('insight-conversion').textContent=fulfillment.toFixed(1)+'% '+trendArrow(fulfillment); document.getElementById('insight-retention').textContent='$'+data.summary.avgOrderValue.toFixed(2); document.getElementById('insight-top-product').textContent=data.summary.topProduct||'--'; document.getElementById('insight-returns-rate').textContent=data.summary.returnsRate.toFixed(1)+'%'; }catch(e){ console.error('Update error:', e); if(last) last.textContent='Last updated: error'; } }
  async function updateTopUser(prefetched){ try{ const usersData = prefetched && prefetched.users ? { users: prefetched.users } : await fetchJSON(`${FN_BASE}/users`); const users=(usersData && usersData.users)||[]; const userById=new Map(users.map(u=>[String(u.id||u.user_id||u.uid||u.username), u])); const logs=await fetchAuditLogs(1000); const counts={}; logs.forEach(l=>{ if(l.user_id!=null){ const k=String(l.user_id); counts[k]=(counts[k]||0)+1; } }); let topId='--', max=0; Object.entries(counts).forEach(([id,c])=>{ if(c>max){ max=c; topId=id; }}); const u=userById.get(topId); document.getElementById('insight-top-user').textContent= u? (u.username||u.name||(`User #${u.id}`)) : (topId==='--'?'--':`User #${topId}`); }catch(e){ document.getElementById('insight-top-user').textContent='--'; } }
  async function buildUserBreakdown(){ let users=[]; try{ const u=await fetchJSON(`${FN_BASE}/users`); users=(u&&u.users)||[]; }catch(_){} const list=document.getElementById('user-breakdown-list'); if(list){ const total=users.length; const admins=users.filter(u=>u.role==='admin').length; const regular=users.filter(u=>u.role==='user').length; const locked=users.filter(u=>u.locked).length; const now=new Date(); const newUsers=users.filter(u=>u.created_at && (now-new Date(u.created_at))<7*24*60*60*1000).length; list.innerHTML=`<li>Total: <strong>${total}</strong></li><li>Admins: <strong>${admins}</strong></li><li>Regular: <strong>${regular}</strong></li><li>Locked: <strong>${locked}</strong></li><li>New (7d): <strong>${newUsers}</strong></li>`; } const growthCanvas=document.getElementById('user-growth-sparkline'); if(growthCanvas && window.Chart){ const arr=Array(30).fill(0); const now=new Date(); users.forEach(u=>{ if(u.created_at){ const daysAgo=Math.floor((now-new Date(u.created_at))/(24*60*60*1000)); if(daysAgo>=0 && daysAgo<30) arr[29-daysAgo]++; }}); if(userGrowthSparkline) userGrowthSparkline.destroy(); const t=getChartTheme(); userGrowthSparkline=new Chart(growthCanvas.getContext('2d'),{ type:'line', data:{ labels:Array.from({length:30},(_,i)=>i+1), datasets:[{ data:arr,borderColor:t.primary,backgroundColor:t.primaryFill,tension:.4,fill:true,pointRadius:0,borderWidth:2 }]}, options:{responsive:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}}}}); } const topList=document.getElementById('top-users-list'); if(topList){ const logs=await fetchAuditLogs(2000); const counts={}; logs.forEach(l=>{ if(l.user_id!=null){ const k=String(l.user_id); counts[k]=(counts[k]||0)+1; } }); const top=Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,5); topList.innerHTML= top.length? top.map(([id,c])=>{ const u=users.find(x=> String(x.id||x.user_id)===id); const name=(u&&(u.username||u.name))||`User #${id}`; return `<li class='flex items-center'><span class='inline-block w-2 h-2 rounded-full bg-[color:var(--token-color-primary)] mr-2'></span><strong>${name}</strong><span class='ml-2 text-xs text-[color:var(--token-text-muted)]'>${c} events</span></li>`; }).join(''):'<li>N/A</li>'; } }
  async function updateRealtime(){ 
    try {
      // Check user role to avoid unnecessary 401s on inventory
      const currentUser = await (async () => {
        try {
          const res = await (window.authFetch ? window.authFetch(`${FN_BASE}/auth?action=me`) : fetch(`${FN_BASE}/auth?action=me`));
          if (res.ok) {
            const data = await res.json();
            return data.user;
          }
        } catch (e) {
          console.warn('Could not fetch current user');
        }
        return null;
      })();
      
      const canAccessInventory = currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager');
      
      // Fetch current business data (conditionally fetch inventory based on permissions)
      const promises = [
        fetchJSON(`${FN_BASE}/orders`),
        fetchJSON(`${FN_BASE}/supplier-returns`),
        fetchJSON(`${FN_BASE}/users`)
      ];
      
      if (canAccessInventory) {
        promises.push(fetchJSON(`${FN_BASE}/inventory`));
      }
      
      const results = await Promise.all(promises);
      const [ordersRes, returnsRes, usersRes, inventoryRes] = canAccessInventory 
        ? results 
        : [...results, null];
      
      const orders = (ordersRes && ordersRes.orders) || [];
      const inventory = (inventoryRes && inventoryRes.inventory) || [];
      const returns = (returnsRes && returnsRes.data) || (Array.isArray(returnsRes) ? returnsRes : []);
      
      const totalOrders = orders.length;
      const pendingOrders = orders.filter(o => o.status === 'pending').length;
      const lowStockItems = canAccessInventory ? inventory.filter(i => (i.stock_quantity || i.quantity || 0) < 10).length : 0;
      const pendingReturns = returns.filter(r => r.status === 'pending_shipment' || r.status === 'in_transit').length;
      
      document.getElementById('total-orders').textContent = String(totalOrders);
      document.getElementById('pending-orders').textContent = String(pendingOrders);
      document.getElementById('low-stock-items').textContent = canAccessInventory ? String(lowStockItems) : 'N/A';
      document.getElementById('pending-returns').textContent = String(pendingReturns);
    } catch(e) {
      console.error('Realtime update error:', e);
      document.getElementById('total-orders').textContent = '--';
      document.getElementById('pending-orders').textContent = '--';
      document.getElementById('low-stock-items').textContent = '--';
      document.getElementById('pending-returns').textContent = '--';
    }
  }
  function exportCSV(){ (async()=>{ const data=await generateData(); let csv='Date,Orders\n'; data.dailyOrders.labels.forEach((l,i)=> csv+=`${l},${data.dailyOrders.data[i]}\n`); csv+='\nSummary\n'; csv+=`Total Orders (${filters.dateRange}d),${data.summary.totalOrders}\nCompleted Orders,${data.statusDistribution.completed||0}\nPending Orders,${data.summary.pendingOrders}\nFulfillment Rate,${(data.summary.fulfillmentRate||0).toFixed(1)}%\nAvg Order Value,$${data.summary.avgOrderValue.toFixed(2)}\nReturns Rate,${data.summary.returnsRate.toFixed(1)}%\nTop Product,${data.summary.topProduct}\n`; csv+='\nTop Products\n'; data.topProducts.labels.forEach((p,i)=> csv+=`${p},${data.topProducts.data[i]}\n`); const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`analytics-report-${new Date().toISOString().split('T')[0]}.csv`; a.click(); showToast('CSV exported'); })(); }
  function exportUserCSV(){ (async()=>{ const u=await fetchJSON(`${FN_BASE}/users`); const users=(u&&u.users)||[]; let csv='User,Email,Role,Created At\n'; users.forEach(user=>{ csv+=`${user.name||user.username||'--'},${user.email||'--'},${user.role||'user'},${user.created_at||''}\n`; }); const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`users-export-${new Date().toISOString().split('T')[0]}.csv`; a.click(); showToast('User CSV exported'); })(); }
  function exportPDF(){ if(!window.jspdf||!window.jspdf.jsPDF){ showToast('PDF unavailable; CSV fallback'); return exportCSV(); } const { jsPDF }=window.jspdf; (async()=>{ const data=await generateData(); const doc=new jsPDF(); doc.setFontSize(18); doc.text('Business Analytics Report',20,20); doc.setFontSize(10); doc.text(`Generated: ${new Date().toLocaleString()}`,20,28); let y=40; const lines=[`Range: ${filters.dateRange}d`,`Total Orders: ${data.summary.totalOrders}`,`Completed: ${data.statusDistribution.completed||0}`,`Pending: ${data.summary.pendingOrders}`,`Fulfillment Rate: ${(data.summary.fulfillmentRate||0).toFixed(1)}%`,`Avg Order Value: $${data.summary.avgOrderValue.toFixed(2)}`,`Returns Rate: ${data.summary.returnsRate.toFixed(1)}%`]; lines.forEach(l=>{ doc.text(l,20,y); y+=6; }); y+=4; doc.text('Top Products:',20,y); y+=6; data.topProducts.labels.forEach((p,i)=>{ if(y>270){ doc.addPage(); y=20;} doc.text(`${p}: ${data.topProducts.data[i]} units`,26,y); y+=6; }); doc.save(`business-analytics-${new Date().toISOString().split('T')[0]}.pdf`); showToast('PDF exported'); })(); }
  function exportPNG(){ if(!window.Chart){ showToast('Charts not loaded'); return; } const charts=[['visitor-chart','daily'],['engagement-chart','methods'],['sales-chart','endpoints']]; charts.forEach(([id,name])=>{ const c=document.getElementById(id); if(c){ const ch=Chart.getChart(c); if(ch){ const url=ch.toBase64Image(); const a=document.createElement('a'); a.href=url; a.download=`analytics-${name}-${new Date().toISOString().split('T')[0]}.png`; a.click(); } } }); showToast('PNG export complete'); }
    function bindUI(){ document.getElementById('date-range').addEventListener('change',e=>{ filters.dateRange=parseInt(e.target.value); updateAll(); }); document.getElementById('user-type').addEventListener('change',e=>{ filters.userType=e.target.value; updateAll();}); document.getElementById('export-csv').addEventListener('click',exportCSV); document.getElementById('export-pdf').addEventListener('click',exportPDF); document.getElementById('export-png').addEventListener('click',exportPNG); document.getElementById('export-user-analytics').addEventListener('click',exportUserCSV); document.getElementById('refresh-btn').addEventListener('click',()=>{ updateAll(); updateRealtime(); showToast('Refreshed');}); }
    function startAuto(){ if(autoTimer) clearInterval(autoTimer); autoTimer=setInterval(()=>{ updateAll(); updateRealtime(); }, REFRESH_INTERVAL); }
    
    // Advanced Reports Feature
    function initAdvancedReports() {
      const generateBtn = document.getElementById('generate-advanced-report');
      if (!generateBtn) return;
      
      generateBtn.addEventListener('click', async function() {
        const reportType = document.getElementById('report-type')?.value || 'comprehensive';
        const reportPeriod = document.getElementById('report-period')?.value || '30';
        const reportFormat = document.getElementById('report-format')?.value || 'pdf';
        
        const preview = document.getElementById('report-preview');
        if (preview) {
          preview.innerHTML = `
            <div class="text-center">
              <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-[color:var(--token-color-accent)] border-t-transparent mb-4"></div>
              <p class="font-semibold">Generating ${reportType} report...</p>
              <p class="text-sm text-[color:var(--token-text-muted)] mt-2">Analyzing ${reportPeriod} days of data</p>
            </div>
          `;
          
          // Simulate report generation
          setTimeout(() => {
            preview.innerHTML = `
              <div class="space-y-4">
                <div class="flex items-center justify-between pb-4 border-b border-[color:var(--token-border-default)]">
                  <div>
                    <h4 class="font-bold text-lg">${reportType.charAt(0).toUpperCase() + reportType.slice(1)} Report</h4>
                    <p class="text-sm text-[color:var(--token-text-muted)]">Generated: ${new Date().toLocaleString()}</p>
                  </div>
                  <button class="ui-btn ui-btn-accent" onclick="showToast('Report downloaded as ${reportFormat.toUpperCase()}')">
                    Download ${reportFormat.toUpperCase()}
                  </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="bg-[color:var(--token-bg-elevated)] p-4 rounded">
                    <h5 class="font-semibold mb-2 text-[color:var(--token-color-accent)]">Key Insights</h5>
                    <ul class="space-y-2 text-sm">
                      <li>âœ“ User engagement increased 23% over period</li>
                      <li>âœ“ Conversion rate improved by 15%</li>
                      <li>âœ“ Top performing product: EDGE 5W-30</li>
                      <li>âœ“ Peak activity time: 2-4 PM</li>
                    </ul>
                  </div>
                  <div class="bg-[color:var(--token-bg-elevated)] p-4 rounded">
                    <h5 class="font-semibold mb-2 text-[color:var(--token-color-accent)]">Recommendations</h5>
                    <ul class="space-y-2 text-sm">
                      <li>â†’ Focus marketing on high-engagement hours</li>
                      <li>â†’ Expand inventory for top products</li>
                      <li>â†’ Improve mobile experience (32% traffic)</li>
                      <li>â†’ Consider seasonal promotions</li>
                    </ul>
                  </div>
                </div>
                <div class="text-xs text-[color:var(--token-text-muted)] text-center pt-4 border-t border-[color:var(--token-border-default)]">
                  This is a preview. Full report available in ${reportFormat.toUpperCase()} format.
                </div>
              </div>
            `;
            showToast('Report generated successfully!');
          }, 2000);
        }
      });
    }
    
    document.addEventListener('DOMContentLoaded',()=>{ setupQuickChips(); bindUI(); updateAll(); updateRealtime(); startAuto(); initAdvancedReports(); 
      // Initialize feature flags
      if (window.FeatureFlags) {
        window.FeatureFlags.toggleElements('#advanced-reports-section', 'advancedReports');
      }
    });
  </script>
</body>
</html>
