<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="./assets/css/styles.css">

        <!-- Load shared config and theme system -->
        <script>
            fetch('shared-config.html').then(r => r.text()).then(html => {
                const temp = document.createElement('div');
                temp.innerHTML = html;
                Array.from(temp.children).forEach(child => {
                    if (child.tagName === 'LINK' || child.tagName === 'STYLE' || child.tagName === 'SCRIPT') {
                        document.head.appendChild(child.cloneNode(true));
                    }
                });
            });
            fetch('shared-theme.html').then(r => r.text()).then(html => {
                const temp = document.createElement('div');
                temp.innerHTML = html;
                Array.from(temp.children).forEach(child => {
                    if (child.tagName === 'SCRIPT') {
                        document.head.appendChild(child.cloneNode(true));
                    }
                });
            });
        </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="JoshBurt.com.au">
    <link rel="apple-touch-icon" href="./assets/images/logo-placeholder.svg">
    
    <!-- Chart.js for analytics charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Analytics Data Manager -->
    <script src="analytics-manager.js"></script>
    <script>
        // Configuration for dynamic color updates from settings
        function applyDynamicColors() {
            const settingsHead = JSON.parse(localStorage.getItem('siteSettings')) || {};
            // Apply CSS variables for instant color update
            document.documentElement.style.setProperty('--tw-color-primary', settingsHead.primaryColor || '#3b82f6');
            document.documentElement.style.setProperty('--tw-color-secondary', settingsHead.secondaryColor || '#10b981');
            document.documentElement.style.setProperty('--tw-color-accent', settingsHead.accentColor || '#8b5cf6');
        }
        applyDynamicColors();
        // Service Worker Registration for PWA
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("./sw.js")
                    .then(registration => {
                        console.log("SW registered: ", registration);
                    })
                    .catch(registrationError => {
                        console.log("SW registration failed: ", registrationError);
                    });
            });
        }
    </script>
    <style>
        body {
            transition: background-color 0.3s, color 0.3s;
        }
        .chart-container {
            height: 300px;
            width: 100%;
        }
        .sales-chart-container {
            height: 350px;
            width: 100%;
        }
        .dark {
            background-color: #1f2937;
            color: #f9fafb;
        }
        .light {
            background-color: #f9fafb;
            color: #1f2937;
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.open {
                    body {
                        transition: background-color 0.3s, color 0.3s;
                        font-family: 'Inter', 'system-ui', '-apple-system', sans-serif;
                        background-color: #0a0a0a;
                        color: #ffffff;
                    }
                    .dark {
                        background-color: #0a0a0a;
                        color: #ffffff;
                    }
                    .light {
                        background-color: #f9fafb;
                        color: #1f2937;
                    }
                    .sidebar {
                        width: 16rem;
                        height: 100vh;
                        position: fixed;
                        top: 0;
                        left: 0;
                        overflow-y: auto;
                        transition: background-color 0.3s;
                        z-index: 100;
                        background-color: #111111;
                        border-right: 1px solid #00d4ff20;
                    }
                    main {
                        margin-left: 16rem;
                        min-height: 100vh;
                        background-color: #0a0a0a;
                    }
                    @media (max-width: 768px) {
                        .sidebar {
                            transform: translateX(-100%);
                            transition: transform 0.3s ease-in-out;
                        }
                        .sidebar.open {
                            transform: translateX(0);
                        }
                        main {
                            margin-left: 0;
                        }
                    }
                    .analytics-item {
                        transition: all 0.2s ease;
                        background-color: #111111;
                        border: 1px solid #333333;
                    }
                    .analytics-item:hover {
                        background-color: #181818;
                        border-color: #00d4ff;
                        box-shadow: 0 4px 20px rgba(0, 212, 255, 0.2);
                    }
                    .sr-only {
                        position: absolute;
                        width: 1px;
                        height: 1px;
                        padding: 0;
                        margin: -1px;
                        overflow: hidden;
                        clip: rect(0, 0, 0, 0);
                        white-space: nowrap;
                        border: 0;
                    }
                    .focus\:not-sr-only:focus {
                        position: static;
                        width: auto;
                        height: auto;
                        padding: 0.5rem;
                        margin: 0;
                        overflow: visible;
                        clip: auto;
                        white-space: normal;
                    }
                    @media print {
                        .sidebar, .no-print { display: none !important; }
                        main { margin-left: 0 !important; }
                        body { background: white !important; color: black !important; }
                    }

                    /* Neon button styles */
                    .btn-neon-blue {
                        background: linear-gradient(45deg, #00d4ff, #0099cc);
                        border: 1px solid #00d4ff;
                        box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
                        color: #000000;
                        font-weight: 600;
                    }
                    .btn-neon-blue:hover {
                        box-shadow: 0 0 20px rgba(0, 212, 255, 0.6);
                        background: linear-gradient(45deg, #00eeff, #00b8e6);
                    }
                    .btn-neon-green {
                        background: linear-gradient(45deg, #00ff88, #00cc66);
                        border: 1px solid #00ff88;
                        box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
                        color: #000000;
                        font-weight: 600;
                    }
                    .btn-neon-green:hover {
                        box-shadow: 0 0 20px rgba(0, 255, 136, 0.6);
                        background: linear-gradient(45deg, #00ff99, #00dd77);
                    }

                    /* Navigation link styling */
                    .nav-link {
                        color: #cccccc;
                        transition: all 0.3s ease;
                    }
                    .nav-link:hover {
                        color: #00d4ff;
                        text-shadow: 0 0 8px rgba(0, 212, 255, 0.6);
                    }
                    .nav-link.active {
                        color: #00d4ff;
                        background-color: #00d4ff20;
                        border-left: 3px solid #00d4ff;
                    }
                </style>
                </head>
                <body class="dark">
                <!-- Mobile Menu Toggle -->
                <button id="menu-toggle" class="md:hidden fixed top-4 left-4 z-50 p-2 bg-primary text-white rounded-md focus:outline-none focus:ring-2 focus:ring-secondary" aria-label="Toggle sidebar" aria-expanded="false">☰</button>
                <div id="sidebar-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
                <div class="flex min-h-screen">
                    <!-- Sidebar -->
                    <aside id="sidebar" class="w-64 fixed top-0 left-0 h-full bg-gray-800 text-white p-4 flex flex-col shadow md:static md:translate-x-0 transform transition-transform duration-300">
                        <h1 class="text-2xl font-bold mb-6">Josh's App</h1>
                        <nav aria-label="Main navigation">
                            <ul class="space-y-2">
                                <li><a class="block p-2 rounded hover:bg-primary" href="index.html">Home</a></li>
                                <li><a class="block p-2 rounded hover:bg-primary" href="administration.html">Administration</a></li>
                                <li><a class="block p-2 rounded hover:bg-primary" href="users.html">User Management</a></li>
                                <li><a class="block p-2 rounded bg-primary" aria-current="page" href="analytics.html">Analytics</a></li>
                                <li><a class="block p-2 rounded hover:bg-primary" href="settings.html">Settings</a></li>
                                <li><a class="block p-2 rounded hover:bg-primary" href="oil.html">Oil Orders</a></li>
                                <li><a class="block p-2 rounded hover:bg-primary" href="consumables.html">Consumables Orders</a></li>
                                <li><a class="block p-2 rounded hover:bg-red-600" href="login.html">Logout</a></li>
                            </ul>
                        </nav>
                        <button id="theme-toggle" class="w-full mt-4 p-2 rounded bg-primary text-white hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-colors duration-200">Toggle Light/Dark</button>
                        <div class="mt-auto pt-4 text-xs text-gray-300">v1 Settings</div>
                    </aside>
                    <!-- Main Content -->
                    <main class="flex-1 p-4 md:p-6 ml-64 md:ml-0">
    <!-- Removed extra closing divs that were not opened -->
                <!-- Filter Chips for Quick Date Selection -->
                <div class="mb-4 flex flex-wrap gap-2" role="group" aria-label="Quick date filters">
                    <button class="date-chip px-3 py-1 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary" data-range="1" aria-label="Today" role="button" tabindex="0">Today</button>
                    <button class="date-chip px-3 py-1 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary" data-range="7" aria-label="Last 7 days" role="button" tabindex="0">7d</button>
                    <button class="date-chip px-3 py-1 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary" data-range="30" aria-label="Last 30 days" role="button" tabindex="0">30d</button>
                    <button class="date-chip px-3 py-1 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary" data-range="90" aria-label="Last 90 days" role="button" tabindex="0">90d</button>
                    <button class="date-chip px-3 py-1 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary" data-range="365" aria-label="Last year" role="button" tabindex="0">YTD</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Date Range Filter -->
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-gray-900 dark:text-gray-100">Date Range</label>
                        <select id="date-range" class="w-full p-3 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="365">Last year</option>
                        </select>
                    </div>
                    
                    <!-- User Type Filter -->
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-gray-900 dark:text-gray-100">User Type</label>
                        <select id="user-type" class="w-full p-3 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="all" selected>All Users</option>
                            <option value="admin">Admin Users</option>
                            <option value="user">Regular Users</option>
                        </select>
                    </div>
                
                    <!-- Export Options -->

                    <div class="flex flex-col gap-2">
                        <label class="block text-sm font-semibold text-gray-900 dark:text-gray-100">Export Options</label>
                        <div class="flex gap-2">
                            <button id="export-csv" class="flex-1 px-3 py-2 bg-secondary text-white rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-secondary focus:ring-offset-2 transition-colors duration-200">
                                Export CSV
                            </button>
                            <button id="export-pdf" class="flex-1 px-3 py-2 bg-accent text-white rounded-lg hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 transition-colors duration-200">
                                Export PDF
                            </button>
                            <button id="export-png" class="flex-1 px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 transition-colors duration-200">
                                Export PNG
                            </button>
                        </div>
                    </div>
                </div>

        <!-- Real-time Statistics -->
        <section class="mb-6" aria-label="Real-time statistics">
            <div class="widget-secondary rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-semibold mb-4 flex items-center text-gray-900 dark:text-gray-100">
                    <span class="w-3 h-3 bg-green-400 rounded-full animate-pulse mr-3"></span>
                    Real-time Statistics
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-400" id="active-users">-</div>
                        <div class="text-sm text-gray-400">Active Users</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-400" id="current-page-views">-</div>
                        <div class="text-sm text-gray-400">Page Views (Hour)</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-yellow-400" id="server-status">-</div>
                        <div class="text-sm text-gray-400">Server Status</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-400" id="total-users">-</div>
                        <div class="text-sm text-gray-400">Total Users</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Charts Section -->
        <section class="mb-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Visitor Trends Chart -->
                <div class="widget-primary p-6 rounded-lg shadow-md card border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100 flex items-center gap-2">
                        <span class="inline-block w-2 h-2 bg-blue-400 rounded-full"></span> Visitor Trends
                    </h3>
                    <div class="chart-container"><canvas id="visitor-chart"></canvas></div>
                </div>
                <!-- User Engagement Chart -->
                <div class="widget-secondary p-6 rounded-lg shadow-md card border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100 flex items-center gap-2">
                        <span class="inline-block w-2 h-2 bg-green-400 rounded-full"></span> User Engagement
                    </h3>
                    <div class="chart-container"><canvas id="engagement-chart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- Product Sales Chart -->
        <section class="mb-6">
            <div class="widget-accent p-6 rounded-lg shadow-md card border border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100 flex items-center gap-2">
                    <span class="inline-block w-2 h-2 bg-purple-400 rounded-full"></span> Product Sales Analytics
                </h3>
                <div class="sales-chart-container"><canvas id="sales-chart"></canvas></div>
            </div>
        </section>

        <!-- Statistics Cards -->
        <section>
            <p class="mb-4 text-gray-700 dark:text-gray-300">Real-time statistics and key metrics from your analytics data.</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="widget-primary p-6 rounded-lg shadow-md card border border-gray-200 dark:border-gray-700">
                    <h3 class="text-base font-semibold mb-2 text-gray-900 dark:text-gray-100">Visitor Statistics</h3>
                    <ul id="visitor-stats" class="list-disc pl-5 text-gray-700 dark:text-gray-300 space-y-1">
                        <li>Loading...</li>
                    </ul>
                </div>
                <div class="widget-secondary p-6 rounded-lg shadow-md card border border-gray-200 dark:border-gray-700">
                    <h3 class="text-base font-semibold mb-2 text-gray-900 dark:text-gray-100">User Engagement</h3>
                    <ul id="engagement-stats" class="list-disc pl-5 text-gray-700 dark:text-gray-300 space-y-1">
                        <li>Loading...</li>
                    </ul>
                </div>
                <div class="widget-accent p-6 rounded-lg shadow-md card border border-gray-200 dark:border-gray-700">
                    <h3 class="text-base font-semibold mb-2 text-gray-900 dark:text-gray-100 flex items-center justify-between">
                        Top Pages
                        <input id="top-pages-search" type="search" placeholder="Search pages..." class="ml-2 px-2 py-1 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" aria-label="Search top pages">
                    </h3>
                    <ol id="top-pages" class="list-decimal pl-5 text-gray-700 dark:text-gray-300 space-y-1">
                        <li>Loading...</li>
                    </ol>
                </div>
            </div>
        </section>
    </main>

    <script>
    // Global variables for charts
    let visitorChart, engagementChart, salesChart, funnelChart, deviceChart, browserChart, multiMetricChart, sparklineVisitors, sparklineOrders, sparklineSessions;
        let currentFilters = {
            dateRange: 30,
            userType: 'all'
        };

        // Show toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Load and apply site settings
        function loadAndApplySettings() {
            const settings = JSON.parse(localStorage.getItem('siteSettings')) || {};
            
            // Apply site title if set
            if (settings['site-title']) {
                const brandingElements = document.querySelectorAll('h1');
                brandingElements.forEach(el => {
                    if (el.textContent.includes('Josh\'s App')) {
                        el.textContent = settings['site-title'];
                    }
                });
            }
        }

        // Generate mock analytics data based on filters
        function generateAnalyticsData(filters) {
            // Use the new analytics manager
            if (window.analyticsManager) {
                const analyticsData = window.analyticsManager.getData(filters);
                if (analyticsData) {
                    return processAnalyticsData(analyticsData.data, filters);
                }
            }
            
            // Fallback to original mock data generation
            const days = filters.dateRange;
            const userType = filters.userType;
            const users = JSON.parse(localStorage.getItem('siteUsers') || '[]');
            
            // Filter users by type
            let filteredUsers = users;
            if (userType === 'admin') {
                filteredUsers = users.filter(u => u.role === 'admin');
            } else if (userType === 'user') {
                filteredUsers = users.filter(u => u.role === 'user');
            }
            
            // Generate visitor trend data
            const visitorData = [];
            const labels = [];
            const baseVisitors = Math.max(filteredUsers.length * 10, 50);
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString());
                
                // Simulate visitor patterns (weekends lower, recent days higher)
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const trendMultiplier = 1 + (days - i) / days * 0.3; // Recent growth
                const weekendMultiplier = isWeekend ? 0.7 : 1;
                const randomVariation = 0.8 + Math.random() * 0.4;
                
                const visitors = Math.floor(baseVisitors * trendMultiplier * weekendMultiplier * randomVariation);
                visitorData.push(visitors);
            }
            
            // Generate engagement data
            const engagementData = {
                bounceRate: 30 + Math.random() * 40, // 30-70%
                avgSessionDuration: 180 + Math.random() * 300, // 3-8 minutes
                pagesPerSession: 2 + Math.random() * 3, // 2-5 pages
                returnVisitorRate: 20 + Math.random() * 30 // 20-50%
            };
            
            // Generate product sales data (from oil orders)
            const salesData = {
                labels: ['Castrol GTX', 'Castrol Magnatec', 'Castrol EDGE', 'Castrol GTX Diesel', 'Castrol Actevo'],
                data: [
                    Math.floor(Math.random() * 50 + 10),
                    Math.floor(Math.random() * 40 + 15),
                    Math.floor(Math.random() * 60 + 20),
                    Math.floor(Math.random() * 30 + 5),
                    Math.floor(Math.random() * 25 + 8)
                ]
            };
            
            return {
                visitors: { labels, data: visitorData },
                engagement: engagementData,
                sales: salesData,
                summary: {
                    totalUsers: filteredUsers.length,
                    activeSession: JSON.parse(localStorage.getItem('user') || 'null') ? 1 : 0,
                    adminUsers: users.filter(u => u.role === 'admin').length,
                    regularUsers: users.filter(u => u.role === 'user').length,
                    totalVisitors: visitorData.reduce((a, b) => a + b, 0),
                    avgDailyVisitors: Math.floor(visitorData.reduce((a, b) => a + b, 0) / visitorData.length)
                }
            };
        }

        // Process analytics data from the manager
        function processAnalyticsData(data, filters) {
            const visitorData = data.visitors || [];
            const labels = visitorData.map(v => new Date(v.date).toLocaleDateString());
            const visitors = visitorData.map(v => v.totalVisitors);
            
            // Calculate engagement metrics from session data
            const sessions = data.userSessions || [];
            const avgBounceRate = sessions.reduce((sum, s) => sum + s.bounceRate, 0) / sessions.length || 0;
            const avgSessionDuration = sessions.reduce((sum, s) => sum + s.avgSessionDuration, 0) / sessions.length || 0;
            const avgPagesPerSession = sessions.reduce((sum, s) => sum + s.pagesPerSession, 0) / sessions.length || 0;
            
            // Calculate return visitor rate
            const totalVisitors = visitorData.reduce((sum, v) => sum + v.totalVisitors, 0);
            const totalReturning = visitorData.reduce((sum, v) => sum + v.returningVisitors, 0);
            const returnVisitorRate = totalVisitors > 0 ? (totalReturning / totalVisitors) * 100 : 0;
            
            // Process oil orders data
            const orderData = data.oilOrders || [];
            const productSales = {};
            const productNames = ['Castrol GTX', 'Castrol Magnatec', 'Castrol EDGE', 'Castrol GTX Diesel', 'Castrol Actevo'];
            
            productNames.forEach(product => {
                productSales[product] = orderData.reduce((sum, day) => {
                    return sum + (day.products[product]?.orders || 0);
                }, 0);
            });
            
            return {
                visitors: { labels, data: visitors },
                engagement: {
                    bounceRate: avgBounceRate * 100,
                    avgSessionDuration: avgSessionDuration,
                    pagesPerSession: avgPagesPerSession,
                    returnVisitorRate: returnVisitorRate
                },
                sales: {
                    labels: productNames,
                    data: productNames.map(name => productSales[name])
                },
                summary: {
                    totalUsers: JSON.parse(localStorage.getItem('siteUsers') || '[]').length,
                    activeSession: JSON.parse(localStorage.getItem('user') || 'null') ? 1 : 0,
                    adminUsers: JSON.parse(localStorage.getItem('siteUsers') || '[]').filter(u => u.role === 'admin').length,
                    regularUsers: JSON.parse(localStorage.getItem('siteUsers') || '[]').filter(u => u.role === 'user').length,
                    totalVisitors: totalVisitors,
                    avgDailyVisitors: Math.floor(totalVisitors / visitorData.length)
                }
            };
        }

        // Initialize charts
        function initializeCharts() {
            const analytics = window.analyticsManager ? window.analyticsManager.getData(currentFilters) : null;
            const data = analytics ? analytics.data : generateAnalyticsData(currentFilters);
            const insights = analytics ? analytics.insights : {};
            // Browser Breakdown Chart (Doughnut)
            const browserCanvas = document.getElementById('browser-chart');
            if (browserCanvas && insights.browserBreakdown) {
                const browserCtx = browserCanvas.getContext('2d');
                browserChart = new Chart(browserCtx, {
                    type: 'doughnut',
                    data: {
                        labels: insights.browserBreakdown.browserLabels,
                        datasets: [{
                            data: insights.browserBreakdown.browsers,
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(245, 158, 11, 0.8)',
                                'rgba(139, 92, 246, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#1f2937' }
                            }
                        }
                    }
                });
            }

            // Multi-Metric Stacked Bar Chart
            const multiMetricCanvas = document.getElementById('multi-metric-chart');
            if (multiMetricCanvas && insights.multiMetric) {
                const mmCtx = multiMetricCanvas.getContext('2d');
                multiMetricChart = new Chart(mmCtx, {
                    type: 'bar',
                    data: {
                        labels: insights.multiMetric.labels,
                        datasets: [
                            {
                                label: 'Visitors',
                                data: insights.multiMetric.visitors,
                                backgroundColor: 'rgba(59, 130, 246, 0.7)'
                            },
                            {
                                label: 'Orders',
                                data: insights.multiMetric.orders,
                                backgroundColor: 'rgba(16, 185, 129, 0.7)'
                            },
                            {
                                label: 'Sessions',
                                data: insights.multiMetric.sessions,
                                backgroundColor: 'rgba(245, 158, 11, 0.7)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#1f2937' }
                            }
                        },
                        scales: {
                            x: { stacked: true, ticks: { color: '#1f2937' }, grid: { color: 'rgba(31,41,55,0.1)' } },
                            y: { stacked: true, ticks: { color: '#1f2937' }, grid: { color: 'rgba(31,41,55,0.1)' } }
                        }
                    }
                });
            }

            // Sparkline Mini-Charts
            if (insights.sparklines) {
                const sparkVisitors = document.getElementById('sparkline-visitors');
                const sparkOrders = document.getElementById('sparkline-orders');
                const sparkSessions = document.getElementById('sparkline-sessions');
                if (sparkVisitors) {
                    sparklineVisitors = new Chart(sparkVisitors.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: insights.sparklines.visitors.map((_, i) => i + 1),
                            datasets: [{
                                data: insights.sparklines.visitors,
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointRadius: 0,
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: false,
                            plugins: { legend: { display: false } },
                            scales: { x: { display: false }, y: { display: false } }
                        }
                    });
                }
                if (sparkOrders) {
                    sparklineOrders = new Chart(sparkOrders.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: insights.sparklines.orders.map((_, i) => i + 1),
                            datasets: [{
                                data: insights.sparklines.orders,
                                borderColor: 'rgb(16, 185, 129)',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointRadius: 0,
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: false,
                            plugins: { legend: { display: false } },
                            scales: { x: { display: false }, y: { display: false } }
                        }
                    });
                }
                if (sparkSessions) {
                    sparklineSessions = new Chart(sparkSessions.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: insights.sparklines.sessions.map((_, i) => i + 1),
                            datasets: [{
                                data: insights.sparklines.sessions,
                                borderColor: 'rgb(245, 158, 11)',
                                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointRadius: 0,
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: false,
                            plugins: { legend: { display: false } },
                            scales: { x: { display: false }, y: { display: false } }
                        }
                    });
                }
            }

            // Check if Chart.js is available
            if (!window.Chart) {
                // Fallback: Replace canvas elements with text summaries
                const visitorCanvas = document.getElementById('visitor-chart');
                const engagementCanvas = document.getElementById('engagement-chart');
                const salesCanvas = document.getElementById('sales-chart');
                const funnelCanvas = document.getElementById('funnel-chart');
                const deviceCanvas = document.getElementById('device-chart');

                if (visitorCanvas) {
                    visitorCanvas.parentElement.innerHTML = `
                        <h3 class="font-semibold mb-4">Visitor Trends</h3>
                        <div class="text-gray-300 space-y-2">
                            <p><strong>Chart unavailable (CDN blocked)</strong></p>
                            <p>Total Visitors: ${data.summary.totalVisitors}</p>
                            <p>Average Daily: ${data.summary.avgDailyVisitors}</p>
                            <p>Peak Day: ${Math.max(...data.visitors.data)} visitors</p>
                        </div>
                    `;
                }
                if (engagementCanvas) {
                    engagementCanvas.parentElement.innerHTML = `
                        <h3 class="font-semibold mb-4">User Engagement</h3>
                        <div class="text-gray-300 space-y-2">
                            <p><strong>Chart unavailable (CDN blocked)</strong></p>
                            <p>Bounce Rate: ${data.engagement.bounceRate.toFixed(1)}%</p>
                            <p>Return Rate: ${data.engagement.returnVisitorRate.toFixed(1)}%</p>
                            <p>Avg Session: ${Math.floor(data.engagement.avgSessionDuration / 60)}m</p>
                        </div>
                    `;
                }
                if (salesCanvas) {
                    salesCanvas.parentElement.innerHTML = `
                        <h3 class="font-semibold mb-4">Product Sales Analytics</h3>
                        <div class="text-gray-300 space-y-2">
                            <p><strong>Chart unavailable (CDN blocked)</strong></p>
                            ${data.sales.labels.map((product, i) => 
                                `<p>${product}: ${data.sales.data[i]} units</p>`
                            ).join('')}
                        </div>
                    `;
                }
                if (funnelCanvas) {
                    funnelCanvas.parentElement.innerHTML = `<div class='text-gray-300'>Funnel: Visit → Signup → Order<br>Chart unavailable</div>`;
                }
                if (deviceCanvas) {
                    deviceCanvas.parentElement.innerHTML = `<div class='text-gray-300'>Device/Browser breakdown unavailable</div>`;
                }
                return;
            }

            // Visitor Trends Chart
            const visitorCtx = document.getElementById('visitor-chart').getContext('2d');
            visitorChart = new Chart(visitorCtx, {
                type: 'line',
                data: {
                    labels: data.visitors.labels,
                    datasets: [{
                        label: 'Daily Visitors',
                        data: data.visitors.data,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            labels: { color: '#f9fafb' }
                        }
                    },
                    scales: {
                        x: { 
                            ticks: { color: '#f9fafb' },
                            grid: { color: 'rgba(249, 250, 251, 0.1)' }
                        },
                        y: { 
                            ticks: { color: '#f9fafb' },
                            grid: { color: 'rgba(249, 250, 251, 0.1)' }
                        }
                    }
                }
            });

            // User Engagement Chart (Doughnut)
            const engagementCtx = document.getElementById('engagement-chart').getContext('2d');
            engagementChart = new Chart(engagementCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Return Visitors', 'New Visitors', 'Bounced Sessions', 'Engaged Sessions'],
                    datasets: [{
                        data: [
                            data.engagement.returnVisitorRate,
                            100 - data.engagement.returnVisitorRate,
                            data.engagement.bounceRate,
                            100 - data.engagement.bounceRate
                        ],
                        backgroundColor: [
                            'rgb(16, 185, 129)',
                            'rgb(59, 130, 246)', 
                            'rgb(239, 68, 68)',
                            'rgb(139, 92, 246)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            labels: { color: '#f9fafb' }
                        }
                    }
                }
            });

            // Product Sales Chart (Bar)
            const salesCtx = document.getElementById('sales-chart').getContext('2d');
            salesChart = new Chart(salesCtx, {
                type: 'bar',
                data: {
                    labels: data.sales.labels,
                    datasets: [{
                        label: 'Units Sold',
                        data: data.sales.data,
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderColor: [
                            'rgb(239, 68, 68)',
                            'rgb(16, 185, 129)',
                            'rgb(59, 130, 246)',
                            'rgb(139, 92, 246)',
                            'rgb(245, 158, 11)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            labels: { color: '#f9fafb' }
                        }
                    },
                    scales: {
                        x: { 
                            ticks: { color: '#f9fafb' },
                            grid: { color: 'rgba(249, 250, 251, 0.1)' }
                        },
                        y: { 
                            ticks: { color: '#f9fafb' },
                            grid: { color: 'rgba(249, 250, 251, 0.1)' }
                        }
                    }
                }
            });

            // Funnel Chart (Bar)
            const funnelCanvas = document.getElementById('funnel-chart');
            if (funnelCanvas && insights.funnel) {
                const funnelCtx = funnelCanvas.getContext('2d');
                funnelChart = new Chart(funnelCtx, {
                    type: 'bar',
                    data: {
                        labels: insights.funnel.steps,
                        datasets: [{
                            label: 'Funnel',
                            data: insights.funnel.values,
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(239, 68, 68, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: { ticks: { color: '#1f2937' }, grid: { color: 'rgba(31,41,55,0.1)' } },
                            y: { ticks: { color: '#1f2937' }, grid: { color: 'rgba(31,41,55,0.1)' } }
                        }
                    }
                });
            }

            // Device/Browser Breakdown Chart (Doughnut)
            const deviceCanvas = document.getElementById('device-chart');
            if (deviceCanvas && insights.deviceBreakdown) {
                const deviceCtx = deviceCanvas.getContext('2d');
                deviceChart = new Chart(deviceCtx, {
                    type: 'doughnut',
                    data: {
                        labels: insights.deviceBreakdown.deviceLabels,
                        datasets: [{
                            data: insights.deviceBreakdown.devices,
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(245, 158, 11, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#1f2937' }
                            }
                        }
                    }
                });
            }

            // Set actionable insight values
            if (insights.conversionRate !== undefined) {
                document.getElementById('conversion-rate').textContent = insights.conversionRate + '%';
            }
            if (insights.retentionRate !== undefined) {
                document.getElementById('retention-rate').textContent = insights.retentionRate + '%';
            }
        }

        // Update analytics data and charts
        function updateAnalytics() {
            const data = generateAnalyticsData(currentFilters);
            
            // Update charts
            if (visitorChart) {
                visitorChart.data.labels = data.visitors.labels;
                visitorChart.data.datasets[0].data = data.visitors.data;
                visitorChart.update();
            }
            
            if (engagementChart) {
                engagementChart.data.datasets[0].data = [
                    data.engagement.returnVisitorRate,
                    100 - data.engagement.returnVisitorRate,
                    data.engagement.bounceRate,
                    100 - data.engagement.bounceRate
                ];
                engagementChart.update();
            }
            
            if (salesChart) {
                salesChart.data.datasets[0].data = data.sales.data;
                salesChart.update();
            }
            
            // Update statistics cards
            updateStatCard('visitor-stats', [
                `Total Users: ${data.summary.totalUsers}`,
                `Total Visitors (${currentFilters.dateRange}d): ${data.summary.totalVisitors}`,
                `Avg Daily Visitors: ${data.summary.avgDailyVisitors}`,
                `Active Session: ${data.summary.activeSession > 0 ? 'Yes' : 'No'}`
            ]);
            
            updateStatCard('engagement-stats', [
                `Bounce Rate: ${data.engagement.bounceRate.toFixed(1)}%`,
                `Avg Session: ${Math.floor(data.engagement.avgSessionDuration / 60)}m ${Math.floor(data.engagement.avgSessionDuration % 60)}s`,
                `Pages/Session: ${data.engagement.pagesPerSession.toFixed(1)}`,
                `Return Rate: ${data.engagement.returnVisitorRate.toFixed(1)}%`
            ]);
            
            updateStatCard('top-pages', [
                'Analytics Dashboard',
                'Oil Orders System', 
                'User Management',
                'Settings Page',
                'Admin Dashboard'
            ]);
        }
        
        function updateStatCard(cardType, items) {
            let listElement;
            if (cardType === 'visitor-stats') {
                listElement = document.getElementById('visitor-stats');
            } else if (cardType === 'engagement-stats') {
                listElement = document.getElementById('engagement-stats');
            } else if (cardType === 'top-pages') {
                listElement = document.getElementById('top-pages');
            }
            if (listElement) {
                listElement.innerHTML = '';
                // For top-pages, filter by search input if present
                if (cardType === 'top-pages') {
                    const searchInput = document.getElementById('top-pages-search');
                    let filter = '';
                    if (searchInput) filter = searchInput.value.trim().toLowerCase();
                    items = items.filter(item => item.toLowerCase().includes(filter));
                }
                if (items.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = 'No results';
                    listElement.appendChild(li);
                } else {
                    items.forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = item;
                        listElement.appendChild(li);
                    });
                }
            }
        }
        // Top Pages search filter handler
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('top-pages-search');
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    // Use the same items as in updateAnalytics
                    updateStatCard('top-pages', [
                        'Analytics Dashboard',
                        'Oil Orders System',
                        'User Management',
                        'Settings Page',
                        'Admin Dashboard'
                    ]);
                });
            }
        });

        // CSV Export functionality (enhanced)
        function exportCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            const analytics = window.analyticsManager ? window.analyticsManager.getData(currentFilters) : null;
            const data = analytics ? analytics.data : generateAnalyticsData(currentFilters);
            const insights = analytics ? analytics.insights : {};

            // Visitor data
            csvContent += "Date,Visitors\n";
            data.visitors.labels.forEach((label, index) => {
                csvContent += `${label},${data.visitors.data[index]}\n`;
            });

            // Summary statistics
            csvContent += "\nSummary Statistics\n";
            csvContent += `Total Users,${data.summary.totalUsers}\n`;
            csvContent += `Total Visitors (${currentFilters.dateRange}d),${data.summary.totalVisitors}\n`;
            csvContent += `Average Daily Visitors,${data.summary.avgDailyVisitors}\n`;
            csvContent += `Bounce Rate,${data.engagement.bounceRate.toFixed(1)}%\n`;
            csvContent += `Average Session Duration,${Math.floor(data.engagement.avgSessionDuration / 60)}m ${Math.floor(data.engagement.avgSessionDuration % 60)}s\n`;
            csvContent += `Pages per Session,${data.engagement.pagesPerSession.toFixed(1)}\n`;

            // Actionable insights
            if (insights.conversionRate !== undefined) {
                csvContent += `Conversion Rate,${insights.conversionRate}%\n`;
            }
            if (insights.retentionRate !== undefined) {
                csvContent += `Retention Rate,${insights.retentionRate}%\n`;
            }

            // Funnel
            if (insights.funnel) {
                csvContent += "\nFunnel Analysis\n";
                csvContent += insights.funnel.steps.map((s, i) => `${s},${insights.funnel.values[i]}`).join("\n") + "\n";
            }

            // Device/Browser breakdown
            if (insights.deviceBreakdown) {
                csvContent += "\nDevice Breakdown\n";
                insights.deviceBreakdown.deviceLabels.forEach((label, i) => {
                    csvContent += `${label},${insights.deviceBreakdown.devices[i]}%\n`;
                });
            }
            if (insights.browserBreakdown) {
                csvContent += "\nBrowser Breakdown\n";
                insights.browserBreakdown.browserLabels.forEach((label, i) => {
                    csvContent += `${label},${insights.browserBreakdown.browsers[i]}%\n`;
                });
            }

            // Multi-metric comparison
            if (insights.multiMetric) {
                csvContent += "\nMulti-Metric Comparison\nDate,Visitors,Orders,Sessions\n";
                insights.multiMetric.labels.forEach((label, i) => {
                    csvContent += `${label},${insights.multiMetric.visitors[i]},${insights.multiMetric.orders[i]},${insights.multiMetric.sessions[i]}\n`;
                });
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `analytics-report-${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('Enhanced CSV report exported successfully!');
        }

        // Update real-time statistics
        function updateRealtimeStats() {
            if (window.analyticsManager) {
                const realtimeStats = window.analyticsManager.getRealtimeStats();
                
                document.getElementById('active-users').textContent = realtimeStats.activeUsers;
                document.getElementById('current-page-views').textContent = realtimeStats.currentPageViews;
                document.getElementById('server-status').textContent = realtimeStats.serverStatus;
                document.getElementById('total-users').textContent = realtimeStats.totalUsers;
                
                // Update last updated timestamp
                const lastUpdatedElement = document.getElementById('last-updated');
                if (lastUpdatedElement) {
                    const date = new Date(realtimeStats.lastUpdate);
                    lastUpdatedElement.textContent = date.toLocaleTimeString();
                }
            } else {
                // Fallback when analytics manager is not available
                const users = JSON.parse(localStorage.getItem('siteUsers') || '[]');
                document.getElementById('active-users').textContent = '1';
                document.getElementById('current-page-views').textContent = Math.floor(Math.random() * 15 + 5);
                document.getElementById('server-status').textContent = 'Online';
                document.getElementById('total-users').textContent = users.length;
                
                // Update last updated timestamp
                const lastUpdatedElement = document.getElementById('last-updated');
                if (lastUpdatedElement) {
                    lastUpdatedElement.textContent = new Date().toLocaleTimeString();
                }
            }
        }

        // Refresh analytics data
        function refreshAnalyticsData() {
            if (window.analyticsManager) {
                // Force refresh of analytics data
                window.analyticsManager.createInitialData();
                updateAnalytics();
                updateRealtimeStats();
                showToast('Analytics data refreshed successfully!');
            }
        }

        // PDF Export functionality (enhanced)
        function exportPDF() {
            // Check if jsPDF is available
            if (!window.jspdf || !window.jspdf.jsPDF) {
                showToast('PDF export not available - CDN blocked. Using CSV fallback.');
                exportCSV();
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const analytics = window.analyticsManager ? window.analyticsManager.getData(currentFilters) : null;
            const data = analytics ? analytics.data : generateAnalyticsData(currentFilters);
            const insights = analytics ? analytics.insights : {};
            // Add title
            doc.setFontSize(20);
            doc.text('Analytics Report', 20, 30);
            // Add date range
            doc.setFontSize(12);
            doc.text(`Date Range: Last ${currentFilters.dateRange} days`, 20, 45);
            doc.text(`User Filter: ${currentFilters.userType === 'all' ? 'All Users' : currentFilters.userType + ' Users'}`, 20, 55);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 65);
            // Add summary statistics
            doc.setFontSize(14);
            doc.text('Summary Statistics', 20, 85);
            doc.setFontSize(10);
            let yPos = 95;
            const summaryStats = [
                `Total Users: ${data.summary.totalUsers}`,
                `Total Visitors (${currentFilters.dateRange}d): ${data.summary.totalVisitors}`,
                `Average Daily Visitors: ${data.summary.avgDailyVisitors}`,
                `Bounce Rate: ${data.engagement.bounceRate.toFixed(1)}%`,
                `Average Session Duration: ${Math.floor(data.engagement.avgSessionDuration / 60)}m ${Math.floor(data.engagement.avgSessionDuration % 60)}s`,
                `Pages per Session: ${data.engagement.pagesPerSession.toFixed(1)}`,
                `Return Visitor Rate: ${data.engagement.returnVisitorRate.toFixed(1)}%`
            ];
            summaryStats.forEach(stat => {
                doc.text(stat, 25, yPos);
                yPos += 10;
            });
            // Actionable insights
            if (insights.conversionRate !== undefined) {
                doc.text(`Conversion Rate: ${insights.conversionRate}%`, 25, yPos);
                yPos += 10;
            }
            if (insights.retentionRate !== undefined) {
                doc.text(`Retention Rate: ${insights.retentionRate}%`, 25, yPos);
                yPos += 10;
            }
            // Funnel
            if (insights.funnel) {
                doc.setFontSize(14);
                doc.text('Funnel Analysis', 20, yPos + 10);
                doc.setFontSize(10);
                yPos += 20;
                insights.funnel.steps.forEach((step, i) => {
                    doc.text(`${step}: ${insights.funnel.values[i]}`, 25, yPos);
                    yPos += 8;
                });
            }
            // Device/Browser breakdown
            if (insights.deviceBreakdown) {
                doc.setFontSize(14);
                doc.text('Device Breakdown', 20, yPos + 10);
                doc.setFontSize(10);
                yPos += 20;
                insights.deviceBreakdown.deviceLabels.forEach((label, i) => {
                    doc.text(`${label}: ${insights.deviceBreakdown.devices[i]}%`, 25, yPos);
                    yPos += 8;
                });
            }
            if (insights.browserBreakdown) {
                doc.setFontSize(14);
                doc.text('Browser Breakdown', 20, yPos + 10);
                doc.setFontSize(10);
                yPos += 20;
                insights.browserBreakdown.browserLabels.forEach((label, i) => {
                    doc.text(`${label}: ${insights.browserBreakdown.browsers[i]}%`, 25, yPos);
                    yPos += 8;
                });
            }
            // Multi-metric comparison
            if (insights.multiMetric) {
                doc.setFontSize(14);
                doc.text('Multi-Metric Comparison', 20, yPos + 10);
                doc.setFontSize(10);
                yPos += 20;
                doc.text('Date   Visitors   Orders   Sessions', 25, yPos);
                yPos += 8;
                insights.multiMetric.labels.forEach((label, i) => {
                    if (yPos > 270) { doc.addPage(); yPos = 30; }
                    doc.text(`${label}   ${insights.multiMetric.visitors[i]}   ${insights.multiMetric.orders[i]}   ${insights.multiMetric.sessions[i]}`, 25, yPos);
                    yPos += 8;
                });
            }
            // Product sales section
            doc.setFontSize(14);
            doc.text('Product Sales', 20, yPos + 15);
            doc.setFontSize(10);
            yPos += 25;
            data.sales.labels.forEach((product, index) => {
                doc.text(`${product}: ${data.sales.data[index]} units`, 25, yPos);
                yPos += 8;
            });
            // Add visitor trend data (sample)
            doc.setFontSize(14);
            doc.text('Recent Visitor Trends', 20, yPos + 15);
            doc.setFontSize(10);
            yPos += 25;
            const recentDays = data.visitors.labels.slice(-7);
            const recentData = data.visitors.data.slice(-7);
            recentDays.forEach((date, index) => {
                if (yPos > 250) { doc.addPage(); yPos = 30; }
                doc.text(`${date}: ${recentData[index]} visitors`, 25, yPos);
                yPos += 8;
            });
            doc.save(`analytics-report-${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('PDF report exported successfully!');
        }

        // PNG Export functionality for main charts
        function exportPNG() {
            // Check if Chart.js is available
            if (!window.Chart) {
                showToast('PNG export not available - Charts not loaded. Using CSV fallback.');
                exportCSV();
                return;
            }
            
            // Export visitor, engagement, and sales charts as PNG
            const charts = [
                { id: 'visitor-chart', name: 'visitor-trends' },
                { id: 'engagement-chart', name: 'user-engagement' },
                { id: 'sales-chart', name: 'product-sales' },
                { id: 'funnel-chart', name: 'funnel' },
                { id: 'device-chart', name: 'device-breakdown' },
                { id: 'browser-chart', name: 'browser-breakdown' },
                { id: 'multi-metric-chart', name: 'multi-metric' }
            ];
            
            let exportedCount = 0;
            charts.forEach(chart => {
                const canvas = document.getElementById(chart.id);
                if (canvas && Chart.getChart(canvas)) {
                    const url = Chart.getChart(canvas).toBase64Image();
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `analytics-${chart.name}-${new Date().toISOString().split('T')[0]}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    exportedCount++;
                }
            });
            
            if (exportedCount > 0) {
                showToast(`${exportedCount} charts exported as PNG images!`);
            } else {
                showToast('No charts available for PNG export. Using CSV fallback.');
                exportCSV();
            }
        }

        // Filter change handlers
        function setupFilterHandlers() {
            // Date range select
            document.getElementById('date-range').addEventListener('change', (e) => {
                currentFilters.dateRange = parseInt(e.target.value);
                updateAnalytics();
                updateActiveDateChip(currentFilters.dateRange);
                showToast(`Updated data for last ${currentFilters.dateRange} days`);
            });

            // Date filter chips
            document.querySelectorAll('.date-chip').forEach(chip => {
                chip.addEventListener('click', (e) => {
                    const range = parseInt(chip.getAttribute('data-range'));
                    currentFilters.dateRange = range;
                    document.getElementById('date-range').value = range;
                    updateAnalytics();
                    updateActiveDateChip(range);
                    showToast(`Updated data for last ${range === 1 ? 'today' : range + ' days'}`);
                });
                chip.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        chip.click();
                    }
                });
            });

            // Highlight active chip
            function updateActiveDateChip(activeRange) {
                document.querySelectorAll('.date-chip').forEach(chip => {
                    const range = parseInt(chip.getAttribute('data-range'));
                    if (range === activeRange) {
                        chip.classList.add('bg-primary', 'text-white');
                        chip.setAttribute('aria-pressed', 'true');
                    } else {
                        chip.classList.remove('bg-primary', 'text-white');
                        chip.setAttribute('aria-pressed', 'false');
                    }
                });
            }
            // Set initial chip highlight
            updateActiveDateChip(currentFilters.dateRange);

            // User type select
            document.getElementById('user-type').addEventListener('change', (e) => {
                currentFilters.userType = e.target.value;
                updateAnalytics();
                showToast(`Filtered by ${currentFilters.userType === 'all' ? 'all users' : currentFilters.userType + ' users'}`);
            });

            document.getElementById('export-csv').addEventListener('click', exportCSV);
            document.getElementById('export-pdf').addEventListener('click', exportPDF);
            document.getElementById('export-png').addEventListener('click', exportPNG);

            // Add refresh button handler
            const refreshBtn = document.getElementById('refresh-data');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', refreshAnalyticsData);
            }
        }

        // Theme Toggle
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;
        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark');
            body.classList.toggle('light');
            localStorage.setItem('theme', body.classList.contains('dark') ? 'dark' : 'light');
            themeToggle.textContent = body.classList.contains('dark') ? 'Toggle Light Mode' : 'Toggle Dark Mode';
            themeToggle.setAttribute('aria-label', body.classList.contains('dark') ? 'Toggle light mode' : 'Toggle dark mode');
        });

        // Load saved theme from settings or localStorage
        const settings = JSON.parse(localStorage.getItem('siteSettings')) || {};
        const savedTheme = settings['theme'] || localStorage.getItem('theme') || 'dark';
        body.classList.add(savedTheme);
        themeToggle.textContent = savedTheme === 'dark' ? 'Toggle Light Mode' : 'Toggle Dark Mode';
        themeToggle.setAttribute('aria-label', savedTheme === 'dark' ? 'Toggle light mode' : 'Toggle dark mode');

        // Mobile Menu Toggle
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            const isOpen = sidebar.classList.contains('open');
            menuToggle.setAttribute('aria-expanded', isOpen);
        });
        
        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadAndApplySettings();
            setupFilterHandlers();
            
            // Initialize charts after a short delay to ensure DOM is ready
            setTimeout(() => {
                initializeCharts();
                updateAnalytics();
                updateRealtimeStats();
                
                // Set up real-time updates every 30 seconds
                setInterval(updateRealtimeStats, 30000);
            }, 100);
            
            // Also call immediately to ensure real-time stats show up quickly
            setTimeout(updateRealtimeStats, 50);
        });
    </script>
</body>
</html>
