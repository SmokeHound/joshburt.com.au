<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Analytics</title>
  <link rel="manifest" href="./manifest.json" />
  <link rel="apple-touch-icon" href="./assets/images/logo-placeholder.svg" />
  <link rel="stylesheet" href="./assets/css/styles.css" />
  <script src="./assets/js/init-shared.js" defer></script>
  <script>
    // Defer heavy analytics deps and then load manager
    (async()=>{
      if(!window.Chart){ await import('https://cdn.jsdelivr.net/npm/chart.js'); }
      if(!window.jspdf || !window.jspdf.jsPDF){ await import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'); }
      const s=document.createElement('script'); s.src='analytics-manager.js'; s.defer=true; document.head.appendChild(s);
    })();
  </script>
  <style>
    /* Page-specific minor adjustments only */
    .card{background:#111;border:1px solid #333;transition:.2s box-shadow,.2s transform}
    .card:hover{box-shadow:0 4px 16px rgba(0,212,255,.25);transform:translateY(-3px);border-color:#00d4ff}
  </style>
</head>
<body class="dark min-h-screen flex flex-col md:flex-row font-sans">
  <button id="menu-toggle" class="md:hidden fixed top-4 left-4 z-50 p-2 bg-primary text-white rounded-md focus:outline-none focus:ring-2 focus:ring-secondary" aria-label="Toggle sidebar" aria-expanded="false">☰</button>
  <div id="main-nav"></div>
  <script>fetch('shared-nav.html').then(r=>r.text()).then(h=>{document.getElementById('main-nav').innerHTML=h;});</script>
  <main id="main-content" class="flex-1 p-4 space-y-6" role="main">
    <header class="p-4 md:p-6 card rounded-lg shadow-md sticky top-0 z-30">
      <h1 class="text-2xl font-bold">Analytics Dashboard</h1>
      <p class="text-sm text-gray-400 mt-1">Traffic, engagement & product performance overview</p>
    </header>
    <section class="space-y-4">
      <div class="flex flex-wrap gap-2" id="quick-date-chips"></div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <label class="block text-sm font-semibold mb-2">Date Range</label>
          <select id="date-range" class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700">
            <option value="7">Last 7 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
            <option value="365">Last year</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-2">User Type</label>
          <select id="user-type" class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700">
            <option value="all" selected>All Users</option>
            <option value="admin">Admin Users</option>
            <option value="user">Regular Users</option>
          </select>
        </div>
        <div class="flex flex-col gap-2">
          <label class="block text-sm font-semibold">Export</label>
          <div class="flex gap-2">
            <button id="export-csv" class="btn-neon-green flex-1 px-3 py-2 rounded-lg">CSV</button>
            <button id="export-pdf" class="btn-neon-blue flex-1 px-3 py-2 rounded-lg">PDF</button>
            <button id="export-png" class="btn-neon-blue flex-1 px-3 py-2 rounded-lg">PNG</button>
          </div>
        </div>
      </div>
      <div class="w-full text-center text-xs text-gray-400 flex items-center justify-center gap-2">
        <span id="last-updated">Last updated: --</span>
        <button id="refresh-btn" class="ml-2 px-2 py-1 rounded bg-gray-800 text-white text-xs hover:bg-gray-700">⟳ Refresh</button>
        <span class="text-gray-500 text-xs ml-2" id="auto-refresh-label">(auto every 60s)</span>
      </div>
    </section>
    <section class="mb-2">
      <div class="card widget-secondary rounded-lg shadow-md p-6">
        <h2 class="text-lg font-semibold mb-4 flex items-center"><span class="w-3 h-3 bg-green-400 rounded-full animate-pulse mr-3"></span>Real-time Statistics</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="text-center"><div class="text-2xl font-bold text-green-400" id="active-users">-</div><div class="text-xs text-gray-400">Active Users</div></div>
          <div class="text-center"><div class="text-2xl font-bold text-blue-400" id="current-page-views">-</div><div class="text-xs text-gray-400">Page Views (Hr)</div></div>
          <div class="text-center"><div class="text-2xl font-bold text-yellow-400" id="server-status">-</div><div class="text-xs text-gray-400">Server Status</div></div>
          <div class="text-center"><div class="text-2xl font-bold text-purple-400" id="total-users">-</div><div class="text-xs text-gray-400">Total Users</div></div>
        </div>
      </div>
    </section>
    <section class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="card p-4 widget-primary rounded-lg"><h3 class="text-sm font-semibold mb-1">Conversion Rate</h3><div id="insight-conversion" class="text-xl font-bold">--%</div></div>
      <div class="card p-4 widget-secondary rounded-lg"><h3 class="text-sm font-semibold mb-1">Retention Rate</h3><div id="insight-retention" class="text-xl font-bold">--%</div></div>
      <div class="card p-4 widget-accent rounded-lg"><h3 class="text-sm font-semibold mb-1">Top Product</h3><div id="insight-top-product" class="text-xl font-bold">--</div></div>
      <div class="card p-4 widget-yellow rounded-lg"><h3 class="text-sm font-semibold mb-1">Top User</h3><div id="insight-top-user" class="text-xl font-bold">--</div></div>
    </section>
    <div id="status-bar" class="w-full flex flex-wrap items-center justify-center gap-4 py-2 px-4 card text-sm">
      <span id="status-api" class="inline-flex items-center"><span class="w-2 h-2 rounded-full mr-2 bg-gray-500"></span>API: <span class="ml-1">Checking...</span></span>
      <span id="status-db" class="inline-flex items-center"><span class="w-2 h-2 rounded-full mr-2 bg-gray-500"></span>Database: <span class="ml-1">Checking...</span></span>
      <span id="status-server" class="inline-flex items-center"><span class="w-2 h-2 rounded-full mr-2 bg-gray-500"></span>Server: <span class="ml-1">Checking...</span></span>
    </div>
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="card widget-primary p-6 rounded-lg shadow-md"><h3 class="text-base font-semibold mb-4 flex items-center gap-2"><span class="inline-block w-2 h-2 bg-blue-400 rounded-full"></span>Visitor Trends</h3><div class="h-72"><canvas id="visitor-chart"></canvas></div></div>
      <div class="card widget-secondary p-6 rounded-lg shadow-md"><h3 class="text-base font-semibold mb-4 flex items-center gap-2"><span class="inline-block w-2 h-2 bg-green-400 rounded-full"></span>User Engagement</h3><div class="h-72"><canvas id="engagement-chart"></canvas></div></div>
      <div class="card widget-accent p-6 rounded-lg shadow-md lg:col-span-2"><h3 class="text-base font-semibold mb-4 flex items-center gap-2"><span class="inline-block w-2 h-2 bg-purple-400 rounded-full"></span>Product Sales Analytics</h3><div class="h-80"><canvas id="sales-chart"></canvas></div></div>
    </section>
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="card widget-primary p-6 rounded-lg shadow-md"><h3 class="text-base font-semibold mb-2">Visitor Statistics</h3><ul id="visitor-stats" class="list-disc pl-5 space-y-1 text-gray-300"><li>Loading...</li></ul></div>
      <div class="card widget-secondary p-6 rounded-lg shadow-md"><h3 class="text-base font-semibold mb-2">User Engagement</h3><ul id="engagement-stats" class="list-disc pl-5 space-y-1 text-gray-300"><li>Loading...</li></ul></div>
      <div class="card widget-accent p-6 rounded-lg shadow-md"><h3 class="text-base font-semibold mb-2 flex items-center justify-between">Top Pages <input id="top-pages-search" type="search" placeholder="Search pages..." class="ml-2 px-2 py-1 rounded bg-gray-800 border border-gray-600 text-sm" aria-label="Search top pages"></h3><ol id="top-pages" class="list-decimal pl-5 space-y-1 text-gray-300"><li>Loading...</li></ol></div>
    </section>
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="card p-4 rounded-lg"><h3 class="text-sm font-semibold mb-2">User Breakdown</h3><ul id="user-breakdown-list" class="space-y-1 text-sm"></ul></div>
      <div class="card p-4 rounded-lg"><h3 class="text-sm font-semibold mb-2">User Growth (30d)</h3><canvas id="user-growth-sparkline" width="180" height="60"></canvas></div>
      <div class="card p-4 rounded-lg"><h3 class="text-sm font-semibold mb-2">Top Users</h3><ul id="top-users-list" class="flex flex-col gap-1 text-sm"></ul><div class="mt-3 flex gap-2 items-center text-xs"><label for="user-role-filter">Role:</label><select id="user-role-filter" class="bg-gray-800 text-white rounded px-2 py-1 text-xs"><option value="all">All</option><option value="admin">Admin</option><option value="user">User</option><option value="locked">Locked</option></select></div><div class="mt-2 flex gap-2 items-center text-xs"><label for="user-date-filter">Since:</label><input type="date" id="user-date-filter" class="bg-gray-800 text-white rounded px-2 py-1 text-xs" /></div><button id="export-user-analytics" class="mt-3 w-full px-2 py-1 rounded bg-gray-800 text-white text-xs hover:bg-gray-700">Export Users CSV</button></div>
    </section>
  </main>
  <div id="toast" class="toast hidden fixed bottom-4 right-4 p-4 rounded-lg shadow-lg transition-opacity duration-300 text-sm" role="alert" aria-live="polite"></div>
  <script>
    const FN_BASE='/.netlify/functions';
    const REFRESH_INTERVAL=60000; let autoTimer=null; const filters={dateRange:30,userType:'all'};
    let visitorChart, engagementChart, salesChart, userGrowthSparkline;
    function showToast(msg){const t=document.getElementById('toast'); if(!t)return; t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),3000);}
    function setupQuickChips(){const ranges=[1,7,30,90,365]; const wrap=document.getElementById('quick-date-chips'); ranges.forEach(r=>{ const btn=document.createElement('button'); btn.className='px-3 py-1 rounded-full bg-gray-800 text-gray-200 text-xs'; btn.textContent=r===1?'Today': (r===365?'YTD': r+'d'); btn.dataset.range=r; btn.addEventListener('click',()=>{ filters.dateRange=r; document.getElementById('date-range').value=r; highlight(); updateAll();}); wrap.appendChild(btn);}); function highlight(){wrap.querySelectorAll('button').forEach(b=>{const active=parseInt(b.dataset.range)===filters.dateRange; b.classList.toggle('bg-primary',active); b.classList.toggle('text-white',active);});} highlight(); }
    async function fetchJSON(url){ try{ const r=await fetch(url); if(!r.ok) throw new Error(r.status); return await r.json(); }catch(e){ return null; } }
    async function generateData(){ const usersData=await fetchJSON(`${FN_BASE}/users`); const ordersData=await fetchJSON(`${FN_BASE}/orders`); const productsData=await fetchJSON(`${FN_BASE}/products`); const users=(usersData && usersData.users)||[]; let filteredUsers=users; if(filters.userType==='admin') filteredUsers=users.filter(u=>u.role==='admin'); else if(filters.userType==='user') filteredUsers=users.filter(u=>u.role==='user'); const orders=Array.isArray(ordersData)?ordersData:[]; const products=Array.isArray(productsData)?productsData:[]; const days=filters.dateRange; const labels=[]; const visitorCounts=[]; const now=new Date(); for(let i=days-1;i>=0;i--){ const d=new Date(now); d.setDate(now.getDate()-i); labels.push(d.toLocaleDateString()); const ds=d.toISOString().split('T')[0]; const count=orders.filter(o=> (o.created_at||'').startsWith(ds)).length; visitorCounts.push(count);} const productNames=products.map(p=>p.name); const salesCounts=productNames.map(n=> orders.reduce((s,o)=> s + ((o.items||[]).filter(i=>i.name===n).reduce((a,i)=>a+(i.quantity||1),0)),0)); const totalVisitors=visitorCounts.reduce((a,b)=>a+b,0); return { users:filteredUsers, orders, products, visitors:{labels,data:visitorCounts}, sales:{labels:productNames,data:salesCounts}, engagement:{ bounceRate: Math.max(0,100-(orders.length/(filteredUsers.length*days||1))*100), avgSessionDuration:300, pagesPerSession:3, returnVisitorRate:30 }, summary:{ totalUsers:filteredUsers.length, totalVisitors, avgDaily: days? Math.round(totalVisitors/days):0 }}; }
    function ensureCharts(data){ if(!window.Chart) return; if(!visitorChart){ visitorChart=new Chart(document.getElementById('visitor-chart'), { type:'line', data:{labels:data.visitors.labels,datasets:[{label:'Daily Visitors',data:data.visitors.data,borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.1)',tension:.4,fill:true}]}, options:{plugins:{legend:{labels:{color:'#f9fafb'}}},scales:{x:{ticks:{color:'#f9fafb'}},y:{ticks:{color:'#f9fafb'}}}}}); } else { visitorChart.data.labels=data.visitors.labels; visitorChart.data.datasets[0].data=data.visitors.data; visitorChart.update(); }
      if(!engagementChart){ engagementChart=new Chart(document.getElementById('engagement-chart'), { type:'doughnut', data:{ labels:['Return','New','Bounced','Engaged'], datasets:[{ data:[data.engagement.returnVisitorRate,100-data.engagement.returnVisitorRate,data.engagement.bounceRate,100-data.engagement.bounceRate], backgroundColor:['rgb(16,185,129)','rgb(59,130,246)','rgb(239,68,68)','rgb(139,92,246)'] }]}, options:{plugins:{legend:{labels:{color:'#f9fafb'}}}}}); } else { engagementChart.data.datasets[0].data=[data.engagement.returnVisitorRate,100-data.engagement.returnVisitorRate,data.engagement.bounceRate,100-data.engagement.bounceRate]; engagementChart.update(); }
      if(!salesChart){ salesChart=new Chart(document.getElementById('sales-chart'), { type:'bar', data:{ labels:data.sales.labels, datasets:[{ label:'Units Sold', data:data.sales.data, backgroundColor:['rgba(239,68,68,0.8)','rgba(16,185,129,0.8)','rgba(59,130,246,0.8)','rgba(139,92,246,0.8)','rgba(245,158,11,0.8)']}]}, options:{plugins:{legend:{labels:{color:'#f9fafb'}}},scales:{x:{ticks:{color:'#f9fafb'}},y:{ticks:{color:'#f9fafb'}}}}}); } else { salesChart.data.labels=data.sales.labels; salesChart.data.datasets[0].data=data.sales.data; salesChart.update(); } }
    function updateStatCard(id, items){ const el=document.getElementById(id); if(!el) return; el.innerHTML=''; if(!items.length){ el.innerHTML='<li>No results</li>'; return;} items.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; el.appendChild(li); }); }
    function trendArrow(v){ if(v>50) return '↗'; if(v<20) return '↘'; return '→'; }
    async function updateAll(){ const last=document.getElementById('last-updated'); try{ const data=await generateData(); if(last) last.textContent='Last updated: '+ new Date().toLocaleTimeString(); ensureCharts(data); updateStatCard('visitor-stats',[`Total Visitors (${filters.dateRange}d): ${data.summary.totalVisitors}`,`Avg Daily: ${data.summary.avgDaily}`,`Active Session: ${data.summary.totalUsers>0?'Yes':'No'}`]); updateStatCard('engagement-stats',[`Bounce Rate: ${data.engagement.bounceRate.toFixed(1)}%`,`Avg Session: 5m 0s`,`Pages/Session: ${data.engagement.pagesPerSession.toFixed(1)}`,`Return Rate: ${data.engagement.returnVisitorRate.toFixed(1)}%`]); updateStatCard('top-pages',['Analytics Dashboard','Oil Orders System','User Management','Settings Page','Admin Dashboard']); const totalSalesUnits=data.sales.data.reduce((a,b)=>a+b,0); const conversion = data.summary.totalUsers ? (totalSalesUnits / data.summary.totalUsers)*100 : 0; document.getElementById('insight-conversion').textContent=conversion.toFixed(1)+'% '+trendArrow(conversion); document.getElementById('insight-retention').textContent=data.engagement.returnVisitorRate.toFixed(1)+'% '+trendArrow(data.engagement.returnVisitorRate); if(data.sales.data.length){ const idx=data.sales.data.indexOf(Math.max(...data.sales.data)); document.getElementById('insight-top-product').textContent=data.sales.labels[idx]||'--'; } await updateTopUser(); await buildUserBreakdown(); }catch(e){ if(last) last.textContent='Last updated: error'; } }
    async function updateTopUser(){ try{ const orders=await fetchJSON(`${FN_BASE}/orders`); const usersData=await fetchJSON(`${FN_BASE}/users`); const users=(usersData && usersData.users)||[]; const counts={}; (orders||[]).forEach(o=>{ if(o.created_by) counts[o.created_by]=(counts[o.created_by]||0)+1; }); let top='--', max=0; Object.entries(counts).forEach(([u,c])=>{ if(c>max){ max=c; top=u; }}); document.getElementById('insight-top-user').textContent=top; }catch(e){ document.getElementById('insight-top-user').textContent='--'; } }
    async function buildUserBreakdown(){ let users=[]; let orders=[]; try{ const u=await fetchJSON(`${FN_BASE}/users`); users=(u&&u.users)||[]; }catch(_){} try{ const o=await fetchJSON(`${FN_BASE}/orders`); orders=o||[]; }catch(_){} const list=document.getElementById('user-breakdown-list'); if(list){ const total=users.length; const admins=users.filter(u=>u.role==='admin').length; const regular=users.filter(u=>u.role==='user').length; const locked=users.filter(u=>u.locked).length; const now=new Date(); const newUsers=users.filter(u=>u.created_at && (now-new Date(u.created_at))<7*24*60*60*1000).length; const returning=users.filter(u=> orders.filter(o=>o.created_by===u.username).length>1).length; list.innerHTML=`<li>Total: <strong>${total}</strong></li><li>Admins: <strong>${admins}</strong></li><li>Regular: <strong>${regular}</strong></li><li>Locked: <strong>${locked}</strong></li><li>New (7d): <strong>${newUsers}</strong></li><li>Returning: <strong>${returning}</strong></li>`; } const growthCanvas=document.getElementById('user-growth-sparkline'); if(growthCanvas && window.Chart){ const arr=Array(30).fill(0); const now=new Date(); users.forEach(u=>{ if(u.created_at){ const daysAgo=Math.floor((now-new Date(u.created_at))/(24*60*60*1000)); if(daysAgo>=0 && daysAgo<30) arr[29-daysAgo]++; }}); if(userGrowthSparkline) userGrowthSparkline.destroy(); userGrowthSparkline=new Chart(growthCanvas.getContext('2d'),{ type:'line', data:{ labels:Array.from({length:30},(_,i)=>i+1), datasets:[{ data:arr,borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.1)',tension:.4,fill:true,pointRadius:0,borderWidth:2 }]}, options:{responsive:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}}}}); } const topList=document.getElementById('top-users-list'); if(topList){ const counts={}; orders.forEach(o=>{ if(o.created_by) counts[o.created_by]=(counts[o.created_by]||0)+1; }); const top=Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,5); topList.innerHTML= top.length? top.map(([u,c])=>`<li class='flex items-center'><span class='inline-block w-2 h-2 rounded-full bg-blue-400 mr-2'></span><strong>${u}</strong><span class='ml-2 text-xs text-gray-400'>${c} orders</span></li>`).join(''):'<li>N/A</li>'; } }
    async function updateRealtime(){ let apiHealthy=false, dbHealthy=false, serverHealthy=true; try{ apiHealthy=(await fetch(`${FN_BASE}/users`)).ok; }catch(_){} try{ dbHealthy=(await fetch(`${FN_BASE}/orders`)).ok; }catch(_){} function setStatus(id, healthy){ const el=document.getElementById(id); if(!el) return; const dot=el.querySelector('span'); const text=el.querySelector('span.ml-1'); if(dot){ dot.classList.remove('bg-gray-500','bg-green-500','bg-red-500'); dot.classList.add(healthy?'bg-green-500':'bg-red-500'); } if(text) text.textContent=healthy?'Online':'Offline'; } setStatus('status-api', apiHealthy); setStatus('status-db', dbHealthy); setStatus('status-server', serverHealthy); document.getElementById('active-users').textContent=Math.floor(Math.random()*5)+1; document.getElementById('current-page-views').textContent=Math.floor(Math.random()*50)+10; document.getElementById('server-status').textContent=serverHealthy?'Online':'Offline'; try{ const u=await fetchJSON(`${FN_BASE}/users`); document.getElementById('total-users').textContent=(u&&u.users?u.users.length:'--'); }catch(_){ document.getElementById('total-users').textContent='--'; } }
    function exportCSV(){ (async()=>{ const data=await generateData(); let csv='Date,Visitors\n'; data.visitors.labels.forEach((l,i)=> csv+=`${l},${data.visitors.data[i]}\n`); csv+='\nSummary\n'; csv+=`Total Visitors (${filters.dateRange}d),${data.summary.totalVisitors}\nAverage Daily Visitors,${data.summary.avgDaily}\nBounce Rate,${data.engagement.bounceRate.toFixed(1)}%\nReturn Rate,${data.engagement.returnVisitorRate.toFixed(1)}%\n`; csv+='\nProduct Sales\n'; data.sales.labels.forEach((p,i)=> csv+=`${p},${data.sales.data[i]}\n`); const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`analytics-report-${new Date().toISOString().split('T')[0]}.csv`; a.click(); showToast('CSV exported'); })(); }
    function exportUserCSV(){ (async()=>{ const u=await fetchJSON(`${FN_BASE}/users`); const o=await fetchJSON(`${FN_BASE}/orders`); const users=(u&&u.users)||[]; const orders=o||[]; let csv='Username,Role,Locked,Created At,Orders\n'; users.forEach(user=>{ const count=orders.filter(or=>or.created_by===user.username).length; csv+=`${user.username},${user.role},${user.locked?'Yes':'No'},${user.created_at||''},${count}\n`; }); const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`user-analytics-${new Date().toISOString().split('T')[0]}.csv`; a.click(); showToast('User analytics CSV exported'); })(); }
    function exportPDF(){ if(!window.jspdf||!window.jspdf.jsPDF){ showToast('PDF unavailable; CSV fallback'); return exportCSV(); } const { jsPDF }=window.jspdf; (async()=>{ const data=await generateData(); const doc=new jsPDF(); doc.setFontSize(18); doc.text('Analytics Report',20,20); doc.setFontSize(10); doc.text(`Generated: ${new Date().toLocaleString()}`,20,28); let y=40; const lines=[`Range: ${filters.dateRange}d`,`Total Visitors: ${data.summary.totalVisitors}`,`Avg Daily: ${data.summary.avgDaily}`,`Bounce: ${data.engagement.bounceRate.toFixed(1)}%`,`Return: ${data.engagement.returnVisitorRate.toFixed(1)}%`]; lines.forEach(l=>{ doc.text(l,20,y); y+=6; }); y+=4; doc.text('Product Sales:',20,y); y+=6; data.sales.labels.forEach((p,i)=>{ if(y>270){ doc.addPage(); y=20;} doc.text(`${p}: ${data.sales.data[i]}`,26,y); y+=6; }); doc.save(`analytics-report-${new Date().toISOString().split('T')[0]}.pdf`); showToast('PDF exported'); })(); }
    function exportPNG(){ if(!window.Chart){ showToast('Charts not loaded'); return; } const charts=[['visitor-chart','visitor'],['engagement-chart','engagement'],['sales-chart','sales']]; charts.forEach(([id,name])=>{ const c=document.getElementById(id); if(c){ const ch=Chart.getChart(c); if(ch){ const url=ch.toBase64Image(); const a=document.createElement('a'); a.href=url; a.download=`analytics-${name}-${new Date().toISOString().split('T')[0]}.png`; a.click(); } } }); showToast('PNG export complete'); }
    function bindUI(){ document.getElementById('date-range').addEventListener('change',e=>{ filters.dateRange=parseInt(e.target.value); updateAll(); }); document.getElementById('user-type').addEventListener('change',e=>{ filters.userType=e.target.value; updateAll();}); document.getElementById('export-csv').addEventListener('click',exportCSV); document.getElementById('export-pdf').addEventListener('click',exportPDF); document.getElementById('export-png').addEventListener('click',exportPNG); document.getElementById('export-user-analytics').addEventListener('click',exportUserCSV); document.getElementById('refresh-btn').addEventListener('click',()=>{ updateAll(); updateRealtime(); showToast('Refreshed');}); }
    function startAuto(){ if(autoTimer) clearInterval(autoTimer); autoTimer=setInterval(()=>{ updateAll(); updateRealtime(); }, REFRESH_INTERVAL); }
    document.addEventListener('DOMContentLoaded',()=>{ setupQuickChips(); bindUI(); updateAll(); updateRealtime(); startAuto(); });
  </script>
</body>
</html>
