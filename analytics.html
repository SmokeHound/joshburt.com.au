<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Analytics</title>
  <link rel="manifest" href="./manifest.json" />
  <link rel="apple-touch-icon" href="./assets/images/logo-placeholder.svg" />
  <link rel="stylesheet" href="./assets/css/styles.css" />
  <script src="./assets/js/init-shared.js" defer></script>
  <script src="./assets/js/feature-flags.js" defer></script>
  <script>
    // Purge legacy role demo key to avoid stale UI state
    try { localStorage.removeItem('currentUser'); } catch (_) {}
  </script>
  <script>
    // Defer heavy analytics deps and then load manager
    (async()=>{
      if(!window.Chart){ await import('https://cdn.jsdelivr.net/npm/chart.js'); }
      if(!window.jspdf || !window.jspdf.jsPDF){ await import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'); }
      const s=document.createElement('script'); s.src='analytics-manager.js'; s.defer=true; document.head.appendChild(s);
    })();
  </script>
</head>
<body class="dark min-h-screen flex flex-col md:flex-row font-sans">
  <button id="menu-toggle" class="md:hidden fixed top-4 left-4 z-50 p-2 bg-primary text-white rounded-md focus:outline-none focus:ring-2 focus:ring-secondary" aria-label="Toggle sidebar" aria-expanded="false">â˜°</button>
  <div id="main-nav"></div>
  <script>fetch('shared-nav.html').then(r=>r.text()).then(h=>{document.getElementById('main-nav').innerHTML=h;if(window.setActiveNavLink)window.setActiveNavLink();});</script>
  <main id="main-content" class="flex-1 p-4 space-y-6" role="main">
  <header class="page-header card border">
      <h1 class="text-2xl font-bold">Analytics Dashboard</h1>
  <p class="text-sm text-gray-400 mt-1">Traffic, engagement & feature usage overview</p>
    </header>
    <section class="space-y-4">
      <div class="flex flex-wrap gap-2" id="quick-date-chips"></div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <label class="block text-sm font-semibold mb-2">Date Range</label>
          <select id="date-range" class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700">
            <option value="7">Last 7 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
            <option value="365">Last year</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-2">User Type</label>
          <select id="user-type" class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700">
            <option value="all" selected>All Users</option>
            <option value="admin">Admin Users</option>
            <option value="user">Regular Users</option>
          </select>
        </div>
        <div class="flex flex-col gap-2">
          <label class="block text-sm font-semibold">Export</label>
          <div class="flex gap-2">
            <button id="export-csv" class="btn-neon-green flex-1 px-3 py-2 rounded-lg">CSV</button>
            <button id="export-pdf" class="btn-neon-blue flex-1 px-3 py-2 rounded-lg">PDF</button>
            <button id="export-png" class="btn-neon-blue flex-1 px-3 py-2 rounded-lg">PNG</button>
          </div>
        </div>
      </div>
      <div class="w-full text-center text-xs text-gray-400 flex items-center justify-center gap-2">
        <span id="last-updated">Last updated: --</span>
        <button id="refresh-btn" class="ml-2 px-2 py-1 rounded bg-gray-800 text-white text-xs hover:bg-gray-700">âŸ³ Refresh</button>
        <span class="text-gray-500 text-xs ml-2" id="auto-refresh-label">(auto every 60s)</span>
      </div>
    </section>
    <section class="mb-2">
      <div class="card widget-secondary rounded-lg shadow-md p-6">
        <h2 class="text-lg font-semibold mb-4 flex items-center"><span class="w-3 h-3 bg-green-400 rounded-full animate-pulse mr-3"></span>Real-time Statistics</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="text-center"><div class="text-2xl font-bold text-green-400" id="active-users">-</div><div class="text-xs text-gray-400">Active Users</div></div>
          <div class="text-center"><div class="text-2xl font-bold text-blue-400" id="current-page-views">-</div><div class="text-xs text-gray-400">Page Views (Hr)</div></div>
          <div class="text-center"><div class="text-2xl font-bold text-yellow-400" id="server-status">-</div><div class="text-xs text-gray-400">Server Status</div></div>
          <div class="text-center"><div class="text-2xl font-bold text-purple-400" id="total-users">-</div><div class="text-xs text-gray-400">Total Users</div></div>
        </div>
      </div>
    </section>
    <section class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="card p-4 widget-primary rounded-lg"><h3 class="text-sm font-semibold mb-1">Login Success Rate</h3><div id="insight-conversion" class="text-xl font-bold">--%</div></div>
      <div class="card p-4 widget-secondary rounded-lg"><h3 class="text-sm font-semibold mb-1">Failed Logins (24h)</h3><div id="insight-retention" class="text-xl font-bold">--</div></div>
      <div class="card p-4 widget-accent rounded-lg"><h3 class="text-sm font-semibold mb-1">Top Endpoint</h3><div id="insight-top-product" class="text-xl font-bold">--</div></div>
      <div class="card p-4 widget-yellow rounded-lg"><h3 class="text-sm font-semibold mb-1">Top User</h3><div id="insight-top-user" class="text-xl font-bold">--</div></div>
    </section>
    <div id="status-bar" class="w-full flex flex-wrap items-center justify-center gap-4 py-2 px-4 card text-sm">
      <span id="status-api" class="inline-flex items-center"><span class="w-2 h-2 rounded-full mr-2 bg-gray-500"></span>API: <span class="ml-1">Checking...</span></span>
      <span id="status-db" class="inline-flex items-center"><span class="w-2 h-2 rounded-full mr-2 bg-gray-500"></span>Database: <span class="ml-1">Checking...</span></span>
      <span id="status-server" class="inline-flex items-center"><span class="w-2 h-2 rounded-full mr-2 bg-gray-500"></span>Server: <span class="ml-1">Checking...</span></span>
    </div>
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <div class="card widget-primary p-6 rounded-lg shadow-md"><h3 class="text-base font-semibold mb-4 flex items-center gap-2"><span class="inline-block w-2 h-2 bg-blue-400 rounded-full"></span>Daily Activity</h3><div class="h-72"><canvas id="visitor-chart"></canvas></div></div>
  <div class="card widget-secondary p-6 rounded-lg shadow-md"><h3 class="text-base font-semibold mb-4 flex items-center gap-2"><span class="inline-block w-2 h-2 bg-green-400 rounded-full"></span>Method Distribution</h3><div class="h-72"><canvas id="engagement-chart"></canvas></div></div>
  <div class="card widget-accent p-6 rounded-lg shadow-md lg:col-span-2"><h3 class="text-base font-semibold mb-4 flex items-center gap-2"><span class="inline-block w-2 h-2 bg-purple-400 rounded-full"></span>Endpoint Activity (Top Paths)</h3><div class="h-80"><canvas id="sales-chart"></canvas></div></div>
    </section>
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="card widget-primary p-6 rounded-lg shadow-md"><h3 class="text-base font-semibold mb-2">Visitor Statistics</h3><ul id="visitor-stats" class="list-disc pl-5 space-y-1 text-gray-300"><li>Loading...</li></ul></div>
      <div class="card widget-secondary p-6 rounded-lg shadow-md"><h3 class="text-base font-semibold mb-2">User Engagement</h3><ul id="engagement-stats" class="list-disc pl-5 space-y-1 text-gray-300"><li>Loading...</li></ul></div>
      <div class="card widget-accent p-6 rounded-lg shadow-md"><h3 class="text-base font-semibold mb-2 flex items-center justify-between">Top Pages <input id="top-pages-search" type="search" placeholder="Search pages..." class="ml-2 px-2 py-1 rounded bg-gray-800 border border-gray-600 text-sm" aria-label="Search top pages"></h3><ol id="top-pages" class="list-decimal pl-5 space-y-1 text-gray-300"><li>Loading...</li></ol></div>
    </section>
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="card p-4 rounded-lg"><h3 class="text-sm font-semibold mb-2">User Breakdown</h3><ul id="user-breakdown-list" class="space-y-1 text-sm"></ul></div>
      <div class="card p-4 rounded-lg"><h3 class="text-sm font-semibold mb-2">User Growth (30d)</h3><canvas id="user-growth-sparkline" width="180" height="60"></canvas></div>
      <div class="card p-4 rounded-lg"><h3 class="text-sm font-semibold mb-2">Top Users</h3><ul id="top-users-list" class="flex flex-col gap-1 text-sm"></ul><div class="mt-3 flex gap-2 items-center text-xs"><label for="user-role-filter">Role:</label><select id="user-role-filter" class="bg-gray-800 text-white rounded px-2 py-1 text-xs"><option value="all">All</option><option value="admin">Admin</option><option value="user">User</option><option value="locked">Locked</option></select></div><div class="mt-2 flex gap-2 items-center text-xs"><label for="user-date-filter">Since:</label><input type="date" id="user-date-filter" class="bg-gray-800 text-white rounded px-2 py-1 text-xs" /></div><button id="export-user-analytics" class="mt-3 w-full px-2 py-1 rounded bg-gray-800 text-white text-xs hover:bg-gray-700">Export Users CSV</button></div>
    </section>

    <!-- Advanced Reports Section (Feature Flag Gated) -->
    <section id="advanced-reports-section" class="hidden mt-8">
      <div class="card p-6 rounded-lg border-2 border-purple-500/30">
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <h2 class="text-xl font-bold text-purple-400">ðŸ“Š Advanced Reports</h2>
            <span class="text-xs bg-purple-500 text-white px-2 py-1 rounded">PREMIUM</span>
          </div>
          <button id="generate-advanced-report" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors">
            Generate Report
          </button>
        </div>

        <!-- Report Configuration -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <div>
            <label class="block text-sm font-semibold mb-2">Report Type</label>
            <select id="report-type" class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700">
              <option value="comprehensive">Comprehensive Analysis</option>
              <option value="predictive">Predictive Analytics</option>
              <option value="comparative">Comparative Report</option>
              <option value="behavioral">User Behavior Analysis</option>
              <option value="revenue">Revenue Forecast</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2">Time Period</label>
            <select id="report-period" class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700">
              <option value="7">Last 7 days</option>
              <option value="30">Last 30 days</option>
              <option value="90">Last 90 days</option>
              <option value="365">Last year</option>
              <option value="custom">Custom Range</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2">Export Format</label>
            <select id="report-format" class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700">
              <option value="pdf">PDF Report</option>
              <option value="excel">Excel Spreadsheet</option>
              <option value="json">JSON Data</option>
              <option value="dashboard">Interactive Dashboard</option>
            </select>
          </div>
        </div>

        <!-- Advanced Metrics Grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-gray-800/50 p-4 rounded-lg text-center">
            <div class="text-xs text-gray-400 mb-1">Customer Lifetime Value</div>
            <div class="text-2xl font-bold text-purple-400">$2,456</div>
            <div class="text-xs text-green-400 mt-1">â†— +12.5%</div>
          </div>
          <div class="bg-gray-800/50 p-4 rounded-lg text-center">
            <div class="text-xs text-gray-400 mb-1">Churn Rate</div>
            <div class="text-2xl font-bold text-purple-400">8.3%</div>
            <div class="text-xs text-green-400 mt-1">â†˜ -2.1%</div>
          </div>
          <div class="bg-gray-800/50 p-4 rounded-lg text-center">
            <div class="text-xs text-gray-400 mb-1">Customer Acquisition Cost</div>
            <div class="text-2xl font-bold text-purple-400">$127</div>
            <div class="text-xs text-red-400 mt-1">â†— +5.3%</div>
          </div>
          <div class="bg-gray-800/50 p-4 rounded-lg text-center">
            <div class="text-xs text-gray-400 mb-1">Revenue Per User</div>
            <div class="text-2xl font-bold text-purple-400">$182</div>
            <div class="text-xs text-green-400 mt-1">â†— +8.7%</div>
          </div>
        </div>

        <!-- Report Preview Area -->
        <div id="report-preview" class="bg-gray-800/30 p-6 rounded-lg border border-gray-700">
          <div class="text-center text-gray-400">
            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <p class="font-semibold mb-2">Select report type and click "Generate Report"</p>
            <p class="text-sm">Advanced reports include predictive analytics, trend analysis, and actionable insights.</p>
          </div>
        </div>
      </div>
    </section>
  </main>
  <script>
  const FN_BASE=window.FN_BASE||'/.netlify/functions';
    const REFRESH_INTERVAL=60000; let autoTimer=null; const filters={dateRange:30,userType:'all'};
    let visitorChart, engagementChart, salesChart, userGrowthSparkline;
    function setupQuickChips(){const ranges=[1,7,30,90,365]; const wrap=document.getElementById('quick-date-chips'); ranges.forEach(r=>{ const btn=document.createElement('button'); btn.className='px-3 py-1 rounded-full bg-gray-800 text-gray-200 text-xs'; btn.textContent=r===1?'Today': (r===365?'YTD': r+'d'); btn.dataset.range=r; btn.addEventListener('click',()=>{ filters.dateRange=r; document.getElementById('date-range').value=r; highlight(); updateAll();}); wrap.appendChild(btn);}); function highlight(){wrap.querySelectorAll('button').forEach(b=>{const active=parseInt(b.dataset.range)===filters.dateRange; b.classList.toggle('bg-primary',active); b.classList.toggle('text-white',active);});} highlight(); }
  async function fetchJSON(url){ try{ const r=await fetch(url); if(!r.ok) throw new Error(r.status); return await r.json(); }catch(e){ return null; } }
  async function fetchAuditLogs(limit=2000){ const res=await fetchJSON(`${FN_BASE}/audit-logs?limit=${limit}`); if(!res) return []; return Array.isArray(res.data)? res.data : (Array.isArray(res)? res : []); }
  function safeParseDetails(d){ if(!d) return {}; try{ return JSON.parse(d); }catch(_){ return {}; } }
  function isWithinDays(ts, days){ try{ const t=new Date(ts).getTime(); return (Date.now()-t) <= days*24*60*60*1000; }catch(_){ return false; } }
  function isWithinMs(ts, ms){ try{ const t=new Date(ts).getTime(); return (Date.now()-t) <= ms; }catch(_){ return false; } }
  async function generateData(){ const usersData=await fetchJSON(`${FN_BASE}/users`); const users=(usersData && usersData.users)||[]; let filteredUsers=users; if(filters.userType==='admin') filteredUsers=users.filter(u=>u.role==='admin'); else if(filters.userType==='user') filteredUsers=users.filter(u=>u.role==='user'); const days=filters.dateRange; const logs=await fetchAuditLogs(2000); const logsInRange=logs.filter(l=> isWithinDays(l.created_at||l.createdAt||l.createdAtUtc||l.timestamp||l.time, days)); const labels=[]; const dailyCounts=[]; const now=new Date(); for(let i=days-1;i>=0;i--){ const d=new Date(now); d.setDate(now.getDate()-i); labels.push(d.toLocaleDateString()); const ds=d.toISOString().split('T')[0]; const c=logsInRange.filter(l=> (String(l.created_at||'').startsWith(ds))).length; dailyCounts.push(c); } const pathCounts={}; const methodCounts={ GET:0, POST:0, PUT:0, DELETE:0, OTHER:0 }; let loginSuccess=0, loginFailed=0; const userActivityCounts={}; for(const l of logsInRange){ const det=safeParseDetails(l.details); const p=det.path || det.url || det.endpoint || 'unknown'; const m=(det.method||'OTHER').toUpperCase(); pathCounts[p]=(pathCounts[p]||0)+1; if(methodCounts[m]!==undefined) methodCounts[m]++; else methodCounts.OTHER++; if(l.action==='auth.login_success') loginSuccess++; if(l.action==='auth.login_failed') loginFailed++; const uid = l.user_id || (det.userId) || null; if(uid!=null){ userActivityCounts[uid]=(userActivityCounts[uid]||0)+1; } } const topPaths=Object.entries(pathCounts).sort((a,b)=>b[1]-a[1]).slice(0,10); const pageViewsHour=logs.filter(l=> isWithinMs(l.created_at||l.createdAt||l.timestamp, 60*60*1000)).length; const activeUsers15= new Set(logs.filter(l=> isWithinMs(l.created_at||l.createdAt||l.timestamp, 15*60*1000)).map(l=> l.user_id).filter(Boolean)).size; const successRate = (loginSuccess+loginFailed)>0 ? (loginSuccess/(loginSuccess+loginFailed))*100 : 100; const failed24h = logs.filter(l=> (l.action==='auth.login_failed') && isWithinMs(l.created_at||l.createdAt||l.timestamp, 24*60*60*1000)).length; return { users:filteredUsers, visitors:{labels,data:dailyCounts}, endpoints:{ labels: topPaths.map(([p])=>p), data: topPaths.map(([,c])=>c) }, methods:methodCounts, summary:{ totalUsers:filteredUsers.length, totalEvents:logsInRange.length, avgDaily: days? Math.round(dailyCounts.reduce((a,b)=>a+b,0)/days):0, pageViewsHour, activeUsers15, loginSuccessRate: successRate, failed24h, topEndpoint: topPaths[0]?.[0]||'--', topUserId: Object.entries(userActivityCounts).sort((a,b)=>b[1]-a[1])[0]?.[0]||null } };
  }
    function ensureCharts(data){ if(!window.Chart) return; if(!visitorChart){ visitorChart=new Chart(document.getElementById('visitor-chart'), { type:'line', data:{labels:data.visitors.labels,datasets:[{label:'Daily Activity',data:data.visitors.data,borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.1)',tension:.4,fill:true}]}, options:{plugins:{legend:{labels:{color:'#f9fafb'}}},scales:{x:{ticks:{color:'#f9fafb'}},y:{ticks:{color:'#f9fafb'}}}}}); } else { visitorChart.data.labels=data.visitors.labels; visitorChart.data.datasets[0].data=data.visitors.data; visitorChart.update(); }
      const methodVals=[data.methods.GET||0,data.methods.POST||0,data.methods.PUT||0,data.methods.DELETE||0,(data.methods.OTHER||0)];
      if(!engagementChart){ engagementChart=new Chart(document.getElementById('engagement-chart'), { type:'doughnut', data:{ labels:['GET','POST','PUT','DELETE','OTHER'], datasets:[{ data:methodVals, backgroundColor:['rgb(59,130,246)','rgb(16,185,129)','rgb(245,158,11)','rgb(239,68,68)','rgb(139,92,246)'] }]}, options:{plugins:{legend:{labels:{color:'#f9fafb'}}}}}); } else { engagementChart.data.datasets[0].data=methodVals; engagementChart.update(); }
      if(!salesChart){ salesChart=new Chart(document.getElementById('sales-chart'), { type:'bar', data:{ labels:data.endpoints.labels, datasets:[{ label:'Requests', data:data.endpoints.data, backgroundColor:['rgba(59,130,246,0.8)','rgba(16,185,129,0.8)','rgba(245,158,11,0.8)','rgba(239,68,68,0.8)','rgba(139,92,246,0.8)']}]}, options:{plugins:{legend:{labels:{color:'#f9fafb'}}},scales:{x:{ticks:{color:'#f9fafb'}},y:{ticks:{color:'#f9fafb'}}}}}); } else { salesChart.data.labels=data.endpoints.labels; salesChart.data.datasets[0].data=data.endpoints.data; salesChart.update(); } }
    function updateStatCard(id, items){ const el=document.getElementById(id); if(!el) return; el.innerHTML=''; if(!items.length){ el.innerHTML='<li>No results</li>'; return;} items.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; el.appendChild(li); }); }
    function trendArrow(v){ if(v>50) return 'â†—'; if(v<20) return 'â†˜'; return 'â†’'; }
  async function updateAll(){ const last=document.getElementById('last-updated'); try{ const data=await generateData(); if(last) last.textContent='Last updated: '+ new Date().toLocaleTimeString(); ensureCharts(data); updateStatCard('visitor-stats',[`Total Events (${filters.dateRange}d): ${data.summary.totalEvents}`,`Avg Daily: ${data.summary.avgDaily}`,`Active Users (15m): ${data.summary.activeUsers15}`]); updateStatCard('engagement-stats',[`GET: ${data.methods.GET||0}`,`POST: ${data.methods.POST||0}`,`PUT: ${data.methods.PUT||0}`,`DELETE: ${data.methods.DELETE||0}`,`OTHER: ${data.methods.OTHER||0}`]); updateStatCard('top-pages', data.endpoints.labels.slice(0,5).map((p,i)=> `${p} (${data.endpoints.data[i]})`)); const conv=data.summary.loginSuccessRate||0; document.getElementById('insight-conversion').textContent=conv.toFixed(1)+'% '+trendArrow(conv); document.getElementById('insight-retention').textContent=String(data.summary.failed24h||0); document.getElementById('insight-top-product').textContent=data.summary.topEndpoint||'--'; await updateTopUser(data); await buildUserBreakdown(); }catch(e){ if(last) last.textContent='Last updated: error'; } }
  async function updateTopUser(prefetched){ try{ const usersData = prefetched && prefetched.users ? { users: prefetched.users } : await fetchJSON(`${FN_BASE}/users`); const users=(usersData && usersData.users)||[]; const userById=new Map(users.map(u=>[String(u.id||u.user_id||u.uid||u.username), u])); const logs=await fetchAuditLogs(1000); const counts={}; logs.forEach(l=>{ if(l.user_id!=null){ const k=String(l.user_id); counts[k]=(counts[k]||0)+1; } }); let topId='--', max=0; Object.entries(counts).forEach(([id,c])=>{ if(c>max){ max=c; topId=id; }}); const u=userById.get(topId); document.getElementById('insight-top-user').textContent= u? (u.username||u.name||(`User #${u.id}`)) : (topId==='--'?'--':`User #${topId}`); }catch(e){ document.getElementById('insight-top-user').textContent='--'; } }
  async function buildUserBreakdown(){ let users=[]; try{ const u=await fetchJSON(`${FN_BASE}/users`); users=(u&&u.users)||[]; }catch(_){} const list=document.getElementById('user-breakdown-list'); if(list){ const total=users.length; const admins=users.filter(u=>u.role==='admin').length; const regular=users.filter(u=>u.role==='user').length; const locked=users.filter(u=>u.locked).length; const now=new Date(); const newUsers=users.filter(u=>u.created_at && (now-new Date(u.created_at))<7*24*60*60*1000).length; list.innerHTML=`<li>Total: <strong>${total}</strong></li><li>Admins: <strong>${admins}</strong></li><li>Regular: <strong>${regular}</strong></li><li>Locked: <strong>${locked}</strong></li><li>New (7d): <strong>${newUsers}</strong></li>`; } const growthCanvas=document.getElementById('user-growth-sparkline'); if(growthCanvas && window.Chart){ const arr=Array(30).fill(0); const now=new Date(); users.forEach(u=>{ if(u.created_at){ const daysAgo=Math.floor((now-new Date(u.created_at))/(24*60*60*1000)); if(daysAgo>=0 && daysAgo<30) arr[29-daysAgo]++; }}); if(userGrowthSparkline) userGrowthSparkline.destroy(); userGrowthSparkline=new Chart(growthCanvas.getContext('2d'),{ type:'line', data:{ labels:Array.from({length:30},(_,i)=>i+1), datasets:[{ data:arr,borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.1)',tension:.4,fill:true,pointRadius:0,borderWidth:2 }]}, options:{responsive:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}}}}); } const topList=document.getElementById('top-users-list'); if(topList){ const logs=await fetchAuditLogs(2000); const counts={}; logs.forEach(l=>{ if(l.user_id!=null){ const k=String(l.user_id); counts[k]=(counts[k]||0)+1; } }); const top=Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,5); topList.innerHTML= top.length? top.map(([id,c])=>{ const u=users.find(x=> String(x.id||x.user_id)===id); const name=(u&&(u.username||u.name))||`User #${id}`; return `<li class='flex items-center'><span class='inline-block w-2 h-2 rounded-full bg-blue-400 mr-2'></span><strong>${name}</strong><span class='ml-2 text-xs text-gray-400'>${c} events</span></li>`; }).join(''):'<li>N/A</li>'; } }
  async function updateRealtime(){ let apiHealthy=false, dbHealthy=false, serverHealthy=true; try{ apiHealthy=(await fetch(`${FN_BASE}/users`)).ok; }catch(_){} try{ dbHealthy=(await fetch(`${FN_BASE}/orders`)).ok; }catch(_){} function setStatus(id, healthy){ const el=document.getElementById(id); if(!el) return; const dot=el.querySelector('span'); const text=el.querySelector('span.ml-1'); if(dot){ dot.classList.remove('bg-gray-500','bg-green-500','bg-red-500'); dot.classList.add(healthy?'bg-green-500':'bg-red-500'); } if(text) text.textContent=healthy?'Online':'Offline'; } setStatus('status-api', apiHealthy); setStatus('status-db', dbHealthy); setStatus('status-server', serverHealthy); try{ const logs=await fetchAuditLogs(500); const active15 = new Set(logs.filter(l=>{ try{ return (Date.now()-new Date(l.created_at||l.createdAt||l.timestamp).getTime())<=15*60*1000; }catch(_){ return false; } }).map(x=>x.user_id).filter(Boolean)).size; const pv1h = logs.filter(l=>{ try{ return (Date.now()-new Date(l.created_at||l.createdAt||l.timestamp).getTime())<=60*60*1000; }catch(_){ return false; } }).length; document.getElementById('active-users').textContent=String(active15||0); document.getElementById('current-page-views').textContent=String(pv1h||0); }catch(_){ document.getElementById('active-users').textContent='--'; document.getElementById('current-page-views').textContent='--'; } document.getElementById('server-status').textContent=serverHealthy?'Online':'Offline'; try{ const u=await fetchJSON(`${FN_BASE}/users`); document.getElementById('total-users').textContent=(u&&u.users?u.users.length:'--'); }catch(_){ document.getElementById('total-users').textContent='--'; } }
  function exportCSV(){ (async()=>{ const data=await generateData(); let csv='Date,Events\n'; data.visitors.labels.forEach((l,i)=> csv+=`${l},${data.visitors.data[i]}\n`); csv+='\nSummary\n'; csv+=`Total Events (${filters.dateRange}d),${data.summary.totalEvents}\nAverage Daily,${data.summary.avgDaily}\nLogin Success Rate,${(data.summary.loginSuccessRate||0).toFixed(1)}%\nFailed Logins (24h),${data.summary.failed24h}\nTop Endpoint,${data.summary.topEndpoint}\n`; csv+='\nTop Endpoints\n'; data.endpoints.labels.forEach((p,i)=> csv+=`${p},${data.endpoints.data[i]}\n`); const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`analytics-report-${new Date().toISOString().split('T')[0]}.csv`; a.click(); showToast('CSV exported'); })(); }
  function exportUserCSV(){ (async()=>{ const u=await fetchJSON(`${FN_BASE}/users`); const users=(u&&u.users)||[]; const logs=await fetchAuditLogs(2000); const counts={}; logs.forEach(l=>{ if(l.user_id!=null){ counts[String(l.user_id)]=(counts[String(l.user_id)]||0)+1; } }); let csv='User,Role,Locked,Created At,Events\n'; users.forEach(user=>{ const key=String(user.id||user.user_id||user.username); const count=counts[key]||0; csv+=`${user.username||user.name||key},${user.role},${user.locked?'Yes':'No'},${user.created_at||''},${count}\n`; }); const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`user-analytics-${new Date().toISOString().split('T')[0]}.csv`; a.click(); showToast('User analytics CSV exported'); })(); }
  function exportPDF(){ if(!window.jspdf||!window.jspdf.jsPDF){ showToast('PDF unavailable; CSV fallback'); return exportCSV(); } const { jsPDF }=window.jspdf; (async()=>{ const data=await generateData(); const doc=new jsPDF(); doc.setFontSize(18); doc.text('Analytics Report',20,20); doc.setFontSize(10); doc.text(`Generated: ${new Date().toLocaleString()}`,20,28); let y=40; const lines=[`Range: ${filters.dateRange}d`,`Total Events: ${data.summary.totalEvents}`,`Avg Daily: ${data.summary.avgDaily}`,`Login Success Rate: ${(data.summary.loginSuccessRate||0).toFixed(1)}%`,`Failed Logins (24h): ${data.summary.failed24h}`]; lines.forEach(l=>{ doc.text(l,20,y); y+=6; }); y+=4; doc.text('Top Endpoints:',20,y); y+=6; data.endpoints.labels.forEach((p,i)=>{ if(y>270){ doc.addPage(); y=20;} doc.text(`${p}: ${data.endpoints.data[i]}`,26,y); y+=6; }); doc.save(`analytics-report-${new Date().toISOString().split('T')[0]}.pdf`); showToast('PDF exported'); })(); }
  function exportPNG(){ if(!window.Chart){ showToast('Charts not loaded'); return; } const charts=[['visitor-chart','daily'],['engagement-chart','methods'],['sales-chart','endpoints']]; charts.forEach(([id,name])=>{ const c=document.getElementById(id); if(c){ const ch=Chart.getChart(c); if(ch){ const url=ch.toBase64Image(); const a=document.createElement('a'); a.href=url; a.download=`analytics-${name}-${new Date().toISOString().split('T')[0]}.png`; a.click(); } } }); showToast('PNG export complete'); }
    function bindUI(){ document.getElementById('date-range').addEventListener('change',e=>{ filters.dateRange=parseInt(e.target.value); updateAll(); }); document.getElementById('user-type').addEventListener('change',e=>{ filters.userType=e.target.value; updateAll();}); document.getElementById('export-csv').addEventListener('click',exportCSV); document.getElementById('export-pdf').addEventListener('click',exportPDF); document.getElementById('export-png').addEventListener('click',exportPNG); document.getElementById('export-user-analytics').addEventListener('click',exportUserCSV); document.getElementById('refresh-btn').addEventListener('click',()=>{ updateAll(); updateRealtime(); showToast('Refreshed');}); }
    function startAuto(){ if(autoTimer) clearInterval(autoTimer); autoTimer=setInterval(()=>{ updateAll(); updateRealtime(); }, REFRESH_INTERVAL); }
    
    // Advanced Reports Feature
    function initAdvancedReports() {
      const generateBtn = document.getElementById('generate-advanced-report');
      if (!generateBtn) return;
      
      generateBtn.addEventListener('click', async function() {
        const reportType = document.getElementById('report-type')?.value || 'comprehensive';
        const reportPeriod = document.getElementById('report-period')?.value || '30';
        const reportFormat = document.getElementById('report-format')?.value || 'pdf';
        
        const preview = document.getElementById('report-preview');
        if (preview) {
          preview.innerHTML = `
            <div class="text-center">
              <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-purple-500 border-t-transparent mb-4"></div>
              <p class="font-semibold">Generating ${reportType} report...</p>
              <p class="text-sm text-gray-400 mt-2">Analyzing ${reportPeriod} days of data</p>
            </div>
          `;
          
          // Simulate report generation
          setTimeout(() => {
            preview.innerHTML = `
              <div class="space-y-4">
                <div class="flex items-center justify-between pb-4 border-b border-gray-700">
                  <div>
                    <h4 class="font-bold text-lg">${reportType.charAt(0).toUpperCase() + reportType.slice(1)} Report</h4>
                    <p class="text-sm text-gray-400">Generated: ${new Date().toLocaleString()}</p>
                  </div>
                  <button class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600" onclick="showToast('Report downloaded as ${reportFormat.toUpperCase()}')">
                    Download ${reportFormat.toUpperCase()}
                  </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="bg-gray-900/50 p-4 rounded">
                    <h5 class="font-semibold mb-2 text-purple-400">Key Insights</h5>
                    <ul class="space-y-2 text-sm">
                      <li>âœ“ User engagement increased 23% over period</li>
                      <li>âœ“ Conversion rate improved by 15%</li>
                      <li>âœ“ Top performing product: EDGE 5W-30</li>
                      <li>âœ“ Peak activity time: 2-4 PM</li>
                    </ul>
                  </div>
                  <div class="bg-gray-900/50 p-4 rounded">
                    <h5 class="font-semibold mb-2 text-purple-400">Recommendations</h5>
                    <ul class="space-y-2 text-sm">
                      <li>â†’ Focus marketing on high-engagement hours</li>
                      <li>â†’ Expand inventory for top products</li>
                      <li>â†’ Improve mobile experience (32% traffic)</li>
                      <li>â†’ Consider seasonal promotions</li>
                    </ul>
                  </div>
                </div>
                <div class="text-xs text-gray-500 text-center pt-4 border-t border-gray-700">
                  This is a preview. Full report available in ${reportFormat.toUpperCase()} format.
                </div>
              </div>
            `;
            showToast('Report generated successfully!');
          }, 2000);
        }
      });
    }
    
    document.addEventListener('DOMContentLoaded',()=>{ setupQuickChips(); bindUI(); updateAll(); updateRealtime(); startAuto(); initAdvancedReports(); 
      // Initialize feature flags
      if (window.FeatureFlags) {
        window.FeatureFlags.toggleElements('#advanced-reports-section', 'advancedReports');
      }
    });
  </script>
</body>
</html>
