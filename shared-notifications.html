<!DOCTYPE html>
<!-- Real-time Notifications Framework -->
<style>
/* Centralized notification styles */
.notification-bell {
    position: relative;
}

.notification-badge {
    position: absolute;
    top: -0.25rem;
    right: -0.25rem;
    background: var(--token-color-danger);
    color: var(--token-text-on-danger);
    font-size: 0.75rem;
    line-height: 1;
    border-radius: 9999px;
    height: 1.25rem;
    min-width: 1.25rem;
    padding: 0 0.35rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.notification-dropdown {
    background: var(--token-bg-secondary);
    border: 1px solid var(--token-border-default);
    border-radius: var(--token-radius-lg);
    box-shadow: var(--token-shadow-xl);
    overflow: hidden;
}

.notification-divider {
    border-color: var(--token-border-default);
}

.notification-clear-link {
    background: transparent;
    border: none;
    color: var(--token-color-primary);
    cursor: pointer;
    padding: 0;
    font: inherit;
}

.notification-clear-link:hover {
    color: var(--token-color-primary-hover);
}

.notification-item {
    border-bottom: 1px solid var(--token-border-default);
    transition: background-color var(--token-transition-base);
}

.notification-item:hover {
    background: var(--token-bg-tertiary);
}

.notification-item--unread {
    background: var(--token-color-primary-alpha-10);
}

.notification-muted {
    color: var(--token-text-muted);
}

.toast {
    position: fixed;
    z-index: 9999; /* ensure above other UI */
    right: 1rem;
    bottom: 1rem;
    padding: 1rem;
    border-radius: 0.75rem;
    box-shadow: var(--token-shadow-xl);
    background-color: var(--token-bg-secondary);
    border: 1px solid var(--token-border-default);
    border-left: 4px solid var(--token-color-info);
    color: var(--token-text-primary);
    max-width: 22rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    transform: translateX(120%);
    transition: transform 0.3s ease;
}

.toast.toast--info { border-left-color: var(--token-color-info); }
.toast.toast--success { border-left-color: var(--token-color-success); }
.toast.toast--warning { border-left-color: var(--token-color-warning); }
.toast.toast--error { border-left-color: var(--token-color-danger); }

.toast.toast--show { transform: translateX(0); }
.toast.toast--hide { transform: translateX(120%); }

.toast-close {
    background: transparent;
    border: none;
    color: var(--token-text-muted);
    font-size: 1.25rem;
    line-height: 1;
    cursor: pointer;
}

.toast-close:hover {
    color: var(--token-text-primary);
}

.toast {
    /* overridden above with token-driven styles; kept for backwards compatibility */
}
</style>
<script>
(function() {
    // Notification types and their configurations
    const notificationTypes = {
        info: {
            icon: '‚ÑπÔ∏è',
            toastClass: 'toast--info'
        },
        success: {
            icon: '‚úÖ',
            toastClass: 'toast--success'
        },
        warning: {
            icon: '‚ö†Ô∏è',
            toastClass: 'toast--warning'
        },
        error: {
            icon: '‚ùå',
            toastClass: 'toast--error'
        }
    };

    // Notification storage
    let notifications = JSON.parse(localStorage.getItem('siteNotifications') || '[]');
    let notificationId = parseInt(localStorage.getItem('notificationId') || '1');

    // Create notification center UI
    function createNotificationCenter() {
        // Create notification bell button
        const bellButton = document.createElement('button');
        bellButton.id = 'notification-bell';
        bellButton.className = 'notification-bell ui-btn ui-btn-outline ui-btn-sm';
        bellButton.innerHTML = `
            üîî
            <span id="notification-badge" class="notification-badge hidden">
                0
            </span>
        `;
        bellButton.setAttribute('aria-label', 'Open notifications');

        // Create notification dropdown
        const dropdown = document.createElement('div');
        dropdown.id = 'notification-dropdown';
        dropdown.className = 'notification-dropdown hidden absolute right-0 top-full mt-2 w-80 z-50';
        dropdown.innerHTML = `
            <div class="p-4 border-b notification-divider">
                <h3 class="text-lg font-semibold" data-i18n="notifications.title">Notifications</h3>
            </div>
            <div id="notification-list" class="max-h-96 overflow-y-auto">
                <!-- Notifications will be inserted here -->
            </div>
            <div class="p-4 border-t notification-divider">
                <button id="clear-all-notifications" class="text-sm notification-clear-link">
                    Clear All
                </button>
            </div>
        `;

        // Find a suitable container for the notification system
        let container = document.querySelector('#sidebar nav ul');
        if (container) {
            const listItem = document.createElement('li');
            listItem.className = 'relative';
            listItem.appendChild(bellButton);
            listItem.appendChild(dropdown);
            container.appendChild(listItem);
        }

        return { bellButton, dropdown };
    }

    // Show notification function
    window.showNotification = function(message, type = 'info', persistent = false) {
        const notification = {
            id: notificationId++,
            message,
            type,
            timestamp: Date.now(),
            persistent,
            read: false
        };

        notifications.unshift(notification);
        
        // Keep only last 50 notifications
        notifications = notifications.slice(0, 50);
        
        // Save to localStorage
        localStorage.setItem('siteNotifications', JSON.stringify(notifications));
        localStorage.setItem('notificationId', notificationId.toString());

        // Update UI
        updateNotificationUI();

        // Show toast notification if not persistent
        if (!persistent) {
            showToastNotification(notification);
        }

        return notification.id;
    };

    // Show toast notification
    function showToastNotification(notification) {
        const toast = document.createElement('div');
        const config = notificationTypes[notification.type];
        
        toast.className = `toast ${config.toastClass || 'toast--info'}`;
        toast.innerHTML = `
            <span class="text-xl">${config.icon}</span>
            <span class="flex-1">${notification.message}</span>
            <button class="toast-close" aria-label="Dismiss notification" onclick="this.parentElement.remove()">&times;</button>
        `;

        document.body.appendChild(toast);

        // Animate in
        setTimeout(() => {
            toast.classList.add('toast--show');
        }, 100);

        // Auto remove after 5 seconds
        setTimeout(() => {
            toast.classList.add('toast--hide');
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 300);
        }, 5000);
    }

    // Update notification UI
    function updateNotificationUI() {
        const badge = document.getElementById('notification-badge');
        const notificationList = document.getElementById('notification-list');
        
        if (!badge || !notificationList) return;

        const unreadCount = notifications.filter(n => !n.read).length;
        
        // Update badge
        if (unreadCount > 0) {
            badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }

        // Update notification list
        if (notifications.length === 0) {
            notificationList.innerHTML = `
                <div class="p-4 text-center notification-muted" data-i18n="notifications.empty">
                    No new notifications
                </div>
            `;
        } else {
            notificationList.innerHTML = notifications.map(notification => {
                const config = notificationTypes[notification.type];
                const timeAgo = getTimeAgo(notification.timestamp);
                
                return `
                    <div class="p-4 notification-item ${!notification.read ? 'notification-item--unread' : ''}">
                        <div class="flex items-start gap-3">
                            <span class="text-lg">${config.icon}</span>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm ${!notification.read ? 'font-semibold' : ''}">${notification.message}</p>
                                <p class="text-xs notification-muted mt-1">${timeAgo}</p>
                            </div>
                            <button onclick="window.removeNotification(${notification.id})" class="notification-muted text-sm leading-none" aria-label="Remove notification">
                                √ó
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
    }

    // Get time ago string
    function getTimeAgo(timestamp) {
        const now = Date.now();
        const diff = now - timestamp;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (days > 0) return `${days}d ago`;
        if (hours > 0) return `${hours}h ago`;
        if (minutes > 0) return `${minutes}m ago`;
        return 'Just now';
    }

    // Remove notification
    window.removeNotification = function(id) {
        notifications = notifications.filter(n => n.id !== id);
        localStorage.setItem('siteNotifications', JSON.stringify(notifications));
        updateNotificationUI();
    };

    // Clear all notifications
    window.clearAllNotifications = function() {
        notifications = [];
        localStorage.setItem('siteNotifications', JSON.stringify(notifications));
        updateNotificationUI();
    };

    // Mark notification as read
    function markAsRead(id) {
        const notification = notifications.find(n => n.id === id);
        if (notification) {
            notification.read = true;
            localStorage.setItem('siteNotifications', JSON.stringify(notifications));
            updateNotificationUI();
        }
    }

    // Simulate real-time notifications (for demo purposes)
    function simulateRealtimeNotifications() {
        const demoNotifications = [
            { message: "New user registration", type: "info" },
            { message: "System backup completed", type: "success" },
            { message: "Server load is high", type: "warning" },
            { message: "Failed login attempt detected", type: "error" },
            { message: "New oil order received", type: "info" }
        ];

        // Add a random notification every 30 seconds (for demo)
        setInterval(() => {
            if (Math.random() < 0.3) { // 30% chance
                const randomNotification = demoNotifications[Math.floor(Math.random() * demoNotifications.length)];
                window.showNotification(randomNotification.message, randomNotification.type);
            }
        }, 30000);
    }

    // Initialize notification system
    function initNotificationSystem() {
        const { bellButton, dropdown } = createNotificationCenter();
        
        if (bellButton && dropdown) {
            // Toggle dropdown
            bellButton.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('hidden');
                
                // Mark all as read when opened
                if (!dropdown.classList.contains('hidden')) {
                    notifications.forEach(n => n.read = true);
                    localStorage.setItem('siteNotifications', JSON.stringify(notifications));
                    updateNotificationUI();
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target) && !bellButton.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });

            // Clear all button
            document.getElementById('clear-all-notifications')?.addEventListener('click', () => {
                window.clearAllNotifications();
            });
        }

        // Update UI with existing notifications
        updateNotificationUI();

        // Start demo notifications (remove in production)
        simulateRealtimeNotifications();

        // Show welcome notification
        setTimeout(() => {
            window.showNotification("Notification system activated!", "success");
        }, 2000);
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initNotificationSystem);
    } else {
        initNotificationSystem();
    }
})();
</script>