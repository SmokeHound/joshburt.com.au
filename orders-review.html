<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workshop Orders Review</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="JoshBurt.com.au">
    <link rel="apple-touch-icon" href="/assets/images/logo-placeholder.svg">
    
    <link rel="stylesheet" href="/assets/css/styles.css">
    <script src="/assets/js/init-shared.js" defer></script>
    <script src="/assets/js/components/data-table.js" defer></script>
    
    <!-- Inline Modal Utilities (critical for order details) -->
    <style>
      .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.75); z-index: 9998; display: flex; align-items: center; justify-content: center; padding: 1rem; animation: fadeIn 0.2s ease-out; }
      .modal-overlay.hidden { display: none; }
      .modal-content { background: #1a1a1a; border: 1px solid #333; border-radius: 0.5rem; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 212, 255, 0.3); z-index: 9999; animation: slideUp 0.3s ease-out; }
      .modal-content.modal-sm { max-width: 400px; }
      .modal-content.modal-lg { max-width: 800px; }
      .modal-content.modal-xl { max-width: 1200px; }
    .modal-header { padding: 1rem; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; }
    .modal-body { padding: 1rem; }
    .modal-footer { padding: 1rem; border-top: 1px solid #333; display: flex; gap: 0.5rem; justify-content: flex-end; }
      .modal-close { background: transparent; border: none; color: #999; font-size: 1.5rem; cursor: pointer; padding: 0; width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; border-radius: 0.25rem; transition: all 0.2s; }
      .modal-close:hover { background: #333; color: #fff; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .modal-icon { width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 0.75rem; font-size: 1rem; }
      .modal-icon-danger { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
      .modal-icon-warning { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
      .modal-icon-info { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
      .modal-icon-success { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    </style>
    <script>
      // Inline Modal Utilities (critical for order details)
      (function() {
        'use strict';
        window.ModalUtils = {
          create: function(options) {
            const defaults = { title: '', content: '', size: 'md', showClose: true, onClose: null };
            const config = Object.assign({}, defaults, options);
            const modalId = 'custom-modal-' + Date.now();
            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal-overlay';
            modal.innerHTML = `
              <div class="modal-content modal-${config.size}">
                ${config.title ? `<div class="ui-modal-header"><h3 class="text-xl font-semibold text-gray-100">${config.title}</h3>${config.showClose ? '<button class="modal-close" data-action="close" aria-label="Close">&times;</button>' : ''}</div>` : ''}
                <div class="ui-modal-body">${config.content}</div>
              </div>`;
            document.body.appendChild(modal);
            const close = () => { modal.remove(); if (config.onClose) config.onClose(); };
            if (config.showClose) {
              modal.querySelectorAll('[data-action="close"]').forEach(btn => btn.addEventListener('click', close));
              modal.addEventListener('click', (e) => { if (e.target === modal) close(); });
              const escHandler = (e) => { if (e.key === 'Escape') { document.removeEventListener('keydown', escHandler); close(); } };
              document.addEventListener('keydown', escHandler);
            }
            return { element: modal, close: close };
          },
          confirm: function(options) {
            const defaults = { title: 'Confirm Action', message: 'Are you sure?', confirmText: 'Confirm', cancelText: 'Cancel', type: 'warning' };
            const config = Object.assign({}, defaults, options);
            return new Promise((resolve) => {
              const modal = document.createElement('div');
              modal.className = 'modal-overlay';
              modal.innerHTML = `<div class="modal-content modal-sm"><div class="ui-modal-header"><h3 class="text-xl font-semibold text-gray-100">${config.title}</h3><button class="modal-close" data-action="cancel">&times;</button></div><div class="ui-modal-body text-center"><p class="text-gray-300">${config.message}</p></div><div class="ui-modal-footer"><button class="ui-btn ui-btn-secondary px-4 py-2 rounded" data-action="cancel">${config.cancelText}</button><button class="ui-btn ui-btn-primary px-4 py-2 rounded" data-action="confirm">${config.confirmText}</button></div></div>`;
              document.body.appendChild(modal);
              const handleAction = (action) => { modal.remove(); resolve(action === 'confirm'); };
              modal.querySelectorAll('[data-action]').forEach(btn => btn.addEventListener('click', (e) => handleAction(e.target.dataset.action)));
              modal.addEventListener('click', (e) => { if (e.target === modal) handleAction('cancel'); });
            });
          },
          alert: function(options) {
            const defaults = { title: 'Information', message: '', okText: 'OK', type: 'info' };
            const config = Object.assign({}, defaults, options);
            return new Promise((resolve) => {
              const modal = document.createElement('div');
              modal.className = 'modal-overlay';
              modal.innerHTML = `<div class="modal-content modal-sm"><div class="ui-modal-header"><h3 class="text-xl font-semibold text-gray-100">${config.title}</h3><button class="modal-close" data-action="ok">&times;</button></div><div class="ui-modal-body text-center"><p class="text-gray-300">${config.message}</p></div><div class="ui-modal-footer"><button class="ui-btn ui-btn-primary px-4 py-2 rounded" data-action="ok">${config.okText}</button></div></div>`;
              document.body.appendChild(modal);
              const handleClose = () => { modal.remove(); resolve(); };
              modal.querySelectorAll('[data-action="ok"]').forEach(btn => btn.addEventListener('click', handleClose));
              modal.addEventListener('click', (e) => { if (e.target === modal) handleClose(); });
            });
          }
        };
      })();
    </script>
    <script>
        // Load centralized theme manager
        fetch('shared-theme.html')
            .then(r => r.text())
            .then(html => {
                const temp = document.createElement('div');
                temp.innerHTML = html;
                const scripts = temp.getElementsByTagName('script');
                for (let script of scripts) {
                    const newScript = document.createElement('script');
                    newScript.textContent = script.textContent;
                    document.head.appendChild(newScript);
                }
            })
            .catch(err => console.warn('Failed to load shared-theme.html:', err));
        // Service Worker Registration for PWA
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("./sw.js")
                    .then(registration => {
                        console.log("SW registered: ", registration);
                    })
                    .catch(registrationError => {
                        console.log("SW registration failed: ", registrationError);
                    });
            });
        }
    </script>
    <link rel="stylesheet" href="/assets/css/accessibility.css" />
    <script src="/assets/js/accessibility.js" defer></script>
</head>
<body>
  

    <!-- Mobile Menu Toggle -->
    <button id="menu-toggle" class="md:hidden fixed top-4 left-4 z-50 p-2 bg-blue-600 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400" aria-label="Toggle sidebar" aria-expanded="false">â˜°</button>
    <div id="sidebar-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
        <div class="flex min-h-screen">
            <!-- Shared Navigation Loader -->
            <div id="main-nav"></div>
            <!-- Main Content -->
            <main id="main-content" class="flex-1 p-4 md:p-6" role="main">
                <header class="page-header ui-card border mb-4" role="banner">
                    <div>
                        <h2 class="text-2xl font-bold mb-1 text-gray-100">Workshop Orders Review</h2>
                        <p class="text-gray-400 text-xs">Review, filter and manage submitted workshop stock orders.</p>
                    </div>
                </header>
                <section>
                    <div class="card ui-card ui-card-primary rounded-lg shadow-md p-6" id="orders-container">
                        <div id="orders-table">
                            <div class="text-center text-gray-500 dark:text-gray-400">Loading orders...</div>
                        </div>
                    </div>
                </section>
            </main>
        </div>

    <script>
    // Order Review Script (using DataTable component)
        document.addEventListener('DOMContentLoaded', function() {
            let ordersState = [];
            let ordersTable = null;

            // Status badge renderer
            function renderStatusBadge(status) {
                const statusClasses = {
                    'pending': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
                    'approved': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
                    'rejected': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
                };
                const classes = statusClasses[status] || statusClasses['pending'];
                return `<span class="px-2 py-0.5 rounded-full text-xs ${classes}">${status}</span>`;
            }

            // Priority badge renderer
            function renderPriorityBadge(priority) {
                const priorityClasses = {
                    'urgent': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
                    'normal': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
                    'low': 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200'
                };
                const classes = priorityClasses[priority] || priorityClasses['normal'];
                return `<span class="px-2 py-0.5 rounded-full text-xs ${classes}">${priority || 'normal'}</span>`;
            }

            // Action buttons renderer
            function renderActions(value, row) {
                return `
                    <button class="px-3 py-1.5 rounded text-xs text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 border border-blue-500/40 shadow-sm transition-colors" onclick="showOrderDetailsModal(${row.id})">
                        View Details
                    </button>
                `;
            }

            // DataTable column configuration
            const columns = [
                { 
                    field: 'id', 
                    label: 'Order #', 
                    sortable: true,
                    render: (value) => `<span class="font-semibold text-gray-100">#${value}</span>`
                },
                { 
                    field: 'created_at', 
                    label: 'Date', 
                    sortable: true,
                    render: (value) => `<span class="text-xs text-gray-400">${new Date(value).toLocaleString()}</span>`
                },
                { 
                    field: 'status', 
                    label: 'Status', 
                    sortable: true,
                    render: (value) => renderStatusBadge(value)
                },
                { 
                    field: 'created_by', 
                    label: 'Requested By', 
                    sortable: true,
                    render: (value) => `<span class="text-gray-200">${value || 'mechanic'}</span>`
                },
                { 
                    field: 'total_items', 
                    label: 'Items', 
                    sortable: true,
                    render: (value) => `<span class="text-gray-300">${value || '?'}</span>`
                },
                { 
                    field: 'priority', 
                    label: 'Priority', 
                    sortable: true,
                    render: (value) => renderPriorityBadge(value)
                },
                { 
                    field: 'id', 
                    label: 'Actions', 
                    sortable: false,
                    render: renderActions
                }
            ];

            async function loadOrders() {
                try {
                    const FN_BASE = window.FN_BASE || '/.netlify/functions';
                    const res = await window.authFetch(`${FN_BASE}/orders`);
                    if (!res.ok) throw new Error('Failed to fetch orders');
                    const orders = await res.json();
                    ordersState = Array.isArray(orders) ? orders : [];
                    
                    // Initialize or update DataTable
                    if (!ordersTable) {
                        ordersTable = new DataTable('orders-table', {
                            data: ordersState,
                            columns: columns,
                            pageSize: 10,
                            sortable: true,
                            filterable: true,
                            paginated: true,
                            onRowClick: (row) => showOrderDetailsModal(row.id)
                        });
                    } else {
                        ordersTable.setData(ordersState);
                    }
                } catch (err) {
                    document.getElementById('orders-table').innerHTML = `<div class="text-center text-red-600 dark:text-red-400">Error loading orders: ${err.message}</div>`;
                }
            }

            // Show order details in modal
            window.showOrderDetailsModal = function(orderId) {
                const order = ordersState.find(o => o.id === orderId);
                if (!order) {
                    console.error('Order not found:', orderId);
                    return;
                }

                const statusBadge = order.status === 'pending' 
                    ? '<span class="px-2 py-0.5 rounded-full text-xs bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">Pending</span>'
                    : order.status === 'approved'
                    ? '<span class="px-2 py-0.5 rounded-full text-xs bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">Approved</span>'
                    : '<span class="px-2 py-0.5 rounded-full text-xs bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">Rejected</span>';

                const itemsHtml = (order.items || []).map(item => `
                    <tr class="border-b border-gray-200 dark:border-gray-700">
                        <td class="py-1 px-2 text-gray-900 dark:text-white text-xs">${item.name}</td>
                        <td class="py-1 px-2 text-gray-600 dark:text-gray-400 text-xs">${item.code}</td>
                        <td class="py-1 px-2 text-gray-900 dark:text-white text-right font-medium text-xs">${item.quantity}</td>
                    </tr>
                `).join('');

                const content = `
                    <div class="space-y-3">
                        <div class="flex justify-between items-start border-b border-gray-200 dark:border-gray-700 pb-2">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Order #${order.id}</h3>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${new Date(order.created_at).toLocaleString()}</p>
                            </div>
                            ${statusBadge}
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3 bg-gray-50 dark:bg-gray-800 p-2 rounded">
                            <div>
                                <p class="text-xs text-gray-600 dark:text-gray-400">Requested By</p>
                                <p class="font-medium text-gray-900 dark:text-white">${order.created_by || 'mechanic'}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 dark:text-gray-400">Priority</p>
                                <p class="font-medium text-gray-900 dark:text-white">${order.priority || 'normal'}</p>
                            </div>
                            <div class="col-span-2">
                                <p class="text-xs text-gray-600 dark:text-gray-400">Notes</p>
                                <p class="font-medium text-gray-900 dark:text-white">${order.notes || 'No notes provided'}</p>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-gray-900 dark:text-white mb-2 text-sm">Order Items (${order.total_items || order.items?.length || 0})</h4>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-100 dark:bg-gray-700">
                                        <tr>
                                            <th class="py-1 px-2 text-left text-xs font-semibold text-gray-900 dark:text-white">Product</th>
                                            <th class="py-1 px-2 text-left text-xs font-semibold text-gray-900 dark:text-white">Code</th>
                                            <th class="py-1 px-2 text-right text-xs font-semibold text-gray-900 dark:text-white">Quantity</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${itemsHtml}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="flex gap-2 pt-2 border-t border-gray-200 dark:border-gray-700">
                            <button class="flex-1 px-3 py-1.5 bg-green-500 text-white rounded hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 transition-colors text-sm" onclick="updateOrderStatus(${order.id}, 'approved')">
                                Approve Order
                            </button>
                            <button class="flex-1 px-3 py-1.5 bg-red-500 text-white rounded hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 transition-colors text-sm" onclick="updateOrderStatus(${order.id}, 'rejected')">
                                Reject Order
                            </button>
                            <button class="flex-1 px-3 py-1.5 bg-blue-500 text-white rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-colors text-sm" onclick="emailOrder(${order.id})">
                                Email Order
                            </button>
                        </div>
                    </div>
                `;

                if (window.ModalUtils && window.ModalUtils.create) {
                    window.ModalUtils.create({
                        title: 'Order Details',
                        content: content,
                        size: 'lg',
                        showClose: true
                    });
                } else {
                    // Fallback: show alert with basic info
                    alert(`Order #${order.id}\nStatus: ${order.status}\nRequested by: ${order.created_by || 'mechanic'}\nItems: ${order.total_items || order.items?.length || 0}\n\nUse the action buttons on the order card to approve/reject.`);
                }
            };

            window.updateOrderStatus = async function(orderId, status) {
                try {
                    const order = ordersState.find(o => o.id === orderId);
                    const orderLabel = order ? `Order #${orderId}` : `Order #${orderId}`;
                    const actionText = status === 'approved' ? 'approve' : 'reject';
                    
                    // Fallback to native confirm if ModalUtils not loaded yet
                    let confirmed = false;
                    if (window.ModalUtils && window.ModalUtils.confirm) {
                        confirmed = await window.ModalUtils.confirm({
                            title: `${actionText.charAt(0).toUpperCase() + actionText.slice(1)} Order`,
                            message: `Are you sure you want to ${actionText} ${orderLabel}?`,
                            confirmText: actionText.charAt(0).toUpperCase() + actionText.slice(1),
                            cancelText: 'Cancel',
                            type: status === 'approved' ? 'success' : 'warning'
                        });
                    } else {
                        confirmed = confirm(`Are you sure you want to ${actionText} ${orderLabel}?`);
                    }
                    
                    if (!confirmed) return;
                    
                    const FN_BASE = window.FN_BASE || '/.netlify/functions';
                    const res = await window.authFetch(`${FN_BASE}/orders`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ orderId, status })
                    });
                    if (!res.ok) throw new Error('Failed to update order');
                    
                    if (window.ModalUtils && window.ModalUtils.alert) {
                        await window.ModalUtils.alert({
                            title: 'Order Updated',
                            message: `Order #${orderId} has been ${status === 'approved' ? 'approved' : 'rejected'}.`,
                            type: 'success'
                        });
                    } else {
                        alert(`Order #${orderId} has been ${status === 'approved' ? 'approved' : 'rejected'}.`);
                    }
                    
                    await loadOrders();
                } catch (err) {
                    if (window.ModalUtils && window.ModalUtils.alert) {
                        await window.ModalUtils.alert({
                            title: 'Error',
                            message: `Failed to update order: ${err.message}`,
                            type: 'danger'
                        });
                    } else {
                        alert(`Failed to update order: ${err.message}`);
                    }
                }
            };

            window.emailOrder = async function(orderId) {
                const order = ordersState.find(o => o.id === orderId);
                if (!order) { 
                    if (window.ModalUtils && window.ModalUtils.alert) {
                        await window.ModalUtils.alert({
                            title: 'Order Not Found',
                            message: 'The requested order could not be found.',
                            type: 'warning'
                        });
                    } else {
                        alert('Order not found');
                    }
                    return; 
                }
                const recipient = 'purchasing@workshop.com';
                const createdAt = order.created_at ? new Date(order.created_at).toLocaleString() : '';
                const items = (order.items || []).map(i => `- ${i.name}${i.code ? ' ('+i.code+')' : ''} x ${i.quantity}`).join('\n');
                const subject = `Workshop Order #${order.id} - ${new Date().toISOString().split('T')[0]}`;
                const body = `Workshop Stock Order\n\n`+
`Order ID: ${order.id}\n`+
`Created: ${createdAt}\n`+
`Requested by: ${order.created_by || 'mechanic'}\n`+
`Priority: ${order.priority || 'normal'}\n`+
`Status: ${order.status || 'pending'}\n`+
`Notes: ${order.notes || ''}\n\n`+
`Items:\n${items || '(none)'}\n\n`+
`Total Items: ${order.total_items || (order.items ? order.items.length : 0)}\n`;
                const mailto = `mailto:${encodeURIComponent(recipient)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = mailto;
            };

            loadOrders();
        });
    </script>
</body>
</html>
