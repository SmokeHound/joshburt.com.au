<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bulk Operations - joshburt.com.au</title>
  <link rel="stylesheet" href="/assets/css/styles.css">
  <script src="/assets/js/init-shared.js" defer></script>
  <script src="/assets/js/notifications.js" defer></script>
  <script src="/assets/js/feature-flags.js" defer></script>
</head>
<body class="bg-gray-900 text-gray-100">
  <div id="main-nav"></div>

  <main class="p-6">
    <div class="max-w-7xl mx-auto">
      <!-- Page Header -->
      <header class="page-header ui-card border flex items-center justify-between" role="banner">
        <div>
          <h1 class="text-3xl font-bold text-[color:var(--token-text-primary)]">Bulk Operations</h1>
          <p class="subtitle">Import, export, and manage data in bulk</p>
        </div>
        <div id="notification-bell-wrapper" class="relative"></div>
      </header>

      <!-- Action Cards -->
      <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="ui-card p-6">
          <h2 class="text-xl font-bold mb-4">üì• Import Data</h2>
          <p class="text-gray-400 mb-4">Import products, users, or other data from CSV or JSON files</p>
          <button id="import-btn" class="ui-btn ui-btn-primary w-full">Start Import</button>
        </div>

        <div class="ui-card p-6">
          <h2 class="text-xl font-bold mb-4">üì§ Export Data</h2>
          <p class="text-gray-400 mb-4">Export data to CSV or JSON format for backup or analysis</p>
          <button id="export-btn" class="ui-btn ui-btn-primary w-full">Start Export</button>
        </div>
      </section>

      <!-- Operations History -->
      <section class="ui-card p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold">Operations History</h2>
          <button id="refresh-btn" class="ui-btn ui-btn-secondary px-4 py-2">üîÑ Refresh</button>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead>
              <tr class="border-b border-gray-700">
                <th class="pb-3 pr-4">ID</th>
                <th class="pb-3 pr-4">Type</th>
                <th class="pb-3 pr-4">Table</th>
                <th class="pb-3 pr-4">Status</th>
                <th class="pb-3 pr-4">Records</th>
                <th class="pb-3 pr-4">Success/Error</th>
                <th class="pb-3 pr-4">Started</th>
                <th class="pb-3">Actions</th>
              </tr>
            </thead>
            <tbody id="operations-table">
              <tr>
                <td colspan="8" class="py-8 text-center text-gray-400">Loading operations...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        if (!window.FeatureFlags || typeof window.FeatureFlags.isEnabled !== 'function') return;
        const enabled = await window.FeatureFlags.isEnabled('enableBulkOperations');
        if (enabled) return;

        if (typeof window.showToast === 'function') {
          window.showToast('Bulk Operations is currently disabled.', 'warning');
        } else {
          alert('Bulk Operations is currently disabled.');
        }
        window.location.href = 'administration.html';
      } catch (_) {
        // fail open
      }
    });
  </script>

  <!-- Import Modal -->
  <div id="import-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="modal-content ui-card p-6 w-full max-w-4xl">
      <h2 class="text-2xl font-bold mb-4">Import Data</h2>
      
      <form id="import-form">
        <!-- Step 1: Select Table & Format -->
        <div id="import-step-1" class="space-y-4">
          <div>
            <label class="block text-sm font-semibold mb-2">Target Table</label>
            <select id="import-table" class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700" required>
              <option value="">Select Table...</option>
              <option value="products">Products</option>
              <option value="consumables">Consumables</option>
              <option value="filters">Filters</option>
              <option value="users">Users</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-semibold mb-2">File Format</label>
            <select id="import-format" class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700" required>
              <option value="csv">CSV (Comma-Separated Values)</option>
              <option value="json">JSON (JavaScript Object Notation)</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-semibold mb-2">Upload File or Paste Data</label>
            <div class="flex gap-4 mb-2">
              <button type="button" id="upload-file-btn" class="ui-btn ui-btn-secondary flex-1">üìÅ Upload File</button>
              <button type="button" id="paste-data-btn" class="ui-btn ui-btn-secondary flex-1">üìã Paste Data</button>
            </div>
            <input type="file" id="file-input" accept=".csv,.json" class="hidden">
            <textarea id="import-data" class="w-full h-64 p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700 font-mono text-sm" placeholder="Paste your CSV or JSON data here..." required></textarea>
          </div>

          <div class="bg-blue-900/20 border border-blue-500 rounded p-4">
            <p class="text-sm"><strong>CSV Format Example:</strong></p>
            <pre class="text-xs mt-2 text-gray-300">name,code,type,stock_quantity
Product 1,PROD001,oil,100
Product 2,PROD002,oil,50</pre>
          </div>

          <div class="flex gap-4 mt-6">
            <button type="button" id="validate-btn" class="ui-btn ui-btn-primary flex-1">Validate Data</button>
            <button type="button" id="cancel-import-btn" class="ui-btn ui-btn-secondary flex-1">Cancel</button>
          </div>
        </div>

        <!-- Step 2: Preview & Confirm -->
        <div id="import-step-2" class="space-y-4 hidden">
          <div class="bg-green-900/20 border border-green-500 rounded p-4">
            <h3 class="font-bold mb-2">‚úÖ Validation Successful</h3>
            <div id="validation-summary"></div>
          </div>

          <div>
            <h3 class="font-bold mb-2">Preview (First 5 Records)</h3>
            <div id="preview-data" class="overflow-x-auto"></div>
          </div>

          <div id="validation-errors" class="hidden bg-red-900/20 border border-red-500 rounded p-4">
            <h3 class="font-bold mb-2">‚ö†Ô∏è Validation Warnings</h3>
            <div id="error-list"></div>
          </div>

          <div class="flex gap-4 mt-6">
            <button type="submit" id="execute-import-btn" class="ui-btn ui-btn-primary flex-1">Execute Import</button>
            <button type="button" id="back-to-step1-btn" class="ui-btn ui-btn-secondary flex-1">Back</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Export Modal -->
  <div id="export-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="modal-content ui-card p-6 w-full max-w-2xl">
      <h2 class="text-2xl font-bold mb-4">Export Data</h2>
      
      <form id="export-form">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-semibold mb-2">Table to Export</label>
            <select id="export-table" class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700" required>
              <option value="">Select Table...</option>
              <option value="products">Products</option>
              <option value="consumables">Consumables</option>
              <option value="filters">Filters</option>
              <option value="users">Users</option>
              <option value="orders">Orders</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-semibold mb-2">Export Format</label>
            <select id="export-format" class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700" required>
              <option value="csv">CSV (Excel Compatible)</option>
              <option value="json">JSON (Developer Friendly)</option>
            </select>
          </div>

          <div class="bg-blue-900/20 border border-blue-500 rounded p-4">
            <p class="text-sm">The export will download all records from the selected table in the chosen format.</p>
          </div>

          <div class="flex gap-4 mt-6">
            <button type="submit" class="ui-btn ui-btn-primary flex-1">Download Export</button>
            <button type="button" id="cancel-export-btn" class="ui-btn ui-btn-secondary flex-1">Cancel</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Operation Details Modal -->
  <div id="operation-details-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="modal-content ui-card p-6 w-full max-w-3xl">
      <h2 class="text-2xl font-bold mb-4">Operation Details</h2>
      <div id="operation-details-content" class="space-y-4"></div>
      <div class="flex gap-4 mt-6">
        <button id="close-details-btn" class="ui-btn ui-btn-secondary flex-1">Close</button>
      </div>
    </div>
  </div>

  <!-- Shared components loaded by init-shared.js -->

  <script>
    const FN_BASE = window.FN_BASE || '/.netlify/functions';
    let currentOperationId = null;
    let validationResult = null;

    // Load operations history
    async function loadOperations() {
      if (!window.authFetch) {
        console.warn('authFetch not ready, retrying...');
        setTimeout(loadOperations, 100);
        return;
      }

      try {
        const response = await window.authFetch(`${FN_BASE}/bulk-operations?limit=50`);
        if (!response.ok) throw new Error('Failed to load operations');

        const data = await response.json();
        displayOperations(data.operations);

      } catch (error) {
        console.error('Error loading operations:', error);
        showNotification('Failed to load operations', 'error');
      }
    }

    // Display operations in table
    function displayOperations(operations) {
      const tbody = document.getElementById('operations-table');
      
      if (operations.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="py-8 text-center text-gray-400">No operations found</td></tr>';
        return;
      }

      tbody.innerHTML = operations.map(op => `
        <tr class="border-b border-gray-700 hover:bg-gray-800">
          <td class="py-3 pr-4">#${op.id}</td>
          <td class="py-3 pr-4 capitalize">${op.operation_type}</td>
          <td class="py-3 pr-4">${op.target_table}</td>
          <td class="py-3 pr-4">
            <span class="px-2 py-1 rounded text-xs ${getStatusColor(op.status)}">
              ${op.status}
            </span>
          </td>
          <td class="py-3 pr-4">${op.total_records || 0}</td>
          <td class="py-3 pr-4">${op.success_count || 0} / ${op.error_count || 0}</td>
          <td class="py-3 pr-4">${formatDate(op.started_at)}</td>
          <td class="py-3">
            <button onclick="viewOperation(${op.id})" class="text-blue-500 hover:underline">View</button>
          </td>
        </tr>
      `).join('');
    }

    // Validate import data
    async function validateImportData() {
      try {
        const targetTable = document.getElementById('import-table').value;
        const format = document.getElementById('import-format').value;
        const data = document.getElementById('import-data').value;

        if (!targetTable || !data) {
          showNotification('Please select a table and provide data', 'error');
          return;
        }

        const response = await window.authFetch(`${FN_BASE}/bulk-operations`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            target_table: targetTable,
            format,
            data,
            validate_only: true
          })
        });

        if (!response.ok) {
          const error = await response.json();
          if (error.validation_errors) {
            displayValidationErrors(error.validation_errors);
          } else {
            throw new Error(error.error || 'Validation failed');
          }
          return;
        }

        validationResult = await response.json();
        
        if (validationResult.valid) {
          displayValidationSuccess(validationResult);
          document.getElementById('import-step-1').classList.add('hidden');
          document.getElementById('import-step-2').classList.remove('hidden');
        } else {
          displayValidationErrors(validationResult.validation_errors);
        }

      } catch (error) {
        console.error('Validation error:', error);
        showNotification('Validation failed: ' + error.message, 'error');
      }
    }

    // Display validation success
    function displayValidationSuccess(result) {
      const summary = document.getElementById('validation-summary');
      summary.innerHTML = `
        <p><strong>Total Records:</strong> ${result.total_records}</p>
        <p><strong>Valid:</strong> All records passed validation ‚úì</p>
      `;

      // Display preview
      const preview = document.getElementById('preview-data');
      if (result.preview_data && result.preview_data.length > 0) {
        const headers = Object.keys(result.preview_data[0]);
        preview.innerHTML = `
          <table class="w-full text-left text-sm">
            <thead>
              <tr class="border-b border-gray-700">
                ${headers.map(h => `<th class="pb-2 pr-4">${h}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
              ${result.preview_data.map(row => `
                <tr class="border-b border-gray-700">
                  ${headers.map(h => `<td class="py-2 pr-4">${row[h] || ''}</td>`).join('')}
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      }
    }

    // Display validation errors
    function displayValidationErrors(errors) {
      const errorContainer = document.getElementById('validation-errors');
      const errorList = document.getElementById('error-list');
      
      errorList.innerHTML = `
        <ul class="list-disc pl-5 space-y-1">
          ${errors.map(err => `<li>Row ${err.row}: ${err.message}</li>`).join('')}
        </ul>
      `;
      
      errorContainer.classList.remove('hidden');
      showNotification(`Found ${errors.length} validation error(s)`, 'error');
    }

    // Execute import
    async function executeImport(event) {
      event.preventDefault();

      try {
        const targetTable = document.getElementById('import-table').value;
        const format = document.getElementById('import-format').value;
        const data = document.getElementById('import-data').value;

        // Create operation
        const createResponse = await window.authFetch(`${FN_BASE}/bulk-operations`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            target_table: targetTable,
            format,
            data,
            validate_only: false
          })
        });

        if (!createResponse.ok) throw new Error('Failed to create operation');

        const operation = await createResponse.json();

        // Execute operation
        const executeResponse = await window.authFetch(`${FN_BASE}/bulk-operations/${operation.id}/execute`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ data })
        });

        if (!executeResponse.ok) throw new Error('Failed to execute operation');

        const result = await executeResponse.json();

        showNotification(
          `Import completed: ${result.success_count} successful, ${result.error_count} errors`,
          result.error_count === 0 ? 'success' : 'warning'
        );

        if (window.BulkOpsModal && typeof window.BulkOpsModal.hide === 'function') {
          window.BulkOpsModal.hide('import-modal');
        } else {
          document.getElementById('import-modal').classList.add('hidden');
          const backdrop = document.getElementById('modal-backdrop');
          if (backdrop) {
            backdrop.classList.add('hidden');
            backdrop.classList.remove('block');
          }
          document.body.style.overflow = '';
        }
        document.getElementById('import-form').reset();
        document.getElementById('import-step-1').classList.remove('hidden');
        document.getElementById('import-step-2').classList.add('hidden');
        
        await loadOperations();

      } catch (error) {
        console.error('Import error:', error);
        showNotification('Import failed: ' + error.message, 'error');
      }
    }

    // Execute export
    async function executeExport(event) {
      event.preventDefault();

      try {
        const targetTable = document.getElementById('export-table').value;
        const format = document.getElementById('export-format').value;

        const params = new URLSearchParams({ target_table: targetTable, format });

        const response = await window.authFetch(`${FN_BASE}/bulk-operations/export?${params}`);

        if (!response.ok) throw new Error('Export failed');

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${targetTable}_export.${format}`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        showNotification('Export downloaded successfully', 'success');

        if (window.BulkOpsModal && typeof window.BulkOpsModal.hide === 'function') {
          window.BulkOpsModal.hide('export-modal');
        } else {
          document.getElementById('export-modal').classList.add('hidden');
          const backdrop = document.getElementById('modal-backdrop');
          if (backdrop) {
            backdrop.classList.add('hidden');
            backdrop.classList.remove('block');
          }
          document.body.style.overflow = '';
        }
        document.getElementById('export-form').reset();

      } catch (error) {
        console.error('Export error:', error);
        showNotification('Export failed: ' + error.message, 'error');
      }
    }

    // View operation details
    async function viewOperation(id) {
      try {
        const response = await window.authFetch(`${FN_BASE}/bulk-operations?limit=100`);

        if (!response.ok) throw new Error('Failed to load operation');

        const data = await response.json();
        const operation = data.operations.find(op => op.id === id);

        if (!operation) throw new Error('Operation not found');

        const content = document.getElementById('operation-details-content');
        
        content.innerHTML = `
          <div class="grid grid-cols-2 gap-4">
            <div><strong>ID:</strong> ${operation.id}</div>
            <div><strong>Type:</strong> ${operation.operation_type}</div>
            <div><strong>Table:</strong> ${operation.target_table}</div>
            <div><strong>Format:</strong> ${operation.format || 'N/A'}</div>
            <div><strong>Status:</strong> <span class="px-2 py-1 rounded text-xs ${getStatusColor(operation.status)}">${operation.status}</span></div>
            <div><strong>Total Records:</strong> ${operation.total_records || 0}</div>
            <div><strong>Processed:</strong> ${operation.processed_records || 0}</div>
            <div><strong>Success:</strong> ${operation.success_count || 0}</div>
            <div><strong>Errors:</strong> ${operation.error_count || 0}</div>
            <div><strong>Started:</strong> ${formatDate(operation.started_at)}</div>
            <div><strong>Completed:</strong> ${operation.completed_at ? formatDate(operation.completed_at) : 'N/A'}</div>
            <div><strong>Committed:</strong> ${operation.committed ? 'Yes' : 'No'}</div>
          </div>
          ${operation.error_log && operation.error_log.length > 0 ? `
            <div class="mt-4 p-4 bg-red-900/20 border border-red-500 rounded">
              <strong>Errors:</strong>
              <ul class="list-disc pl-5 mt-2 max-h-64 overflow-y-auto">
                ${operation.error_log.map(err => `<li>Row ${err.row}: ${err.error}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
        `;

        if (window.BulkOpsModal && typeof window.BulkOpsModal.show === 'function') {
          window.BulkOpsModal.show('operation-details-modal');
        } else {
          document.getElementById('operation-details-modal').classList.remove('hidden');
        }

      } catch (error) {
        console.error('Error viewing operation:', error);
        showNotification('Failed to load operation details', 'error');
      }
    }

    // Helper functions
    function getStatusColor(status) {
      const colors = {
        pending: 'bg-gray-600',
        processing: 'bg-yellow-600',
        completed: 'bg-green-600',
        failed: 'bg-red-600',
        cancelled: 'bg-gray-600'
      };
      return colors[status] || 'bg-gray-600';
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      return new Date(dateString).toLocaleString();
    }

    // Event and modal helpers
    (function() {
      function ensureBackdrop() {
        let backdrop = document.getElementById('modal-backdrop');
        if (!backdrop) {
          backdrop = document.createElement('div');
          backdrop.id = 'modal-backdrop';
          backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-40 hidden';
          document.body.appendChild(backdrop);
        }
        return backdrop;
      }

      function showModal(id) {
        const modal = document.getElementById(id);
        if (!modal) return;
        const backdrop = ensureBackdrop();
        backdrop.classList.remove('hidden');
        backdrop.classList.add('block');
        modal.classList.remove('hidden');
        modal.classList.add('z-50');
        document.body.style.overflow = 'hidden';
        // focus first focusable element
        const focusable = modal.querySelector('select, input, button, textarea');
        if (focusable) focusable.focus();
        // attach outside-click (modal backdrop area) to close
        modal.onclick = (e) => {
          if (e.target === modal) hideModal(id);
        };
        // esc to close
        document.addEventListener('keydown', escHandler);
      }

      function hideModal(id) {
        const modal = document.getElementById(id);
        const backdrop = document.getElementById('modal-backdrop');
        if (modal) modal.classList.add('hidden');
        if (modal) modal.onclick = null;
        if (backdrop) {
          backdrop.classList.add('hidden');
          backdrop.classList.remove('block');
        }
        document.body.style.overflow = '';
        document.removeEventListener('keydown', escHandler);
      }

      function escHandler(e) {
        if (e.key === 'Escape') {
          // hide any open modal
          ['import-modal','export-modal','operation-details-modal'].forEach(id => {
            const m = document.getElementById(id);
            if (m && !m.classList.contains('hidden')) hideModal(id);
          });
        }
      }

      // Wire buttons
      const importBtn = document.getElementById('import-btn');
      const exportBtn = document.getElementById('export-btn');
      const cancelImportBtn = document.getElementById('cancel-import-btn');
      const cancelExportBtn = document.getElementById('cancel-export-btn');
      const closeDetailsBtn = document.getElementById('close-details-btn');

      if (importBtn) importBtn.addEventListener('click', () => showModal('import-modal'));
      if (exportBtn) exportBtn.addEventListener('click', () => showModal('export-modal'));
      if (cancelImportBtn) cancelImportBtn.addEventListener('click', () => {
        hideModal('import-modal');
        document.getElementById('import-form').reset();
        document.getElementById('import-step-1').classList.remove('hidden');
        document.getElementById('import-step-2').classList.add('hidden');
      });
      if (cancelExportBtn) cancelExportBtn.addEventListener('click', () => {
        hideModal('export-modal');
        document.getElementById('export-form').reset();
      });
      if (closeDetailsBtn) closeDetailsBtn.addEventListener('click', () => hideModal('operation-details-modal'));

      // other ui wiring
      const uploadFileBtn = document.getElementById('upload-file-btn');
      if (uploadFileBtn) uploadFileBtn.addEventListener('click', () => document.getElementById('file-input').click());

      const fileInput = document.getElementById('file-input');
      if (fileInput) fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
          const text = await file.text();
          document.getElementById('import-data').value = text;
        }
      });

      const pasteBtn = document.getElementById('paste-data-btn');
      if (pasteBtn) pasteBtn.addEventListener('click', async () => {
        try {
          const text = await navigator.clipboard.readText();
          document.getElementById('import-data').value = text;
          showNotification('Data pasted from clipboard', 'success');
        } catch (err) {
          showNotification('Failed to read clipboard', 'error');
        }
      });

      const validateBtn = document.getElementById('validate-btn');
      if (validateBtn) validateBtn.addEventListener('click', validateImportData);

      const backBtn = document.getElementById('back-to-step1-btn');
      if (backBtn) backBtn.addEventListener('click', () => {
        document.getElementById('import-step-1').classList.remove('hidden');
        document.getElementById('import-step-2').classList.add('hidden');
      });

      const importForm = document.getElementById('import-form');
      if (importForm) importForm.addEventListener('submit', executeImport);
      const exportForm = document.getElementById('export-form');
      if (exportForm) exportForm.addEventListener('submit', executeExport);

      const refreshBtn = document.getElementById('refresh-btn');
      if (refreshBtn) refreshBtn.addEventListener('click', loadOperations);

      // ensure backdrop exists but hidden
      ensureBackdrop();

      // expose modal helpers so import/export handlers can close cleanly
      window.BulkOpsModal = window.BulkOpsModal || {};
      window.BulkOpsModal.show = showModal;
      window.BulkOpsModal.hide = hideModal;
      // Initialize
      loadOperations();
    })();
  </script>
</body>
</html>
