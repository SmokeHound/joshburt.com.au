<!-- Theme Scheduling System -->
<script>
(function() {
    // Theme schedule configuration
    const defaultSchedule = {
        enabled: false,
        darkModeStart: '18:00', // 6 PM
        lightModeStart: '06:00'  // 6 AM
    };

    let themeSchedule = JSON.parse(localStorage.getItem('themeSchedule') || JSON.stringify(defaultSchedule));
    let schedulerInterval = null;

    // Check if time is between dark mode hours
    function isDarkModeTime() {
        if (!themeSchedule.enabled) return null;

        const now = new Date();
        const currentTime = now.getHours() * 60 + now.getMinutes();
        
        const darkStart = parseTimeString(themeSchedule.darkModeStart);
        const lightStart = parseTimeString(themeSchedule.lightModeStart);

        // Handle case where dark mode crosses midnight
        if (darkStart > lightStart) {
            return currentTime >= darkStart || currentTime < lightStart;
        } else {
            return currentTime >= darkStart && currentTime < lightStart;
        }
    }

    // Parse time string (HH:MM) to minutes since midnight
    function parseTimeString(timeStr) {
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours * 60 + minutes;
    }

    // Apply scheduled theme
    function applyScheduledTheme() {
        if (!themeSchedule.enabled) return;

        const shouldBeDark = isDarkModeTime();
        const body = document.body;
        const currentlyDark = body.classList.contains('dark');

        if (shouldBeDark !== null && shouldBeDark !== currentlyDark) {
            if (shouldBeDark) {
                body.classList.remove('light');
                body.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.remove('dark');
                body.classList.add('light');
                localStorage.setItem('theme', 'light');
            }

            // Update theme toggle button
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.textContent = body.classList.contains('dark') ? 
                    (window.t ? window.t('theme.toggle.dark') : 'Toggle Light Mode') : 
                    (window.t ? window.t('theme.toggle.light') : 'Toggle Dark Mode');
            }

            // Show notification about automatic theme change
            if (window.showNotification) {
                const themeName = shouldBeDark ? 'dark' : 'light';
                window.showNotification(
                    `Automatically switched to ${themeName} mode`, 
                    'info'
                );
            }
        }
    }

    // Start theme scheduler
    function startThemeScheduler() {
        if (schedulerInterval) {
            clearInterval(schedulerInterval);
        }

        if (themeSchedule.enabled) {
            // Check every minute
            schedulerInterval = setInterval(applyScheduledTheme, 60000);
            
            // Apply immediately
            applyScheduledTheme();
        }
    }

    // Stop theme scheduler
    function stopThemeScheduler() {
        if (schedulerInterval) {
            clearInterval(schedulerInterval);
            schedulerInterval = null;
        }
    }

    // Update theme schedule
    window.updateThemeSchedule = function(newSchedule) {
        themeSchedule = { ...themeSchedule, ...newSchedule };
        localStorage.setItem('themeSchedule', JSON.stringify(themeSchedule));
        
        if (themeSchedule.enabled) {
            startThemeScheduler();
        } else {
            stopThemeScheduler();
        }

        // Update UI if schedule settings exist
        updateScheduleUI();

        if (window.showNotification) {
            window.showNotification(
                themeSchedule.enabled ? 'Theme scheduling enabled' : 'Theme scheduling disabled',
                'success'
            );
        }
    };

    // Get current theme schedule
    window.getThemeSchedule = function() {
        return { ...themeSchedule };
    };

    // Create schedule settings UI
    function createScheduleSettingsUI() {
        const settingsContainer = document.getElementById('theme-schedule-settings');
        if (!settingsContainer) return;

        settingsContainer.innerHTML = `
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm border border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold mb-4" data-i18n="schedule.title">Theme Schedule</h3>
                
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <label class="flex items-center cursor-pointer">
                            <input 
                                type="checkbox" 
                                id="schedule-enabled" 
                                ${themeSchedule.enabled ? 'checked' : ''}
                                class="mr-3 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                            >
                            <span class="text-sm font-medium" data-i18n="schedule.auto">Auto Dark Mode</span>
                        </label>
                        <span class="text-xs px-2 py-1 rounded ${themeSchedule.enabled ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'}" data-i18n="${themeSchedule.enabled ? 'schedule.enabled' : 'Disabled'}">
                            ${themeSchedule.enabled ? 'Enabled' : 'Disabled'}
                        </span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2" data-i18n="schedule.start">
                                Dark mode starts at
                            </label>
                            <input 
                                type="time" 
                                id="dark-mode-start" 
                                value="${themeSchedule.darkModeStart}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2" data-i18n="schedule.end">
                                Light mode starts at
                            </label>
                            <input 
                                type="time" 
                                id="light-mode-start" 
                                value="${themeSchedule.lightModeStart}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                            >
                        </div>
                    </div>

                    <div class="text-xs text-gray-600 dark:text-gray-400">
                        Current time: <span id="current-time"></span> | 
                        Scheduled mode: <span id="scheduled-mode"></span>
                    </div>
                </div>
            </div>
        `;

        // Add event listeners
        const enabledCheckbox = document.getElementById('schedule-enabled');
        const darkStartInput = document.getElementById('dark-mode-start');
        const lightStartInput = document.getElementById('light-mode-start');

        enabledCheckbox?.addEventListener('change', (e) => {
            window.updateThemeSchedule({ enabled: e.target.checked });
        });

        darkStartInput?.addEventListener('change', (e) => {
            window.updateThemeSchedule({ darkModeStart: e.target.value });
        });

        lightStartInput?.addEventListener('change', (e) => {
            window.updateThemeSchedule({ lightModeStart: e.target.value });
        });

        // Update current time and scheduled mode
        updateTimeDisplay();
        setInterval(updateTimeDisplay, 1000);
    }

    // Update schedule UI
    function updateScheduleUI() {
        const enabledCheckbox = document.getElementById('schedule-enabled');
        const darkStartInput = document.getElementById('dark-mode-start');
        const lightStartInput = document.getElementById('light-mode-start');

        if (enabledCheckbox) enabledCheckbox.checked = themeSchedule.enabled;
        if (darkStartInput) darkStartInput.value = themeSchedule.darkModeStart;
        if (lightStartInput) lightStartInput.value = themeSchedule.lightModeStart;
    }

    // Update time display
    function updateTimeDisplay() {
        const currentTimeEl = document.getElementById('current-time');
        const scheduledModeEl = document.getElementById('scheduled-mode');

        if (currentTimeEl) {
            const now = new Date();
            currentTimeEl.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        if (scheduledModeEl) {
            if (!themeSchedule.enabled) {
                scheduledModeEl.textContent = 'Manual';
                scheduledModeEl.className = 'text-gray-500';
            } else {
                const isDark = isDarkModeTime();
                scheduledModeEl.textContent = isDark ? 'Dark' : 'Light';
                scheduledModeEl.className = isDark ? 'text-blue-400' : 'text-yellow-500';
            }
        }
    }

    // Initialize theme scheduler
    function initThemeScheduler() {
        // Create UI if settings container exists
        createScheduleSettingsUI();
        
        // Start scheduler if enabled
        if (themeSchedule.enabled) {
            startThemeScheduler();
        }

        // Show initial notification about scheduler
        setTimeout(() => {
            if (themeSchedule.enabled && window.showNotification) {
                const isDark = isDarkModeTime();
                window.showNotification(
                    `Theme scheduler active. Current mode: ${isDark ? 'dark' : 'light'}`,
                    'info'
                );
            }
        }, 3000);
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initThemeScheduler);
    } else {
        initThemeScheduler();
    }
})();
</script>