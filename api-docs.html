<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Documentation - joshburt.com.au</title>
  <link rel="stylesheet" href="/assets/css/styles.css">
  <script src="/assets/js/init-shared.js" defer></script>
  <style>
    .endpoint-card {
      transition: all 0.3s ease;
    }
    .endpoint-card:hover {
      transform: translateY(-2px);
    }
    .method-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .method-get { background: #10b981; color: white; }
    .method-post { background: #3b82f6; color: white; }
    .method-put { background: #f59e0b; color: white; }
    .method-delete { background: #ef4444; color: white; }
    .method-patch { background: #8b5cf6; color: white; }
    .code-block {
      background: #1f2937;
      color: #f3f4f6;
      padding: 1rem;
      border-radius: 0.5rem;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
    }
    .try-it-section {
      background: #1f2937;
      border: 1px solid #374151;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <!-- Mobile Menu Toggle -->
  <button id="menu-toggle" class="md:hidden fixed top-4 left-4 z-50 p-2 mobile-menu-toggle" aria-label="Toggle sidebar" aria-expanded="false">â˜°</button>
  <div id="sidebar-backdrop" class="fixed inset-0 sidebar-backdrop z-40 hidden"></div>

  <div class="flex min-h-screen">
    <!-- Shared Navigation Loader -->
    <div id="main-nav"></div>

    <!-- Main Content -->
    <main id="main-content" class="flex-1 p-4 md:p-6" role="main">
    <!-- Header -->
    <header class="page-header ui-card border mb-6 shadow-xl bg-gradient-to-br from-gray-900 via-blue-900/20 to-purple-900/20">
      <div class="flex items-center gap-4">
        <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-blue-500 via-purple-500 to-purple-600 flex items-center justify-center flex-shrink-0 shadow-2xl">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-9 w-9 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
          </svg>
        </div>
        <div>
          <h1 class="text-2xl font-bold text-[color:var(--token-text-primary)]">API Documentation</h1>
          <p class="text-xs mt-2 text-[color:var(--token-text-secondary)]">Interactive documentation for all API endpoints</p>
        </div>
      </div>
    </header>

    <!-- Stats Summary -->
    <div id="stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <!-- Stats will be populated here -->
    </div>

    <!-- Search and Filter -->
    <div class="ui-card rounded-lg shadow-md p-6 mb-6 border border-[color:var(--token-border-default)]">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label for="search" class="block text-sm font-medium text-[color:var(--token-text-secondary)] mb-2">
            Search Endpoints
          </label>
          <input
            type="text"
            id="search"
            placeholder="Search by name or description..."
            class="w-full px-3 py-2 border border-[color:var(--token-border-default)] rounded-md bg-[color:var(--token-bg-elevated)] text-[color:var(--token-text-primary)] placeholder:text-[color:var(--token-text-muted)] focus:outline-none focus:border-[color:var(--token-color-primary)] focus:shadow-[var(--token-shadow-glow-primary)]"
          >
        </div>
        <div>
          <label for="category-filter" class="block text-sm font-medium text-[color:var(--token-text-secondary)] mb-2">
            Category
          </label>
          <select
            id="category-filter"
            class="w-full px-3 py-2 border border-[color:var(--token-border-default)] rounded-md bg-[color:var(--token-bg-elevated)] text-[color:var(--token-text-primary)] focus:outline-none focus:border-[color:var(--token-color-primary)] focus:shadow-[var(--token-shadow-glow-primary)]"
          >
            <option value="">All Categories</option>
          </select>
        </div>
        <div>
          <label for="method-filter" class="block text-sm font-medium text-[color:var(--token-text-secondary)] mb-2">
            Method
          </label>
          <select
            id="method-filter"
            class="w-full px-3 py-2 border border-[color:var(--token-border-default)] rounded-md bg-[color:var(--token-bg-elevated)] text-[color:var(--token-text-primary)] focus:outline-none focus:border-[color:var(--token-color-primary)] focus:shadow-[var(--token-shadow-glow-primary)]"
          >
            <option value="">All Methods</option>
            <option value="GET">GET</option>
            <option value="POST">POST</option>
            <option value="PUT">PUT</option>
            <option value="DELETE">DELETE</option>
            <option value="PATCH">PATCH</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Endpoints List -->
    <div id="endpoints-container">
      <!-- Endpoints will be populated here -->
    </div>
  </main>

  <!-- Shared Components loaded by init-shared.js -->

  <script>
    const FN_BASE = window.FN_BASE || '/.netlify/functions';
    let apiSpec = null;
    let filteredEndpoints = [];

    // Load API specification
    async function loadAPISpec() {
      try {
        const response = await fetch('./data/api-spec.json');
        apiSpec = await response.json();
        renderStats();
        renderCategories();
        renderEndpoints(Object.entries(apiSpec.paths));
      } catch (error) {
        console.error('Failed to load API spec:', error);
        document.getElementById('endpoints-container').innerHTML = `
          <div class="ui-card border border-red-500/30 rounded-lg p-4 text-red-200">
            <p class="font-semibold">Failed to load API documentation</p>
            <p class="text-sm mt-1">Run <code class="bg-red-900/50 px-2 py-1 rounded">node scripts/generate-api-docs.js</code> to generate the documentation.</p>
          </div>
        `;
      }
    }

    // Render statistics
    function renderStats() {
      const endpoints = Object.entries(apiSpec.paths);
      const stats = {
        total: endpoints.length,
        authenticated: endpoints.filter(([_, methods]) => 
          Object.values(methods).some(m => m.security)
        ).length,
        public: endpoints.filter(([_, methods]) => 
          !Object.values(methods).some(m => m.security)
        ).length,
        categories: new Set(endpoints.flatMap(([_, methods]) => 
          Object.values(methods).flatMap(m => m.tags || [])
        )).size
      };

      document.getElementById('stats').innerHTML = `
        <div class="ui-card rounded-lg shadow-md p-6 border border-blue-500/20 hover:border-blue-500/40 transition-all">
          <div class="text-3xl font-bold text-blue-400">${stats.total}</div>
          <div class="text-sm text-gray-400 mt-1">Total Endpoints</div>
        </div>
        <div class="ui-card rounded-lg shadow-md p-6 border border-green-500/20 hover:border-green-500/40 transition-all">
          <div class="text-3xl font-bold text-green-400">${stats.authenticated}</div>
          <div class="text-sm text-gray-400 mt-1">Authenticated</div>
        </div>
        <div class="ui-card rounded-lg shadow-md p-6 border border-purple-500/20 hover:border-purple-500/40 transition-all">
          <div class="text-3xl font-bold text-purple-400">${stats.public}</div>
          <div class="text-sm text-gray-400 mt-1">Public</div>
        </div>
        <div class="ui-card rounded-lg shadow-md p-6 border border-orange-500/20 hover:border-orange-500/40 transition-all">
          <div class="text-3xl font-bold text-orange-400">${stats.categories}</div>
          <div class="text-sm text-gray-400 mt-1">Categories</div>
        </div>
      `;
    }

    // Render category filter options
    function renderCategories() {
      const categories = new Set();
      Object.values(apiSpec.paths).forEach(methods => {
        Object.values(methods).forEach(method => {
          if (method.tags) {
            method.tags.forEach(tag => categories.add(tag));
          }
        });
      });

      const select = document.getElementById('category-filter');
      Array.from(categories).sort().forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        select.appendChild(option);
      });
    }

    // Render endpoints
    function renderEndpoints(endpoints) {
      filteredEndpoints = endpoints;
      const container = document.getElementById('endpoints-container');
      
      if (endpoints.length === 0) {
        container.innerHTML = `
          <div class="ui-card rounded-lg p-8 text-center border border-[color:var(--token-border-default)]">
            <p class="text-[color:var(--token-text-muted)]">No endpoints found matching your filters</p>
          </div>
        `;
        return;
      }

      container.innerHTML = endpoints.map(([path, methods]) => {
        const firstMethod = Object.values(methods)[0];
        const allMethods = Object.keys(methods);
        const requiresAuth = Object.values(methods).some(m => m.security);
        const category = firstMethod.tags?.[0] || 'Other';

        return `
          <div class="endpoint-card ui-card rounded-lg shadow-md p-6 mb-4 border border-[color:var(--token-border-default)] hover:border-[color:var(--token-color-primary)]">
            <div class="flex justify-between items-start mb-4">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2 flex-wrap">
                  ${allMethods.map(m => `<span class="method-badge method-${m.toLowerCase()}">${m}</span>`).join('')}
                  ${requiresAuth ? '<span class="text-xs bg-yellow-900/50 text-yellow-200 px-2 py-1 rounded border border-yellow-700">ðŸ”’ Auth Required</span>' : ''}
                </div>
                <h3 class="text-lg font-semibold text-[color:var(--token-text-primary)] font-mono">${path}</h3>
                <p class="text-sm text-[color:var(--token-text-muted)] mt-1">${firstMethod.summary || 'No description'}</p>
                <span class="inline-block mt-2 text-xs bg-[color:var(--token-bg-elevated)] text-[color:var(--token-text-secondary)] px-2 py-1 rounded border border-[color:var(--token-border-default)]">${category}</span>
              </div>
              <button onclick="toggleDetails('${path.replace(/[^a-zA-Z0-9]/g, '_')}')" class="text-blue-400 hover:text-blue-300 text-sm ml-4">
                Details
              </button>
            </div>
            
            <div id="details_${path.replace(/[^a-zA-Z0-9]/g, '_')}" class="hidden mt-4">
              ${renderEndpointDetails(path, methods)}
            </div>
          </div>
        `;
      }).join('');
    }

    // Render endpoint details
    function renderEndpointDetails(path, methods) {
      return Object.entries(methods).map(([method, details]) => {
        const baseUrl = window.location.hostname === 'localhost' ? 
          'http://localhost:8888' : 'https://joshburt.com.au';
        
        const exampleUrl = `${baseUrl}${path}${details.parameters?.length ? '?' + details.parameters.map(p => `${p.name}=value`).join('&') : ''}`;
        
        return `
          <div class="mb-6 pb-6 border-b border-[color:var(--token-border-default)] last:border-0">
            <h4 class="font-semibold text-white mb-3">
              <span class="method-badge method-${method.toLowerCase()}">${method}</span>
              ${details.summary}
            </h4>
            
            ${details.parameters?.length ? `
              <div class="mb-3">
                <h5 class="text-sm font-semibold text-gray-300 mb-2">Parameters</h5>
                <div class="space-y-2">
                  ${details.parameters.map(p => `
                    <div class="text-sm">
                      <code class="bg-gray-700 px-2 py-1 rounded text-blue-300">${p.name}</code>
                      <span class="text-gray-400 ml-2">(${p.schema?.type || 'string'})</span>
                      ${p.schema?.enum ? `<span class="text-gray-500 ml-2">enum: ${p.schema.enum.join(', ')}</span>` : ''}
                      <p class="text-gray-400 mt-1 ml-2">${p.description || ''}</p>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
            
            <div class="mb-3">
              <h5 class="text-sm font-semibold text-gray-300 mb-2">Example Request</h5>
              <div class="code-block">
${method} ${exampleUrl}
${details.security ? 'Authorization: Bearer YOUR_ACCESS_TOKEN' : ''}
${details.requestBody ? `Content-Type: application/json

{
  // Your request body
}` : ''}
              </div>
            </div>

            ${details.security ? `
              <div class="try-it-section">
                <h5 class="text-sm font-semibold text-gray-300 mb-2">Try It Out</h5>
                <button onclick="tryEndpoint('${method}', '${path}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm transition-colors">
                  Send Request
                </button>
                <div id="response_${method}_${path.replace(/[^a-zA-Z0-9]/g, '_')}" class="mt-3 hidden">
                  <h6 class="text-sm font-semibold text-gray-300 mb-2">Response:</h6>
                  <pre class="code-block text-xs"></pre>
                </div>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    // Toggle endpoint details
    function toggleDetails(id) {
      const element = document.getElementById(`details_${id}`);
      element.classList.toggle('hidden');
    }

    // Try an endpoint
    async function tryEndpoint(method, path) {
      const token = (window.getToken && window.getToken()) || localStorage.getItem('accessToken');
      if (!token && window.AUTH_DISABLED !== true) {
        alert('Please log in first to try this endpoint');
        window.location.href = '/login.html';
        return;
      }

      const responseDiv = document.getElementById(`response_${method}_${path.replace(/[^a-zA-Z0-9]/g, '_')}`);
      const responsePre = responseDiv.querySelector('pre');
      
      responseDiv.classList.remove('hidden');
      responsePre.textContent = 'Loading...';

      try {
        const init = {
          method,
          headers: {
            'Content-Type': 'application/json'
          }
        };

        const response = await (window.authFetch
          ? window.authFetch(path, init)
          : fetch(path, {
              ...init,
              headers: {
                ...init.headers,
                Authorization: `Bearer ${token || ''}`
              }
            }));

        const data = await response.json();
        responsePre.textContent = JSON.stringify(data, null, 2);
      } catch (error) {
        responsePre.textContent = `Error: ${error.message}`;
      }
    }

    // Filter endpoints
    function filterEndpoints() {
      const search = document.getElementById('search').value.toLowerCase();
      const category = document.getElementById('category-filter').value;
      const method = document.getElementById('method-filter').value;

      const filtered = Object.entries(apiSpec.paths).filter(([path, methods]) => {
        // Search filter
        const matchesSearch = !search || 
          path.toLowerCase().includes(search) ||
          Object.values(methods).some(m => m.summary?.toLowerCase().includes(search));

        // Category filter
        const matchesCategory = !category ||
          Object.values(methods).some(m => m.tags?.includes(category));

        // Method filter
        const matchesMethod = !method || Object.keys(methods).includes(method);

        return matchesSearch && matchesCategory && matchesMethod;
      });

      renderEndpoints(filtered);
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      loadAPISpec();
      
      document.getElementById('search').addEventListener('input', filterEndpoints);
      document.getElementById('category-filter').addEventListener('change', filterEndpoints);
      document.getElementById('method-filter').addEventListener('change', filterEndpoints);
    });

    // Mobile menu wiring
    function wireMenu() {
      const menuToggle = document.getElementById('menu-toggle');
      const sidebar = document.getElementById('sidebar');
      const sidebarBackdrop = document.getElementById('sidebar-backdrop');
      if (!(menuToggle && sidebar)) return;
      if (menuToggle.dataset.wired === 'true') return;
      menuToggle.dataset.wired = 'true';

      function toggle() {
        const isOpen = sidebar.classList.toggle('open');
        menuToggle.setAttribute('aria-expanded', String(isOpen));
        if (sidebarBackdrop) {
          if (isOpen) sidebarBackdrop.classList.remove('hidden');
          else sidebarBackdrop.classList.add('hidden');
        }
        document.body.classList.toggle('sidebar-open', isOpen);
      }
      menuToggle.addEventListener('click', toggle);
      if (sidebarBackdrop) {
        sidebarBackdrop.addEventListener('click', function() {
          if (sidebar.classList.contains('open')) toggle();
        });
      }
    }
    wireMenu();
    setTimeout(wireMenu, 250);
  </script>
  </div>
</body>
</html>
