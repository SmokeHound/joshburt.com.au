<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Scheduled Reports - joshburt.com.au</title>
  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="/assets/images/logo-placeholder.svg" />
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <script src="/assets/js/init-shared.js" defer></script>
  <script src="/assets/js/notifications.js" defer></script>
  <script src="/assets/js/feature-flags.js" defer></script>
  <link rel="stylesheet" href="/assets/css/accessibility.css" />
  <script src="/assets/js/accessibility.js" defer></script>
</head>
<body class="min-h-screen flex flex-col md:flex-row font-sans">

<button id="menu-toggle" class="md:hidden fixed top-4 left-4 z-50 p-2 mobile-menu-toggle" aria-label="Toggle sidebar" aria-expanded="false">☰</button>
<div id="main-nav"></div>

<main id="main-content" class="flex-1 p-4 space-y-6" role="main">
  <header class="page-header ui-card border flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-bold">Scheduled Reports</h1>
      <p class="text-sm text-[color:var(--token-text-muted)] mt-1">Automate report generation and delivery</p>
    </div>
    <div class="flex items-center gap-3">
      <button id="create-report-btn" class="ui-btn ui-btn-secondary px-4 py-2 rounded-lg">
        + Create Report
      </button>
    </div>
  </header>

  <!-- Reports List -->
  <section class="ui-card p-6">
    <h2 class="text-lg font-semibold mb-4">Active Reports</h2>
    <div id="reports-list" class="space-y-4">
      <div class="text-center text-[color:var(--token-text-muted)] py-8">Loading...</div>
    </div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        if (!window.FeatureFlags || typeof window.FeatureFlags.isEnabled !== 'function') return;
        const enabled = await window.FeatureFlags.isEnabled('enableScheduledReports');
        if (enabled) return;

        if (typeof window.showToast === 'function') {
          window.showToast('Scheduled Reports is currently disabled.', 'warning');
        } else {
          alert('Scheduled Reports is currently disabled.');
        }
        window.location.href = 'administration.html';
      } catch (_) {
        // fail open
      }
    });
  </script>

  <!-- Report History -->
  <section class="ui-card p-6">
    <h2 class="text-lg font-semibold mb-4">Recent Executions</h2>
    <div class="overflow-x-auto">
      <table class="w-full text-left">
        <thead>
          <tr class="border-b border-[color:var(--token-border-default)]">
            <th class="pb-3">Report Name</th>
            <th class="pb-3">Type</th>
            <th class="pb-3">Generated</th>
            <th class="pb-3">Status</th>
            <th class="pb-3">Recipients</th>
            <th class="pb-3">Actions</th>
          </tr>
        </thead>
        <tbody id="history-table">
          <tr>
            <td colspan="6" class="py-4 text-center text-[color:var(--token-text-muted)]">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
</main>

<!-- Create/Edit Report Modal -->
<div id="report-modal" class="fixed inset-0 bg-[color:var(--token-bg-overlay)] hidden flex items-center justify-center z-[9998]">
  <div class="ui-card p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto relative z-[9999]">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold" id="modal-title">Create Scheduled Report</h2>
      <button id="close-modal" class="text-[color:var(--token-text-muted)] hover:text-[color:var(--token-text-primary)]">×</button>
    </div>

    <form id="report-form" class="space-y-4">
      <input type="hidden" id="report-id" />

      <div>
        <label class="block text-sm font-semibold mb-2">Report Name</label>
        <input type="text" id="report-name" required class="w-full p-3 rounded-lg bg-[color:var(--token-bg-elevated)] text-[color:var(--token-text-primary)] border border-[color:var(--token-border-default)] placeholder:text-[color:var(--token-text-muted)] focus:outline-none focus:border-[color:var(--token-color-primary)] focus:shadow-[var(--token-shadow-glow-primary)]" placeholder="Weekly Sales Report" />
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold mb-2">Report Type</label>
          <select id="report-type" required class="w-full p-3 rounded-lg bg-[color:var(--token-bg-elevated)] text-[color:var(--token-text-primary)] border border-[color:var(--token-border-default)] focus:outline-none focus:border-[color:var(--token-color-primary)] focus:shadow-[var(--token-shadow-glow-primary)]">
            <option value="">Select type...</option>
            <option value="sales">Sales Report</option>
            <option value="inventory">Inventory Report</option>
            <option value="users">Users Report</option>
            <option value="analytics">Analytics Report</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Frequency</label>
          <select id="report-frequency" required class="w-full p-3 rounded-lg bg-[color:var(--token-bg-elevated)] text-[color:var(--token-text-primary)] border border-[color:var(--token-border-default)] focus:outline-none focus:border-[color:var(--token-color-primary)] focus:shadow-[var(--token-shadow-glow-primary)]">
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
            <option value="once">One-time</option>
          </select>
        </div>
      </div>

      <div>
        <label class="block text-sm font-semibold mb-2">Format</label>
        <select id="report-format" class="w-full p-3 rounded-lg bg-[color:var(--token-bg-elevated)] text-[color:var(--token-text-primary)] border border-[color:var(--token-border-default)] focus:outline-none focus:border-[color:var(--token-color-primary)] focus:shadow-[var(--token-shadow-glow-primary)]">
          <option value="csv">CSV</option>
          <option value="pdf">PDF</option>
          <option value="excel">Excel (Coming Soon)</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-semibold mb-2">Recipients (one email per line)</label>
        <textarea id="report-recipients" rows="3" class="w-full p-3 rounded-lg bg-[color:var(--token-bg-elevated)] text-[color:var(--token-text-primary)] border border-[color:var(--token-border-default)] placeholder:text-[color:var(--token-text-muted)] focus:outline-none focus:border-[color:var(--token-color-primary)] focus:shadow-[var(--token-shadow-glow-primary)]" placeholder="email@example.com"></textarea>
      </div>

      <div>
        <label class="block text-sm font-semibold mb-2">Date Range (optional)</label>
        <div class="grid grid-cols-2 gap-4">
          <input type="date" id="report-date-from" class="w-full p-3 rounded-lg bg-[color:var(--token-bg-elevated)] text-[color:var(--token-text-primary)] border border-[color:var(--token-border-default)] focus:outline-none focus:border-[color:var(--token-color-primary)] focus:shadow-[var(--token-shadow-glow-primary)]" />
          <input type="date" id="report-date-to" class="w-full p-3 rounded-lg bg-[color:var(--token-bg-elevated)] text-[color:var(--token-text-primary)] border border-[color:var(--token-border-default)] focus:outline-none focus:border-[color:var(--token-color-primary)] focus:shadow-[var(--token-shadow-glow-primary)]" />
        </div>
      </div>

      <div class="flex justify-end gap-2 pt-4">
        <button type="button" id="cancel-btn" class="ui-btn ui-btn-outline px-4 py-2 rounded-lg">
          Cancel
        </button>
        <button type="submit" class="ui-btn ui-btn-primary px-4 py-2 rounded-lg">
          Save Report
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  const FN_BASE = window.FN_BASE || '/.netlify/functions';
  let currentReports = [];

  async function loadReports() {
    try {
      const response = await window.authFetch(`${FN_BASE}/scheduled-reports`);

      if (!response.ok) {
        throw new Error('Failed to load reports');
      }

      const data = await response.json();
      currentReports = data.reports || [];

      displayReports(currentReports);
      loadHistory();

    } catch (error) {
      console.error('Error loading reports:', error);
      document.getElementById('reports-list').innerHTML = '<div class="text-center text-red-400 py-8">Failed to load reports</div>';
    }
  }

  function displayReports(reports) {
    const container = document.getElementById('reports-list');

    if (reports.length === 0) {
      container.innerHTML = '<div class="text-center text-[color:var(--token-text-muted)] py-8">No scheduled reports yet. Create one to get started!</div>';
      return;
    }

    container.innerHTML = reports.map(report => `
      <div class="ui-card p-4 border border-[color:var(--token-border-default)]">
        <div class="flex justify-between items-start">
          <div class="flex-1">
            <div class="flex items-center gap-3">
              <h3 class="text-lg font-semibold">${report.name}</h3>
              <span class="px-2 py-1 text-xs rounded ${report.is_active ? 'bg-green-600' : 'bg-gray-600'}">
                ${report.is_active ? 'Active' : 'Inactive'}
              </span>
            </div>
            <div class="mt-2 space-y-1 text-sm text-[color:var(--token-text-muted)]">
              <div>Type: <span class="text-[color:var(--token-text-secondary)]">${report.report_type}</span></div>
              <div>Frequency: <span class="text-[color:var(--token-text-secondary)]">${report.frequency}</span></div>
              <div>Format: <span class="text-[color:var(--token-text-secondary)]">${report.format}</span></div>
              ${report.recipients ? `<div>Recipients: <span class="text-[color:var(--token-text-secondary)]">${report.recipients.length}</span></div>` : ''}
              ${report.last_run ? `<div>Last Run: <span class="text-[color:var(--token-text-secondary)]">${new Date(report.last_run).toLocaleString()}</span></div>` : ''}
              ${report.next_run ? `<div>Next Run: <span class="text-[color:var(--token-text-secondary)]">${new Date(report.next_run).toLocaleString()}</span></div>` : ''}
            </div>
          </div>
          <div class="flex gap-2">
            <button onclick="generateNow(${report.id})" class="ui-btn ui-btn-primary px-3 py-1 text-sm rounded">
              Run Now
            </button>
            <button onclick="editReport(${report.id})" class="ui-btn ui-btn-outline px-3 py-1 text-sm rounded">
              Edit
            </button>
            <button onclick="toggleReportStatus(${report.id}, ${!report.is_active})" class="px-3 py-1 text-sm ${report.is_active ? 'bg-yellow-600' : 'bg-green-600'} text-white rounded hover:opacity-80">
              ${report.is_active ? 'Pause' : 'Activate'}
            </button>
            <button onclick="deleteReport(${report.id})" class="ui-btn ui-btn-danger px-3 py-1 text-sm rounded">
              Delete
            </button>
          </div>
        </div>
      </div>
    `).join('');
  }

  async function loadHistory() {
    try {
      const historyTable = document.getElementById('history-table');

      const response = await window.authFetch(`${FN_BASE}/scheduled-reports/history?per_page=10`);
      if (!response.ok) {
        throw new Error('Failed to load report history');
      }

      const data = await response.json();
      const history = data.history || [];

      if (history.length === 0) {
        historyTable.innerHTML = '<tr><td colspan="6" class="py-4 text-center text-[color:var(--token-text-muted)]">No executions yet</td></tr>';
        return;
      }

      historyTable.innerHTML = history
        .map(item => {
          const generatedAt = item.generated_at ? new Date(item.generated_at).toLocaleString() : '-';
          const reportName = item.report_name || 'Unnamed Report';
          const reportType = item.report_type || '-';
          const status = item.status || 'unknown';
          const recipientsCount =
            typeof item.recipient_count === 'number'
              ? item.recipient_count
              : Array.isArray(item.recipients)
                ? item.recipients.length
                : 0;

          const statusClass =
            status === 'success'
              ? 'bg-green-600'
              : status === 'failed'
                ? 'bg-red-600'
                : 'bg-gray-600';

          const actions = item.scheduled_report_id
            ? `<button onclick="generateNow(${item.scheduled_report_id})" class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">Run Again</button>`
            : '<span class="text-gray-500">-</span>';

          return `
            <tr class="border-b border-[color:var(--token-border-default)]">
              <td class="py-3">${reportName}</td>
              <td class="py-3">${reportType}</td>
              <td class="py-3">${generatedAt}</td>
              <td class="py-3"><span class="px-2 py-1 text-xs rounded ${statusClass}">${status}</span></td>
              <td class="py-3">${recipientsCount}</td>
              <td class="py-3">${actions}</td>
            </tr>
          `;
        })
        .join('');
    } catch (error) {
      console.error('Error loading history:', error);
      document.getElementById('history-table').innerHTML = '<tr><td colspan="6" class="py-4 text-center text-red-400">Failed to load history</td></tr>';
    }
  }

  function base64ToUint8Array(base64) {
    const binaryString = atob(base64);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes;
  }

  async function generateNow(reportId) {
    try {
      const response = await window.authFetch(`${FN_BASE}/scheduled-reports`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'generate',
          report_id: reportId
        })
      });

      if (!response.ok) {
        throw new Error('Failed to generate report');
      }

      const data = await response.json();

      // Download the report
      if (data.report) {
        const format = data.format || 'csv';
        const filename = data.filename || `report-${Date.now()}.${format === 'pdf' ? 'pdf' : 'csv'}`;

        const blob =
          data.isBase64 === true
            ? new Blob([base64ToUint8Array(data.report)], {
              type: format === 'pdf' ? 'application/pdf' : 'application/octet-stream'
            })
            : new Blob([data.report], {
              type: format === 'csv' ? 'text/csv' : 'application/octet-stream'
            });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      alert('Report generated successfully!');
      loadReports();
    } catch (error) {
      console.error('Error generating report:', error);
      alert('Failed to generate report');
    }
  }

  async function toggleReportStatus(reportId, isActive) {
    try {
      const response = await window.authFetch(`${FN_BASE}/scheduled-reports/${reportId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_active: isActive })
      });

      if (!response.ok) {
        throw new Error('Failed to update report');
      }

      loadReports();
    } catch (error) {
      console.error('Error updating report:', error);
      alert('Failed to update report');
    }
  }

  async function deleteReport(reportId) {
    if (!confirm('Are you sure you want to delete this report?')) {
      return;
    }

    try {
      const response = await window.authFetch(`${FN_BASE}/scheduled-reports/${reportId}`, {
        method: 'DELETE'
      });

      if (!response.ok) {
        throw new Error('Failed to delete report');
      }

      loadReports();
    } catch (error) {
      console.error('Error deleting report:', error);
      alert('Failed to delete report');
    }
  }

  function editReport(reportId) {
    const report = currentReports.find(r => r.id === reportId);
    if (!report) return;

    document.getElementById('modal-title').textContent = 'Edit Scheduled Report';
    document.getElementById('report-id').value = report.id;
    document.getElementById('report-name').value = report.name;
    document.getElementById('report-type').value = report.report_type;
    document.getElementById('report-frequency').value = report.frequency;
    document.getElementById('report-format').value = report.format;
    document.getElementById('report-recipients').value = (report.recipients || []).join('\n');

    if (report.filters) {
      document.getElementById('report-date-from').value = report.filters.date_from || '';
      document.getElementById('report-date-to').value = report.filters.date_to || '';
    }

    document.getElementById('report-modal').classList.remove('hidden');
  }

  // Event listeners
  document.getElementById('create-report-btn').addEventListener('click', () => {
    document.getElementById('modal-title').textContent = 'Create Scheduled Report';
    document.getElementById('report-form').reset();
    document.getElementById('report-id').value = '';
    document.getElementById('report-modal').classList.remove('hidden');
  });

  document.getElementById('close-modal').addEventListener('click', () => {
    document.getElementById('report-modal').classList.add('hidden');
  });

  document.getElementById('cancel-btn').addEventListener('click', () => {
    document.getElementById('report-modal').classList.add('hidden');
  });

  document.getElementById('report-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const reportId = document.getElementById('report-id').value;
    const name = document.getElementById('report-name').value;
    const report_type = document.getElementById('report-type').value;
    const frequency = document.getElementById('report-frequency').value;
    const format = document.getElementById('report-format').value;
    const recipientsText = document.getElementById('report-recipients').value;
    const recipients = recipientsText.split('\n').map(email => email.trim()).filter(email => email);
    const date_from = document.getElementById('report-date-from').value;
    const date_to = document.getElementById('report-date-to').value;

    const filters = {};
    if (date_from) filters.date_from = date_from;
    if (date_to) filters.date_to = date_to;

    try {
      const method = reportId ? 'PUT' : 'POST';
      const url = reportId ? `${FN_BASE}/scheduled-reports/${reportId}` : `${FN_BASE}/scheduled-reports`;

      const response = await (window.authFetch
        ? window.authFetch(url, {
            method,
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              name,
              report_type,
              frequency,
              format,
              recipients,
              filters
            })
          })
        : fetch(url, {
        method,
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('accessToken') || ''}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name,
          report_type,
          frequency,
          format,
          recipients,
          filters
        })
      }));

      if (!response.ok) {
        throw new Error('Failed to save report');
      }

      document.getElementById('report-modal').classList.add('hidden');
      loadReports();
    } catch (error) {
      console.error('Error saving report:', error);
      alert('Failed to save report');
    }
  });

  // Make functions global for onclick handlers
  window.generateNow = generateNow;
  window.toggleReportStatus = toggleReportStatus;
  window.deleteReport = deleteReport;
  window.editReport = editReport;

  // Load initial data - wait for authFetch to be available
  if (window.authFetch) {
    loadReports();
  } else {
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(loadReports, 100);
    });
  }
</script>

</body>
</html>
