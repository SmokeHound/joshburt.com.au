<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Progressive Web App Configuration</title>
  <!-- PWA Configuration -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3b82f6">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-status-bar-style" content="default">
  <meta name="mobile-web-app-title" content="JoshBurt.com.au">
  <link rel="apple-touch-icon" href="/assets/images/logo-placeholder.svg">
  <!-- Load shared configuration (TailwindCSS, color variables, layout styles) -->
  <script>
    fetch('shared-config.html')
      .then(response => response.text())
      .then(html => {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        const styles = tempDiv.getElementsByTagName('style');
        const scripts = tempDiv.getElementsByTagName('script');
        const links = tempDiv.getElementsByTagName('link');
        for (let link of links) {
          document.head.appendChild(link.cloneNode(true));
        }
        for (let style of styles) {
          document.head.appendChild(style.cloneNode(true));
        }
        for (let script of scripts) {
          const newScript = document.createElement('script');
          newScript.textContent = script.textContent;
          document.head.appendChild(newScript);
        }
      });
  </script>
  <style>
    .offline-indicator {
      background: var(--token-color-warning);
      color: var(--token-text-primary);
    }
  </style>
</head>
<body class="min-h-screen font-sans">
  <!-- Offline Indicator -->
  <div id="offline-indicator" class="offline-indicator fixed top-0 left-0 right-0 px-4 py-2 text-center z-50 hidden">
    <svg class="inline-block w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414" />
    </svg>
    You are offline. Some features may be limited.
  </div>

  <!-- PWA Install Prompt -->
  <div id="pwa-install-prompt" class="fixed bottom-4 right-4 ui-card ui-card-flat p-4 max-w-sm hidden z-50">
    <div class="flex items-start">
      <svg class="w-6 h-6 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
      </svg>
      <div class="flex-1">
        <h3 class="font-semibold mb-1">Install App</h3>
        <p class="text-sm mb-3">Install JoshBurt.com.au for quick access and offline support.</p>
        <div class="flex gap-2">
          <button id="pwa-install-btn" class="ui-btn ui-btn-primary ui-btn-sm">
            Install
          </button>
          <button id="pwa-dismiss-btn" class="ui-btn ui-btn-outline ui-btn-sm">
            Not Now
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Service Worker Registration and PWA Features -->
  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        // Register service worker
        const registration = await navigator.serviceWorker.register('./sw.js');
        console.log('SW registered: ', registration);

        // Handle install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          deferredPrompt = e;

          // Show custom install prompt if user hasn't dismissed it
          const dismissed = localStorage.getItem('pwa-install-dismissed');
          if (!dismissed) {
            const prompt = document.getElementById('pwa-install-prompt');
            if (prompt) {
              prompt.classList.remove('hidden');
            }
          }
        });

        // Handle install button click
        const installBtn = document.getElementById('pwa-install-btn');
        if (installBtn) {
          installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) return;

            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User ${outcome} the install prompt`);

            deferredPrompt = null;
            document.getElementById('pwa-install-prompt').classList.add('hidden');
          });
        }

        // Handle dismiss button click
        const dismissBtn = document.getElementById('pwa-dismiss-btn');
        if (dismissBtn) {
          dismissBtn.addEventListener('click', () => {
            document.getElementById('pwa-install-prompt').classList.add('hidden');
            localStorage.setItem('pwa-install-dismissed', 'true');
          });
        }

        // Log when app is installed
        window.addEventListener('appinstalled', () => {
          console.log('PWA installed successfully');
          document.getElementById('pwa-install-prompt').classList.add('hidden');
        });

      } catch (error) {
        console.log('SW registration failed: ', error);
      }
    });
  }
  </script>

  <!-- Load Offline Storage and Sync -->
  <script src="/assets/js/offline-storage.js"></script>
  <script src="/assets/js/offline-sync.js"></script>

  <!-- Initialize Offline Features -->
  <script>
    // Initialize offline storage
    window.addEventListener('load', async () => {
      try {
        await window.OfflineStorage.init();
        console.log('Offline storage initialized');

        // Set up offline indicator
        if (window.OfflineSyncManager) {
          window.OfflineSyncManager.addStatusListener((isOnline) => {
            console.log('Connection status:', isOnline ? 'Online' : 'Offline');
          });
        }
      } catch (error) {
        console.error('Failed to initialize offline features:', error);
      }
    });
  </script>

  <!-- Load shared theme functionality (dark/light mode, theme toggle) -->
  <script>
    fetch('shared-theme.html')
      .then(response => response.text())
      .then(html => {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        const scripts = tempDiv.getElementsByTagName('script');
        for (let script of scripts) {
          const newScript = document.createElement('script');
          newScript.textContent = script.textContent;
          document.body.appendChild(newScript);
        }
      });
  </script>
</body>
</html>