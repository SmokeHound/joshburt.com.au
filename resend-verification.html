<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resend Verification Email - Josh Burt</title>
  <link rel="stylesheet" href="/assets/css/styles.css">
  <script>
    (function(){
      fetch('shared-config.html').then(r=>r.text()).then(html=>{
        const t=document.createElement('div'); t.innerHTML=html;
        Array.from(t.children).forEach(c=>{
          const tag = c.tagName;
          if (tag === 'LINK' || tag === 'STYLE') {
            document.head.appendChild(c.cloneNode(true));
          } else if (tag === 'SCRIPT') {
            const s = document.createElement('script');
            if (c.src) s.src = c.src;
            s.type = c.type || 'text/javascript';
            s.text = c.textContent;
            document.body.appendChild(s);
          } else {
            document.head.appendChild(c.cloneNode(true));
          }
        });
      }).catch(()=>{});

      fetch('shared-theme.html').then(r=>r.text()).then(html=>{
        const t=document.createElement('div'); t.innerHTML=html;
        Array.from(t.children).forEach(c=>{
          if (c.tagName === 'SCRIPT') {
            const s = document.createElement('script');
            if (c.src) s.src = c.src;
            s.type = c.type || 'text/javascript';
            s.text = c.textContent;
            document.body.appendChild(s);
          } else if (c.tagName === 'LINK' || c.tagName === 'STYLE') {
            document.head.appendChild(c.cloneNode(true));
          } else {
            document.body.appendChild(c);
          }
        });
      }).catch(()=>{});
    })();
  </script>
</head>
<body class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800">
  
  <div class="max-w-md w-full mx-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Resend Verification Email</h1>
        <p class="text-gray-600 dark:text-gray-400">Enter your email to receive a new verification link</p>
      </div>

      <form id="resendForm" class="space-y-6">
        <div>
          <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Email Address
          </label>
          <input 
            type="email" 
            id="email" 
            name="email" 
            required
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
            placeholder="you@example.com"
          >
        </div>

        <button 
          type="submit" 
          id="submitBtn"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center"
        >
          <span id="submitText">Send Verification Email</span>
          <span id="submitSpinner" class="hidden ml-2">
            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </span>
        </button>
      </form>

      <div id="message" class="mt-4 hidden">
        <div class="p-4 rounded-lg" id="messageContent"></div>
      </div>

      <div class="mt-6 text-center">
        <a href="/login.html" class="text-blue-600 dark:text-blue-400 hover:underline text-sm">
          Back to Login
        </a>
      </div>
    </div>
  </div>

  <script>
    const FN_BASE = window.FN_BASE || '/.netlify/functions';
    const form = document.getElementById('resendForm');
    const emailInput = document.getElementById('email');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const submitSpinner = document.getElementById('submitSpinner');
    const message = document.getElementById('message');
    const messageContent = document.getElementById('messageContent');

    function showMessage(text, type = 'success') {
      message.classList.remove('hidden');
      messageContent.textContent = text;
      messageContent.className = `p-4 rounded-lg ${
        type === 'success' 
          ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 border border-green-200 dark:border-green-700' 
          : 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 border border-red-200 dark:border-red-700'
      }`;
    }

    function hideMessage() {
      message.classList.add('hidden');
    }

    function setLoading(loading) {
      submitBtn.disabled = loading;
      if (loading) {
        submitText.textContent = 'Sending...';
        submitSpinner.classList.remove('hidden');
      } else {
        submitText.textContent = 'Send Verification Email';
        submitSpinner.classList.add('hidden');
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideMessage();
      
      const email = emailInput.value.trim();
      if (!email) {
        showMessage('Please enter your email address', 'error');
        return;
      }

      setLoading(true);

      try {
          const response = await fetch(`${FN_BASE}/auth?action=resend-verification`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
          });

          const text = await response.text();
          let data = null;
          try { data = text ? JSON.parse(text) : null; } catch (e) {
            console.warn('Resend verification returned non-JSON response', text.substring(0,200));
          }

          if (!response.ok) {
            const msgFromBody = data && data.error ? data.error : (text ? text.replace(/<[^>]+>/g, ' ').trim() : null);
            throw new Error(msgFromBody || 'Failed to send verification email');
          }

          showMessage(data && data.message ? data.message : 'Verification email sent! Check your inbox.', 'success');
          form.reset();

          // Redirect to login after 3 seconds
          setTimeout(() => {
            window.location.href = '/login.html';
          }, 3000);

      } catch (error) {
        console.error('Resend verification error:', error);
        showMessage(error.message || 'An error occurred. Please try again.', 'error');
      } finally {
        setLoading(false);
      }
    });
  </script>

</body>
</html>
