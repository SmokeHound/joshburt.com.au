<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Database Backups - joshburt.com.au</title>
  <link rel="stylesheet" href="/assets/css/styles.css">
  <script src="/assets/js/init-shared.js" defer></script>
  <script src="/assets/js/feature-flags.js" defer></script>
</head>
<body class="bg-gray-900 text-gray-100">
  <div id="main-nav"></div>

  <main class="p-6">
    <div class="max-w-7xl mx-auto">
      <!-- Page Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold mb-2">Database Backups</h1>
        <p class="text-gray-400">Manage database backups and exports</p>
      </div>

      <!-- Statistics Cards -->
      <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
        <div class="ui-card p-6">
          <div class="text-gray-400 text-sm mb-2">Total Backups</div>
          <div id="stat-total" class="text-3xl font-bold">0</div>
        </div>
        <div class="ui-card p-6">
          <div class="text-gray-400 text-sm mb-2">Completed</div>
          <div id="stat-completed" class="text-3xl font-bold text-green-500">0</div>
        </div>
        <div class="ui-card p-6">
          <div class="text-gray-400 text-sm mb-2">Failed</div>
          <div id="stat-failed" class="text-3xl font-bold text-red-500">0</div>
        </div>
        <div class="ui-card p-6">
          <div class="text-gray-400 text-sm mb-2">Running</div>
          <div id="stat-running" class="text-3xl font-bold text-yellow-500">0</div>
        </div>
        <div class="ui-card p-6">
          <div class="text-gray-400 text-sm mb-2">Total Size</div>
          <div id="stat-size" class="text-3xl font-bold">0 MB</div>
        </div>
      </section>

      <!-- Actions -->
      <section class="ui-card p-6 mb-8">
        <div class="flex gap-4">
          <button id="create-backup-btn" class="btn-primary px-6 py-3">
            <span class="mr-2">ðŸ“¦</span> Create Backup
          </button>
          <button id="refresh-btn" class="btn-secondary px-6 py-3">
            <span class="mr-2">ðŸ”„</span> Refresh
          </button>
        </div>
      </section>

      <!-- Filters -->
      <section class="ui-card p-6 mb-8">
        <h2 class="text-lg font-semibold mb-4">Filters</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-2">Status</label>
            <select id="filter-status" class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700">
              <option value="">All</option>
              <option value="pending">Pending</option>
              <option value="running">Running</option>
              <option value="completed">Completed</option>
              <option value="failed">Failed</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2">Type</label>
            <select id="filter-type" class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700">
              <option value="">All Types</option>
              <option value="full">Full</option>
              <option value="incremental">Incremental</option>
              <option value="table">Table</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2">Limit</label>
            <select id="filter-limit" class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700">
              <option value="25">25</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
            </select>
          </div>
          <div class="flex items-end">
            <button id="apply-filters-btn" class="w-full p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
              Apply Filters
            </button>
          </div>
        </div>
      </section>

      <!-- Backups Table -->
      <section class="ui-card p-6">
        <h2 class="text-lg font-semibold mb-4">Backup History</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead>
              <tr class="border-b border-gray-700">
                <th class="pb-3 pr-4">ID</th>
                <th class="pb-3 pr-4">Type</th>
                <th class="pb-3 pr-4">Format</th>
                <th class="pb-3 pr-4">Status</th>
                <th class="pb-3 pr-4">Size</th>
                <th class="pb-3 pr-4">Started</th>
                <th class="pb-3 pr-4">Completed</th>
                <th class="pb-3">Actions</th>
              </tr>
            </thead>
            <tbody id="backups-table">
              <tr>
                <td colspan="8" class="py-8 text-center text-gray-400">Loading backups...</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="mt-4 flex justify-between items-center">
          <div id="pagination-info" class="text-sm text-gray-400"></div>
          <div class="flex gap-2">
            <button id="prev-page" class="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600 disabled:opacity-50" disabled>
              Previous
            </button>
            <button id="next-page" class="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600 disabled:opacity-50" disabled>
              Next
            </button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        if (!window.FeatureFlags || typeof window.FeatureFlags.isEnabled !== 'function') return;
        const enabled = await window.FeatureFlags.isEnabled('enableDatabaseBackups');
        if (enabled) return;

        if (typeof window.showToast === 'function') {
          window.showToast('Database Backups is currently disabled.', 'warning');
        } else {
          alert('Database Backups is currently disabled.');
        }
        window.location.href = 'administration.html';
      } catch (_) {
        // fail open
      }
    });
  </script>

  <!-- Create Backup Modal -->
  <div id="create-backup-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[9998] p-4">
    <div class="ui-card w-full max-w-2xl p-6 relative z-[9999]">
      <h2 class="text-2xl font-bold mb-4">Create New Backup</h2>
      
      <form id="create-backup-form">
        <div class="mb-4">
          <label class="block text-sm font-semibold mb-2">Backup Type</label>
          <select id="backup-type" class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700" required>
            <option value="full">Full Backup (All Tables)</option>
            <option value="table">Table Backup (Specific Tables)</option>
          </select>
        </div>

        <div id="tables-selector" class="mb-4 hidden">
          <label class="block text-sm font-semibold mb-2">Select Tables</label>
          <div class="grid grid-cols-2 gap-2 p-4 bg-gray-800 rounded-lg">
            <label class="flex items-center"><input type="checkbox" name="tables" value="products" class="mr-2"> Products</label>
            <label class="flex items-center"><input type="checkbox" name="tables" value="consumables" class="mr-2"> Consumables</label>
            <label class="flex items-center"><input type="checkbox" name="tables" value="filters" class="mr-2"> Filters</label>
            <label class="flex items-center"><input type="checkbox" name="tables" value="users" class="mr-2"> Users</label>
            <label class="flex items-center"><input type="checkbox" name="tables" value="orders" class="mr-2"> Orders</label>
            <label class="flex items-center"><input type="checkbox" name="tables" value="audit_logs" class="mr-2"> Audit Logs</label>
          </div>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-semibold mb-2">Format</label>
          <select id="backup-format" class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700" required>
            <option value="sql">SQL (PostgreSQL Dump)</option>
            <option value="json">JSON (Structured Data)</option>
            <option value="csv">CSV (Per-Table Files)</option>
          </select>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-semibold mb-2">Compression</label>
          <select id="backup-compression" class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700" required>
            <option value="gzip">Gzip (Recommended)</option>
            <option value="none">None</option>
          </select>
        </div>

        <div class="flex gap-4 mt-6">
          <button type="submit" class="btn-primary flex-1">Create Backup</button>
          <button type="button" id="cancel-create-btn" class="btn-secondary flex-1">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Backup Details Modal -->
  <div id="backup-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[9998] p-4">
    <div class="ui-card w-full max-w-3xl p-6 relative z-[9999]">
      <h2 class="text-2xl font-bold mb-4">Backup Details</h2>
      <div id="backup-details-content" class="space-y-4"></div>
      <div class="flex gap-4 mt-6">
        <button id="close-details-btn" class="btn-secondary flex-1">Close</button>
      </div>
    </div>
  </div>

  <!-- Shared components loaded by init-shared.js -->

  <script>
    const FN_BASE = window.FN_BASE || '/.netlify/functions';
    let currentPage = 0;
    let currentFilters = {};

    function getAuthToken() {
      return (window.getToken && window.getToken()) || localStorage.getItem('accessToken');
    }

    async function apiFetch(url, options = {}) {
      if (typeof window.authFetch === 'function') {
        return await window.authFetch(url, options);
      }

      const token = getAuthToken();
      const headers = { ...(options.headers || {}) };
      if (token) {
        headers.Authorization = `Bearer ${token}`;
      }
      return await fetch(url, { ...options, headers });
    }

    // Load backups
    async function loadBackups() {
      try {
        const token = getAuthToken();
        if (!token && window.AUTH_DISABLED !== true) {
          window.location.href = `/login.html?returnUrl=${encodeURIComponent(window.location.pathname)}`;
          return;
        }

        const params = new URLSearchParams({
          limit: document.getElementById('filter-limit').value || 50,
          offset: currentPage * (document.getElementById('filter-limit').value || 50),
          ...currentFilters
        });

        const response = await apiFetch(`${FN_BASE}/backups?${params}`);

        if (!response.ok) {
          if (response.status === 401) {
            throw new Error('Login required');
          }
          if (response.status === 403) {
            throw new Error('Admin permission required');
          }
          const bodyText = await response.text();
          throw new Error(bodyText || 'Failed to load backups');
        }

        const data = await response.json();
        displayBackups(data.backups);
        updatePagination(data);

        // Load stats
        await loadStats();

      } catch (error) {
        console.error('Error loading backups:', error);
        const message = (error && error.message) ? error.message : 'Failed to load backups';
        showNotification(message, 'error');
        document.getElementById('backups-table').innerHTML =
          `<tr><td colspan="8" class="py-8 text-center text-red-400">${escapeHtml(message)}</td></tr>`;
      }
    }

    function escapeHtml(value) {
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // Display backups in table
    function displayBackups(backups) {
      const tbody = document.getElementById('backups-table');
      
      if (backups.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="py-8 text-center text-gray-400">No backups found</td></tr>';
        return;
      }

      tbody.innerHTML = backups.map(backup => `
        <tr class="border-b border-gray-700 hover:bg-gray-800">
          <td class="py-3 pr-4">#${backup.id}</td>
          <td class="py-3 pr-4">
            <span class="capitalize">${backup.backup_type}</span>
          </td>
          <td class="py-3 pr-4 uppercase">${backup.format}</td>
          <td class="py-3 pr-4">
            <span class="px-2 py-1 rounded text-xs ${getStatusColor(backup.status)}">
              ${backup.status}
            </span>
          </td>
          <td class="py-3 pr-4">${formatSize(backup.file_size)}</td>
          <td class="py-3 pr-4">${formatDate(backup.started_at)}</td>
          <td class="py-3 pr-4">${backup.completed_at ? formatDate(backup.completed_at) : '-'}</td>
          <td class="py-3">
            <button onclick="viewBackup(${backup.id})" class="text-blue-500 hover:underline mr-2">View</button>
            ${backup.status === 'completed' ? `<button onclick="downloadBackup(${backup.id})" class="text-green-500 hover:underline mr-2">Download</button>` : ''}
            <button onclick="deleteBackup(${backup.id})" class="text-red-500 hover:underline">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    // Load statistics
    async function loadStats() {
      try {
        const response = await apiFetch(`${FN_BASE}/backups/stats`);

        if (!response.ok) {
          if (response.status === 401) throw new Error('Login required');
          if (response.status === 403) throw new Error('Admin permission required');
          throw new Error('Failed to load stats');
        }

        const stats = await response.json();
        document.getElementById('stat-total').textContent = stats.total_backups || 0;
        document.getElementById('stat-completed').textContent = stats.completed || 0;
        document.getElementById('stat-failed').textContent = stats.failed || 0;
        document.getElementById('stat-running').textContent = stats.running || 0;
        document.getElementById('stat-size').textContent = formatSize(stats.total_size);

      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Create backup
    async function createBackup(event) {
      event.preventDefault();
      
      try {
        const token = getAuthToken();
        if (!token && window.AUTH_DISABLED !== true) {
          window.location.href = `/login.html?returnUrl=${encodeURIComponent(window.location.pathname)}`;
          return;
        }
        const backupType = document.getElementById('backup-type').value;
        const format = document.getElementById('backup-format').value;
        const compression = document.getElementById('backup-compression').value;

        let tables = [];
        if (backupType === 'table') {
          const checkboxes = document.querySelectorAll('input[name="tables"]:checked');
          tables = Array.from(checkboxes).map(cb => cb.value);
          
          if (tables.length === 0) {
            showNotification('Please select at least one table', 'error');
            return;
          }
        }

        const response = await apiFetch(`${FN_BASE}/backups`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            backup_type: backupType,
            format,
            compression,
            tables: tables.length > 0 ? tables : null
          })
        });

        if (!response.ok) {
          if (response.status === 401) throw new Error('Login required');
          if (response.status === 403) throw new Error('Admin permission required');
          const bodyText = await response.text();
          throw new Error(bodyText || 'Failed to create backup');
        }

        showNotification('Backup created successfully', 'success');
        document.getElementById('create-backup-modal').classList.add('hidden');
        document.getElementById('create-backup-form').reset();
        await loadBackups();

      } catch (error) {
        console.error('Error creating backup:', error);
        showNotification((error && error.message) ? error.message : 'Failed to create backup', 'error');
      }
    }

    // View backup details
    async function viewBackup(id) {
      try {
        const response = await apiFetch(`${FN_BASE}/backups/${id}`);

        if (!response.ok) {
          if (response.status === 401) throw new Error('Login required');
          if (response.status === 403) throw new Error('Admin permission required');
          throw new Error('Failed to load backup details');
        }

        const backup = await response.json();
        const content = document.getElementById('backup-details-content');
        
        content.innerHTML = `
          <div class="grid grid-cols-2 gap-4">
            <div><strong>ID:</strong> ${backup.id}</div>
            <div><strong>Type:</strong> ${backup.backup_type}</div>
            <div><strong>Format:</strong> ${backup.format}</div>
            <div><strong>Compression:</strong> ${backup.compression || 'none'}</div>
            <div><strong>Status:</strong> <span class="px-2 py-1 rounded text-xs ${getStatusColor(backup.status)}">${backup.status}</span></div>
            <div><strong>Size:</strong> ${formatSize(backup.file_size)}</div>
            <div><strong>Started:</strong> ${formatDate(backup.started_at)}</div>
            <div><strong>Completed:</strong> ${backup.completed_at ? formatDate(backup.completed_at) : 'N/A'}</div>
          </div>
          ${backup.tables ? `<div class="mt-4"><strong>Tables:</strong> ${backup.tables.join(', ')}</div>` : ''}
          ${backup.file_path ? `<div class="mt-4"><strong>File Path:</strong> <code class="bg-gray-800 px-2 py-1 rounded">${backup.file_path}</code></div>` : ''}
          ${backup.error_message ? `<div class="mt-4 p-4 bg-red-900/20 border border-red-500 rounded"><strong>Error:</strong> ${backup.error_message}</div>` : ''}
        `;

        document.getElementById('backup-details-modal').classList.remove('hidden');

      } catch (error) {
        console.error('Error viewing backup:', error);
        showNotification((error && error.message) ? error.message : 'Failed to load backup details', 'error');
      }
    }

    async function downloadBackup(id) {
      try {
        const response = await apiFetch(`${FN_BASE}/backups/${id}`);
        if (!response.ok) {
          if (response.status === 401) throw new Error('Login required');
          if (response.status === 403) throw new Error('Admin permission required');
          throw new Error('Failed to load backup details');
        }

        const backup = await response.json();

        if (backup && typeof backup.download_url === 'string' && backup.download_url) {
          window.open(backup.download_url, '_blank', 'noopener');
          return;
        }

        if (backup && typeof backup.file_path === 'string' && /^https?:\/\//i.test(backup.file_path)) {
          window.open(backup.file_path, '_blank', 'noopener');
          return;
        }

        showNotification('Download not available (no public download URL). Use View to see details.', 'error');
        await viewBackup(id);
      } catch (error) {
        console.error('Error downloading backup:', error);
        showNotification((error && error.message) ? error.message : 'Failed to download backup', 'error');
      }
    }

    // Delete backup
    async function deleteBackup(id) {
      if (!confirm('Are you sure you want to delete this backup?')) return;

      try {
        const response = await apiFetch(`${FN_BASE}/backups/${id}`, {
          method: 'DELETE',
          headers: {}
        });

        if (!response.ok) {
          if (response.status === 401) throw new Error('Login required');
          if (response.status === 403) throw new Error('Admin permission required');
          throw new Error('Failed to delete backup');
        }

        showNotification('Backup deleted successfully', 'success');
        await loadBackups();

      } catch (error) {
        console.error('Error deleting backup:', error);
        showNotification((error && error.message) ? error.message : 'Failed to delete backup', 'error');
      }
    }

    // Helper functions
    function getStatusColor(status) {
      const colors = {
        pending: 'bg-gray-600',
        running: 'bg-yellow-600',
        completed: 'bg-green-600',
        failed: 'bg-red-600'
      };
      return colors[status] || 'bg-gray-600';
    }

    function formatSize(bytes) {
      if (!bytes) return '0 B';
      const mb = bytes / (1024 * 1024);
      if (mb < 1) return `${(bytes / 1024).toFixed(2)} KB`;
      if (mb < 1024) return `${mb.toFixed(2)} MB`;
      return `${(mb / 1024).toFixed(2)} GB`;
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      return new Date(dateString).toLocaleString();
    }

    function updatePagination(data) {
      const info = document.getElementById('pagination-info');
      const limit = parseInt(document.getElementById('filter-limit').value);
      const start = currentPage * limit + 1;
      const end = Math.min(start + data.backups.length - 1, data.total);
      
      info.textContent = `Showing ${start}-${end} of ${data.total}`;
      
      document.getElementById('prev-page').disabled = currentPage === 0;
      document.getElementById('next-page').disabled = end >= data.total;
    }

    // Event listeners
    document.getElementById('create-backup-btn').addEventListener('click', () => {
      document.getElementById('create-backup-modal').classList.remove('hidden');
    });

    document.getElementById('cancel-create-btn').addEventListener('click', () => {
      document.getElementById('create-backup-modal').classList.add('hidden');
      document.getElementById('create-backup-form').reset();
    });

    document.getElementById('close-details-btn').addEventListener('click', () => {
      document.getElementById('backup-details-modal').classList.add('hidden');
    });

    document.getElementById('backup-type').addEventListener('change', (e) => {
      const tablesSelector = document.getElementById('tables-selector');
      tablesSelector.classList.toggle('hidden', e.target.value !== 'table');
    });

    document.getElementById('create-backup-form').addEventListener('submit', createBackup);

    document.getElementById('apply-filters-btn').addEventListener('click', () => {
      currentFilters = {
        status: document.getElementById('filter-status').value,
        backup_type: document.getElementById('filter-type').value
      };
      currentPage = 0;
      loadBackups();
    });

    document.getElementById('refresh-btn').addEventListener('click', loadBackups);

    document.getElementById('prev-page').addEventListener('click', () => {
      if (currentPage > 0) {
        currentPage--;
        loadBackups();
      }
    });

    document.getElementById('next-page').addEventListener('click', () => {
      currentPage++;
      loadBackups();
    });

    // Initialize
    loadBackups();

    // Auto-refresh every 30 seconds
    setInterval(loadBackups, 30000);
  </script>
</body>
</html>
