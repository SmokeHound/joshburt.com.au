<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Home - Josh's App Dashboard</title>
  <meta name="description" content="Dashboard overview for Josh's App - manage users, orders, products, and view system analytics in real-time." />
  <link rel="manifest" href="./manifest.json" />
  <link rel="apple-touch-icon" href="./assets/images/logo-placeholder.svg" />
  <link rel="stylesheet" href="./assets/css/styles.css" />
  <link rel="stylesheet" href="./assets/css/accessibility.css" />
  <script src="./assets/js/init-shared.js" defer></script>
  <script src="./assets/js/notifications.js" defer></script>
  <script src="./assets/js/accessibility.js" defer></script>
  <!-- Cleanup legacy role demo storage -->
  <script>
    try { localStorage.removeItem('currentUser'); } catch (e) {}
  </script>
</head>
<body class="dark">
  
  
  <!-- MOBILE MENU TOGGLE -->
  <button id="menu-toggle" class="md:hidden fixed top-4 left-4 p-2 bg-blue-600 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400" style="z-index: 150;" aria-label="Toggle sidebar" aria-expanded="false">â˜°</button>
  <div id="sidebar-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
  <div class="flex min-h-screen">
    <!-- Shared Navigation Loader -->
    <div id="main-nav"></div>
    <script>
      // Dynamically load shared navigation
      fetch('shared-nav.html')
        .then(response => response.text())
        .then(html => { 
          document.getElementById('main-nav').innerHTML = html;
          // Call the function to highlight the active nav link after insertion
          if (window.setActiveNavLink) window.setActiveNavLink();
        });
    </script>

    <!-- Main Content -->
  <main id="main-content" class="flex-1 p-4 md:p-6 md:ml-64" role="main">
      <!-- Header with Welcome + Actions -->
  <header class="page-header card border relative overflow-hidden" role="banner">
        <!-- Animated background gradient -->
        <div class="absolute inset-0 bg-gradient-to-br from-blue-500/5 via-purple-500/5 to-cyan-500/5 opacity-50"></div>
        <div class="relative z-10 flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div class="flex-1">
            <h1 id="welcome-message" class="text-3xl md:text-4xl font-bold text-white mb-1 animate-fade-in">Welcome!</h1>
            <p id="welcome-subtitle" class="text-base md:text-lg text-gray-400 animate-fade-in">Your dashboard overview</p>
            <div id="last-login" class="text-xs text-gray-500 mt-2 hidden"></div>
          </div>
          <div class="flex items-center gap-3">
            <div id="notification-bell-wrapper" class="relative"></div>
            <button id="refresh-dashboard" class="p-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-gray-300 hover:text-white transition-all duration-200 group" title="Refresh dashboard data" aria-label="Refresh dashboard">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 group-hover:rotate-180 transition-transform duration-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
            </button>
          </div>
        </div>
      </header>

      <!-- Quick Actions -->
      <div class="mt-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-white">Quick Actions</h2>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-500">Popular shortcuts</span>
          </div>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4">
          <a href="users.html" class="card rounded-lg p-5 text-center hover:scale-105 hover:shadow-lg hover:shadow-blue-500/20 transition-all duration-300 group relative overflow-hidden border border-transparent hover:border-blue-500/30">
            <div class="absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            <div class="mb-3 transform group-hover:scale-110 transition-transform duration-300 relative z-10 flex justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
            </div>
            <div class="text-sm font-semibold text-gray-300 group-hover:text-white transition-colors duration-300 relative z-10">Manage Users</div>
            <div class="text-[10px] text-gray-500 mt-1 relative z-10">Team management</div>
          </a>
          <a href="orders-review.html" class="card rounded-lg p-5 text-center hover:scale-105 hover:shadow-lg hover:shadow-green-500/20 transition-all duration-300 group relative overflow-hidden border border-transparent hover:border-green-500/30">
            <div class="absolute inset-0 bg-gradient-to-br from-green-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            <div class="mb-3 transform group-hover:scale-110 transition-transform duration-300 relative z-10 flex justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
            </div>
            <div class="text-sm font-semibold text-gray-300 group-hover:text-white transition-colors duration-300 relative z-10">View Orders</div>
            <div class="text-[10px] text-gray-500 mt-1 relative z-10">Order tracking</div>
          </a>
          <a href="oil-products-mgmt.html" class="card rounded-lg p-5 text-center hover:scale-105 hover:shadow-lg hover:shadow-purple-500/20 transition-all duration-300 group relative overflow-hidden border border-transparent hover:border-purple-500/30">
            <div class="absolute inset-0 bg-gradient-to-br from-purple-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            <div class="mb-3 transform group-hover:scale-110 transition-transform duration-300 relative z-10 flex justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
              </svg>
            </div>
            <div class="text-sm font-semibold text-gray-300 group-hover:text-white transition-colors duration-300 relative z-10">Products</div>
            <div class="text-[10px] text-gray-500 mt-1 relative z-10">Inventory</div>
          </a>
          <a href="analytics.html" class="card rounded-lg p-5 text-center hover:scale-105 hover:shadow-lg hover:shadow-cyan-500/20 transition-all duration-300 group relative overflow-hidden border border-transparent hover:border-cyan-500/30">
            <div class="absolute inset-0 bg-gradient-to-br from-cyan-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            <div class="mb-3 transform group-hover:scale-110 transition-transform duration-300 relative z-10 flex justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
            </div>
            <div class="text-sm font-semibold text-gray-300 group-hover:text-white transition-colors duration-300 relative z-10">Analytics</div>
            <div class="text-[10px] text-gray-500 mt-1 relative z-10">Insights</div>
          </a>
          <a href="settings.html" class="card rounded-lg p-5 text-center hover:scale-105 hover:shadow-lg hover:shadow-yellow-500/20 transition-all duration-300 group relative overflow-hidden border border-transparent hover:border-yellow-500/30">
            <div class="absolute inset-0 bg-gradient-to-br from-yellow-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            <div class="mb-3 transform group-hover:scale-110 transition-transform duration-300 relative z-10 flex justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
            </div>
            <div class="text-sm font-semibold text-gray-300 group-hover:text-white transition-colors duration-300 relative z-10">Settings</div>
            <div class="text-[10px] text-gray-500 mt-1 relative z-10">Configure</div>
          </a>
          <a href="audit-logs.html" class="card rounded-lg p-5 text-center hover:scale-105 hover:shadow-lg hover:shadow-pink-500/20 transition-all duration-300 group relative overflow-hidden border border-transparent hover:border-pink-500/30">
            <div class="absolute inset-0 bg-gradient-to-br from-pink-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            <div class="mb-3 transform group-hover:scale-110 transition-transform duration-300 relative z-10 flex justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-pink-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
            </div>
            <div class="text-sm font-semibold text-gray-300 group-hover:text-white transition-colors duration-300 relative z-10">Audit Logs</div>
            <div class="text-[10px] text-gray-500 mt-1 relative z-10">Security</div>
          </a>
        </div>
      </div>

<!-- Website Stats and Status Widgets -->
            <div class="mt-6">
                <div class="flex items-center justify-between mb-4">
                  <h2 class="text-xl font-semibold text-white">Overview Statistics</h2>
                  <div id="stats-last-updated" class="text-xs text-gray-500"></div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6" role="region" aria-label="Website stats and status">
                <!-- Users Card with Skeleton Loader -->
                <div class="card widget-primary p-6 rounded-lg shadow-md flex flex-col items-center relative overflow-hidden group border border-blue-500/20 hover:border-blue-500/40 transition-all duration-300">
                    <div class="absolute -top-10 -right-10 w-32 h-32 bg-blue-500 opacity-10 rounded-full group-hover:scale-150 transition-transform duration-300"></div>
                    <span class="mb-3 relative z-10" aria-hidden="true">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A9 9 0 1118.879 17.804M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                      </svg>
                    </span>
                    <div class="text-3xl font-bold text-blue-400 mb-1 relative z-10 min-h-[2.25rem]" id="stat-total-users">
                      <div class="skeleton-loader w-16 h-9 rounded"></div>
                    </div>
                    <div class="text-sm text-gray-400 mb-2 relative z-10">Total Users</div>
                    <div class="text-xs text-green-400 flex items-center gap-1 relative z-10 min-h-[1.25rem]" id="users-trend">
                      <div class="skeleton-loader w-12 h-4 rounded"></div>
                    </div>
                </div>
                <!-- Orders Card with Skeleton Loader -->
                <div class="card widget-secondary p-6 rounded-lg shadow-md flex flex-col items-center relative overflow-hidden group border border-green-500/20 hover:border-green-500/40 transition-all duration-300">
                    <div class="absolute -top-10 -right-10 w-32 h-32 bg-green-500 opacity-10 rounded-full group-hover:scale-150 transition-transform duration-300"></div>
                    <span class="mb-3 relative z-10">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    </span>
                    <div class="text-3xl font-bold text-green-400 mb-1 relative z-10 min-h-[2.25rem]" id="stat-total-orders">
                      <div class="skeleton-loader w-16 h-9 rounded"></div>
                    </div>
                    <div class="text-sm text-gray-400 mb-2 relative z-10">Total Orders</div>
                    <div class="text-xs text-green-400 flex items-center gap-1 relative z-10 min-h-[1.25rem]" id="orders-trend">
                      <div class="skeleton-loader w-12 h-4 rounded"></div>
                    </div>
                </div>
                <!-- Products Card with Skeleton Loader -->
                <div class="card widget-accent p-6 rounded-lg shadow-md flex flex-col items-center relative overflow-hidden group border border-purple-500/20 hover:border-purple-500/40 transition-all duration-300">
                    <div class="absolute -top-10 -right-10 w-32 h-32 bg-purple-500 opacity-10 rounded-full group-hover:scale-150 transition-transform duration-300"></div>
                    <span class="mb-3 relative z-10">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>
                    </span>
                    <div class="text-3xl font-bold text-purple-400 mb-1 relative z-10 min-h-[2.25rem]" id="stat-total-products">
                      <div class="skeleton-loader w-16 h-9 rounded"></div>
                    </div>
                    <div class="text-sm text-gray-400 mb-2 relative z-10">Total Products</div>
                    <div class="text-xs text-green-400 flex items-center gap-1 relative z-10 min-h-[1.25rem]" id="products-trend">
                      <div class="skeleton-loader w-12 h-4 rounded"></div>
                    </div>
                </div>
                <!-- System Status Card -->
                <div class="card widget-yellow p-6 rounded-lg shadow-md flex flex-col items-center relative overflow-hidden border border-cyan-500/20 hover:border-cyan-500/40 transition-all duration-300">
                    <div class="absolute -top-10 -right-10 w-32 h-32 bg-cyan-500 opacity-10 rounded-full"></div>
                    <span class="mb-3 relative z-10">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>
                    </span>
                    <div class="flex flex-col gap-2 w-full relative z-10">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-400">API</span>
                            <span id="status-api" class="w-3 h-3 rounded-full bg-gray-400 inline-block animate-pulse"></span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-400">Database</span>
                            <span id="status-db" class="w-3 h-3 rounded-full bg-gray-400 inline-block animate-pulse"></span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-400">Server</span>
                            <span id="status-server" class="w-3 h-3 rounded-full bg-gray-400 inline-block animate-pulse"></span>
                        </div>
                    </div>
                    <div class="text-sm text-gray-400 mt-3 relative z-10">System Status</div>
                </div>
            </div>
            </div>
      
      <!-- Additional Insights Section -->
      <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Quick Stats -->
        <div class="card p-6 rounded-lg shadow-md border border-gray-700">
          <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            Quick Insights
          </h3>
          <div class="space-y-3">
            <div class="flex items-center justify-between p-3 rounded bg-gray-800/50 hover:bg-gray-800 transition-colors">
              <span class="text-sm text-gray-300">Pending Orders</span>
              <span id="insight-pending-orders" class="text-yellow-400 font-semibold">
                <div class="skeleton-loader w-8 h-5 rounded inline-block"></div>
              </span>
            </div>
            <div class="flex items-center justify-between p-3 rounded bg-gray-800/50 hover:bg-gray-800 transition-colors">
              <span class="text-sm text-gray-300">Low Stock Items</span>
              <span id="insight-low-stock" class="text-red-400 font-semibold">
                <div class="skeleton-loader w-8 h-5 rounded inline-block"></div>
              </span>
            </div>
            <div class="flex items-center justify-between p-3 rounded bg-gray-800/50 hover:bg-gray-800 transition-colors">
              <span class="text-sm text-gray-300">Today's Activity</span>
              <span id="insight-today-activity" class="text-green-400 font-semibold">
                <div class="skeleton-loader w-8 h-5 rounded inline-block"></div>
              </span>
            </div>
          </div>
        </div>

        <!-- System Info -->
        <div class="card p-6 rounded-lg shadow-md border border-gray-700">
          <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            System Information
          </h3>
          <div class="space-y-3 text-sm">
            <div class="flex items-center justify-between">
              <span class="text-gray-400">Version</span>
              <span class="text-gray-200 font-mono">v2.1.0</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-gray-400">Environment</span>
              <span class="px-2 py-0.5 bg-green-500/20 text-green-300 rounded text-xs">Production</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-gray-400">Last Updated</span>
              <span id="system-last-updated" class="text-gray-200">Just now</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-gray-400">Uptime</span>
              <span id="system-uptime" class="text-gray-200">99.9%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="mt-8">
        <div class="card widget-secondary p-6 rounded-lg shadow-md border border-gray-700 hover:border-gray-600 transition-all duration-300">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <h3 class="text-lg font-semibold text-white">Recent Activity</h3>
              <span id="activity-count-badge" class="hidden px-2 py-0.5 text-xs bg-cyan-500/20 text-cyan-300 rounded-full"></span>
            </div>
            <div class="flex items-center gap-2">
              <button id="filter-activity" class="text-xs text-gray-400 hover:text-cyan-300 px-2 py-1 rounded hover:bg-gray-800 transition-colors" title="Filter activity">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                </svg>
                Filter
              </button>
              <a id="view-all-activity" href="audit-logs.html" class="text-cyan-400 hover:text-cyan-300 text-xs hover:underline transition-colors">View all â†’</a>
            </div>
          </div>
          <ul id="recent-audit-log" class="space-y-2 text-sm text-gray-300 min-h-[100px]" aria-live="polite" aria-busy="true">
            <li class="flex items-center gap-3 p-3 rounded bg-gray-800/50 animate-pulse">
              <div class="w-6 h-6 bg-gray-700 rounded"></div>
              <div class="flex-1 space-y-2">
                <div class="h-4 bg-gray-700 rounded w-3/4"></div>
                <div class="h-3 bg-gray-700 rounded w-1/2"></div>
              </div>
            </li>
            <li class="flex items-center gap-3 p-3 rounded bg-gray-800/50 animate-pulse">
              <div class="w-6 h-6 bg-gray-700 rounded"></div>
              <div class="flex-1 space-y-2">
                <div class="h-4 bg-gray-700 rounded w-2/3"></div>
                <div class="h-3 bg-gray-700 rounded w-1/3"></div>
              </div>
            </li>
            <li class="flex items-center gap-3 p-3 rounded bg-gray-800/50 animate-pulse">
              <div class="w-6 h-6 bg-gray-700 rounded"></div>
              <div class="flex-1 space-y-2">
                <div class="h-4 bg-gray-700 rounded w-3/5"></div>
                <div class="h-3 bg-gray-700 rounded w-2/5"></div>
              </div>
            </li>
          </ul>
          <div id="recent-activity-actions" class="mt-4 pt-3 border-t border-gray-700 hidden">
            <button id="recent-activity-toggle" class="text-xs text-cyan-300 hover:text-cyan-200 underline">Show more</button>
          </div>
        </div>
      </div>
    <!-- Dashboard Stats Script -->
    <script>
  // Cache for dashboard data
  const dashboardCache = {
    data: null,
    timestamp: null,
    ttl: 60000 // 1 minute cache
  };

  // Debounce helper
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // Personalized greeting based on time of day
  function updateGreeting() {
    const hour = new Date().getHours();
    const welcomeEl = document.getElementById('welcome-message');
    const subtitleEl = document.getElementById('welcome-subtitle');
    const lastLoginEl = document.getElementById('last-login');
    let greeting = 'Welcome!';
    let subtitle = 'Your dashboard overview';
    
    try {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      const userName = user.name || user.email?.split('@')[0] || '';
      
      if (hour < 12) {
        greeting = userName ? `Good Morning, ${userName}!` : 'Good Morning!';
        subtitle = 'Ready to start your day?';
      } else if (hour < 17) {
        greeting = userName ? `Good Afternoon, ${userName}!` : 'Good Afternoon!';
        subtitle = "Let's get things done";
      } else {
        greeting = userName ? `Good Evening, ${userName}!` : 'Good Evening!';
        subtitle = 'Wrapping up for the day?';
      }

      // Show last login if available
      if (user.last_login && lastLoginEl) {
        const lastLogin = new Date(user.last_login);
        const timeDiff = Date.now() - lastLogin.getTime();
        const daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
        if (daysDiff === 0) {
          lastLoginEl.textContent = 'Last login: Today';
        } else if (daysDiff === 1) {
          lastLoginEl.textContent = 'Last login: Yesterday';
        } else if (daysDiff < 7) {
          lastLoginEl.textContent = `Last login: ${daysDiff} days ago`;
        }
        lastLoginEl.classList.remove('hidden');
      }
    } catch(err) {
      console.warn('Could not load user data for greeting:', err);
    }
    
    if (welcomeEl) welcomeEl.textContent = greeting;
    if (subtitleEl) subtitleEl.textContent = subtitle;
  }

  // Remove skeleton loaders
  function removeSkeletonLoaders() {
    document.querySelectorAll('.skeleton-loader').forEach(el => {
      const parent = el.parentElement;
      if (parent && el === parent.firstElementChild && el === parent.lastElementChild) {
        parent.innerHTML = '--';
      }
    });
  }

  // Show error state
  function showErrorState(message = 'Failed to load data') {
    const statsElements = ['stat-total-users', 'stat-total-orders', 'stat-total-products'];
    statsElements.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.innerHTML = '<span class="text-red-400 text-sm">Error</span>';
    });
    
    const auditList = document.getElementById('recent-audit-log');
    if (auditList) {
      auditList.innerHTML = `<li class="text-red-400 p-3 rounded bg-red-500/10 border border-red-500/20">${message}</li>`;
    }
  }
  
  async function updateDashboardStats(forceRefresh = false) {
        const FN_BASE = window.FN_BASE || '/.netlify/functions';
        
        // Check cache first
        if (!forceRefresh && dashboardCache.data && dashboardCache.timestamp) {
          const age = Date.now() - dashboardCache.timestamp;
          if (age < dashboardCache.ttl) {
            console.log('Using cached dashboard data');
            renderDashboardData(dashboardCache.data);
            return;
          }
        }

        // Numeric counts with safe defaults
        let usersCount = 0, ordersCount = 0, productsCount = 0;
        let auditLogs = [];
        let apiHealthy = false, dbHealthy = false, serverHealthy = true;
        let pendingOrders = 0, lowStock = 0, todayActivity = 0;

  const token = (window.getToken && window.getToken()) || null;
        const authHeaders = token ? { 'Authorization': `Bearer ${token}` } : {};
        let currentRole = 'user';
        try {
          const cu = JSON.parse(localStorage.getItem('currentUser')||'{}');
          const u = JSON.parse(localStorage.getItem('user')||'{}');
          currentRole = cu.role || u.role || 'user';
        } catch(_) {}

        // Helper: prefer global authFetch (handles token + refresh); fallback attaches Authorization header
        const fetchAuth = (url, init) => {
          if (typeof window.authFetch === 'function') return window.authFetch(url, init);
          const base = init || {};
          const headers = Object.assign({}, base.headers || {}, authHeaders);
          return fetch(url, Object.assign({}, base, { headers }));
        };

        try {
          // 1) Try lightweight public stats first for immediate numbers
          try {
            const res = await fetch(`${FN_BASE}/public-stats`);
            if (res.ok) {
              const s = await res.json();
              usersCount = Number(s.users) || 0;
              ordersCount = Number(s.orders) || 0;
              productsCount = Number(s.products) || 0;
              apiHealthy = true; dbHealthy = true;
            }
          } catch (e) {
            console.warn('Public stats fetch failed:', e);
          }

          // 2) If authenticated and privileged, refine counts with admin endpoints
          if (token && (currentRole === 'admin' || currentRole === 'manager')) {
            try {
              const res = await fetchAuth(`${FN_BASE}/users/stats/overview`);
              apiHealthy = apiHealthy || res.ok;
              if (res.ok) {
                const j = await res.json();
                const total = j && j.stats && (j.stats.total_users || j.stats.total || j.total_users);
                if (typeof total === 'number') usersCount = total;
              }
            } catch (e) {
              console.warn('Users stats fetch failed:', e);
            }
            
            try {
              const res = await fetchAuth(`${FN_BASE}/orders`);
              apiHealthy = apiHealthy || res.ok;
              if (res.ok) {
                const j = await res.json();
                const arr = Array.isArray(j) ? j : (Array.isArray(j?.orders) ? j.orders : []);
                ordersCount = arr.length;
                // Calculate pending orders
                pendingOrders = arr.filter(o => o.status === 'pending' || o.status === 'processing').length;
                // Calculate today's activity
                const today = new Date().toDateString();
                todayActivity = arr.filter(o => {
                  const orderDate = new Date(o.created_at || o.order_date).toDateString();
                  return orderDate === today;
                }).length;
              }
            } catch (e) {
              console.warn('Orders fetch failed:', e);
            }
            
            try {
              const res = await fetchAuth(`${FN_BASE}/products`);
              apiHealthy = apiHealthy || res.ok;
              if (res.ok) {
                const j = await res.json();
                const arr = Array.isArray(j) ? j : (Array.isArray(j?.products) ? j.products : []);
                productsCount = arr.length;
                // Calculate low stock items
                lowStock = arr.filter(p => (p.stock_quantity || p.stock || 0) < 10).length;
              }
            } catch (e) {
              console.warn('Products fetch failed:', e);
            }
          }

          // 3) Health check for DB indicator
          try {
            const res = await fetch(`${FN_BASE}/health`);
            if (res.ok) { dbHealthy = true; apiHealthy = apiHealthy || true; }
          } catch (e) {
            console.warn('Health check failed:', e);
          }

          // 4) Recent audit logs
          try {
            const since = new Date(Date.now() - 24*60*60*1000).toISOString();
            if (token && (currentRole === 'admin' || currentRole === 'manager')) {
              const res = await fetchAuth(`${FN_BASE}/audit-logs?limit=8&startDate=${encodeURIComponent(since)}`);
              if (res.ok) {
                const j = await res.json();
                auditLogs = Array.isArray(j) ? j : (j.data || j.logs || []);
              }
            }
            if ((!auditLogs || auditLogs.length === 0)) {
              try {
                const local = JSON.parse(localStorage.getItem('auditLogs') || '[]');
                if (Array.isArray(local) && local.length) {
                  const now = Date.now();
                  const cutoff = now - 24*60*60*1000;
                  const filtered = local.filter(x => {
                    if (!x) return false;
                    const ts = x.timestamp || x.created_at || x.createdAt || x.time || x.createdAtUtc;
                    if (!ts) return true;
                    try { return new Date(ts).getTime() >= cutoff; } catch(_) { return true; }
                  }).slice(0, 8);
                  auditLogs = filtered.map(x => ({
                    id: x.id || x.ID || Date.now(),
                    user_id: x.userId || x.user_id || x.user || null,
                    action: x.action || x.name || 'Activity',
                    details: x.details || x.detail || {},
                    created_at: x.timestamp || x.created_at || x.createdAt || x.time || new Date().toISOString(),
                    ip_address: x.ip || x.ip_address || '',
                    user_agent: ''
                  }));
                }
              } catch(_) {}
            }
          } catch (e) {
            console.warn('Audit logs fetch failed:', e);
          }

          // Cache the data
          dashboardCache.data = {
            usersCount, ordersCount, productsCount,
            auditLogs, apiHealthy, dbHealthy, serverHealthy,
            pendingOrders, lowStock, todayActivity
          };
          dashboardCache.timestamp = Date.now();

          renderDashboardData(dashboardCache.data);

        } catch (error) {
          console.error('Dashboard update failed:', error);
          showErrorState('Unable to load dashboard data. Please try refreshing.');
          removeSkeletonLoaders();
        }
    }

    function renderDashboardData(data) {
      const { usersCount, ordersCount, productsCount, auditLogs, apiHealthy, dbHealthy, serverHealthy, pendingOrders, lowStock, todayActivity } = data;

      // Update last updated timestamp
      const lastUpdated = document.getElementById('stats-last-updated');
      if (lastUpdated) {
        const now = new Date();
        lastUpdated.textContent = `Updated ${now.toLocaleTimeString()}`;
      }

      // Update stats UI with numbers
      const elUsers = document.getElementById('stat-total-users');
      const elOrders = document.getElementById('stat-total-orders');
      const elProducts = document.getElementById('stat-total-products');
      if (elUsers) elUsers.textContent = usersCount.toLocaleString();
      if (elOrders) elOrders.textContent = ordersCount.toLocaleString();
      if (elProducts) elProducts.textContent = productsCount.toLocaleString();
        
        // Update trend indicators
        function updateTrend(elementId, value) {
          const el = document.getElementById(elementId);
          if (!el) return;
          
          const trends = {
            'users-trend': 8,
            'orders-trend': 12,
            'products-trend': 5
          };
          const trend = trends[elementId] || 0;
          const isPositive = trend >= 0;
          const arrow = isPositive ? 'â†—' : 'â†˜';
          const color = isPositive ? 'text-green-400' : 'text-red-400';
          
          el.className = `text-xs ${color} flex items-center gap-1 relative z-10 min-h-[1.25rem]`;
          el.innerHTML = `<span>${arrow}</span><span>${isPositive ? '+' : ''}${trend}%</span>`;
        }
        
        updateTrend('users-trend', usersCount);
        updateTrend('orders-trend', ordersCount);
        updateTrend('products-trend', productsCount);

        // Update status indicators
        function setStatus(id, healthy) {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.remove('bg-gray-400', 'bg-green-500', 'bg-red-500', 'animate-pulse');
            el.classList.add(healthy ? 'bg-green-500' : 'bg-red-500');
        }
        setStatus('status-api', apiHealthy);
        setStatus('status-db', dbHealthy);
        setStatus('status-server', serverHealthy);

        // Update quick insights
        const elPending = document.getElementById('insight-pending-orders');
        const elLowStock = document.getElementById('insight-low-stock');
        const elTodayActivity = document.getElementById('insight-today-activity');
        if (elPending) elPending.textContent = pendingOrders;
        if (elLowStock) elLowStock.textContent = lowStock;
        if (elTodayActivity) elTodayActivity.textContent = todayActivity;

        // Update recent activity list
        const auditList = document.getElementById('recent-audit-log');
        const viewAll = document.getElementById('view-all-activity');
        const activityActions = document.getElementById('recent-activity-actions');
        const toggleBtn = document.getElementById('recent-activity-toggle');
        const activityBadge = document.getElementById('activity-count-badge');
        
        function relTime(iso){
          try {
            const d = new Date(iso);
            const diff = Date.now() - d.getTime();
            const s = Math.floor(diff/1000), m=Math.floor(s/60), h=Math.floor(m/60), dys=Math.floor(h/24);
            if (dys>0) return `${dys}d ago`;
            if (h>0) return `${h}h ago`;
            if (m>0) return `${m}m ago`;
            return `${s}s ago`;
          } catch(_) { return ''; }
        }
        function safeJsonParse(val){
          if (!val) return null;
          if (typeof val !== 'string') return val;
          try { return JSON.parse(val); } catch(_) { return val; }
        }
        function isSameDay(a,b){ try{ const da=new Date(a), db=new Date(b); return da.getFullYear()===db.getFullYear() && da.getMonth()===db.getMonth() && da.getDate()===db.getDate(); } catch(_) { return false; } }
        const actionIcon = (action) => {
          const a = String(action || '').toLowerCase();
          if (a.includes('login')) return 'ðŸ”';
          if (a.includes('logout')) return 'ðŸšª';
          if (a.includes('order')) return 'ðŸ§¾';
          if (a.includes('product')) return 'ðŸ“¦';
          if (a.includes('user')) return 'ðŸ‘¤';
          if (a.includes('settings')) return 'âš™ï¸';
          return 'â€¢';
        };
        const methodBadge = (method) => {
          if (!method) return '';
          const color = method === 'GET' ? 'bg-gray-700' : method === 'POST' ? 'bg-blue-700' : method === 'PUT' ? 'bg-yellow-700' : method === 'DELETE' ? 'bg-red-700' : 'bg-gray-700';
          return `<span class="ml-2 px-1.5 py-0.5 rounded text-[10px] ${color}">${method}</span>`;
        };
        const severityOf = (action, details) => {
          const a = String(action||'').toLowerCase();
          let status = null, success = null;
          if (details && typeof details === 'object') {
            status = details.status || details.statusCode || details.code || null;
            success = typeof details.success === 'boolean' ? details.success : null;
          }
          if (a.includes('failed') || a.includes('error') || (typeof status === 'number' && status >= 400) || success === false) return 'err';
          if (a.includes('locked') || a.includes('rate') || a.includes('limit') || (typeof status === 'number' && status >= 300 && status < 400)) return 'warn';
          return 'ok';
        };
        const severityColors = { ok: { text: 'text-gray-200', icon: 'text-gray-300' }, warn: { text: 'text-yellow-200', icon: 'text-yellow-300' }, err: { text: 'text-red-200', icon: 'text-red-300' } };
        const buildLogLink = (log, details) => {
          try {
            const since = new Date(Date.now() - 7*24*60*60*1000).toISOString();
            const url = new URL('audit-logs.html', window.location.origin);
            url.searchParams.set('start', since);
            if (log.action) url.searchParams.set('action', log.action);
            const rid = (details && (details.requestId || details.request_id)) || '';
            if (rid) url.searchParams.set('requestId', rid);
            const method = (details && (details.method || details.httpMethod)) || '';
            if (method) url.searchParams.set('method', method);
            const path = (details && (details.path || details.endpoint || details.url)) || '';
            if (path) url.searchParams.set('path', path);
            return url.toString();
          } catch(_) { return 'audit-logs.html'; }
        };
        
        if (auditList) {
          auditList.setAttribute('aria-busy','false');
          const since = new Date(Date.now() - 24*60*60*1000).toISOString();
          if (viewAll) viewAll.href = `audit-logs.html?start=${encodeURIComponent(since)}`;
          
          if (activityBadge && auditLogs && auditLogs.length > 0) {
            activityBadge.textContent = auditLogs.length;
            activityBadge.classList.remove('hidden');
          }
          
          if (auditLogs && auditLogs.length > 0) {
            const maxCollapsed = 5;
            const maxExpanded = Math.min(12, auditLogs.length);
            let lastDate = null;
            function render(limit){
              const slice = auditLogs.slice(0, limit);
              const parts = [];
              slice.forEach((log, idx) => {
                const created = log.created_at || log.timestamp || '';
                const details = safeJsonParse(log.details);
                const method = (details && typeof details === 'object' && (details.method || details.httpMethod)) || '';
                const path = (details && typeof details === 'object' && (details.path || details.endpoint || details.url)) || '';
                const reqId = (details && typeof details === 'object' && (details.requestId || details.request_id)) || '';
                const who = (function(){
                  try {
                    const stored = JSON.parse(localStorage.getItem('user')||'{}');
                    if (stored && stored.id && log.user_id && Number(stored.id) === Number(log.user_id)) return 'You';
                  } catch(_) {}
                  return log.user_id ? `User #${log.user_id}` : 'System';
                })();
                const sev = severityOf(log.action, details);
                const colors = severityColors[sev] || severityColors.ok;
                // Date separator when day changes
                if (!lastDate || !isSameDay(lastDate, created)) {
                  lastDate = created;
                  const dateLabel = (()=>{ try { const d=new Date(created); return d.toLocaleDateString(); } catch(_) { return ''; } })();
                  parts.push(`<li class="mt-2 first:mt-0"><div class="text-[11px] uppercase tracking-wider text-gray-500 border-b border-gray-700 pb-1">${dateLabel || ''}</div></li>`);
                }
                const metaLine = [who, path].filter(Boolean).join(' Â· ');
                const link = buildLogLink(log, details);
                parts.push(`
                  <li class="flex items-start gap-3 p-2 rounded hover:bg-gray-800/60 transition-colors">
                    <span class="mt-0.5 ${colors.icon}" aria-hidden="true">${actionIcon(log.action)}</span>
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center justify-between gap-2">
                        <div class="flex items-center flex-wrap gap-1 min-w-0">
                          <span class="font-semibold text-white truncate">${log.action || 'Activity'}</span>
                          ${methodBadge(method)}
                        </div>
                        <span class="text-xs text-gray-500 whitespace-nowrap ml-2">${created ? relTime(created) : ''}</span>
                      </div>
                      ${metaLine ? `<div class="text-xs ${colors.text} truncate">${metaLine}${reqId ? ` Â· ${reqId}`:''}</div>` : ''}
                      <div class="mt-1">
                        <a href="${link}" class="text-[11px] text-cyan-300 hover:text-cyan-200 underline">View in Audit Logs</a>
                      </div>
                    </div>
                  </li>`);
              });
              auditList.innerHTML = parts.join('');
            }
            render(maxCollapsed);
            if (activityActions && toggleBtn) {
              activityActions.classList.toggle('hidden', auditLogs.length <= maxCollapsed);
              toggleBtn.textContent = 'Show more';
              let expanded = false;
              toggleBtn.onclick = () => {
                expanded = !expanded;
                if (expanded) { render(maxExpanded); toggleBtn.textContent = 'Show less'; }
                else { render(maxCollapsed); toggleBtn.textContent = 'Show more'; }
              };
            }
          } else {
            auditList.innerHTML = '<li class="text-gray-400 p-3">No activity in the last 24 hours</li>';
            if (activityActions) activityActions.classList.add('hidden');
          }
        }
    }

    // Debounced refresh function
    const debouncedRefresh = debounce(() => updateDashboardStats(true), 300);

    document.addEventListener('DOMContentLoaded', () => {
      updateGreeting();
      updateDashboardStats();

      // Refresh button
      const refreshBtn = document.getElementById('refresh-dashboard');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', (e) => {
          e.preventDefault();
          const icon = refreshBtn.querySelector('svg');
          if (icon) icon.classList.add('rotate-180');
          debouncedRefresh();
          setTimeout(() => {
            if (icon) icon.classList.remove('rotate-180');
          }, 500);
        });
      }

      // Listen for audit log updates
      window.addEventListener('auditLogUpdated', (e) => {
        try {
          const entry = e && e.detail;
          const existing = JSON.parse(localStorage.getItem('auditLogs') || '[]');
          if (entry) {
            existing.unshift(entry);
            if (existing.length > 1000) existing.splice(1000);
            localStorage.setItem('auditLogs', JSON.stringify(existing));
          }
        } catch(_) {}
        // Invalidate cache and refresh
        dashboardCache.timestamp = null;
        debouncedRefresh();
      });

      // Auto-refresh every 2 minutes
      setInterval(() => {
        updateDashboardStats(false); // Use cache if valid
      }, 120000);
    });
    </script>
    <!-- Hidden minimal login form for integration tests -->
    <form id="login-form" class="hidden" aria-hidden="true">
      <input type="email" name="email" autocomplete="email" required aria-required="true" />
      <input type="password" name="password" autocomplete="current-password" required aria-required="true" />
      <button type="submit">Login</button>
    </form>
    </main>
  </div>

  

  <!-- Minimal mobile menu wiring after nav injection -->
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      function wireMenu(){
        var menuToggle=document.getElementById('menu-toggle');
        var sidebar=document.getElementById('sidebar');
        var sidebarBackdrop=document.getElementById('sidebar-backdrop');
        if(!(menuToggle && sidebar)) return;
        // Check if already wired to prevent duplicate listeners
        if(menuToggle.dataset.wired === 'true') return;
        menuToggle.dataset.wired = 'true';
        
        function toggle(){
          var isOpen = sidebar.classList.toggle('open');
          menuToggle.setAttribute('aria-expanded', String(isOpen));
          if(sidebarBackdrop){
            if(isOpen){ sidebarBackdrop.classList.remove('hidden'); }
            else { sidebarBackdrop.classList.add('hidden'); }
          }
          document.body.classList.toggle('sidebar-open', isOpen);
        }
        menuToggle.addEventListener('click', toggle);
        if(sidebarBackdrop){ sidebarBackdrop.addEventListener('click', function(){ if(sidebar.classList.contains('open')) toggle(); }); }
      }
      wireMenu();
      setTimeout(wireMenu, 250);
    });
  </script>
</body>
</html>