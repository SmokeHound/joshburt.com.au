<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Home - Josh's App Dashboard</title>
  <meta name="description" content="Dashboard overview for Josh's App - manage users, orders, products, and view system analytics in real-time." />
  <link rel="manifest" href="./manifest.json" />
  <link rel="apple-touch-icon" href="./assets/images/logo-placeholder.svg" />
  <link rel="stylesheet" href="./assets/css/styles.css" />
  <script src="./assets/js/init-shared.js" defer></script>
  <script src="./assets/js/notifications.js" defer></script>
  <!-- Cleanup legacy role demo storage -->
  <script>
    try { localStorage.removeItem('currentUser'); } catch (e) {}
  </script>
</head>
<body class="dark">
  <!-- MOBILE MENU TOGGLE -->
  <button id="menu-toggle" class="md:hidden fixed top-4 left-4 z-50 p-2 bg-primary text-white rounded-md focus:outline-none focus:ring-2 focus:ring-secondary" aria-label="Toggle sidebar" aria-expanded="false">‚ò∞</button>
  <div id="sidebar-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
  <div class="flex min-h-screen">
    <!-- Shared Navigation Loader -->
    <div id="main-nav"></div>
    <script>
      // Dynamically load shared navigation
      fetch('shared-nav.html')
        .then(response => response.text())
        .then(html => { 
          document.getElementById('main-nav').innerHTML = html;
          // Call the function to highlight the active nav link after insertion
          if (window.setActiveNavLink) window.setActiveNavLink();
        });
    </script>

    <!-- Main Content -->
  <main class="flex-1 p-4 md:p-6 md:ml-64">
      <!-- Header with Welcome + Actions -->
  <header class="page-header card border">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div>
            <h1 id="welcome-message" class="text-3xl md:text-4xl font-bold text-white">Welcome!</h1>
            <p id="welcome-subtitle" class="text-base md:text-lg mt-2 text-gray-400">Your dashboard overview</p>
          </div>
          <div class="flex items-center gap-3">
            <div id="notification-bell-wrapper" class="relative"></div>
          </div>
        </div>
      </header>

      <!-- Quick Actions -->
      <div class="mt-6">
        <h2 class="text-xl font-semibold text-white mb-4">Quick Actions</h2>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
          <a href="users.html" class="card p-4 text-center hover:scale-105 transition-transform">
            <div class="text-3xl mb-2">üë•</div>
            <div class="text-sm font-medium text-gray-300">Manage Users</div>
          </a>
          <a href="orders-review.html" class="card p-4 text-center hover:scale-105 transition-transform">
            <div class="text-3xl mb-2">üìã</div>
            <div class="text-sm font-medium text-gray-300">View Orders</div>
          </a>
          <a href="oil-products-mgmt.html" class="card p-4 text-center hover:scale-105 transition-transform">
            <div class="text-3xl mb-2">üõ¢Ô∏è</div>
            <div class="text-sm font-medium text-gray-300">Products</div>
          </a>
          <a href="analytics.html" class="card p-4 text-center hover:scale-105 transition-transform">
            <div class="text-3xl mb-2">üìä</div>
            <div class="text-sm font-medium text-gray-300">Analytics</div>
          </a>
          <a href="settings.html" class="card p-4 text-center hover:scale-105 transition-transform">
            <div class="text-3xl mb-2">‚öôÔ∏è</div>
            <div class="text-sm font-medium text-gray-300">Settings</div>
          </a>
          <a href="audit-logs.html" class="card p-4 text-center hover:scale-105 transition-transform">
            <div class="text-3xl mb-2">üìù</div>
            <div class="text-sm font-medium text-gray-300">Audit Logs</div>
          </a>
        </div>
      </div>

<!-- Website Stats and Status Widgets -->
            <div class="mt-6">
                <h2 class="text-xl font-semibold text-white mb-4">Overview Statistics</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6" role="region" aria-label="Website stats and status">
                <div class="card widget-primary p-6 rounded-lg shadow-md flex flex-col items-center relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-20 h-20 bg-blue-500 opacity-10 rounded-full -mr-10 -mt-10 group-hover:scale-150 transition-transform duration-300"></div>
                    <span class="mb-3" aria-hidden="true">
                      <!-- Users Icon (simplified for reliability) -->
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A9 9 0 1118.879 17.804M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                      </svg>
                    </span>
                    <div class="text-3xl font-bold text-blue-400 mb-1" id="stat-total-users">--</div>
                    <div class="text-sm text-gray-400 mb-2">Total Users</div>
                    <div class="text-xs text-green-400 flex items-center gap-1" id="users-trend">
                      <span>‚Üó</span>
                      <span>+0%</span>
                    </div>
                </div>
                <div class="card widget-secondary p-6 rounded-lg shadow-md flex flex-col items-center relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-20 h-20 bg-green-500 opacity-10 rounded-full -mr-10 -mt-10 group-hover:scale-150 transition-transform duration-300"></div>
                    <span class="mb-3">
                      <!-- Orders Icon -->
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    </span>
                    <div class="text-3xl font-bold text-green-400 mb-1" id="stat-total-orders">--</div>
                    <div class="text-sm text-gray-400 mb-2">Total Orders</div>
                    <div class="text-xs text-green-400 flex items-center gap-1" id="orders-trend">
                      <span>‚Üó</span>
                      <span>+0%</span>
                    </div>
                </div>
                <div class="card widget-accent p-6 rounded-lg shadow-md flex flex-col items-center relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-20 h-20 bg-purple-500 opacity-10 rounded-full -mr-10 -mt-10 group-hover:scale-150 transition-transform duration-300"></div>
                    <span class="mb-3">
                      <!-- Products Icon -->
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>
                    </span>
                    <div class="text-3xl font-bold text-purple-400 mb-1" id="stat-total-products">--</div>
                    <div class="text-sm text-gray-400 mb-2">Total Products</div>
                    <div class="text-xs text-green-400 flex items-center gap-1" id="products-trend">
                      <span>‚Üó</span>
                      <span>+0%</span>
                    </div>
                </div>
                <div class="card widget-yellow p-6 rounded-lg shadow-md flex flex-col items-center relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-20 h-20 bg-cyan-400 opacity-10 rounded-full -mr-10 -mt-10"></div>
                    <span class="mb-3">
                      <!-- System Status Icon -->
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>
                    </span>
                    <div class="flex flex-col gap-2 w-full">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-400">API</span>
                            <span id="status-api" class="w-3 h-3 rounded-full bg-gray-400 inline-block animate-pulse"></span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-400">Database</span>
                            <span id="status-db" class="w-3 h-3 rounded-full bg-gray-400 inline-block animate-pulse"></span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-400">Server</span>
                            <span id="status-server" class="w-3 h-3 rounded-full bg-gray-400 inline-block animate-pulse"></span>
                        </div>
                    </div>
                    <div class="text-sm text-gray-400 mt-3">System Status</div>
                </div>
            </div>
            </div>
      <!-- Recent Activity -->
      <div class="mt-8">
        <div class="card widget-secondary p-6 rounded-lg shadow-md">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold text-white">Recent Activity</h3>
            <a id="view-all-activity" href="audit-logs.html" class="text-cyan-400 hover:underline text-sm">View all</a>
          </div>
          <ul id="recent-audit-log" class="space-y-2 text-sm text-gray-300" aria-live="polite" aria-busy="true">
            <li class="text-gray-400">Loading recent activity‚Ä¶</li>
          </ul>
          <div id="recent-activity-actions" class="mt-3 hidden">
            <button id="recent-activity-toggle" class="text-xs text-cyan-300 hover:text-cyan-200 underline">Show more</button>
          </div>
        </div>
      </div>
    <!-- Dashboard Stats Script -->
    <script>
  // Personalized greeting based on time of day
  function updateGreeting() {
    const hour = new Date().getHours();
    const welcomeEl = document.getElementById('welcome-message');
    const subtitleEl = document.getElementById('welcome-subtitle');
    let greeting = 'Welcome!';
    let subtitle = 'Your dashboard overview';
    
    try {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      const userName = user.name || user.email?.split('@')[0] || '';
      
      if (hour < 12) {
        greeting = userName ? `Good Morning, ${userName}!` : 'Good Morning!';
        subtitle = 'Ready to start your day?';
      } else if (hour < 17) {
        greeting = userName ? `Good Afternoon, ${userName}!` : 'Good Afternoon!';
        subtitle = "Let's get things done";
      } else {
        greeting = userName ? `Good Evening, ${userName}!` : 'Good Evening!';
        subtitle = 'Wrapping up for the day?';
      }
    } catch(err) {
      console.warn('Could not load user data for greeting:', err);
    }
    
    if (welcomeEl) welcomeEl.textContent = greeting;
    if (subtitleEl) subtitleEl.textContent = subtitle;
  }
  
  async function updateDashboardStats() {
        const FN_BASE = window.FN_BASE || '/.netlify/functions';
        // Numeric counts with safe defaults
        let usersCount = 0, ordersCount = 0, productsCount = 0;
        let auditLogs = [];
        let apiHealthy = false, dbHealthy = false, serverHealthy = true;

  const token = (window.getToken && window.getToken()) || null;
        const authHeaders = token ? { 'Authorization': `Bearer ${token}` } : {};
        let currentRole = 'user';
        try {
          const cu = JSON.parse(localStorage.getItem('currentUser')||'{}');
          const u = JSON.parse(localStorage.getItem('user')||'{}');
          currentRole = cu.role || u.role || 'user';
        } catch(_) {}

        // Helper: prefer global authFetch (handles token + refresh); fallback attaches Authorization header
        const fetchAuth = (url, init) => {
          if (typeof window.authFetch === 'function') return window.authFetch(url, init);
          const base = init || {};
          const headers = Object.assign({}, base.headers || {}, authHeaders);
          return fetch(url, Object.assign({}, base, { headers }));
        };

        // 1) Try lightweight public stats first for immediate numbers
        try {
          const res = await fetch(`${FN_BASE}/public-stats`);
          if (res.ok) {
            const s = await res.json();
            usersCount = Number(s.users) || 0;
            ordersCount = Number(s.orders) || 0;
            productsCount = Number(s.products) || 0;
            apiHealthy = true; dbHealthy = true;
          }
        } catch (_) {}

        // Small helper: proactively refresh token to avoid noisy 401s on public homepage
        async function ensureFreshToken(tok){
          try {
            const rt = (window.getRefreshToken && window.getRefreshToken()) || null;
            if (!rt) return tok;
            // If we don't yet have a user cached, or token exists but might be expired, do a lightweight refresh once
            const refRes = await fetch(`${FN_BASE}/auth?action=refresh`, {
              method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify({ refreshToken: rt })
            });
            if (refRes.ok) {
              const data = await refRes.json();
              if (data && (data.accessToken || data.refreshToken)) {
                try {
                  if (data.accessToken) localStorage.setItem('accessToken', data.accessToken);
                  if (data.refreshToken) localStorage.setItem('refreshToken', data.refreshToken);
                } catch(_) { /* noop */ }
                return data.accessToken || tok;
              }
            }
            return tok;
          } catch(_) { return tok; }
        }

        // 2) If authenticated and privileged, refine counts with admin endpoints (after trying a silent refresh)
        if (token && (currentRole === 'admin' || currentRole === 'manager')) {
          try {
            const res = await fetchAuth(`${FN_BASE}/users/stats/overview`);
            apiHealthy = apiHealthy || res.ok;
            if (res.ok) {
              const j = await res.json();
              // shape: { stats: { total_users, ... } }
              const total = j && j.stats && (j.stats.total_users || j.stats.total || j.total_users);
              if (typeof total === 'number') usersCount = total;
            }
          } catch (_) {}
          try {
            const res = await fetchAuth(`${FN_BASE}/orders`);
            apiHealthy = apiHealthy || res.ok;
            if (res.ok) {
              const j = await res.json();
              const arr = Array.isArray(j) ? j : (Array.isArray(j?.orders) ? j.orders : []);
              ordersCount = arr.length;
            }
          } catch (_) {}
          try {
            const res = await fetchAuth(`${FN_BASE}/products`);
            apiHealthy = apiHealthy || res.ok;
            if (res.ok) {
              const j = await res.json();
              const arr = Array.isArray(j) ? j : (Array.isArray(j?.products) ? j.products : []);
              productsCount = arr.length;
            }
          } catch (_) {}
        }

        // 3) Health check for DB indicator (optional)
        try {
          const res = await fetch(`${FN_BASE}/health`);
          if (res.ok) { dbHealthy = true; apiHealthy = apiHealthy || true; }
        } catch (_) {}

        // 4) Recent audit logs (best-effort, last 24h, limit 8) with fallback to localStorage
        try {
          const since = new Date(Date.now() - 24*60*60*1000).toISOString();
          if (token && (currentRole === 'admin' || currentRole === 'manager')) {
            const res = await fetchAuth(`${FN_BASE}/audit-logs?limit=8&startDate=${encodeURIComponent(since)}`);
            if (res.ok) {
              const j = await res.json();
              auditLogs = Array.isArray(j) ? j : (j.data || j.logs || []);
            }
          }
          if ((!auditLogs || auditLogs.length === 0)) {
            // Fallback to local in-browser audit log cache (if present)
            try {
              const local = JSON.parse(localStorage.getItem('auditLogs') || '[]');
              if (Array.isArray(local) && local.length) {
                // Normalize to expected fields
                auditLogs = local
                  .filter(x => x && x.timestamp && new Date(x.timestamp) >= new Date(Date.now() - 24*60*60*1000))
                  .slice(0, 8)
                  .map(x => ({
                    id: x.id,
                    user_id: x.userId || x.user_id || null,
                    action: x.action,
                    details: x.details,
                    created_at: x.timestamp,
                    ip_address: x.ip || '',
                    user_agent: ''
                  }));
              }
            } catch(_) {}
          }
        } catch (_) {}

        // Update stats UI with numbers (fallback to 0s)
        const elUsers = document.getElementById('stat-total-users');
        const elOrders = document.getElementById('stat-total-orders');
        const elProducts = document.getElementById('stat-total-products');
        if (elUsers) elUsers.textContent = usersCount;
        if (elOrders) elOrders.textContent = ordersCount;
        if (elProducts) elProducts.textContent = productsCount;
        
        // Simulate trend data (in production, this would come from API with historical comparison)
        function updateTrend(elementId, value) {
          const el = document.getElementById(elementId);
          if (!el) return;
          
          // Use consistent placeholder trends until real API data is available
          const trends = {
            'users-trend': 8,
            'orders-trend': 12,
            'products-trend': 5
          };
          const trend = trends[elementId] || 0;
          const isPositive = trend >= 0;
          const arrow = isPositive ? '‚Üó' : '‚Üò';
          const color = isPositive ? 'text-green-400' : 'text-red-400';
          
          el.className = `text-xs ${color} flex items-center gap-1`;
          el.innerHTML = `<span>${arrow}</span><span>${isPositive ? '+' : ''}${trend}%</span>`;
        }
        
        // Update trend indicators
        updateTrend('users-trend', usersCount);
        updateTrend('orders-trend', ordersCount);
        updateTrend('products-trend', productsCount);

        // Update status indicators
        function setStatus(id, healthy) {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.remove('bg-gray-400', 'bg-green-500', 'bg-red-500', 'animate-pulse');
            el.classList.add(healthy ? 'bg-green-500' : 'bg-red-500');
        }
        setStatus('status-api', apiHealthy);
        setStatus('status-db', dbHealthy);
        setStatus('status-server', serverHealthy);

        // Update recent activity list (improved layout)
        const auditList = document.getElementById('recent-audit-log');
        const viewAll = document.getElementById('view-all-activity');
        const activityActions = document.getElementById('recent-activity-actions');
        const toggleBtn = document.getElementById('recent-activity-toggle');
        function relTime(iso){
          try {
            const d = new Date(iso);
            const diff = Date.now() - d.getTime();
            const s = Math.floor(diff/1000), m=Math.floor(s/60), h=Math.floor(m/60), dys=Math.floor(h/24);
            if (dys>0) return `${dys}d ago`;
            if (h>0) return `${h}h ago`;
            if (m>0) return `${m}m ago`;
            return `${s}s ago`;
          } catch(_) { return ''; }
        }
        function safeJsonParse(val){
          if (!val) return null;
          if (typeof val !== 'string') return val;
          try { return JSON.parse(val); } catch(_) { return val; }
        }
        function isSameDay(a,b){ try{ const da=new Date(a), db=new Date(b); return da.getFullYear()===db.getFullYear() && da.getMonth()===db.getMonth() && da.getDate()===db.getDate(); } catch(_) { return false; } }
        const actionIcon = (action) => {
          const a = String(action || '').toLowerCase();
          if (a.includes('login')) return 'üîê';
          if (a.includes('logout')) return 'üö™';
          if (a.includes('order')) return 'üßæ';
          if (a.includes('product')) return 'üì¶';
          if (a.includes('user')) return 'üë§';
          if (a.includes('settings')) return '‚öôÔ∏è';
          return '‚Ä¢';
        };
        const methodBadge = (method) => {
          if (!method) return '';
          const color = method === 'GET' ? 'bg-gray-700' : method === 'POST' ? 'bg-blue-700' : method === 'PUT' ? 'bg-yellow-700' : method === 'DELETE' ? 'bg-red-700' : 'bg-gray-700';
          return `<span class="ml-2 px-1.5 py-0.5 rounded text-[10px] ${color}">${method}</span>`;
        };
        const severityOf = (action, details) => {
          const a = String(action||'').toLowerCase();
          let status = null, success = null;
          if (details && typeof details === 'object') {
            status = details.status || details.statusCode || details.code || null;
            success = typeof details.success === 'boolean' ? details.success : null;
          }
          if (a.includes('failed') || a.includes('error') || (typeof status === 'number' && status >= 400) || success === false) return 'err';
          if (a.includes('locked') || a.includes('rate') || a.includes('limit') || (typeof status === 'number' && status >= 300 && status < 400)) return 'warn';
          return 'ok';
        };
        const severityColors = { ok: { text: 'text-gray-200', icon: 'text-gray-300' }, warn: { text: 'text-yellow-200', icon: 'text-yellow-300' }, err: { text: 'text-red-200', icon: 'text-red-300' } };
        const buildLogLink = (log, details) => {
          try {
            const since = new Date(Date.now() - 7*24*60*60*1000).toISOString();
            const url = new URL('audit-logs.html', window.location.origin);
            url.searchParams.set('start', since);
            if (log.action) url.searchParams.set('action', log.action);
            const rid = (details && (details.requestId || details.request_id)) || '';
            if (rid) url.searchParams.set('requestId', rid);
            const method = (details && (details.method || details.httpMethod)) || '';
            if (method) url.searchParams.set('method', method);
            const path = (details && (details.path || details.endpoint || details.url)) || '';
            if (path) url.searchParams.set('path', path);
            return url.toString();
          } catch(_) { return 'audit-logs.html'; }
        };
        if (auditList) {
          auditList.setAttribute('aria-busy','false');
          const since = new Date(Date.now() - 24*60*60*1000).toISOString();
          if (viewAll) viewAll.href = `audit-logs.html?start=${encodeURIComponent(since)}`;
          if (auditLogs && auditLogs.length > 0) {
            const maxCollapsed = 6;
            const maxExpanded = Math.min(12, auditLogs.length);
            let lastDate = null;
            function render(limit){
              const slice = auditLogs.slice(0, limit);
              const parts = [];
              slice.forEach((log, idx) => {
                const created = log.created_at || log.timestamp || '';
                const details = safeJsonParse(log.details);
                const method = (details && typeof details === 'object' && (details.method || details.httpMethod)) || '';
                const path = (details && typeof details === 'object' && (details.path || details.endpoint || details.url)) || '';
                const reqId = (details && typeof details === 'object' && (details.requestId || details.request_id)) || '';
                const who = (function(){
                  try {
                    const stored = JSON.parse(localStorage.getItem('user')||'{}');
                    if (stored && stored.id && log.user_id && Number(stored.id) === Number(log.user_id)) return 'You';
                  } catch(_) {}
                  return log.user_id ? `User #${log.user_id}` : 'System';
                })();
                const sev = severityOf(log.action, details);
                const colors = severityColors[sev] || severityColors.ok;
                // Date separator when day changes
                if (!lastDate || !isSameDay(lastDate, created)) {
                  lastDate = created;
                  const dateLabel = (()=>{ try { const d=new Date(created); return d.toLocaleDateString(); } catch(_) { return ''; } })();
                  parts.push(`<li class="mt-2 first:mt-0"><div class="text-[11px] uppercase tracking-wider text-gray-500 border-b border-gray-700 pb-1">${dateLabel || ''}</div></li>`);
                }
                const metaLine = [who, path].filter(Boolean).join(' ¬∑ ');
                const link = buildLogLink(log, details);
                parts.push(`
                  <li class="flex items-start gap-3 p-2 rounded hover:bg-gray-800/60">
                    <span class="mt-0.5 ${colors.icon}" aria-hidden="true">${actionIcon(log.action)}</span>
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center justify-between gap-2">
                        <div class="flex items-center flex-wrap gap-1 min-w-0">
                          <span class="font-semibold text-white truncate">${log.action || 'Activity'}</span>
                          ${methodBadge(method)}
                        </div>
                        <span class="text-xs text-gray-500 whitespace-nowrap ml-2">${created ? relTime(created) : ''}</span>
                      </div>
                      ${metaLine ? `<div class="text-xs ${colors.text} truncate">${metaLine}${reqId ? ` ¬∑ ${reqId}`:''}</div>` : ''}
                      <div class="mt-1">
                        <a href="${link}" class="text-[11px] text-cyan-300 hover:text-cyan-200 underline">View in Audit Logs</a>
                      </div>
                    </div>
                  </li>`);
              });
              auditList.innerHTML = parts.join('');
            }
            render(maxCollapsed);
            if (activityActions && toggleBtn) {
              activityActions.classList.toggle('hidden', auditLogs.length <= maxCollapsed);
              toggleBtn.textContent = 'Show more';
              let expanded = false;
              toggleBtn.onclick = () => {
                expanded = !expanded;
                if (expanded) { render(maxExpanded); toggleBtn.textContent = 'Show less'; }
                else { render(maxCollapsed); toggleBtn.textContent = 'Show more'; }
              };
            }
          } else {
            auditList.innerHTML = '<li class="text-gray-400">No activity in the last 24 hours</li>';
            if (activityActions) activityActions.classList.add('hidden');
          }
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
      updateGreeting();
      updateDashboardStats();
    });
    </script>
    <!-- Hidden minimal login form for integration tests -->
    <form id="login-form" class="hidden" aria-hidden="true">
      <input type="email" name="email" required aria-required="true" />
      <input type="password" name="password" required aria-required="true" />
      <button type="submit">Login</button>
    </form>
    </main>
  </div>

  

  <!-- Minimal mobile menu wiring after nav injection -->
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      function wireMenu(){
        var menuToggle=document.getElementById('menu-toggle');
        var sidebar=document.getElementById('sidebar');
        var sidebarBackdrop=document.getElementById('sidebar-backdrop');
        if(!(menuToggle && sidebar)) return;
        // Check if already wired to prevent duplicate listeners
        if(menuToggle.dataset.wired === 'true') return;
        menuToggle.dataset.wired = 'true';
        
        function toggle(){
          var isOpen = sidebar.classList.toggle('open');
          menuToggle.setAttribute('aria-expanded', String(isOpen));
          if(sidebarBackdrop){
            if(isOpen){ sidebarBackdrop.classList.remove('hidden'); }
            else { sidebarBackdrop.classList.add('hidden'); }
          }
          document.body.classList.toggle('sidebar-open', isOpen);
        }
        menuToggle.addEventListener('click', toggle);
        if(sidebarBackdrop){ sidebarBackdrop.addEventListener('click', function(){ if(sidebar.classList.contains('open')) toggle(); }); }
      }
      wireMenu();
      setTimeout(wireMenu, 250);
    });
  </script>
</body>
</html>