<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Email Templates - joshburt.com.au</title>
  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="/assets/images/logo-placeholder.svg" />
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <script src="/assets/js/init-shared.js" defer></script>
  <script src="/assets/js/notifications.js" defer></script>
  <script src="/assets/js/feature-flags.js" defer></script>
  <link rel="stylesheet" href="/assets/css/accessibility.css" />
  <script src="/assets/js/accessibility.js" defer></script>
</head>
<body class="dark min-h-screen flex flex-col md:flex-row font-sans">

<button id="menu-toggle" class="md:hidden fixed top-4 left-4 z-50 p-2 mobile-menu-toggle" aria-label="Toggle sidebar" aria-expanded="false">☰</button>
<div id="main-nav"></div>

<main id="main-content" class="flex-1 p-4 space-y-6" role="main">
  <header class="page-header ui-card border flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-bold">Email Templates</h1>
      <p class="text-sm text-gray-400 mt-1">Manage reusable email templates with variable substitution</p>
    </div>
    <div class="flex items-center gap-3">
      <div id="notification-bell-wrapper" class="relative"></div>
      <button id="create-template-btn" class="ui-btn ui-btn-secondary px-4 py-2 rounded-lg">
        + Create Template
      </button>
    </div>
  </header>

  <!-- Templates List -->
  <section class="ui-card p-6">
    <h2 class="text-lg font-semibold mb-4">Templates</h2>
    <div id="templates-list" class="space-y-4">
      <div class="text-center text-gray-400 py-8">Loading...</div>
    </div>
  </section>
</main>

<!-- Template Editor Modal -->
<div id="template-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[9998]">
  <div class="ui-card p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto relative z-[9999]">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold" id="modal-title">Create Email Template</h2>
      <button id="close-modal" class="text-gray-400 hover:text-white">×</button>
    </div>

    <form id="template-form" class="space-y-4">
      <input type="hidden" id="template-id" />

      <div>
        <label class="block text-sm font-semibold mb-2">Template Name (Unique ID)</label>
        <input type="text" id="template-name" required class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700" placeholder="password_reset" pattern="[a-z0-9_]+" />
        <p class="text-xs text-gray-400 mt-1">Use lowercase letters, numbers, and underscores only</p>
      </div>

      <div>
        <label class="block text-sm font-semibold mb-2">Subject</label>
        <input type="text" id="template-subject" required class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700" placeholder="Reset Your Password - {{siteName}}" />
        <p class="text-xs text-gray-400 mt-1">Use {{variableName}} for dynamic content</p>
      </div>

      <div>
        <label class="block text-sm font-semibold mb-2">HTML Body</label>
        <textarea id="template-body-html" rows="10" class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700 font-mono text-sm" placeholder="<html>...</html>"></textarea>
      </div>

      <div>
        <label class="block text-sm font-semibold mb-2">Plain Text Body (Optional)</label>
        <textarea id="template-body-text" rows="5" class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700" placeholder="Plain text version..."></textarea>
      </div>

      <div>
        <label class="block text-sm font-semibold mb-2">Variables (comma-separated)</label>
        <input type="text" id="template-variables" class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700" placeholder="name, resetUrl, siteName" />
        <p class="text-xs text-gray-400 mt-1">List all variables used in this template</p>
      </div>

      <div>
        <label class="block text-sm font-semibold mb-2">Description (Optional)</label>
        <input type="text" id="template-description" class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700" placeholder="Password reset email template" />
      </div>

      <div class="flex justify-end gap-2 pt-4">
        <button type="button" id="cancel-btn" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600">
          Cancel
        </button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
          Save Template
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Preview Modal -->
<div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[9998]">
  <div class="ui-card p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto relative z-[9999]">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold">Template Preview</h2>
      <button id="close-preview" class="text-gray-400 hover:text-white">×</button>
    </div>

    <div id="preview-content" class="space-y-4">
      <div>
        <h3 class="font-semibold mb-2">Subject</h3>
        <p id="preview-subject" class="text-gray-300 bg-gray-900 p-3 rounded"></p>
      </div>

      <div>
        <h3 class="font-semibold mb-2">HTML Preview</h3>
        <iframe id="preview-iframe" class="w-full h-96 bg-[color:var(--token-bg-elevated)] rounded"></iframe>
      </div>

      <div>
        <h3 class="font-semibold mb-2">Plain Text</h3>
        <pre id="preview-text" class="text-gray-300 bg-gray-900 p-3 rounded whitespace-pre-wrap"></pre>
      </div>
    </div>
  </div>
</div>

<script>
  const FN_BASE = window.FN_BASE || '/.netlify/functions';
  let currentTemplates = [];

  function getAuthToken() {
    return (window.getToken && window.getToken()) || localStorage.getItem('accessToken');
  }

  async function apiFetch(url, options = {}) {
    if (typeof window !== 'undefined' && typeof window.authFetch === 'function') {
      return await window.authFetch(url, options);
    }

    const token = getAuthToken();
    const headers = { ...(options.headers || {}) };
    if (token && !headers.Authorization) {
      headers.Authorization = `Bearer ${token}`;
    }
    return await fetch(url, { ...options, headers });
  }

  async function loadTemplates() {
    try {
      const token = getAuthToken();
      if (!token && window.AUTH_DISABLED !== true) {
        window.location.href = '/login.html';
        return;
      }

      const response = await apiFetch(`${FN_BASE}/email-queue?templates=true`);

      if (!response.ok) {
        throw new Error('Failed to load templates');
      }

      const data = await response.json();
      currentTemplates = data.templates || [];

      displayTemplates(currentTemplates);

    } catch (error) {
      console.error('Error loading templates:', error);
      document.getElementById('templates-list').innerHTML = '<div class="text-center text-red-400 py-8">Failed to load templates</div>';
    }
  }

  function displayTemplates(templates) {
    const container = document.getElementById('templates-list');

    if (templates.length === 0) {
      container.innerHTML = '<div class="text-center text-gray-400 py-8">No templates yet. Create one to get started!</div>';
      return;
    }

    container.innerHTML = templates.map(template => {
      // Handle variables - could be array (JSONB) or string
      let variablesArr = [];
      if (template.variables) {
        if (Array.isArray(template.variables)) {
          variablesArr = template.variables;
        } else if (typeof template.variables === 'string') {
          try { variablesArr = JSON.parse(template.variables); } catch (_) { variablesArr = []; }
        }
      }
      return `
      <div class="ui-card p-4 border border-gray-700">
        <div class="flex justify-between items-start">
          <div class="flex-1">
            <h3 class="text-lg font-semibold">${template.name}</h3>
            <p class="text-sm text-gray-400 mt-1">${template.description || 'No description'}</p>
            <div class="mt-2 space-y-1 text-sm text-gray-400">
              <div><span class="font-semibold">Subject:</span> ${template.subject}</div>
              ${variablesArr.length ? `<div><span class="font-semibold">Variables:</span> ${variablesArr.join(', ')}</div>` : ''}
              <div><span class="font-semibold">Updated:</span> ${new Date(template.updated_at).toLocaleString()}</div>
            </div>
          </div>
          <div class="flex gap-2">
            <button onclick="previewTemplate('${template.name}')" class="px-3 py-1 text-sm bg-purple-600 text-white rounded hover:bg-purple-700">
              Preview
            </button>
            <button onclick="editTemplate('${template.name}')" class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
              Edit
            </button>
            <button onclick="deleteTemplate('${template.name}')" class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700">
              Delete
            </button>
          </div>
        </div>
      </div>
    `;}).join('');
  }

  function editTemplate(templateName) {
    const template = currentTemplates.find(t => t.name === templateName);
    if (!template) return;

    document.getElementById('modal-title').textContent = 'Edit Email Template';
    document.getElementById('template-id').value = template.id;
    document.getElementById('template-name').value = template.name;
    document.getElementById('template-name').disabled = true; // Can't change name after creation
    document.getElementById('template-subject').value = template.subject;
    document.getElementById('template-body-html').value = template.body_html || '';
    document.getElementById('template-body-text').value = template.body_text || '';
    
    // Handle variables - could be array (JSONB) or string
    let variablesArr = [];
    if (template.variables) {
      if (Array.isArray(template.variables)) {
        variablesArr = template.variables;
      } else if (typeof template.variables === 'string') {
        try { variablesArr = JSON.parse(template.variables); } catch (_) { variablesArr = []; }
      }
    }
    document.getElementById('template-variables').value = variablesArr.join(', ');
    document.getElementById('template-description').value = template.description || '';

    document.getElementById('template-modal').classList.remove('hidden');
  }

  function previewTemplate(templateName) {
    const template = currentTemplates.find(t => t.name === templateName);
    if (!template) return;

    document.getElementById('preview-subject').textContent = template.subject;
    
    // Load HTML into iframe
    const iframe = document.getElementById('preview-iframe');
    iframe.srcdoc = template.body_html || '<p>No HTML content</p>';

    document.getElementById('preview-text').textContent = template.body_text || 'No plain text version';

    document.getElementById('preview-modal').classList.remove('hidden');
  }

  async function deleteTemplate(templateName) {
    if (!confirm(`Are you sure you want to delete the template "${templateName}"?`)) return;

    try {
      const response = await apiFetch(`${FN_BASE}/email-queue/template/${templateName}`, {
        method: 'DELETE',
        headers: {}
      });

      if (!response.ok) {
        throw new Error('Failed to delete template');
      }

      loadTemplates();
    } catch (error) {
      console.error('Error deleting template:', error);
      alert('Failed to delete template');
    }
  }

  // Event listeners
  document.getElementById('create-template-btn').addEventListener('click', () => {
    document.getElementById('modal-title').textContent = 'Create Email Template';
    document.getElementById('template-form').reset();
    document.getElementById('template-id').value = '';
    document.getElementById('template-name').disabled = false;
    document.getElementById('template-modal').classList.remove('hidden');
  });

  document.getElementById('close-modal').addEventListener('click', () => {
    document.getElementById('template-modal').classList.add('hidden');
  });

  document.getElementById('cancel-btn').addEventListener('click', () => {
    document.getElementById('template-modal').classList.add('hidden');
  });

  document.getElementById('close-preview').addEventListener('click', () => {
    document.getElementById('preview-modal').classList.add('hidden');
  });

  document.getElementById('template-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const templateId = document.getElementById('template-id').value;
    const name = document.getElementById('template-name').value;
    const subject = document.getElementById('template-subject').value;
    const body_html = document.getElementById('template-body-html').value;
    const body_text = document.getElementById('template-body-text').value;
    const variablesText = document.getElementById('template-variables').value;
    const description = document.getElementById('template-description').value;

    const variables = variablesText.split(',').map(v => v.trim()).filter(v => v);

    try {
      const method = templateId ? 'PUT' : 'POST';
      const url = templateId ? `${FN_BASE}/email-queue/template/${name}` : `${FN_BASE}/email-queue/template`;

      const response = await apiFetch(url, {
        method,
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name,
          subject,
          body_html,
          body_text,
          variables,
          description
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to save template');
      }

      document.getElementById('template-modal').classList.add('hidden');
      loadTemplates();
    } catch (error) {
      console.error('Error saving template:', error);
      alert('Failed to save template: ' + error.message);
    }
  });

  // Make functions global for onclick handlers
  window.editTemplate = editTemplate;
  window.previewTemplate = previewTemplate;
  window.deleteTemplate = deleteTemplate;

  // Load initial data
  loadTemplates();
</script>

</body>
</html>
