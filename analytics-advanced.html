<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Advanced Analytics - joshburt.com.au</title>
  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="/assets/images/logo-placeholder.svg" />
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <script src="/assets/js/init-shared.js" defer></script>
  <script src="/assets/js/notifications.js" defer></script>
  <script src="/assets/js/feature-flags.js" defer></script>
  <link rel="stylesheet" href="/assets/css/accessibility.css" />
  <script src="/assets/js/accessibility.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="dark min-h-screen flex flex-col md:flex-row font-sans">

<button id="menu-toggle" class="md:hidden fixed top-4 left-4 z-50 p-2 mobile-menu-toggle" aria-label="Toggle sidebar" aria-expanded="false">â˜°</button>
<div id="main-nav"></div>

<main id="main-content" class="flex-1 p-4 space-y-6" role="main">
  <header class="page-header ui-card border flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold">Advanced Analytics</h1>
      <p class="text-sm text-gray-400 mt-1">Deep insights into user behavior, sessions, and events</p>
    </div>
    <div id="notification-bell-wrapper" class="relative"></div>
  </header>

  <!-- Filters Section -->
  <section class="ui-card p-4">
    <h2 class="text-lg font-semibold mb-4">Filters</h2>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div>
        <label class="block text-sm font-semibold mb-2">Date Range</label>
        <select id="date-range" class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700">
          <option value="1">Last 24 hours</option>
          <option value="7">Last 7 days</option>
          <option value="30" selected>Last 30 days</option>
          <option value="90">Last 90 days</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-semibold mb-2">Event Type</label>
        <select id="event-type" class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700">
          <option value="">All Events</option>
          <option value="page_view">Page Views</option>
          <option value="click">Clicks</option>
          <option value="search">Searches</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-semibold mb-2">Group By</label>
        <select id="group-by" class="w-full p-3 bg-gray-800 text-gray-100 rounded-lg border border-gray-700">
          <option value="day">Day</option>
          <option value="hour">Hour</option>
        </select>
      </div>
      <div class="flex items-end">
        <button id="refresh-btn" class="w-full p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
          Refresh Data
        </button>
      </div>
    </div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        if (!window.FeatureFlags || typeof window.FeatureFlags.isEnabled !== 'function') return;
        const enabled = await window.FeatureFlags.isEnabled('enableAdvancedAnalytics');
        if (enabled) return;

        if (typeof window.showToast === 'function') {
          window.showToast('Advanced Analytics is currently disabled.', 'warning');
        } else {
          alert('Advanced Analytics is currently disabled.');
        }
        window.location.href = 'administration.html';
      } catch (_) {
        // fail open
      }
    });
  </script>

  <!-- Overview Stats -->
  <section class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <div class="card p-4 ui-card ui-card-primary rounded-lg">
      <h3 class="text-sm font-semibold mb-1">Total Events</h3>
      <div id="stat-total-events" class="text-2xl font-bold text-blue-400">-</div>
    </div>
    <div class="card p-4 ui-card ui-card-secondary rounded-lg">
      <h3 class="text-sm font-semibold mb-1">Unique Users</h3>
      <div id="stat-unique-users" class="text-2xl font-bold text-green-400">-</div>
    </div>
    <div class="card p-4 ui-card ui-card-accent rounded-lg">
      <h3 class="text-sm font-semibold mb-1">Unique Sessions</h3>
      <div id="stat-unique-sessions" class="text-2xl font-bold text-purple-400">-</div>
    </div>
    <div class="ui-card p-4 widget-yellow rounded-lg">
      <h3 class="text-sm font-semibold mb-1">Avg Session Duration</h3>
      <div id="stat-avg-duration" class="text-2xl font-bold text-yellow-400">-</div>
    </div>
  </section>

  <!-- Charts Section -->
  <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="card ui-card ui-card-primary p-6 rounded-lg shadow-md">
      <h3 class="text-base font-semibold mb-4 flex items-center gap-2">
        <span class="inline-block w-2 h-2 bg-blue-400 rounded-full"></span>
        Events Over Time
      </h3>
      <div class="h-72">
        <canvas id="events-chart"></canvas>
      </div>
    </div>

    <div class="card ui-card ui-card-secondary p-6 rounded-lg shadow-md">
      <h3 class="text-base font-semibold mb-4 flex items-center gap-2">
        <span class="inline-block w-2 h-2 bg-green-400 rounded-full"></span>
        Event Type Distribution
      </h3>
      <div class="h-72">
        <canvas id="event-type-chart"></canvas>
      </div>
    </div>

    <div class="card ui-card ui-card-accent p-6 rounded-lg shadow-md lg:col-span-2">
      <h3 class="text-base font-semibold mb-4 flex items-center gap-2">
        <span class="inline-block w-2 h-2 bg-purple-400 rounded-full"></span>
        Top Pages
      </h3>
      <div class="h-80">
        <canvas id="top-pages-chart"></canvas>
      </div>
    </div>
  </section>

  <!-- Session Details Table -->
  <section class="ui-card p-6">
    <h2 class="text-lg font-semibold mb-4">Recent Sessions</h2>
    <div class="overflow-x-auto">
      <table class="w-full text-left">
        <thead>
          <tr class="border-b border-gray-700">
            <th class="pb-3">Session ID</th>
            <th class="pb-3">Started</th>
            <th class="pb-3">Duration</th>
            <th class="pb-3">Page Views</th>
            <th class="pb-3">User</th>
          </tr>
        </thead>
        <tbody id="sessions-table">
          <tr>
            <td colspan="5" class="py-4 text-center text-gray-400">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Export Section -->
  <section class="ui-card p-4">
    <div class="flex justify-between items-center">
      <h2 class="text-lg font-semibold">Export Data</h2>
      <div class="flex gap-2">
        <button id="export-csv" class="ui-btn ui-btn-secondary px-4 py-2 rounded-lg">Export CSV</button>
        <button id="export-json" class="ui-btn ui-btn-primary px-4 py-2 rounded-lg">Export JSON</button>
      </div>
    </div>
  </section>
</main>

<script>
  const FN_BASE = window.FN_BASE || '/.netlify/functions';
  let currentData = null;

  // Initialize charts
  let eventsChart, eventTypeChart, topPagesChart;

  function getCssVar(name, fallback) {
    try {
      const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
      return v || fallback;
    } catch (e) {
      return fallback;
    }
  }

  function colorToRgba(color, alpha) {
    if (!color) return color;
    const c = String(color).trim();
    const clamp = (n, min, max) => Math.min(max, Math.max(min, n));
    const a = clamp(Number(alpha), 0, 1);

    if (c.startsWith('rgba(')) {
      const parts = c
        .slice(5, -1)
        .split(',')
        .map(p => p.trim());
      if (parts.length >= 3) {
        return `rgba(${parts[0]}, ${parts[1]}, ${parts[2]}, ${a})`;
      }
    }

    if (c.startsWith('rgb(')) {
      const parts = c
        .slice(4, -1)
        .split(',')
        .map(p => p.trim());
      if (parts.length >= 3) {
        return `rgba(${parts[0]}, ${parts[1]}, ${parts[2]}, ${a})`;
      }
    }

    if (c.startsWith('#')) {
      const raw = c.slice(1);
      const hex = raw.length === 3 ? raw.split('').map(ch => ch + ch).join('') : raw;
      if (/^[0-9a-fA-F]{6}$/.test(hex)) {
        const r = parseInt(hex.slice(0, 2), 16);
        const g = parseInt(hex.slice(2, 4), 16);
        const b = parseInt(hex.slice(4, 6), 16);
        return `rgba(${r}, ${g}, ${b}, ${a})`;
      }
    }

    return c;
  }

  function getChartTheme() {
    const primary = getCssVar('--token-color-primary', '#3b82f6');
    const secondary = getCssVar('--token-color-secondary', '#10b981');
    const accent = getCssVar('--token-color-accent', '#8b5cf6');
    const warning = getCssVar('--token-color-warning', '#f59e0b');
    const danger = getCssVar('--token-color-danger', '#ef4444');
    const text = getCssVar('--token-text-secondary', 'rgb(209, 213, 219)');
    const grid = getCssVar('--token-border-default', 'rgba(255,255,255,0.1)');
    return {
      palette: [primary, secondary, accent, warning, danger],
      text,
      grid
    };
  }

  function applyChartsTheme() {
    if (!window.Chart) return;
    const t = getChartTheme();

    const styleLegend = chart => {
      if (chart?.options?.plugins?.legend?.labels) {
        chart.options.plugins.legend.labels.color = t.text;
      }
    };

    const styleAxes = chart => {
      if (!chart?.options?.scales) return;
      ['x', 'y'].forEach(axis => {
        if (chart.options.scales[axis]?.ticks) {
          chart.options.scales[axis].ticks.color = t.text;
        }
        if (chart.options.scales[axis]?.grid) {
          chart.options.scales[axis].grid.color = colorToRgba(t.grid, 0.25);
        }
      });
    };

    if (eventsChart) {
      try {
        eventsChart.data.datasets.forEach((ds, idx) => {
          const c = t.palette[idx % t.palette.length];
          ds.borderColor = c;
          ds.backgroundColor = colorToRgba(c, 0.12);
        });
        styleLegend(eventsChart);
        styleAxes(eventsChart);
        eventsChart.update();
      } catch (e) {}
    }

    if (eventTypeChart) {
      try {
        if (eventTypeChart.data?.datasets?.[0]) {
          eventTypeChart.data.datasets[0].backgroundColor = t.palette;
        }
        styleLegend(eventTypeChart);
        eventTypeChart.update();
      } catch (e) {}
    }

    if (topPagesChart) {
      try {
        if (topPagesChart.data?.datasets?.[0]) {
          topPagesChart.data.datasets[0].backgroundColor = t.palette[0];
        }
        styleAxes(topPagesChart);
        topPagesChart.update();
      } catch (e) {}
    }
  }

  try {
    if (!window.__analyticsAdvancedThemeListener) {
      window.__analyticsAdvancedThemeListener = function() {
        applyChartsTheme();
      };
      window.addEventListener('theme:changed', window.__analyticsAdvancedThemeListener);
    }
  } catch (e) {}

  async function loadAnalytics() {
    try {
      const dateRange = document.getElementById('date-range').value;
      const eventType = document.getElementById('event-type').value;
      const groupBy = document.getElementById('group-by').value;

      const endDate = new Date().toISOString().split('T')[0];
      const startDate = new Date(Date.now() - parseInt(dateRange) * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

      if (!window.authFetch) {
        console.warn('authFetch not ready, retrying...');
        setTimeout(loadAnalytics, 100);
        return;
      }

      let url = `${FN_BASE}/analytics-events?aggregate=true&date_from=${startDate}&date_to=${endDate}&group_by=${groupBy}`;
      if (eventType) {
        url += `&event_type=${eventType}`;
      }

      const response = await window.authFetch(url);

      if (!response.ok) {
        const errorText = await response.text();
        console.error('Analytics API error:', response.status, errorText);
        throw new Error(`Failed to load analytics: ${response.status} ${response.statusText}`);
      }

      const data = await response.json();
      currentData = data;

      updateStats(data);
      updateCharts(data);
      loadSessions();

    } catch (error) {
      console.error('Error loading analytics:', error);
      
      // Show user-friendly error message
      const errorDiv = document.createElement('div');
      errorDiv.className = 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 mb-4';
      errorDiv.innerHTML = `
        <p class="text-red-800 dark:text-red-200 font-semibold">Failed to load analytics data</p>
        <p class="text-sm text-red-600 dark:text-red-400 mt-2">${error.message}</p>
        <p class="text-xs text-red-500 dark:text-red-500 mt-1">Check browser console for details</p>
      `;
      
      // Insert error at top of main content area
      const mainContent = document.querySelector('main');
      if (mainContent) {
        mainContent.insertBefore(errorDiv, mainContent.firstChild);
      }
    }
  }

  function updateStats(data) {
    // Calculate totals from event_types
    const totalEvents = data.event_types.reduce((sum, item) => sum + parseInt(item.count), 0);
    const uniqueUsers = data.event_types.reduce((max, item) => Math.max(max, parseInt(item.unique_users)), 0);
    const uniqueSessions = data.event_types.reduce((max, item) => Math.max(max, parseInt(item.unique_sessions)), 0);

    document.getElementById('stat-total-events').textContent = totalEvents.toLocaleString();
    document.getElementById('stat-unique-users').textContent = uniqueUsers.toLocaleString();
    document.getElementById('stat-unique-sessions').textContent = uniqueSessions.toLocaleString();

    // Format average duration
    const avgDuration = data.sessions?.avg_duration || 0;
    const minutes = Math.floor(avgDuration / 60);
    const seconds = Math.floor(avgDuration % 60);
    document.getElementById('stat-avg-duration').textContent = `${minutes}m ${seconds}s`;
  }

  function updateCharts(data) {
    // Events over time
    const trendsData = data.trends || [];
    const dates = [...new Set(trendsData.map(item => {
      const date = new Date(item.period);
      return date.toLocaleDateString();
    }))];

    const datasets = {};
    trendsData.forEach(item => {
      const date = new Date(item.period).toLocaleDateString();
      if (!datasets[item.event_type]) {
        datasets[item.event_type] = new Array(dates.length).fill(0);
      }
      const index = dates.indexOf(date);
      datasets[item.event_type][index] = parseInt(item.count);
    });

    if (eventsChart) {
      eventsChart.destroy();
    }

    const ctx1 = document.getElementById('events-chart').getContext('2d');
    const theme1 = getChartTheme();
    eventsChart = new Chart(ctx1, {
      type: 'line',
      data: {
        labels: dates,
        datasets: Object.keys(datasets).map((eventType, index) => ({
          label: eventType,
          data: datasets[eventType],
          borderColor: theme1.palette[index % theme1.palette.length],
          backgroundColor: colorToRgba(theme1.palette[index % theme1.palette.length], 0.12),
          tension: 0.4
        }))
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'top', labels: { color: theme1.text } }
        },
        scales: {
          x: { ticks: { color: theme1.text }, grid: { color: colorToRgba(theme1.grid, 0.25) } },
          y: { beginAtZero: true, ticks: { color: theme1.text }, grid: { color: colorToRgba(theme1.grid, 0.25) } }
        }
      }
    });

    // Event type distribution
    if (eventTypeChart) {
      eventTypeChart.destroy();
    }

    const ctx2 = document.getElementById('event-type-chart').getContext('2d');
    const theme2 = getChartTheme();
    eventTypeChart = new Chart(ctx2, {
      type: 'doughnut',
      data: {
        labels: data.event_types.map(item => item.event_type),
        datasets: [{
          data: data.event_types.map(item => parseInt(item.count)),
          backgroundColor: theme2.palette
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right', labels: { color: theme2.text } }
        }
      }
    });

    // Top pages
    if (topPagesChart) {
      topPagesChart.destroy();
    }

    const topPages = (data.top_pages || []).slice(0, 10);
    const ctx3 = document.getElementById('top-pages-chart').getContext('2d');
    const theme3 = getChartTheme();
    topPagesChart = new Chart(ctx3, {
      type: 'bar',
      data: {
        labels: topPages.map(item => item.page_url.substring(0, 50) + (item.page_url.length > 50 ? '...' : '')),
        datasets: [{
          label: 'Page Views',
          data: topPages.map(item => parseInt(item.views)),
          backgroundColor: theme3.palette[0]
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: { beginAtZero: true, ticks: { color: theme3.text }, grid: { color: colorToRgba(theme3.grid, 0.25) } },
          y: { ticks: { color: theme3.text }, grid: { color: colorToRgba(theme3.grid, 0.25) } }
        }
      }
    });

    applyChartsTheme();
  }

  async function loadSessions() {
    try {
      if (!window.authFetch) {
        console.warn('authFetch not ready, retrying...');
        setTimeout(loadSessions, 100);
        return;
      }

      const response = await window.authFetch(`${FN_BASE}/analytics-events?aggregate=false&per_page=10`);

      if (!response.ok) {
        const errorText = await response.text();
        console.error('Sessions API error:', response.status, errorText);
        throw new Error(`Failed to load sessions: ${response.status}`);
      }

      const data = await response.json();
      const sessionsTable = document.getElementById('sessions-table');

      if (data.events && data.events.length > 0) {
        // Group by session
        const sessions = {};
        data.events.forEach(event => {
          if (!sessions[event.session_id]) {
            sessions[event.session_id] = {
              session_id: event.session_id,
              started: event.timestamp,
              events: []
            };
          }
          sessions[event.session_id].events.push(event);
        });

        sessionsTable.innerHTML = Object.values(sessions).slice(0, 10).map(session => {
          const duration = 'N/A'; // Would need to calculate from events
          const pageViews = session.events.filter(e => e.event_type === 'page_view').length;
          const userId = session.events[0].user_id || 'Anonymous';

          return `
            <tr class="border-b border-gray-700">
              <td class="py-3 font-mono text-sm">${session.session_id.substring(0, 16)}...</td>
              <td class="py-3">${new Date(session.started).toLocaleString()}</td>
              <td class="py-3">${duration}</td>
              <td class="py-3">${pageViews}</td>
              <td class="py-3">${userId}</td>
            </tr>
          `;
        }).join('');
      } else {
        sessionsTable.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-400">No sessions found</td></tr>';
      }
    } catch (error) {
      console.error('Error loading sessions:', error);
    }
  }

  // Event listeners
  document.getElementById('refresh-btn').addEventListener('click', loadAnalytics);
  document.getElementById('date-range').addEventListener('change', loadAnalytics);
  document.getElementById('event-type').addEventListener('change', loadAnalytics);
  document.getElementById('group-by').addEventListener('change', loadAnalytics);

  document.getElementById('export-csv').addEventListener('click', () => {
    if (!currentData) return;

    const csv = convertToCSV(currentData.event_types);
    downloadFile(csv, 'analytics-export.csv', 'text/csv');
  });

  document.getElementById('export-json').addEventListener('click', () => {
    if (!currentData) return;

    const json = JSON.stringify(currentData, null, 2);
    downloadFile(json, 'analytics-export.json', 'application/json');
  });

  function convertToCSV(data) {
    if (!data || data.length === 0) return '';

    const headers = Object.keys(data[0]);
    const rows = data.map(row => headers.map(h => row[h]).join(','));

    return [headers.join(','), ...rows].join('\n');
  }

  function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  // Load initial data
  loadAnalytics();
</script>

</body>
</html>
