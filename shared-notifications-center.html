<!-- Notification Center Component -->
<style>
  .notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--token-color-danger);
    color: var(--token-text-on-danger);
    border-radius: 9999px;
    padding: 2px 6px;
    font-size: 11px;
    font-weight: bold;
    min-width: 18px;
    text-align: center;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .notification-panel {
    position: fixed;
    top: 60px;
    right: 20px;
    width: 400px;
    max-width: 90vw;
    max-height: 600px;
    background: var(--token-bg-secondary);
    border: 1px solid var(--token-border-default);
    border-radius: 8px;
    box-shadow: var(--token-shadow-xl);
    z-index: 1000;
    display: none;
    flex-direction: column;
  }

  .notification-panel.show {
    display: flex;
  }

  .notification-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    border-bottom: 1px solid var(--token-border-default);
  }

  .notification-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
  }

  .notification-item {
    padding: 12px;
    margin-bottom: 8px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s;
    border-left: 3px solid transparent;
  }

  .notification-item:hover {
    background: var(--token-bg-tertiary);
  }

  .notification-item.unread {
    background: var(--token-color-primary-alpha-10);
    border-left-color: var(--token-color-primary);
  }

  .notification-item.high {
    border-left-color: var(--token-color-danger);
  }

  .notification-item.urgent {
    border-left-color: var(--token-color-danger-active);
    background: var(--token-color-danger-alpha-10);
  }

  .notification-title {
    font-weight: 600;
    margin-bottom: 4px;
  }

  .notification-message {
    font-size: 13px;
    color: var(--token-text-secondary);
    margin-bottom: 4px;
  }

  .notification-time {
    font-size: 11px;
    color: var(--token-text-muted);
  }

  .notification-actions {
    display: flex;
    gap: 8px;
    padding: 12px 16px;
    border-top: 1px solid var(--token-border-default);
  }

  .notification-empty {
    padding: 40px 20px;
    text-align: center;
    color: var(--token-text-secondary);
  }

  @media (max-width: 768px) {
    .notification-panel {
      right: 0;
      left: 0;
      width: 100%;
      max-width: 100%;
      border-radius: 0;
      top: 56px;
    }
  }
</style>

<!-- Notification Bell Button -->
<button id="notification-bell" class="ui-btn ui-btn-outline ui-btn-sm relative" aria-label="Notifications">
  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
  </svg>
  <span id="notification-badge" class="notification-badge hidden">0</span>
</button>

<!-- Notification Panel -->
<div id="notification-panel" class="notification-panel">
  <div class="notification-header">
    <h3 class="text-lg font-semibold">Notifications</h3>
    <div class="flex gap-2">
      <button id="mark-all-read-btn" class="ui-btn ui-btn-primary ui-btn-sm" title="Mark all as read">
        ✓ All
      </button>
      <button id="close-notifications-btn" class="ui-btn ui-btn-outline ui-btn-sm" title="Close" aria-label="Close">×</button>
    </div>
  </div>
  <div id="notification-list" class="notification-list">
    <div class="notification-empty">
      <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
      </svg>
      <p>No notifications</p>
    </div>
  </div>
  <div class="notification-actions">
    <button id="clear-read-btn" class="ui-btn ui-btn-outline ui-btn-sm flex-1">
      Clear Read
    </button>
    <button id="view-all-btn" class="ui-btn ui-btn-primary ui-btn-sm flex-1">
      View All
    </button>
  </div>
</div>

<script>
(function() {
  'use strict';

  const notificationBell = document.getElementById('notification-bell');
  const notificationBadge = document.getElementById('notification-badge');
  const notificationPanel = document.getElementById('notification-panel');
  const notificationList = document.getElementById('notification-list');
  const closeBtn = document.getElementById('close-notifications-btn');
  const markAllReadBtn = document.getElementById('mark-all-read-btn');
  const clearReadBtn = document.getElementById('clear-read-btn');
  const viewAllBtn = document.getElementById('view-all-btn');

  let notifications = [];
  let unreadCount = 0;

  // Toggle notification panel
  notificationBell.addEventListener('click', () => {
    notificationPanel.classList.toggle('show');
    if (notificationPanel.classList.contains('show')) {
      loadNotifications();
    }
  });

  // Close panel
  closeBtn.addEventListener('click', () => {
    notificationPanel.classList.remove('show');
  });

  // Close panel when clicking outside
  document.addEventListener('click', (e) => {
    if (!notificationBell.contains(e.target) && !notificationPanel.contains(e.target)) {
      notificationPanel.classList.remove('show');
    }
  });

  // Mark all as read
  markAllReadBtn.addEventListener('click', async () => {
    try {
      const response = await fetch('/.netlify/functions/notifications', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify({ mark_all_read: true })
      });

      if (response.ok) {
        loadNotifications();
      }
    } catch (error) {
      console.error('Failed to mark all as read:', error);
    }
  });

  // Clear read notifications
  clearReadBtn.addEventListener('click', async () => {
    try {
      const response = await fetch('/.netlify/functions/notifications', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify({ delete_all_read: true })
      });

      if (response.ok) {
        loadNotifications();
      }
    } catch (error) {
      console.error('Failed to clear read notifications:', error);
    }
  });

  // View all notifications
  viewAllBtn.addEventListener('click', () => {
    window.location.href = '/notifications.html';
  });

  // Load notifications
  async function loadNotifications() {
    try {
      const response = await fetch('/.netlify/functions/notifications?limit=20', {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });

      if (response.ok) {
        const data = await response.json();
        notifications = data.notifications || [];
        unreadCount = data.unread_count || 0;
        updateBadge();
        renderNotifications();
      }
    } catch (error) {
      console.error('Failed to load notifications:', error);
    }
  }

  // Update badge
  function updateBadge() {
    if (unreadCount > 0) {
      notificationBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
      notificationBadge.classList.remove('hidden');
    } else {
      notificationBadge.classList.add('hidden');
    }
  }

  // Render notifications
  function renderNotifications() {
    if (notifications.length === 0) {
      notificationList.innerHTML = `
        <div class="notification-empty">
          <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
          </svg>
          <p>No notifications</p>
        </div>
      `;
      return;
    }

    notificationList.innerHTML = notifications.map(n => {
      const timeAgo = formatTimeAgo(n.created_at);
      const unreadClass = n.is_read ? '' : 'unread';
      const priorityClass = n.priority === 'high' ? 'high' : n.priority === 'urgent' ? 'urgent' : '';
      
      return `
        <div class="notification-item ${unreadClass} ${priorityClass}" data-id="${n.id}" data-url="${n.action_url || ''}">
          <div class="notification-title">${escapeHtml(n.title)}</div>
          <div class="notification-message">${escapeHtml(n.message)}</div>
          <div class="notification-time">${timeAgo}</div>
        </div>
      `;
    }).join('');

    // Add click handlers
    notificationList.querySelectorAll('.notification-item').forEach(item => {
      item.addEventListener('click', () => handleNotificationClick(item));
    });
  }

  // Handle notification click
  async function handleNotificationClick(item) {
    const id = parseInt(item.dataset.id);
    const url = item.dataset.url;

    // Mark as read
    try {
      await fetch('/.netlify/functions/notifications', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify({ notification_id: id })
      });

      // Navigate if URL exists
      if (url) {
        window.location.href = url;
      } else {
        loadNotifications();
      }
    } catch (error) {
      console.error('Failed to mark notification as read:', error);
    }
  }

  // Format time ago
  function formatTimeAgo(timestamp) {
    const now = new Date();
    const time = new Date(timestamp);
    const diff = Math.floor((now - time) / 1000); // seconds

    if (diff < 60) return 'Just now';
    if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
    if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
    if (diff < 604800) return `${Math.floor(diff / 86400)}d ago`;
    return time.toLocaleDateString();
  }

  // Escape HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Load notifications on page load
  if (localStorage.getItem('token')) {
    loadNotifications();
    // Refresh every 60 seconds
    setInterval(loadNotifications, 60000);
  }

  // Export for external use
  window.notificationCenter = {
    load: loadNotifications,
    refresh: loadNotifications
  };
})();
</script>
